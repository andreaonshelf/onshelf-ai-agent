<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Demo: Interactive Planogram (18 Products)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f7fa;
            color: #1e293b;
        }
        
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 0;
            color: #64748b;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 12px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            font-size: 14px;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        .demo-mode {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        /* Planogram specific styles */
        #planogramViewer {
            height: 500px;
            overflow: auto;
            padding: 0;
        }
        
        /* Products table */
        .products-table {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .products-table h4 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 700;
        }
        
        .products-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .products-table thead tr {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .products-table th {
            padding: 10px 6px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
        }
        
        .products-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .products-table tbody tr:hover {
            background: #f7fafc;
        }
        
        /* Stats */
        .stats-container {
            background: white;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .stat-label {
            font-size: 9px;
            color: #64748b;
            margin-top: 2px;
        }
        
        /* Controls */
        .controls-container {
            background: white;
            border-radius: 6px;
            padding: 4px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Demo: Interactive Planogram (18 Products)</h1>
            <p>Grid-based visualization with cumulative positioning and gravity-based stacking</p>
        </div>
        
        <div class="main-grid">
            <div class="panel">
                <div class="panel-header">üì∑ Original Image</div>
                <div class="panel-content">
                    <div class="demo-mode">
                        <h3>üì∑ Demo Mode</h3>
                        <p>Select a real image from the sidebar to see the original photo, or view the interactive planogram demo on the right.</p>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <div class="panel-header">üìä Generated Planogram</div>
                <div class="panel-content" style="padding: 0;">
                    <div id="planogramViewer"></div>
                </div>
            </div>
        </div>
        
        <!-- Stats Dashboard -->
        <div id="compactStatsDashboard" class="stats-container">
            <div class="stat-item">
                <div class="stat-value" id="totalProducts">0</div>
                <div class="stat-label">Products</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalShelves">0</div>
                <div class="stat-label">Shelves</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalFacings">0</div>
                <div class="stat-label">Facings</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avgConfidence">0%</div>
                <div class="stat-label">Confidence</div>
            </div>
        </div>
        
        <!-- Controls -->
        <div id="planogramControls" class="controls-container">
            <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                <!-- Zoom Controls -->
                <div style="display: flex; align-items: center; gap: 3px;">
                    <span style="font-size: 8px; font-weight: 600; color: #4a5568;">üîç <span id="zoomPercentage">100%</span></span>
                    <button onclick="updatePlanogramZoom(0.5, false, true)" style="padding: 2px 4px; background: #10b981; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">50%</button>
                    <button onclick="updatePlanogramZoom(1, true)" style="padding: 2px 4px; background: #6b7280; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">100%</button>
                    <button onclick="updatePlanogramZoom(1.5, false, true)" style="padding: 2px 4px; background: #f59e0b; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">150%</button>
                </div>
                
                <!-- Display Toggles -->
                <div style="display: flex; gap: 2px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #4facfe; color: white; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                        <input type="checkbox" id="toggleBrands" checked onchange="updatePlanogramDisplay('showBrands', this.checked)" style="display: none;">
                        <span>‚úì</span>B
                    </label>
                    <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #fa709a; color: white; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                        <input type="checkbox" id="toggleProducts" checked onchange="updatePlanogramDisplay('showProducts', this.checked)" style="display: none;">
                        <span>‚úì</span>P
                    </label>
                    <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #a8edea; color: #2d3748; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                        <input type="checkbox" id="togglePrices" checked onchange="updatePlanogramDisplay('showPrices', this.checked)" style="display: none;">
                        <span>‚úì</span>¬£
                    </label>
                    <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #f7fafc; color: #4a5568; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                        <input type="checkbox" id="toggleConfidence" onchange="updatePlanogramDisplay('showConfidence', this.checked)" style="display: none;">
                        <span>‚óã</span>%
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Products Table -->
        <div id="extractedProductsTable" class="products-table">
            <!-- Table will be populated by loadExtractedProductsTable -->
        </div>
    </div>

    <script>
        // Current zoom level
        let currentZoomLevel = 1;
        
        // EXACT functions from main.py dashboard
        
        // Update zoom
        function updatePlanogramZoom(zoomFactor, reset = false, setExact = false) {
            const planogramViewer = document.getElementById('planogramViewer');
            if (!planogramViewer) return;
            
            const gridContainers = planogramViewer.querySelectorAll('.planogram-grid');
            
            if (reset) {
                currentZoomLevel = 1;
            } else if (setExact) {
                currentZoomLevel = zoomFactor;
            } else {
                currentZoomLevel *= zoomFactor;
                currentZoomLevel = Math.max(0.5, Math.min(2, currentZoomLevel));
            }
            
            gridContainers.forEach(container => {
                container.style.transform = `scale(${currentZoomLevel})`;
            });
            
            const zoomDisplay = document.getElementById('zoomPercentage');
            if (zoomDisplay) {
                zoomDisplay.textContent = `${Math.round(currentZoomLevel * 100)}%`;
            }
        }
        
        // Update display toggles
        function updatePlanogramDisplay(setting, value) {
            const planogramViewer = document.getElementById('planogramViewer');
            if (!planogramViewer) return;
            
            switch(setting) {
                case 'showBrands':
                    planogramViewer.querySelectorAll('[data-brand]').forEach(el => {
                        el.style.display = value ? 'block' : 'none';
                    });
                    break;
                case 'showProducts':
                    planogramViewer.querySelectorAll('[data-name]').forEach(el => {
                        el.style.display = value ? 'block' : 'none';
                    });
                    break;
                case 'showPrices':
                    planogramViewer.querySelectorAll('[data-price]').forEach(el => {
                        el.style.display = value ? 'block' : 'none';
                    });
                    break;
                case 'showConfidence':
                    planogramViewer.querySelectorAll('[data-confidence]').forEach(el => {
                        el.style.display = value ? 'block' : 'none';
                    });
                    break;
            }
        }
        
        function getConfidenceColor(confidence) {
            // EXACT MATCH with backend color mapping in src/api/planogram_editor.py
            // This must match the get_confidence_color function in the backend
            if (confidence >= 0.95) return '#22c55e'; // Green - very high (95%+)
            if (confidence >= 0.85) return '#3b82f6'; // Blue - high (85-94%)
            if (confidence >= 0.70) return '#f59e0b'; // Orange - medium (70-84%)
            return '#ef4444'; // Red - low (below 70%)
        }
        
        function adjustColor(color, amount) {
            const usePound = color[0] === '#';
            const col = usePound ? color.slice(1) : color;
            const num = parseInt(col, 16);
            let r = (num >> 16) + amount;
            let g = (num >> 8 & 0x00FF) + amount;
            let b = (num & 0x0000FF) + amount;
            r = r > 255 ? 255 : r < 0 ? 0 : r;
            g = g > 255 ? 255 : g < 0 ? 0 : g;
            b = b > 255 ? 255 : b < 0 ? 0 : b;
            return (usePound ? '#' : '') + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
        }
        
        // EXACT createSimpleGridPlanogram from main.py
        function createSimpleGridPlanogram(container, planogramData) {
            console.log('üéØ Creating GLOBAL CONSISTENT GRID planogram with proper stacking');
            
            const { shelves } = planogramData;
            
            // Calculate GLOBAL dimensions across ALL shelves - CUMULATIVE APPROACH
            let globalMaxPosition = 8; // Minimum shelf width
            let globalMaxStackHeight = 1;
            
            console.log('üîç Calculating global dimensions using CUMULATIVE positioning...');
            
            // First pass: calculate actual grid slots needed for each shelf
            shelves.forEach(shelf => {
                console.log(`üìè Analyzing shelf ${shelf.shelf_number} for global dimensions`);
                
                let shelfGridPosition = 1; // Track cumulative position for this shelf
                
                ['Left', 'Center', 'Right'].forEach(sectionName => {
                    if (shelf.sections[sectionName]) {
                        shelf.sections[sectionName].forEach(slot => {
                            if (slot.type === 'product' && slot.data) {
                                const product = slot.data;
                                const facings = product.quantity?.columns || 1;
                                const stackHeight = product.quantity?.stack || 1;
                                
                                console.log(`  üìç ${product.brand} ${product.name}: ${facings} facings starting at grid ${shelfGridPosition}`);
                                
                                shelfGridPosition += facings; // Move to next position
                                globalMaxStackHeight = Math.max(globalMaxStackHeight, stackHeight);
                                
                            } else if (slot.type === 'empty') {
                                console.log(`  ‚≠ï Empty slot at grid ${shelfGridPosition}`);
                                shelfGridPosition += 1; // Empty takes 1 slot
                            }
                        });
                    }
                });
                
                const shelfTotalSlots = shelfGridPosition - 1;
                console.log(`  üìä Shelf ${shelf.shelf_number} needs ${shelfTotalSlots} total grid slots`);
                globalMaxPosition = Math.max(globalMaxPosition, shelfTotalSlots);
            });

            console.log(`üìè Global dimensions: ${globalMaxPosition} positions √ó ${globalMaxStackHeight} stack height`);
            
            // Create main container
            const planogramDiv = document.createElement('div');
            planogramDiv.style.cssText = `
                background: #f8fafc;
                height: 100%;
                padding: 16px;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                overflow: auto;
                display: flex;
                flex-direction: column;
            `;
            
            // Create shelves container
            const shelvesContainer = document.createElement('div');
            shelvesContainer.style.cssText = `
                display: flex;
                flex-direction: column;
                gap: 16px;
                min-height: 100%;
                overflow: visible;
                padding: 8px;
                min-width: max-content;
            `;

            // Sort shelves from top to bottom (highest shelf number first)
            const sortedShelves = shelves.sort((a, b) => b.shelf_number - a.shelf_number);

            // ALL shelves use the SAME global dimensions
            sortedShelves.forEach(shelf => {
                const shelfDiv = createGlobalConsistentShelfGrid(shelf, globalMaxPosition, globalMaxStackHeight);
                shelvesContainer.appendChild(shelfDiv);
            });
            
            planogramDiv.appendChild(shelvesContainer);
            container.appendChild(planogramDiv);
        }
        
        // Create GLOBAL CONSISTENT shelf grid - all shelves same width
        function createGlobalConsistentShelfGrid(shelf, globalMaxPosition, globalMaxStackHeight) {
            console.log(`üèóÔ∏è Creating GLOBAL CONSISTENT grid for Shelf ${shelf.shelf_number}: ${globalMaxPosition} positions √ó ${globalMaxStackHeight} stack (SAME for all shelves)`);
            
            const shelfDiv = document.createElement('div');
            shelfDiv.style.cssText = `
                background: white;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
                padding: 12px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                display: flex;
                align-items: stretch;
            `;

            // Shelf number on the left side
            const shelfNumber = document.createElement('div');
            shelfNumber.style.cssText = `
                background: transparent;
                color: #64748b;
                font-weight: 600;
                font-size: 16px;
                padding: 8px 4px;
                margin-right: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 25px;
                flex-shrink: 0;
            `;
            shelfNumber.textContent = shelf.shelf_number;
            shelfDiv.appendChild(shelfNumber);

            // Grid container (no header)
            const gridWrapper = document.createElement('div');
            gridWrapper.style.cssText = `
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                min-width: 0;
            `;

            // Create 2D grid array using GLOBAL dimensions
            const grid = createGlobal2DGrid(shelf, globalMaxPosition, globalMaxStackHeight);
            
            // Calculate ACTUAL stack height for THIS shelf (not global)
            let actualShelfStackHeight = 1;
            ['Left', 'Center', 'Right'].forEach(sectionName => {
                if (shelf.sections[sectionName]) {
                    shelf.sections[sectionName].forEach(slot => {
                        if (slot.type === 'product' && slot.data) {
                            const stackHeight = slot.data.quantity?.stack || 1;
                            actualShelfStackHeight = Math.max(actualShelfStackHeight, stackHeight);
                        }
                    });
                }
            });

            console.log(`üìê Shelf ${shelf.shelf_number}: Using actual stack height ${actualShelfStackHeight} (not global ${globalMaxStackHeight})`);

            // Create the visual grid container with FIXED compact dimensions - no horizontal scroll
            const gridContainer = document.createElement('div');
            gridContainer.className = 'planogram-grid';
            gridContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(${globalMaxPosition}, 45px);
                grid-template-rows: repeat(${actualShelfStackHeight}, 32px);
                gap: 1px;
                background: #f7fafc;
                border-radius: 4px;
                padding: 6px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                overflow: hidden;
                transform-origin: top left;
                transition: transform 0.3s ease;
                justify-content: start;
            `;

            // Fill grid with cells using ACTUAL shelf stack height
            for (let stackLevel = actualShelfStackHeight - 1; stackLevel >= 0; stackLevel--) {
                for (let position = 0; position < globalMaxPosition; position++) {
                    const cellData = grid[stackLevel][position];
                    const cell = createGlobalGridCell(cellData, position + 1, stackLevel + 1);
                    gridContainer.appendChild(cell);
                }
            }

            gridWrapper.appendChild(gridContainer);
            shelfDiv.appendChild(gridWrapper);
            return shelfDiv;
        }
        
        // Create GLOBAL 2D grid array using ACTUAL JSON data
        function createGlobal2DGrid(shelf, globalMaxPosition, globalMaxStackHeight) {
            console.log(`üìä Creating GLOBAL 2D grid from JSON: ${globalMaxPosition} √ó ${globalMaxStackHeight}`);
            
            // Initialize empty grid with GLOBAL dimensions
            const grid = [];
            for (let stackLevel = 0; stackLevel < globalMaxStackHeight; stackLevel++) {
                grid[stackLevel] = [];
                for (let position = 0; position < globalMaxPosition; position++) {
                    grid[stackLevel][position] = { 
                        type: 'empty', 
                        position: position + 1, 
                        stackLevel: stackLevel + 1 
                    };
                }
            }
            
            // Place products from ACTUAL JSON data - CALCULATE REAL GRID POSITIONS
            console.log(`üèóÔ∏è Shelf ${shelf.shelf_number}: Starting product placement`);
            console.log(`üìä Raw shelf data:`, shelf);
            
            let currentGridPosition = 1; // Track actual grid position
            
            ['Left', 'Center', 'Right'].forEach(sectionName => {
                if (shelf.sections[sectionName]) {
                    console.log(`üìÇ Section ${sectionName}: ${shelf.sections[sectionName].length} slots`);
                    console.log(`üìã Section ${sectionName} raw data:`, shelf.sections[sectionName]);
                    
                    shelf.sections[sectionName].forEach((slot, index) => {
                        console.log(`üîç Processing slot ${index + 1}:`, slot);
                        
                        if (slot.type === 'product' && slot.data) {
                            const facings = slot.data.quantity?.columns || 1;
                            console.log(`üìç PRODUCT: ${slot.data.brand} ${slot.data.name}`);
                            console.log(`üìê JSON position: ${slot.position} (sequence in section)`);
                            console.log(`üìê REAL grid position: ${currentGridPosition} (calculated)`);
                            console.log(`üìê Facings: ${facings} ‚Üí will occupy grid slots ${currentGridPosition} to ${currentGridPosition + facings - 1}`);
                            
                            placeProductInGlobalGrid(grid, slot.data, currentGridPosition);
                            currentGridPosition += facings; // Move to next available position
                            
                        } else if (slot.type === 'empty') {
                            console.log(`‚≠ï EMPTY: JSON position ${slot.position} ‚Üí grid position ${currentGridPosition}`);
                            currentGridPosition += 1; // Empty slot takes 1 position
                        } else {
                            console.log(`‚ùì UNKNOWN SLOT TYPE: ${slot.type}`, slot);
                        }
                    });
                } else {
                    console.log(`üìÇ Section ${sectionName}: No data`);
                }
            });
            console.log(`‚úÖ Shelf ${shelf.shelf_number}: Product placement complete. Total grid positions used: ${currentGridPosition - 1}`);
            
            return grid;
        }
        
        // Place product in GLOBAL grid - DECOUPLE JSON position from grid positions
        function placeProductInGlobalGrid(grid, product, jsonPosition) {
            // Extract EXACT values from JSON data
            const facings = product.quantity?.columns || 1;
            const stackHeight = product.quantity?.stack || 1;
            
            console.log(`üì¶ PRODUCT: ${product.brand} ${product.name}`);
            console.log(`üìç JSON position: ${jsonPosition} (starting position of this product)`);
            console.log(`üìê Facings: ${facings} (will occupy ${facings} grid slots)`);
            console.log(`üìö Stack: ${stackHeight} (height in each slot)`);
            console.log(`üéØ GRID SLOTS TO FILL: ${jsonPosition} to ${jsonPosition + facings - 1}`);
            
            // FILL GRID SLOTS: Each facing gets its own grid column
            for (let stackLevel = 0; stackLevel < stackHeight; stackLevel++) {
                for (let facing = 0; facing < facings; facing++) {
                    // GRID POSITION CALCULATION:
                    // - jsonPosition is 1-based (e.g., position 4)
                    // - grid is 0-based (e.g., grid[0][3])
                    // - facing 0 goes to jsonPosition, facing 1 goes to jsonPosition+1, etc.
                    const gridRow = stackLevel;
                    const gridCol = (jsonPosition - 1) + facing; // Convert to 0-based and add facing offset
                    
                    console.log(`  üî≤ SLOT ${gridCol + 1}: grid[${gridRow}][${gridCol}] = ${product.brand} facing ${facing + 1}/${facings}, stack ${stackLevel + 1}/${stackHeight}`);
                    
                    if (gridRow < grid.length && gridCol < grid[0].length) {
                        grid[gridRow][gridCol] = {
                            type: 'product',
                            product: product,
                            jsonPosition: jsonPosition, // Original JSON position
                            gridPosition: gridCol + 1, // Actual grid slot (1-based)
                            stackLevel: stackLevel + 1,
                            facingIndex: facing + 1,
                            totalFacings: facings,
                            totalStack: stackHeight,
                            cellId: `${product.id || product.brand}-JSON${jsonPosition}-GRID${gridCol + 1}-F${facing + 1}S${stackLevel + 1}`
                        };
                        console.log(`    ‚úÖ FILLED grid slot ${gridCol + 1} with ${product.brand} facing ${facing + 1}`);
                    } else {
                        console.error(`‚ùå GRID OVERFLOW: grid[${gridRow}][${gridCol}] for ${product.brand} facing ${facing + 1}`);
                    }
                }
            }
            console.log(`‚úÖ ${product.brand}: JSON position ${jsonPosition} ‚Üí FILLED grid slots ${jsonPosition} to ${jsonPosition + facings - 1}`);
        }
        
        // Create grid cell using EXACT JSON data - truly empty slots are invisible
        function createGlobalGridCell(cellData, position, stackLevel) {
            const cell = document.createElement('div');
            
            if (cellData.type === 'empty') {
                // TRULY EMPTY cell - completely transparent/invisible with fixed dimensions
                cell.style.cssText = `
                    background: transparent;
                    border: none;
                    height: 32px;
                    width: 45px;
                    min-width: 45px;
                    max-width: 45px;
                    box-sizing: border-box;
                `;
                return cell;
            }

            // Product cell using EXACT JSON data
            const { product, jsonPosition, gridPosition, facingIndex, stackLevel: productStackLevel, totalFacings, totalStack, cellId } = cellData;
            
            // Use EXACT confidence from JSON - prioritize visual.confidence_color if available
            const confidence = product.metadata?.extraction_confidence || product.extraction_confidence || 0.9;
            const confidenceColor = product.visual?.confidence_color || getConfidenceColor(confidence);
            
            console.log(`üé® Cell: ${cellId}, JSON pos: ${jsonPosition}, Grid pos: ${gridPosition}, Facing: ${facingIndex}/${totalFacings}, Stack: ${productStackLevel}/${totalStack}, Confidence: ${confidence}`);
            console.log(`üé® Color source: ${product.visual?.confidence_color ? 'JSON visual.confidence_color' : 'calculated from confidence'} = ${confidenceColor}`);
            console.log(`üé® Product visual data:`, product.visual);
            
            // Style product cell - FIXED compact size to prevent expansion
            cell.style.cssText = `
                background: linear-gradient(135deg, ${confidenceColor} 0%, ${adjustColor(confidenceColor, -20)} 100%);
                color: white;
                border-radius: 2px;
                height: 32px;
                width: 45px;
                min-width: 45px;
                max-width: 45px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-size: 6px;
                font-weight: 500;
                border: 1px solid ${confidenceColor};
                position: relative;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                box-sizing: border-box;
                overflow: hidden;
            `;

            // Add hover effect
            cell.addEventListener('mouseenter', () => {
                cell.style.transform = 'scale(1.05)';
                cell.style.zIndex = '10';
                cell.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            });
            cell.addEventListener('mouseleave', () => {
                cell.style.transform = 'scale(1)';
                cell.style.zIndex = '1';
                cell.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            });

            // Add data attribute for display controls
            cell.setAttribute('data-product-cell', 'true');

            // ALL CELLS show the same product info - no "main cell" concept for facings
            const brandDiv = document.createElement('div');
            brandDiv.setAttribute('data-brand', 'true');
            brandDiv.style.cssText = `
                font-weight: 700;
                font-size: 6px;
                text-align: center;
                margin-bottom: 0px;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                width: 100%;
                line-height: 1;
            `;
            brandDiv.textContent = product.brand || 'Unknown';

            const nameDiv = document.createElement('div');
            nameDiv.setAttribute('data-name', 'true');
            nameDiv.style.cssText = `
                font-size: 5px;
                text-align: center;
                opacity: 0.9;
                text-overflow: ellipsis;
                overflow: hidden;
                white-space: nowrap;
                width: 100%;
                line-height: 1;
                margin-bottom: 0px;
            `;
            nameDiv.textContent = product.name || 'Product';

            if (product.price) {
                const priceDiv = document.createElement('div');
                priceDiv.setAttribute('data-price', 'true');
                priceDiv.style.cssText = `
                    font-size: 5px;
                    font-weight: 700;
                    text-align: center;
                    background: rgba(255,255,255,0.2);
                    padding: 0px 2px;
                    border-radius: 1px;
                    line-height: 1;
                    margin-top: 1px;
                `;
                priceDiv.textContent = `¬£${product.price.toFixed(2)}`;
                cell.appendChild(priceDiv);
            }

            const confidenceDiv = document.createElement('div');
            confidenceDiv.setAttribute('data-confidence', 'true');
            confidenceDiv.style.cssText = `
                font-size: 4px;
                font-weight: 700;
                text-align: center;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 0px 1px;
                border-radius: 1px;
                margin-top: 1px;
                display: none;
                line-height: 1;
            `;
            confidenceDiv.textContent = `${Math.round(confidence * 100)}%`;
            cell.appendChild(confidenceDiv);

            cell.appendChild(brandDiv);
            cell.appendChild(nameDiv);

            // Add facing indicator for debugging (optional)
            if (totalFacings > 1) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: absolute;
                    top: 1px;
                    right: 1px;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    font-size: 4px;
                    padding: 0px 1px;
                    border-radius: 1px;
                    font-weight: 700;
                    line-height: 1;
                `;
                indicator.textContent = `F${facingIndex}`;
                cell.appendChild(indicator);
            }

            // Add click handler with EXACT JSON data
            cell.addEventListener('click', () => {
                console.log(`üñ±Ô∏è Clicked cell: ${cellId}`);
                console.log(`üìç Product: ${product.brand} ${product.name}`);
                console.log(`üìê JSON position: ${jsonPosition}, Grid position: ${gridPosition}`);
                console.log(`üìä Facing: ${facingIndex}/${totalFacings}, Stack: ${productStackLevel}/${totalStack}`);
                console.log('Full product data:', product);
            });

            return cell;
        }
        
        // EXACT loadCompactStatsDashboard from main.py
        async function loadCompactStatsDashboard() {
            try {
                const data = demoData;
                let totalProducts = 0;
                let totalFacings = 0;
                let hasStacking = false;
                let confidenceSum = 0;
                let confidenceCount = 0;
                
                // Calculate stats from shelves
                data.planogram.shelves.forEach(shelf => {
                    Object.values(shelf.sections).forEach(section => {
                        section.forEach(slot => {
                            if (slot.type === 'product') {
                                totalProducts++;
                                totalFacings += slot.data.quantity?.total_facings || 1;
                                if (slot.data.quantity?.stack > 1) {
                                    hasStacking = true;
                                }
                                if (slot.data.metadata?.extraction_confidence) {
                                    confidenceSum += slot.data.metadata.extraction_confidence;
                                    confidenceCount++;
                                }
                            }
                        });
                    });
                });
                
                const avgConfidence = confidenceCount > 0 ? confidenceSum / confidenceCount : 0.9;
                
                // Update stats
                document.getElementById('totalProducts').textContent = totalProducts;
                document.getElementById('totalShelves').textContent = data.planogram.shelves.length;
                document.getElementById('totalFacings').textContent = totalFacings;
                document.getElementById('avgConfidence').textContent = `${Math.round(avgConfidence * 100)}%`;
                
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }
        
        // EXACT loadExtractedProductsTable from main.py
        async function loadExtractedProductsTable() {
            const tableContainer = document.getElementById('extractedProductsTable');
            
            try {
                const data = demoData;
                const products = [];
                
                // Extract all products from shelves
                data.planogram.shelves.forEach(shelf => {
                    Object.values(shelf.sections).forEach(section => {
                        section.forEach(slot => {
                            if (slot.type === 'product') {
                                products.push({
                                    ...slot.data,
                                    shelf: shelf.shelf_number,
                                    position: slot.position
                                });
                            }
                        });
                    });
                });
                
                // Sort by shelf and position
                products.sort((a, b) => {
                    if (a.shelf !== b.shelf) return a.shelf - b.shelf;
                    return a.position - b.position;
                });
                
                // Generate table HTML with ALL metadata
                const tableHTML = `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 16px 0; color: #2d3748; font-size: 18px; font-weight: 700;">üìã Extracted Products (${products.length} items)</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 50px;">Shelf</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 40px;">Pos</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 80px;">Section</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Brand</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 150px;">Product</th>
                                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Price</th>
                                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Facings</th>
                                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 50px;">Stack</th>
                                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 80px;">Total Units</th>
                                        <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Confidence</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 80px;">Color</th>
                                        <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 60px;">Volume</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${products.map(product => {
                                        const confidence = product.metadata?.extraction_confidence || 0;
                                        const confidenceColor = product.visual?.confidence_color || getConfidenceColor(confidence);
                                        const section = product.position?.section?.vertical || 'Unknown';
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #e2e8f0;">
                                                <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${product.shelf}</td>
                                                <td style="padding: 8px 6px; text-align: center;">${product.position || ''}</td>
                                                <td style="padding: 8px 6px;">${section}</td>
                                                <td style="padding: 8px 6px; font-weight: 500;">${product.brand || ''}</td>
                                                <td style="padding: 8px 6px;">${product.name || ''}</td>
                                                <td style="padding: 8px 6px; text-align: center; font-weight: 500;">¬£${(product.price || 0).toFixed(2)}</td>
                                                <td style="padding: 8px 6px; text-align: center;">${product.quantity?.columns || 1}</td>
                                                <td style="padding: 8px 6px; text-align: center;">${product.quantity?.stack || 1}</td>
                                                <td style="padding: 8px 6px; text-align: center; font-weight: 600;">${product.quantity?.total_facings || 1}</td>
                                                <td style="padding: 8px 6px; text-align: center;">
                                                    <span style="display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; color: white; background: ${confidenceColor};">
                                                        ${Math.round(confidence * 100)}%
                                                    </span>
                                                </td>
                                                <td style="padding: 8px 6px;">${product.metadata?.color || '-'}</td>
                                                <td style="padding: 8px 6px;">${product.metadata?.volume || '-'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                tableContainer.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Error loading products table:', error);
                tableContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No extraction data available</div>';
            }
        }
        
        // Demo data structure EXACTLY as returned by /api/planogram/demo/editable
        const demoData = {
            "image_id": "demo",
            "planogram": {
                "structure": {
                    "shelf_count": 3,
                    "total_width": 250,
                    "total_height": 180
                },
                "shelves": [
                    {
                        "shelf_number": 1,
                        "sections": {
                            "Left": [
                                {"type": "product", "position": 1, "data": {
                                    "id": "coke_1", "brand": "Coca-Cola", "name": "Coke Zero 330ml", "price": 1.29,
                                    "position": {"shelf_level": 1, "position_on_shelf": 1, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 3, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.98, "color": "black", "volume": "330ml"}
                                }},
                                {"type": "product", "position": 2, "data": {
                                    "id": "sprite_1", "brand": "Coca-Cola", "name": "Sprite 330ml", "price": 1.29,
                                    "position": {"shelf_level": 1, "position_on_shelf": 2, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.92, "color": "green", "volume": "330ml"}
                                }},
                                {"type": "product", "position": 3, "data": {
                                    "id": "fanta_1", "brand": "Coca-Cola", "name": "Fanta Orange 330ml", "price": 1.29,
                                    "position": {"shelf_level": 1, "position_on_shelf": 3, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.89, "color": "orange", "volume": "330ml"}
                                }}
                            ],
                            "Center": [
                                {"type": "product", "position": 4, "data": {
                                    "id": "pepsi_1", "brand": "Pepsi", "name": "Pepsi Max 330ml", "price": 1.19,
                                    "position": {"shelf_level": 1, "position_on_shelf": 4, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 3, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.95, "color": "blue", "volume": "330ml"}
                                }},
                                {"type": "product", "position": 5, "data": {
                                    "id": "7up_1", "brand": "Pepsi", "name": "7UP 330ml", "price": 1.19,
                                    "position": {"shelf_level": 1, "position_on_shelf": 5, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.87, "color": "green", "volume": "330ml"}
                                }},
                                {"type": "empty", "position": 6, "reason": "gap_detected"}
                            ],
                            "Right": [
                                {"type": "product", "position": 7, "data": {
                                    "id": "redbull_1", "brand": "Red Bull", "name": "Red Bull Energy 250ml", "price": 1.89,
                                    "position": {"shelf_level": 1, "position_on_shelf": 7, "section": {"vertical": "Right"}},
                                    "quantity": {"stack": 2, "columns": 2, "total_facings": 4},
                                    "visual": {"uses_full_height": false, "stack_rows": 2, "facing_width": 2, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.96, "color": "blue", "volume": "250ml"}
                                }},
                                {"type": "product", "position": 8, "data": {
                                    "id": "monster_1", "brand": "Monster", "name": "Monster Energy 500ml", "price": 2.15,
                                    "position": {"shelf_level": 1, "position_on_shelf": 8, "section": {"vertical": "Right"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.91, "color": "green", "volume": "500ml"}
                                }}
                            ]
                        },
                        "total_positions": 8,
                        "product_count": 7,
                        "empty_count": 1
                    },
                    {
                        "shelf_number": 2,
                        "sections": {
                            "Left": [
                                {"type": "product", "position": 1, "data": {
                                    "id": "water_1", "brand": "Evian", "name": "Natural Water 500ml", "price": 0.89,
                                    "position": {"shelf_level": 2, "position_on_shelf": 1, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 3, "columns": 2, "total_facings": 6},
                                    "visual": {"uses_full_height": false, "stack_rows": 3, "facing_width": 2, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.97, "color": "clear", "volume": "500ml"}
                                }},
                                {"type": "product", "position": 2, "data": {
                                    "id": "smartwater_1", "brand": "Coca-Cola", "name": "Smartwater 600ml", "price": 1.49,
                                    "position": {"shelf_level": 2, "position_on_shelf": 2, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 2, "columns": 2, "total_facings": 4},
                                    "visual": {"uses_full_height": false, "stack_rows": 2, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.88, "color": "clear", "volume": "600ml"}
                                }}
                            ],
                            "Center": [
                                {"type": "product", "position": 3, "data": {
                                    "id": "juice_1", "brand": "Innocent", "name": "Orange Juice 330ml", "price": 2.29,
                                    "position": {"shelf_level": 2, "position_on_shelf": 3, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 3, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.94, "color": "orange", "volume": "330ml"}
                                }},
                                {"type": "product", "position": 4, "data": {
                                    "id": "apple_juice_1", "brand": "Innocent", "name": "Apple Juice 330ml", "price": 2.29,
                                    "position": {"shelf_level": 2, "position_on_shelf": 4, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.90, "color": "green", "volume": "330ml"}
                                }},
                                {"type": "product", "position": 5, "data": {
                                    "id": "smoothie_1", "brand": "Innocent", "name": "Berry Smoothie 250ml", "price": 2.79,
                                    "position": {"shelf_level": 2, "position_on_shelf": 5, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#f59e0b"},
                                    "metadata": {"extraction_confidence": 0.76, "color": "purple", "volume": "250ml"}
                                }}
                            ],
                            "Right": [
                                {"type": "product", "position": 6, "data": {
                                    "id": "tea_1", "brand": "Lipton", "name": "Ice Tea Lemon 500ml", "price": 1.59,
                                    "position": {"shelf_level": 2, "position_on_shelf": 6, "section": {"vertical": "Right"}},
                                    "quantity": {"stack": 2, "columns": 3, "total_facings": 6},
                                    "visual": {"uses_full_height": false, "stack_rows": 2, "facing_width": 3, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.93, "color": "yellow", "volume": "500ml"}
                                }},
                                {"type": "empty", "position": 7, "reason": "gap_detected"}
                            ]
                        },
                        "total_positions": 7,
                        "product_count": 6,
                        "empty_count": 1
                    },
                    {
                        "shelf_number": 3,
                        "sections": {
                            "Left": [
                                {"type": "product", "position": 1, "data": {
                                    "id": "coffee_1", "brand": "Starbucks", "name": "Frappuccino Vanilla 250ml", "price": 2.49,
                                    "position": {"shelf_level": 3, "position_on_shelf": 1, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 3, "confidence_color": "#22c55e"},
                                    "metadata": {"extraction_confidence": 0.96, "color": "beige", "volume": "250ml"}
                                }},
                                {"type": "product", "position": 2, "data": {
                                    "id": "coffee_2", "brand": "Starbucks", "name": "Frappuccino Mocha 250ml", "price": 2.49,
                                    "position": {"shelf_level": 3, "position_on_shelf": 2, "section": {"vertical": "Left"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.89, "color": "brown", "volume": "250ml"}
                                }}
                            ],
                            "Center": [
                                {"type": "product", "position": 3, "data": {
                                    "id": "sports_1", "brand": "Powerade", "name": "Blue Sport Drink 500ml", "price": 1.79,
                                    "position": {"shelf_level": 3, "position_on_shelf": 3, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 2, "columns": 2, "total_facings": 4},
                                    "visual": {"uses_full_height": false, "stack_rows": 2, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.85, "color": "blue", "volume": "500ml"}
                                }},
                                {"type": "product", "position": 4, "data": {
                                    "id": "sports_2", "brand": "Gatorade", "name": "Orange Sport Drink 500ml", "price": 1.79,
                                    "position": {"shelf_level": 3, "position_on_shelf": 4, "section": {"vertical": "Center"}},
                                    "quantity": {"stack": 2, "columns": 2, "total_facings": 4},
                                    "visual": {"uses_full_height": false, "stack_rows": 2, "facing_width": 2, "confidence_color": "#f59e0b"},
                                    "metadata": {"extraction_confidence": 0.78, "color": "orange", "volume": "500ml"}
                                }}
                            ],
                            "Right": [
                                {"type": "product", "position": 5, "data": {
                                    "id": "energy_1", "brand": "Rockstar", "name": "Energy Drink 500ml", "price": 1.99,
                                    "position": {"shelf_level": 3, "position_on_shelf": 5, "section": {"vertical": "Right"}},
                                    "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
                                    "visual": {"uses_full_height": true, "stack_rows": 1, "facing_width": 2, "confidence_color": "#3b82f6"},
                                    "metadata": {"extraction_confidence": 0.86, "color": "black", "volume": "500ml"}
                                }},
                                {"type": "empty", "position": 6, "reason": "gap_detected"}
                            ]
                        },
                        "total_positions": 6,
                        "product_count": 5,
                        "empty_count": 1
                    }
                ]
            },
            "has_corrections": false,
            "correction_count": 0
        };
        
        // Initialize on load - EXACT sequence from dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            const planogramViewer = document.getElementById('planogramViewer');
            
            // Clear container
            planogramViewer.innerHTML = '';
            
            // Create the planogram using the exact function from dashboard
            createSimpleGridPlanogram(planogramViewer, demoData.planogram);
            
            // Load stats
            await loadCompactStatsDashboard();
            
            // Load products table
            await loadExtractedProductsTable();
        });
    </script>
</body>
</html>