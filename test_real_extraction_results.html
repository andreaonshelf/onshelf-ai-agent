<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Real Extraction Results</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.completed {
            background: #10b981;
            color: white;
        }
        .status.processing {
            background: #3b82f6;
            color: white;
        }
        .status.failed {
            background: #ef4444;
            color: white;
        }
        .status.pending {
            background: #6b7280;
            color: white;
        }
        .product-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .product-table th,
        .product-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        .product-table th {
            background: #f9fafb;
            font-weight: bold;
        }
        .product-table tr:nth-child(even) {
            background: #f9fafb;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .info-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 4px;
        }
        .info-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #111827;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 4px;
            margin: 12px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
        }
        button:hover {
            background: #2563eb;
        }
        .loading {
            color: #6b7280;
            font-style: italic;
        }
        pre {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Real Extraction Results</h1>
        
        <div>
            <button onclick="loadQueueItems()">Load Queue Items</button>
            <button onclick="loadResults(9)">Load Results for Item #9</button>
            <button onclick="loadAllCompletedResults()">Load All Completed Items</button>
        </div>
        
        <div id="queue-items" style="margin-top: 20px;"></div>
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        async function loadQueueItems() {
            const container = document.getElementById('queue-items');
            container.innerHTML = '<div class="loading">Loading queue items...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/queue/items`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let html = `<h2>Queue Items (${data.total} total)</h2>`;
                
                if (data.items && data.items.length > 0) {
                    // Filter to show completed items with extraction results
                    const completedItems = data.items.filter(item => item.status === 'completed');
                    
                    html += `<div class="info-grid">`;
                    html += `<div class="info-item">
                        <div class="info-label">Total Items</div>
                        <div class="info-value">${data.total}</div>
                    </div>`;
                    html += `<div class="info-item">
                        <div class="info-label">Completed Items</div>
                        <div class="info-value">${completedItems.length}</div>
                    </div>`;
                    html += `</div>`;
                    
                    html += '<table class="product-table">';
                    html += '<thead><tr>';
                    html += '<th>ID</th>';
                    html += '<th>Status</th>';
                    html += '<th>Store</th>';
                    html += '<th>Category</th>';
                    html += '<th>Products</th>';
                    html += '<th>Accuracy</th>';
                    html += '<th>Actions</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';
                    
                    data.items.forEach(item => {
                        const productCount = item.extraction_results?.total_products || 0;
                        html += '<tr>';
                        html += `<td>${item.id}</td>`;
                        html += `<td><span class="status ${item.status}">${item.status}</span></td>`;
                        html += `<td>${item.store_name || 'Unknown'}</td>`;
                        html += `<td>${item.category || 'Unknown'}</td>`;
                        html += `<td>${productCount}</td>`;
                        html += `<td>${item.final_accuracy ? (item.final_accuracy * 100).toFixed(0) + '%' : '-'}</td>`;
                        html += `<td><button onclick="loadResults(${item.id})">View Results</button></td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p>No queue items found.</p>';
                }
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading queue items: ${error.message}</div>`;
            }
        }
        
        async function loadResults(itemId) {
            const container = document.getElementById('results');
            container.innerHTML = '<div class="loading">Loading results...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/queue/results/${itemId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                let html = `<h2>Results for Queue Item #${itemId}</h2>`;
                
                // Basic info
                html += '<div class="info-grid">';
                html += `<div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value"><span class="status ${data.status}">${data.status}</span></div>
                </div>`;
                html += `<div class="info-item">
                    <div class="info-label">Store</div>
                    <div class="info-value">${data.store_name || 'Unknown'}</div>
                </div>`;
                html += `<div class="info-item">
                    <div class="info-label">Category</div>
                    <div class="info-value">${data.category || 'Unknown'}</div>
                </div>`;
                html += `<div class="info-item">
                    <div class="info-label">Total Products</div>
                    <div class="info-value">${data.total_products || 0}</div>
                </div>`;
                html += `<div class="info-item">
                    <div class="info-label">Accuracy</div>
                    <div class="info-value">${data.final_accuracy ? (data.final_accuracy * 100).toFixed(0) + '%' : '-'}</div>
                </div>`;
                html += `<div class="info-item">
                    <div class="info-label">API Cost</div>
                    <div class="info-value">$${data.api_cost ? data.api_cost.toFixed(4) : '0.00'}</div>
                </div>`;
                html += '</div>';
                
                // Products
                if (data.products && data.products.length > 0) {
                    html += `<h3>Extracted Products (${data.products.length})</h3>`;
                    html += '<table class="product-table">';
                    html += '<thead><tr>';
                    html += '<th>Name</th>';
                    html += '<th>Brand</th>';
                    html += '<th>Size</th>';
                    html += '<th>Price</th>';
                    html += '<th>Shelf</th>';
                    html += '<th>Position</th>';
                    html += '<th>Facings</th>';
                    html += '<th>Category</th>';
                    html += '<th>Confidence</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';
                    
                    data.products.forEach(product => {
                        html += '<tr>';
                        html += `<td>${product.name || '-'}</td>`;
                        html += `<td>${product.brand || '-'}</td>`;
                        html += `<td>${product.size || '-'}</td>`;
                        html += `<td>${product.price ? '$' + product.price.toFixed(2) : '-'}</td>`;
                        html += `<td>${product.shelf || '-'}</td>`;
                        html += `<td>${product.position || '-'}</td>`;
                        html += `<td>${product.facings || '-'}</td>`;
                        html += `<td>${product.category || '-'}</td>`;
                        html += `<td>${product.confidence ? (product.confidence * 100).toFixed(0) + '%' : '-'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p>No products found in extraction results.</p>';
                }
                
                // Iterations
                if (data.iterations_data && data.iterations_data.length > 0) {
                    html += `<h3>Iterations</h3>`;
                    html += '<table class="product-table">';
                    html += '<thead><tr>';
                    html += '<th>Iteration</th>';
                    html += '<th>Products Found</th>';
                    html += '<th>Accuracy</th>';
                    html += '<th>Cost</th>';
                    html += '</tr></thead>';
                    html += '<tbody>';
                    
                    data.iterations_data.forEach(iter => {
                        html += '<tr>';
                        html += `<td>${iter.iteration || '-'}</td>`;
                        html += `<td>${iter.products_found || '-'}</td>`;
                        html += `<td>${iter.accuracy ? (iter.accuracy * 100).toFixed(0) + '%' : '-'}</td>`;
                        html += `<td>$${iter.cost ? iter.cost.toFixed(4) : '0.00'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                }
                
                // Raw data for debugging
                html += '<h3>Raw Extraction Result</h3>';
                html += '<pre>' + JSON.stringify(data.extraction_result, null, 2) + '</pre>';
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading results: ${error.message}</div>`;
            }
        }
        
        async function loadAllCompletedResults() {
            const itemsContainer = document.getElementById('queue-items');
            const resultsContainer = document.getElementById('results');
            
            itemsContainer.innerHTML = '<div class="loading">Loading completed items...</div>';
            resultsContainer.innerHTML = '';
            
            try {
                const response = await fetch(`${API_BASE}/api/queue/items?status=completed`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const completedItems = data.items.filter(item => item.status === 'completed');
                
                itemsContainer.innerHTML = `<h2>Completed Items with Real Data</h2>`;
                resultsContainer.innerHTML = '';
                
                for (const item of completedItems) {
                    const resultResponse = await fetch(`${API_BASE}/api/queue/results/${item.id}`);
                    if (resultResponse.ok) {
                        const resultData = await resultResponse.json();
                        if (resultData.products && resultData.products.length > 0) {
                            resultsContainer.innerHTML += `
                                <div style="margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 8px;">
                                    <h3>Item #${item.id} - ${item.store_name || 'Unknown Store'}</h3>
                                    <p>Products: ${resultData.products.length}</p>
                                    <p>Sample: ${resultData.products[0].name} (${resultData.products[0].brand})</p>
                                </div>
                            `;
                        }
                    }
                }
                
                if (resultsContainer.innerHTML === '') {
                    resultsContainer.innerHTML = '<p>No completed items with product data found.</p>';
                }
            } catch (error) {
                itemsContainer.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Load queue items on page load
        window.addEventListener('load', () => {
            loadQueueItems();
        });
    </script>
</body>
</html>