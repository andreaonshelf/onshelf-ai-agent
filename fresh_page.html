1
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OnShelf AI - Extraction Dashboard</title>
        
        <!-- React and Dependencies -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        
        <!-- Planogram Styles -->
        <link rel="stylesheet" href="/static/css/planogram.css">
        
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                background: #f8fafc;
                color: #1e293b;
                line-height: 1.6;
            }
            
            /* Layout Structure */
            .app-container {
                display: flex;
                height: 100vh;
                overflow: hidden;
                position: relative;
            }
            
            /* Left Sidebar - Image Selection */
            .left-sidebar {
                width: 400px;
                background: white;
                border-right: 1px solid #e2e8f0;
                display: flex;
                flex-direction: column;
                transition: all 0.3s ease;
                z-index: 100;
                position: relative;
                flex-shrink: 0;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            /* Right Sidebar - Prompt Management */
            .right-sidebar {
                width: 350px;
                background: white;
                border-left: 1px solid #e2e8f0;
                display: flex;
                flex-direction: column;
                transition: all 0.3s ease;
                z-index: 100;
                position: relative;
                flex-shrink: 0;
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .right-sidebar.collapsed {
                transform: translateX(330px);
                width: 20px;
            }
            
            .left-sidebar.collapsed {
                transform: translateX(-380px);
                width: 20px;
            }
            
            
            .sidebar-header {
                padding: 20px;
                border-bottom: 1px solid #e2e8f0;
                background: #f8fafc;
            }
            
            .sidebar-toggle {
                position: fixed;
                right: -30px;
                top: 20px;
                width: 30px;
                height: 40px;
                background: #3b82f6;
                color: white;
                border: none;
                cursor: pointer;
                border-radius: 0 4px 4px 0;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                z-index: 1000;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            
            .left-sidebar .sidebar-toggle {
                left: -30px;
                right: auto;
                border-radius: 4px 0 0 4px;
            }
            
            .left-sidebar.collapsed .sidebar-toggle {
                left: 0px;
                border-radius: 0 4px 4px 0;
            }
            
            .right-sidebar .sidebar-toggle {
                right: -30px;
                left: auto;
                border-radius: 4px 0 0 4px;
            }
            
            .right-sidebar.collapsed .sidebar-toggle {
                right: 0px;
                border-radius: 0 4px 4px 0;
            }
            
            
            .filters-section {
                padding: 15px 20px;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .filter-group {
                margin-bottom: 15px;
            }
            
            .filter-group label {
                display: block;
                font-size: 12px;
                font-weight: 600;
                color: #64748b;
                margin-bottom: 5px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .filter-group select,
            .filter-group input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 14px;
                background: white;
            }
            
            .search-box {
                position: relative;
            }
            
            .search-box input {
                padding-left: 35px;
            }
            
            .search-box::before {
                content: "üîç";
                position: absolute;
                left: 12px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 14px;
            }
            
            .view-toggle {
                display: flex;
                gap: 5px;
                margin-top: 10px;
            }
            
            .view-toggle button {
                flex: 1;
                padding: 6px 12px;
                border: 1px solid #d1d5db;
                background: white;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
            }
            
            .view-toggle button.active {
                background: #3b82f6;
                color: white;
            }
            
            /* Prompt Management Styles */
            .prompt-section {
                padding: 15px 20px;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .prompt-section h3 {
                font-size: 14px;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 12px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .system-selection {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .radio-group {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }
            
            .radio-option {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .radio-option:hover {
                background: #f8fafc;
                border-color: #3b82f6;
            }
            
            .radio-option.selected {
                background: #eff6ff;
                border-color: #3b82f6;
                color: #1d4ed8;
            }
            
            .radio-option input[type="radio"] {
                margin: 0;
            }
            
            .radio-option label {
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                margin: 0;
            }
            
            .prompt-dropdowns {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .dropdown-group {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }
            
            .dropdown-group label {
                font-size: 11px;
                font-weight: 600;
                color: #64748b;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .dropdown-group select {
                padding: 6px 10px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 12px;
                background: white;
            }
            
            .prompt-preview {
                max-height: 200px;
                overflow-y: auto;
            }
            
            .prompt-content {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                padding: 10px;
                font-size: 11px;
                font-family: 'Monaco', 'Menlo', monospace;
                line-height: 1.4;
                color: #374151;
                white-space: pre-wrap;
                max-height: 150px;
                overflow-y: auto;
            }
            
            .performance-metrics {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
                margin-top: 10px;
            }
            
            .metric {
                background: #f1f5f9;
                padding: 6px 8px;
                border-radius: 4px;
                text-align: center;
            }
            
            .metric-label {
                font-size: 10px;
                color: #64748b;
                font-weight: 500;
            }
            
            .metric-value {
                font-size: 12px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .prompt-editor {
                max-height: 300px;
                overflow-y: auto;
            }
            
            .prompt-editor textarea {
                width: 100%;
                height: 120px;
                padding: 10px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 11px;
                font-family: 'Monaco', 'Menlo', monospace;
                resize: vertical;
                background: white;
            }
            
            .editor-actions {
                display: flex;
                gap: 6px;
                margin-top: 8px;
            }
            
            .editor-actions button {
                flex: 1;
                padding: 6px 10px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .editor-actions button.primary {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
            
            .editor-actions button:hover {
                background: #f8fafc;
            }
            
            .editor-actions button.primary:hover {
                background: #2563eb;
            }
            
            /* Batch Operations */
            .batch-controls {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .batch-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .batch-selection {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 12px;
            }
            
            .batch-actions {
                display: flex;
                gap: 6px;
            }
            
            .batch-actions button {
                padding: 4px 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
                background: white;
            }
            
            .batch-actions button:hover {
                background: #f8fafc;
            }
            
            .batch-actions button.primary {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
            
            /* Enhanced Queue Items */
            .queue-item {
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 12px;
                margin-bottom: 8px;
                background: white;
                transition: all 0.2s ease;
            }
            
            .queue-item:hover {
                border-color: #3b82f6;
                box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
            }
            
            .queue-item.selected {
                border-color: #3b82f6;
                background: #eff6ff;
            }
            
            .queue-item-header {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
            }
            
            .queue-item-checkbox {
                margin: 0;
            }
            
            .queue-item-title {
                font-size: 13px;
                font-weight: 600;
                color: #1e293b;
                flex: 1;
            }
            
            .queue-item-config {
                display: flex;
                gap: 12px;
                margin-bottom: 8px;
                font-size: 11px;
            }
            
            .config-indicator {
                display: flex;
                align-items: center;
                gap: 4px;
                color: #64748b;
            }
            
            .config-indicator.override {
                color: #dc2626;
                font-weight: 500;
            }
            
            .queue-item-actions {
                display: flex;
                gap: 6px;
            }
            
            .queue-item-actions button {
                padding: 4px 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 10px;
                cursor: pointer;
                background: white;
            }
            
            .queue-item-actions button:hover {
                background: #f8fafc;
            }
            
            .queue-item-actions button.primary {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
                border-color: #3b82f6;
            }
            
            .images-container {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }
            
            .image-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 10px;
            }
            
            .image-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .image-item {
                border: 2px solid transparent;
                border-radius: 8px;
                overflow: hidden;
                cursor: pointer;
                transition: all 0.2s ease;
                background: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .image-item:hover {
                border-color: #3b82f6;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .image-item.selected {
                border-color: #10b981;
                background: #f0fdf4;
            }
            
            .image-item.grid-view {
                aspect-ratio: 1;
            }
            
            .image-item.list-view {
                display: flex;
                padding: 8px;
                align-items: center;
                gap: 10px;
            }
            
            .image-thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
                background: #f1f5f9;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
            }
            
            .image-item.list-view .image-thumbnail {
                width: 60px;
                height: 60px;
                border-radius: 4px;
                flex-shrink: 0;
            }
            
            .image-info {
                padding: 8px;
                font-size: 12px;
            }
            
            .image-item.list-view .image-info {
                padding: 0;
                flex: 1;
            }
            
            .image-title {
                font-weight: 600;
                margin-bottom: 2px;
                color: #1e293b;
            }
            
            .image-meta {
                color: #64748b;
                font-size: 11px;
            }
            
            .status-badge {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-top: 4px;
            }
            
            .status-pending { background: #fef3c7; color: #92400e; }
            .status-processing { background: #dbeafe; color: #1e40af; }
            .status-completed { background: #d1fae5; color: #065f46; }
            .status-failed { background: #fee2e2; color: #991b1b; }
            .status-review { background: #fde68a; color: #92400e; }
            
            .pagination {
                padding: 15px 20px;
                border-top: 1px solid #e2e8f0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 12px;
                color: #64748b;
            }
            
            .pagination-controls {
                display: flex;
                gap: 5px;
            }
            
            .pagination-controls button {
                padding: 4px 8px;
                border: 1px solid #d1d5db;
                background: white;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .pagination-controls button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .pagination-controls button.active {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
            
            /* Main Content Area */
            .main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                width: 100%;
            }
            
            /* Header */
            .header {
                background: white;
                border-bottom: 1px solid #e2e8f0;
                padding: 20px 30px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .header h1 {
                font-size: 24px;
                font-weight: 700;
                color: #1e293b;
            }
            
            .mode-selector {
                display: flex;
                gap: 10px;
            }
            
            .mode-btn {
                padding: 8px 16px;
                border: 1px solid #d1d5db;
                background: white;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.2s ease;
            }
            
            .mode-btn:hover {
                background: #f8fafc;
                border-color: #3b82f6;
            }
            
            .mode-btn.active {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }
            
            /* Breadcrumb */
            .breadcrumb {
                padding: 15px 30px;
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                font-size: 14px;
                color: #64748b;
            }
            
            /* Content Area */
            .content-area {
                flex: 1;
                overflow: hidden;
                position: relative;
            }
            
            /* Queue Interface */
            .queue-interface {
                display: none;
                padding: 30px;
                height: 100%;
                overflow-y: auto;
            }
            
            .queue-interface.active {
                display: block;
            }
            
            .queue-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .stat-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border-left: 4px solid #3b82f6;
            }
            
            .stat-card.review { border-left-color: #f59e0b; }
            .stat-card.processing { border-left-color: #3b82f6; }
            .stat-card.completed { border-left-color: #10b981; }
            .stat-card.failed { border-left-color: #ef4444; }
            
            .stat-number {
                font-size: 32px;
                font-weight: 700;
                color: #1e293b;
            }
            
            .stat-label {
                font-size: 14px;
                color: #64748b;
                margin-top: 5px;
            }
            
            .queue-grid {
                margin-top: 20px;
            }
            
            .queue-item {
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border: 2px solid transparent;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .queue-item:hover {
                border-color: #3b82f6;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            .queue-item.selected {
                border-color: #10b981;
                background: #f0fdf4;
            }
            
            .queue-item.priority {
                border-left: 4px solid #f59e0b;
            }
            
            .item-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            
            .item-title {
                font-size: 16px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .item-status {
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
            }
            
            .item-meta {
                font-size: 14px;
                color: #64748b;
                margin-bottom: 15px;
                line-height: 1.5;
            }
            
            .item-accuracy {
                margin: 15px 0;
            }
            
            .accuracy-bar {
                width: 100%;
                height: 8px;
                background: #e2e8f0;
                border-radius: 4px;
                overflow: hidden;
                margin-bottom: 5px;
            }
            
            .accuracy-fill {
                height: 100%;
                background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%);
                transition: width 0.3s ease;
            }
            
            .accuracy-text {
                font-size: 12px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .system-selection {
                margin: 15px 0;
                padding: 15px;
                background: #f8fafc;
                border-radius: 6px;
                border: 1px solid #e2e8f0;
            }
            
            .system-label {
                font-size: 12px;
                font-weight: 600;
                color: #64748b;
                margin-bottom: 10px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .system-checkboxes {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .system-checkbox {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .system-checkbox input[type="checkbox"] {
                width: 16px;
                height: 16px;
            }
            
            .system-checkbox label {
                font-size: 14px;
                font-weight: 500;
                color: #1e293b;
                cursor: pointer;
            }
            
            .system-description {
                font-size: 12px;
                color: #64748b;
                margin-left: 24px;
                margin-top: -4px;
            }
            
            .item-actions {
                display: flex;
                gap: 10px;
                margin-top: 15px;
            }
            
            .btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s ease;
                text-decoration: none;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
            
            .btn-primary {
                background: #3b82f6;
                color: white;
            }
            
            .btn-primary:hover {
                background: #2563eb;
            }
            
            .btn-success {
                background: #10b981;
                color: white;
            }
            
            .btn-success:hover {
                background: #059669;
            }
            
            .btn-secondary {
                background: #6b7280;
                color: white;
            }
            
            .btn-secondary:hover {
                background: #4b5563;
            }
            
            .btn-warning {
                background: #f59e0b;
                color: white;
            }
            
            .btn-warning:hover {
                background: #d97706;
            }
            
            /* Simple Mode - 2 Panel Layout */
            .simple-mode {
                display: none;
                height: 100%;
                padding: 20px;
                 flex-direction: column;
            }
            
            .simple-mode.active {
                 display: flex;
            }
            
            .image-panel,
            .planogram-panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .panel-header {
                padding: 20px;
                border-bottom: 1px solid #e2e8f0;
                background: #f8fafc;
            }
            
            .panel-header h3 {
                font-size: 18px;
                font-weight: 600;
                color: #1e293b;
                margin: 0;
            }
            
            .panel-content {
                flex: 1;
                padding: 20px;
                overflow: auto;
            }
            
            .image-viewer {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 6px;
                overflow: hidden;
                position: relative;
            }
            
            .image-viewer img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                transition: transform 0.3s ease;
            }
            
            .image-controls {
                position: absolute;
                bottom: 10px;
                right: 10px;
                display: flex;
                gap: 5px;
                background: rgba(0,0,0,0.7);
                border-radius: 6px;
                padding: 5px;
            }
            
            .control-btn {
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                padding: 5px 8px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
            }
            
            .control-btn:hover {
                background: rgba(255,255,255,0.3);
            }
            
            .rating-system {
                margin-top: 20px;
                padding: 20px;
                background: #f8fafc;
                border-radius: 6px;
            }
            
            .rating-system h4 {
                font-size: 16px;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 10px;
            }
            
            .star-rating {
                display: flex;
                gap: 5px;
                margin-bottom: 15px;
            }
            
            .star {
                font-size: 24px;
                color: #d1d5db;
                cursor: pointer;
                transition: color 0.2s ease;
            }
            
            .star:hover,
            .star.active {
                color: #fbbf24;
            }
            
            .feedback-area {
                margin-top: 15px;
            }
            
            .feedback-area label {
                display: block;
                font-size: 14px;
                font-weight: 500;
                color: #374151;
                margin-bottom: 5px;
            }
            
            .feedback-area textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 14px;
                resize: vertical;
                min-height: 80px;
            }
            
            /* Simple Mode Tabs */
            .simple-tabs {
                display: flex;
                gap: 10px;
                border-bottom: 2px solid #e5e7eb;
                margin-bottom: 20px;
            }
            
            .simple-tab {
                padding: 10px 20px;
                background: none;
                border: none;
                border-bottom: 3px solid transparent;
                font-size: 14px;
                font-weight: 500;
                color: #6b7280;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .simple-tab:hover {
                color: #3b82f6;
            }
            
            .simple-tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
            }
            
            .simple-tab-content {
                animation: fadeIn 0.3s ease;
            }
            
            .simple-tab-content.active {
                display: block;
            }
            
            /* Feedback Status */
            #feedbackStatus {
                font-size: 14px;
                font-weight: 500;
                text-align: center;
                animation: slideIn 0.3s ease;
            }
            
            /* Comparison Mode */
            .comparison-mode {
                display: none;
                height: 100%;
                padding: 20px;
                overflow-y: auto;
            }
            
            .comparison-mode.active {
                display: block;
            }
            
            .agent-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .agent-tab {
                padding: 12px 20px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                color: #64748b;
                border-bottom: 2px solid transparent;
                transition: all 0.2s ease;
            }
            
            .agent-tab:hover {
                color: #3b82f6;
            }
            
            .agent-tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
            }
            
            .agent-content {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                padding: 20px;
            }
            
            .agent-metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }
            
            .metric-card {
                background: #f8fafc;
                padding: 15px;
                border-radius: 6px;
                text-align: center;
            }
            
            .metric-value {
                font-size: 24px;
                font-weight: 700;
                color: #1e293b;
            }
            
            .metric-label {
                font-size: 12px;
                color: #64748b;
                margin-top: 5px;
            }
            
            .extraction-results {
                margin-top: 20px;
            }
            
            .results-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }
            
            .result-card {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 15px;
            }
            
            .result-card h5 {
                font-size: 14px;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 10px;
            }
            
            .result-details {
                font-size: 12px;
                color: #64748b;
                line-height: 1.4;
            }
            
            /* Advanced Mode */
            .advanced-mode {
                display: none;
                height: 100%;
                padding: 20px;
                overflow-y: auto;
            }
            
            .advanced-mode.active {
                display: block;
            }
            
            /* Advanced Mode Tabs */
            .advanced-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .advanced-tab {
                padding: 12px 20px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                color: #64748b;
                border-bottom: 2px solid transparent;
                transition: all 0.2s ease;
            }
            
            .advanced-tab:hover {
                color: #3b82f6;
            }
            
            .advanced-tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
            }
            
            .advanced-tab-content {
                display: none;
                height: calc(100% - 60px);
            }
            
            .advanced-tab-content.active {
                display: block;
            }
            
            .advanced-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
                gap: 20px;
                height: 100%;
            }
            
            .advanced-panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            .technical-analysis {
                padding: 20px;
                overflow-y: auto;
            }
            
            /* Log Viewer Styles */
            .logs-container {
                height: 100%;
                display: flex;
                flex-direction: column;
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                overflow: hidden;
            }
            
            .log-controls {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px 20px;
                background: #f8fafc;
                border-bottom: 1px solid #e2e8f0;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .log-filters {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            
            .log-filters select,
            .log-filters input {
                padding: 6px 10px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 14px;
            }
            
            .log-filters input {
                min-width: 200px;
            }
            
            .log-actions {
                display: flex;
                gap: 8px;
                align-items: center;
            }
            
            .log-viewer {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
                background: #1e293b;
                color: #e2e8f0;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                font-size: 13px;
                line-height: 1.4;
            }
            
            .log-entry {
                display: flex;
                align-items: flex-start;
                padding: 4px 0;
                border-bottom: 1px solid #334155;
                word-wrap: break-word;
            }
            
            .log-entry:hover {
                background: #334155;
            }
            
            .log-timestamp {
                color: #94a3b8;
                margin-right: 10px;
                min-width: 80px;
                font-weight: 500;
            }
            
            .log-level {
                margin-right: 10px;
                min-width: 60px;
                font-weight: 600;
                text-align: center;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
            }
            
            .log-level.ERROR {
                background: #dc2626;
                color: white;
            }
            
            .log-level.WARNING {
                background: #d97706;
                color: white;
            }
            
            .log-level.INFO {
                background: #2563eb;
                color: white;
            }
            
            .log-level.DEBUG {
                background: #6b7280;
                color: white;
            }
            
            .log-component {
                color: #60a5fa;
                margin-right: 10px;
                min-width: 120px;
                font-weight: 500;
            }
            
            .log-message {
                flex: 1;
                color: #e2e8f0;
            }
            
            .log-loading {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #64748b;
            }
            
            /* Error Summary Styles */
            .error-summary-panel {
                padding: 20px;
                overflow-y: auto;
            }
            
            .error-summary {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .error-item {
                background: #fef2f2;
                border: 1px solid #fecaca;
                border-radius: 6px;
                padding: 12px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .error-item:hover {
                background: #fee2e2;
                border-color: #f87171;
            }
            
            .error-item.warning {
                background: #fffbeb;
                border-color: #fed7aa;
            }
            
            .error-item.warning:hover {
                background: #fef3c7;
                border-color: #fbbf24;
            }
            
            .error-timestamp {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 4px;
            }
            
            .error-component {
                font-size: 12px;
                font-weight: 600;
                color: #374151;
                margin-bottom: 4px;
            }
            
            .error-message {
                font-size: 14px;
                color: #1f2937;
                line-height: 1.4;
            }
            
            .analysis-section {
                margin-bottom: 25px;
            }
            
            .analysis-section h4 {
                font-size: 16px;
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 10px;
                border-bottom: 1px solid #e2e8f0;
                padding-bottom: 5px;
            }
            
            .analysis-data {
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 12px;
                background: #f8fafc;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #e2e8f0;
                overflow-x: auto;
            }
            
            .orchestrator-panel {
                padding: 20px;
            }
            
            .orchestrator-flow {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .flow-step {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                background: #f8fafc;
                border-radius: 6px;
                border-left: 4px solid #3b82f6;
            }
            
            .flow-step.completed {
                border-left-color: #10b981;
                background: #f0fdf4;
            }
            
            .flow-step.failed {
                border-left-color: #ef4444;
                background: #fef2f2;
            }
            
            .step-icon {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 12px;
                font-weight: 600;
                color: white;
                background: #3b82f6;
            }
            
            .flow-step.completed .step-icon {
                background: #10b981;
            }
            
            .flow-step.failed .step-icon {
                background: #ef4444;
            }
            
            .step-details {
                flex: 1;
            }
            
            .step-title {
                font-size: 14px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .step-description {
                font-size: 12px;
                color: #64748b;
            }
            
            .step-timing {
                font-size: 11px;
                color: #9ca3af;
            }
            
            /* Enhanced Extraction Settings CSS */
            .smart-recommendations {
                background: #e3f2fd;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                border: 1px solid #bbdefb;
            }
            
            .recommendation-context ul {
                margin: 5px 0;
                padding-left: 20px;
                font-size: 13px;
            }
            
            .recommendation-choices {
                background: white;
                padding: 12px;
                border-radius: 6px;
                margin: 10px 0;
                border: 1px solid #e3f2fd;
            }
            
            .auto-choice {
                padding: 6px 0;
                border-bottom: 1px solid #f5f5f5;
                font-size: 13px;
            }
            
            .auto-choice:last-child {
                border-bottom: none;
            }
            
            .auto-choice .reason {
                color: #666;
                font-size: 12px;
                font-style: italic;
            }
            
            /* Prompt Preview Panel */
            .prompt-preview-panel {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 6px;
                padding: 12px;
                margin-top: 10px;
                font-size: 13px;
            }
            
            .preview-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .prompt-name {
                font-weight: 600;
                color: #1e293b;
            }
            
            .performance-badge {
                background: #10b981;
                color: white;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
            }
            
            .performance-badge.new {
                background: #94a3b8;
            }
            
            .performance-badge.low {
                background: #ef4444;
            }
            
            .performance-badge.medium {
                background: #f59e0b;
            }
            
            .preview-stats {
                display: flex;
                gap: 12px;
                font-size: 11px;
                color: #64748b;
                margin-bottom: 8px;
                flex-wrap: wrap;
            }
            
            .prompt-snippet {
                background: white;
                padding: 8px;
                border-radius: 4px;
                font-family: 'Monaco', 'Menlo', monospace;
                font-size: 11px;
                max-height: 80px;
                overflow-y: auto;
                white-space: pre-wrap;
                color: #374151;
                border: 1px solid #e5e7eb;
            }
            
            .preview-actions {
                display: flex;
                gap: 6px;
                margin-top: 8px;
            }
            
            .preview-actions button {
                padding: 4px 8px;
                font-size: 11px;
                border: 1px solid #d1d5db;
                background: white;
                border-radius: 3px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .preview-actions button:hover {
                background: #f3f4f6;
                border-color: #9ca3af;
            }
            
            /* Model and Prompt Selectors */
            .model-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .model-row span {
                font-size: 13px;
                font-weight: 500;
                color: #374151;
                min-width: 80px;
            }
            
            .model-row select {
                flex: 1;
                margin-left: 10px;
                padding: 4px 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                font-size: 12px;
            }
            
            .prompt-selector-group {
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .prompt-selector-group:last-child {
                border-bottom: none;
            }
            
            .prompt-type-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .prompt-type-header span {
                font-weight: 500;
                color: #374151;
                font-size: 13px;
            }
            
            .new-prompt-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .new-prompt-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            }
            
            /* Config Actions */
            .config-actions {
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid #e5e7eb;
            }
            
            .config-actions button {
                width: 100%;
                padding: 10px;
                margin-bottom: 8px;
                border: none;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .btn-primary {
                background: #3b82f6;
                color: white;
            }
            
            .btn-primary:hover {
                background: #2563eb;
                transform: translateY(-1px);
            }
            
            .btn-secondary {
                background: #f3f4f6;
                color: #374151;
                border: 1px solid #d1d5db;
            }
            
            .btn-secondary:hover {
                background: #e5e7eb;
            }
            
            /* Version Management */
            .version-management {
                background: #fef3c7;
                border: 1px solid #fbbf24;
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 20px;
            }
            
            .current-version {
                font-weight: 600;
                color: #92400e;
                margin-bottom: 10px;
            }
            
            .version-badge {
                background: #3b82f6;
                color: white;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 11px;
                margin-left: 8px;
            }
            
            .version-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            
            .version-options label {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 13px;
                cursor: pointer;
            }
            
            /* Meta-Learning Dashboard Styles */
            .summary-cards {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .metric-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                text-align: center;
                border: 1px solid #e5e7eb;
            }
            
            .metric-value {
                font-size: 2em;
                font-weight: bold;
                color: #1976d2;
                margin: 10px 0;
            }
            
            .metric-label {
                color: #64748b;
                font-size: 13px;
                font-weight: 500;
            }
            
            .metric-trend {
                color: #10b981;
                font-size: 12px;
                margin-top: 5px;
            }
            
            .metric-trend.down {
                color: #ef4444;
            }
            
            .pattern-item {
                background: white;
                padding: 15px;
                margin-bottom: 10px;
                border-radius: 6px;
                border-left: 4px solid #10b981;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            .pattern-item.failure {
                border-left-color: #ef4444;
            }
            
            .pattern-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-weight: 600;
                margin-bottom: 5px;
            }
            
            .pattern-name {
                color: #1e293b;
                font-size: 14px;
            }
            
            .pattern-impact {
                color: #10b981;
                font-weight: 700;
                font-size: 14px;
            }
            
            .pattern-impact.negative {
                color: #ef4444;
            }
            
            .pattern-impact::before {
                content: "‚Üë ";
            }
            
            .pattern-impact.negative::before {
                content: "‚Üì ";
            }
            
            .pattern-details {
                font-size: 12px;
                color: #64748b;
                margin-bottom: 5px;
            }
            
            .pattern-description {
                font-size: 13px;
                color: #374151;
                line-height: 1.4;
            }
            
            /* Intelligence Interface Enhancements */
            .intelligence-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .intelligence-panel {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                overflow: hidden;
            }
            
            .intelligence-panel .panel-header {
                background: #f8fafc;
                padding: 15px 20px;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .intelligence-panel .panel-header h3 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
                padding: 20px;
            }
            
            .insights-list {
                padding: 20px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .insight-item {
                display: flex;
                align-items: flex-start;
                gap: 10px;
                padding: 10px 0;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .insight-item:last-child {
                border-bottom: none;
            }
            
            .insight-icon {
                font-size: 16px;
                margin-top: 2px;
            }
            
            .insight-text {
                flex: 1;
                font-size: 13px;
                color: #374151;
                line-height: 1.4;
            }
            
            .insight-time {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 4px;
            }
            
            .quick-actions {
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .quick-actions button {
                padding: 10px 15px;
                border: none;
                border-radius: 6px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 13px;
            }
            
            .btn-warning {
                background: #f59e0b;
                color: white;
            }
            
            .btn-warning:hover {
                background: #d97706;
            }
            
            /* Responsive Design */
            @media (max-width: 1200px) {
                .left-sidebar {
                    width: 300px;
                }
                
                .advanced-grid {
                    grid-template-columns: 1fr;
                    grid-template-rows: repeat(4, 1fr);
                }
            }
            
            @media (max-width: 768px) {
                .left-sidebar {
                    position: absolute;
                    left: 0;
                    top: 0;
                    height: 100%;
                    z-index: 1000;
                    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
                }
                
                .simple-mode {
                    grid-template-columns: 1fr;
                    grid-template-rows: 1fr 1fr;
                }
                
                .queue-grid {
                    grid-template-columns: 1fr;
                }
                
                .queue-stats {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
            
            /* Loading States */
            .loading {
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 40px;
                color: #64748b;
            }
            
            .loading::before {
                content: "";
                width: 20px;
                height: 20px;
                border: 2px solid #e2e8f0;
                border-top: 2px solid #3b82f6;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* Empty States */
            .empty-state {
                text-align: center;
                padding: 60px 20px;
                color: #64748b;
            }
            
            .empty-state h3 {
                font-size: 18px;
                margin-bottom: 10px;
                color: #374151;
            }
            
            .empty-state p {
                font-size: 14px;
                line-height: 1.5;
            }
            
            /* Intelligence Interface Styles */
            .intelligence-interface {
                display: none;
                height: 100%;
                padding: 20px;
                overflow-y: auto;
                background: #f8fafc;
            }
            
            .intelligence-interface.active {
                display: block;
            }
            
            .intelligence-container {
                max-width: 1400px;
                margin: 0 auto;
            }
            
            .intelligence-header {
                text-align: center;
                margin-bottom: 30px;
            }
            
            .intelligence-header h2 {
                font-size: 28px;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 10px;
            }
            
            .intelligence-header p {
                font-size: 16px;
                color: #64748b;
            }
            
            /* Intelligence Tabs */
            .intelligence-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 30px;
                border-bottom: 1px solid #e2e8f0;
                justify-content: center;
            }
            
            .intelligence-tab {
                padding: 12px 24px;
                border: none;
                background: none;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                color: #64748b;
                border-bottom: 2px solid transparent;
                transition: all 0.2s ease;
            }
            
            .intelligence-tab:hover {
                color: #3b82f6;
            }
            
            .intelligence-tab.active {
                color: #3b82f6;
                border-bottom-color: #3b82f6;
            }
            
            .intelligence-tab-content {
                display: none;
            }
            
            .intelligence-tab-content.active {
                display: block;
            }
            
            /* Intelligence Grid Layouts */
            .intelligence-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .charts-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .patterns-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            .recommendations-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            
            /* Intelligence Panels */
            .intelligence-panel {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                overflow: hidden;
                transition: transform 0.2s ease;
            }
            
            .intelligence-panel:hover {
                transform: translateY(-2px);
            }
            
            .chart-panel {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                overflow: hidden;
                padding: 20px;
            }
            
            .pattern-panel {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                overflow: hidden;
                padding: 20px;
            }
            
            .recommendation-panel {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                overflow: hidden;
                padding: 20px;
            }
            
            .evolution-panel {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                overflow: hidden;
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .panel-header {
                padding: 20px;
                border-bottom: 1px solid #e2e8f0;
                background: #f8fafc;
            }
            
            .panel-header h3 {
                margin: 0;
                font-size: 18px;
                font-weight: 600;
                color: #1e293b;
            }
            
            .panel-header h4 {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: #1e293b;
            }
            
            /* Metrics Grid */
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 15px;
                padding: 20px;
            }
            
            .metric-card {
                text-align: center;
                padding: 15px;
                background: #f8fafc;
                border-radius: 8px;
                border: 1px solid #e2e8f0;
            }
            
            .metric-value {
                font-size: 24px;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 5px;
            }
            
            .metric-label {
                font-size: 12px;
                color: #64748b;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            /* System Performance */
            .system-performance {
                padding: 20px;
            }
            
            .system-metric {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .system-metric:last-child {
                border-bottom: none;
            }
            
            .system-name {
                font-weight: 600;
                color: #1e293b;
            }
            
            .system-accuracy {
                font-weight: 600;
                color: #10b981;
            }
            
            .system-cost {
                font-size: 12px;
                color: #64748b;
            }
            
            /* Insights */
            .insights-list {
                padding: 20px;
            }
            
            .insight-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 0;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .insight-item:last-child {
                border-bottom: none;
            }
            
            .insight-icon {
                font-size: 20px;
            }
            
            .insight-text {
                flex: 1;
                font-size: 14px;
                color: #1e293b;
            }
            
            .insight-time {
                font-size: 12px;
                color: #64748b;
            }
            
            /* Quick Actions */
            .quick-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
                padding: 20px;
            }
            
            /* Chart Containers */
            .chart-container {
                height: 300px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 8px;
                color: #64748b;
                font-size: 14px;
            }
            
            /* Pattern Content */
            .pattern-content {
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 8px;
                color: #64748b;
                font-size: 14px;
                padding: 20px;
                text-align: center;
            }
            
            /* Recommendation Content */
            .recommendation-content {
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 8px;
                color: #64748b;
                font-size: 14px;
                padding: 20px;
                text-align: center;
            }
            
            /* Evolution Content */
            .evolution-content {
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
                background: #f8fafc;
                border-radius: 8px;
                color: #64748b;
                font-size: 14px;
                padding: 20px;
                text-align: center;
            }
            
            .evolution-timeline {
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                padding: 20px;
                margin-bottom: 20px;
                min-height: 300px;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #64748b;
                font-size: 14px;
            }
            
            .evolution-analysis {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 20px;
            }
            
            /* Enhanced Extraction Settings Styles */
            .config-group {
                margin-bottom: 20px;
                padding: 15px;
                background: #f8fafc;
                border-radius: 8px;
            }
            
            .config-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 10px;
                color: #1e293b;
            }
            
            .radio-group label {
                display: block;
                padding: 8px 12px;
                margin-bottom: 5px;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .radio-group label:hover {
                border-color: #3b82f6;
                background: #f0f9ff;
            }
            
            .radio-group input[type="radio"]:checked + label {
                border-color: #3b82f6;
                background: #f0f9ff;
                font-weight: 600;
            }
            
            /* Smart Recommendations */
            .smart-recommendations {
                background: #e3f2fd;
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            
            .recommendation-context ul {
                margin: 5px 0;
                padding-left: 20px;
            }
            
            .recommendation-choices {
                background: white;
                padding: 10px;
                border-radius: 4px;
                margin: 10px 0;
            }
            
            .auto-choice {
                padding: 5px 0;
                border-bottom: 1px solid #eee;
            }
            
            .auto-choice:last-child {
                border-bottom: none;
            }
            
            .auto-choice .reason {
                color: #666;
                font-size: 0.9em;
            }
            
            /* Model Configuration */
            .model-selectors {
                background: white;
                padding: 10px;
                border-radius: 4px;
            }
            
            .model-row {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }
            
            .model-row span {
                width: 100px;
                font-weight: 500;
            }
            
            .model-row select {
                flex: 1;
                padding: 6px;
                border: 1px solid #e2e8f0;
                border-radius: 4px;
            }
            
            /* Prompt Selection */
            .prompt-selector-group {
                margin-bottom: 20px;
            }
            
            .prompt-type-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .prompt-type-header span {
                font-weight: 600;
                color: #1e293b;
            }
            
            .new-prompt-btn {
                background: #3b82f6;
                color: white;
                border: none;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .new-prompt-btn:hover {
                background: #2563eb;
            }
            
            /* Prompt Preview Panel */
            .prompt-preview-panel {
                background: #f5f5f5;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
                margin-top: 10px;
            }
            
            .preview-header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            
            .prompt-name {
                font-weight: 600;
                color: #1e293b;
            }
            
            .performance-badge {
                background: #4caf50;
                color: white;
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 0.9em;
            }
            
            .preview-stats {
                display: flex;
                gap: 15px;
                font-size: 0.85em;
                color: #666;
                margin-bottom: 10px;
            }
            
            .prompt-snippet {
                background: white;
                padding: 10px;
                border-radius: 4px;
                font-family: monospace;
                font-size: 0.85em;
                max-height: 100px;
                overflow-y: auto;
            }
            
            .preview-actions {
                display: flex;
                gap: 8px;
                margin-top: 10px;
            }
            
            .preview-actions button {
                padding: 4px 12px;
                border: 1px solid #e2e8f0;
                background: white;
                border-radius: 4px;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .preview-actions button:hover {
                border-color: #3b82f6;
                background: #f0f9ff;
            }
            
            /* Config Actions */
            .config-actions {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e2e8f0;
                display: flex;
                gap: 10px;
            }
            
            .config-actions button {
                flex: 1;
            }
            
            /* Process With Modal Styles */
            .modal-overlay {
                backdrop-filter: blur(4px);
                animation: fadeIn 0.2s ease-out;
            }
            
            .modal-content {
                animation: slideIn 0.3s ease-out;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .system-option {
                transition: all 0.2s ease;
            }
            
            .system-option:hover {
                border-color: #3b82f6 !important;
                background: #f8fafc !important;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            }
            
            .system-option.selected {
                border-color: #3b82f6 !important;
                background: #f0f9ff !important;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            @keyframes slideIn {
                from { 
                    opacity: 0;
                    transform: translateY(-20px) scale(0.95);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }
            
            @keyframes slideOut {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100%);
                }
            }
            
            /* Configuration indicator styles */
            .config-badge {
                position: relative;
                cursor: help;
            }
            
            .config-badge:hover .config-tooltip {
                display: block;
            }
            
            .config-tooltip {
                display: none;
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #1e293b;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 11px;
                white-space: nowrap;
                z-index: 1000;
                margin-bottom: 5px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            
            .config-tooltip::after {
                content: '';
                position: absolute;
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                border: 5px solid transparent;
                border-top-color: #1e293b;
            }
            /* Evolution Tree Styles */
            .evolution-timeline svg {
                background: #f8fafc;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .trend-summary {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .trend-summary h4 {
                margin: 0 0 15px 0;
                color: #1e293b;
            }
            
            .trend-summary ul {
                margin: 0;
                padding-left: 20px;
            }
            
            .trend-summary li {
                margin-bottom: 8px;
                color: #64748b;
            }
            
            .trend-summary strong {
                color: #10b981;
                font-weight: 600;
            }
            
            .adaptation-timeline {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }
            
            .adaptation-timeline h4 {
                margin: 0 0 15px 0;
                color: #1e293b;
            }
            
            .adaptation-item {
                display: flex;
                align-items: center;
                padding: 10px 0;
                border-bottom: 1px solid #e5e7eb;
                font-size: 14px;
            }
            
            .adaptation-item:last-child {
                border-bottom: none;
            }
            
            .adaptation-item .date {
                width: 100px;
                color: #6b7280;
                font-weight: 500;
            }
            
            .adaptation-item .change {
                flex: 1;
                color: #1e293b;
                margin: 0 15px;
            }
            
            .adaptation-item .impact {
                color: #10b981;
                font-weight: 600;
                min-width: 80px;
                text-align: right;
            }
            
            /* Chart container styles */
            .chart-container {
                position: relative;
                height: 300px;
                background: white;
                padding: 15px;
                border-radius: 8px;
            }
            
            .chart-panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                padding: 20px;
            }
            
            .chart-panel h4 {
                margin: 0 0 15px 0;
                color: #1e293b;
                font-size: 16px;
            }
        </style>
        <!-- Chart.js for visualizations -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <!-- D3.js for evolution tree visualization -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
    </head>
    <body>
        <div class="app-container">
            <!-- Left Sidebar - Prompt Management (Queue Mode) / Image Selection (Simple/Advanced Mode) -->
            <div class="left-sidebar" id="leftSidebar">
                <button class="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
                
                <!-- Enhanced Prompt Management Sidebar (Queue Mode) -->
                <div id="promptManagementSidebar" class="prompt-management-sidebar">
                    <div class="sidebar-header">
                        <h3>üîß Extraction Configuration</h3>
                        <p style="font-size: 12px; color: #64748b; margin-top: 5px;">
                            Configure extraction systems and prompts
                        </p>
                    </div>
                    
                    <!-- System Selection Section -->
                    <div class="config-group">
                        <label>System Selection</label>
                        <div class="radio-group">
                            <label><input type="radio" name="system" value="custom_consensus" checked onclick="selectSystem('custom_consensus')"> Custom Consensus</label>
                            <label><input type="radio" name="system" value="langgraph" onclick="selectSystem('langgraph')"> LangGraph</label>
                            <label><input type="radio" name="system" value="hybrid" onclick="selectSystem('hybrid')"> Hybrid</label>
                        </div>
                    </div>
                    
                    <!-- Smart Recommendations -->
                    <div class="smart-recommendations" id="smartRecommendations" style="display: none;">
                        <h4>üìä Auto-Selection Logic</h4>
                        <div class="recommendation-context">
                            Based on:
                            <ul>
                                <li>Store: <span id="recStore">-</span></li>
                                <li>Category: <span id="recCategory">-</span></li>
                                <li>History: <span id="recHistory">-</span></li>
                            </ul>
                        </div>
                        <div class="recommendation-choices">
                            Auto would select:
                            <div id="autoSelectChoices">
                                <!-- Populated dynamically -->
                            </div>
                        </div>
                        <button onclick="useAutoSelection()" class="btn btn-primary">Use Auto-Selection</button>
                        <button onclick="showCustomSelection()" class="btn btn-secondary">Customize</button>
                    </div>
                    
                    <!-- Model Configuration (shown when customizing) -->
                    <div class="config-group" id="modelConfig" style="display: none;">
                        <label>Model Override (Optional)</label>
                        <p style="font-size: 12px; color: #6b7280; margin: 5px 0 10px 0;">
                            ‚ö° The system automatically selects optimal models. Use these overrides only if you have specific requirements.
                        </p>
                        <div class="model-selectors">
                            <div class="model-row">
                                <span>Structure:</span>
                                <select id="model-structure" onchange="updatePromptOptions('structure')">
                                    <option value="">System Choice</option>
                                    <option value="claude">Force Claude</option>
                                    <option value="gpt4o">Force GPT-4o</option>
                                    <option value="gemini">Force Gemini</option>
                                </select>
                            </div>
                            <div class="model-row">
                                <span>Products:</span>
                                <select id="model-products" onchange="updatePromptOptions('products')">
                                    <option value="">System Choice</option>
                                    <option value="claude">Force Claude</option>
                                    <option value="gpt4o">Force GPT-4o</option>
                                    <option value="gemini">Force Gemini</option>
                                </select>
                            </div>
                            <div class="model-row">
                                <span>Details:</span>
                                <select id="model-details" onchange="updatePromptOptions('details')">
                                    <option value="">System Choice</option>
                                    <option value="claude">Force Claude</option>
                                    <option value="gpt4o">Force GPT-4o</option>
                                    <option value="gemini">Force Gemini</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Prompt Selection -->
                    <div class="config-group" id="promptSelection" style="display: none;">
                        <label>Prompt Selection</label>
                        
                        <!-- For each extraction type -->
                        <div class="prompt-selector-group">
                            <div class="prompt-type-header">
                                <span>Structure Analysis:</span>
                                <button onclick="createNewPrompt('structure')" class="new-prompt-btn">‚ú® New</button>
                            </div>
                            <select id="prompt-structure" onchange="showPromptPreview('structure')">
                                <option value="auto">ü§ñ Auto-select best</option>
                                <!-- Populated with prompts showing performance -->
                            </select>
                            
                            <!-- Prompt Preview Panel -->
                            <div id="preview-structure" class="prompt-preview-panel" style="display: none;">
                                <div class="preview-header">
                                    <span class="prompt-name">Loading...</span>
                                    <span class="performance-badge">No data yet</span>
                                </div>
                                <div class="preview-stats">
                                    <span>üìä No usage data</span>
                                    <span>‚è±Ô∏è Never used</span>
                                    <span>üí∞ No cost data</span>
                                </div>
                                <div class="preview-content">
                                    <pre class="prompt-snippet"><!-- First 150 chars --></pre>
                                </div>
                                <div class="preview-actions">
                                    <button onclick="viewFullPrompt('structure')">View Full</button>
                                    <button onclick="customizePrompt('structure')">Customize</button>
                                    <button onclick="viewPerformance('structure')">Performance</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="prompt-selector-group">
                            <div class="prompt-type-header">
                                <span>Product Extraction:</span>
                                <button onclick="createNewPrompt('products')" class="new-prompt-btn">‚ú® New</button>
                            </div>
                            <select id="prompt-products" onchange="showPromptPreview('products')">
                                <option value="auto">ü§ñ Auto-select best</option>
                                <!-- Populated with prompts showing performance -->
                            </select>
                            
                            <div id="preview-products" class="prompt-preview-panel" style="display: none;">
                                <!-- Similar structure as structure preview -->
                            </div>
                        </div>
                        
                        <div class="prompt-selector-group">
                            <div class="prompt-type-header">
                                <span>Detail Enhancement:</span>
                                <button onclick="createNewPrompt('details')" class="new-prompt-btn">‚ú® New</button>
                            </div>
                            <select id="prompt-details" onchange="showPromptPreview('details')">
                                <option value="auto">ü§ñ Auto-select best</option>
                                <!-- Populated with prompts showing performance -->
                            </select>
                            
                            <div id="preview-details" class="prompt-preview-panel" style="display: none;">
                                <!-- Similar structure as structure preview -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Apply Configuration -->
                    <div class="config-actions">
                        <button onclick="applyEnhancedConfigToSelected()" class="btn btn-primary">
                            Apply to Selected Items
                        </button>
                        <button onclick="saveAsDefault()" class="btn btn-secondary">
                            Save as Default
                        </button>
                    </div>
                </div>
                
                <!-- Image Selection Sidebar (Simple/Advanced Mode) -->
                <div id="imageSelectionSidebar" class="image-selection-sidebar" style="display: none;">
                <div class="sidebar-header">
                    <h3>üìÅ Image Library</h3>
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;">
                        Select an image to analyze
                    </p>
                </div>
                
                <div class="filters-section">
                    <div class="filter-group">
                        <label>Search</label>
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="Search images..." onkeyup="filterImages()">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>Store</label>
                        <select id="storeFilter" onchange="filterImages()">
                            <option value="">All Stores</option>
                            <!-- Real store data will be loaded from database -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Country</label>
                        <select id="countryFilter" onchange="filterImages()">
                            <option value="">All Countries</option>
                            <!-- Real country data will be loaded from database -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>City</label>
                        <select id="cityFilter" onchange="filterImages()">
                            <option value="">All Cities</option>
                            <!-- Real city data will be loaded from database -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Category</label>
                        <select id="categoryFilter" onchange="filterImages()">
                            <option value="">All Categories</option>
                            <!-- Real category data will be loaded from database -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="statusFilter" onchange="filterImages()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="review">Needs Review</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Date</label>
                        <input type="date" id="dateFilter" onchange="filterImages()">
                    </div>
                    
                    <div class="view-toggle">
                        <button class="active" onclick="setViewMode('grid')">Grid</button>
                        <button onclick="setViewMode('list')">List</button>
                    </div>
                </div>
                
                <div class="images-container">
                    <div id="imageGrid" class="image-grid">
                        <!-- Images will be loaded here -->
                    </div>
                </div>
                
                <div class="pagination">
                    <span id="paginationInfo">1-20 of 156 images</span>
                    <div class="pagination-controls">
                        <button onclick="previousPage()" id="prevBtn">‚Äπ</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button onclick="nextPage()" id="nextBtn">‚Ä∫</button>
                                            </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <!-- Header -->
                <div class="header">
                    <h1>ü§ñ OnShelf AI Dashboard</h1>
                    <div class="mode-selector">
                        <button class="mode-btn active" onclick="switchMode('queue')">Queue</button>
                        <button class="mode-btn" onclick="switchMode('simple')">Simple</button>
                        <button class="mode-btn" onclick="switchMode('advanced')">Advanced</button>
                        <button class="mode-btn" onclick="switchMode('intelligence')">Prompt Intelligence</button>
                    </div>
                </div>
                
                <!-- Breadcrumb -->
                <div class="breadcrumb">
                    <span id="breadcrumb">Extraction Queue</span>
                </div>
                
                <!-- Content Area -->
                <div class="content-area">
                    <!-- Queue Interface -->
                    <div id="queue-interface" class="queue-interface active">
                        <div class="queue-stats">
                            <div class="stat-card review">
                                <div class="stat-number" id="reviewCount">0</div>
                                <div class="stat-label">Needs Review</div>
                            </div>
                            <div class="stat-card processing">
                                <div class="stat-number" id="processingCount">0</div>
                                <div class="stat-label">Processing</div>
                            </div>
                            <div class="stat-card completed">
                                <div class="stat-number" id="completedCount">0</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-card failed">
                                <div class="stat-number" id="failedCount">0</div>
                                <div class="stat-label">Failed</div>
                            </div>
                            <div class="stat-card" style="border-left-color: #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%); cursor: pointer;" onclick="resetAllFailedItems()">
                                <div class="stat-number" style="font-size: 20px; color: #92400e;">üîÑ</div>
                                <div class="stat-label" style="color: #92400e; font-weight: 600;">Reset All Failed</div>
                                <div style="font-size: 11px; color: #92400e; margin-top: 5px; opacity: 0.8;">Click to reset stuck items</div>
                            </div>
                        </div>
                        
                        
                        <div id="queueGrid" class="queue-grid">
                            <!-- Enhanced queue items will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Simple Mode - 2 Panel Layout -->
                    <div id="simple-mode" class="simple-mode">
                         <div class="simple-content" style="height: 100%; overflow-y: auto; padding: 20px;">
                             <!-- Top Panels: Image (40%) and Planogram (60%) - 25% taller -->
                             <div class="top-panels" style="display: grid; grid-template-columns: 2fr 3fr; gap: 20px; margin-bottom: 15px; height: 500px;">
                        <div class="image-panel">
                                       <div class="panel-header" style="padding: 8px 20px; min-height: 20px;">
                                           <h3 style="margin: 0; font-size: 14px; font-weight: 600;">üì∑ Original Image</h3>
                            </div>
                                     <div class="panel-content" style="height: 100%;">
                                         <div class="image-viewer" style="height: 100%;">
                                    <img id="originalImage" src="" alt="Original shelf image" style="display: none;">
                                    <div id="imageLoading" class="loading">Loading image...</div>
                                    <div class="image-controls">
                                        <button class="control-btn" onclick="zoomImage(0.5)">50%</button>
                                        <button class="control-btn" onclick="zoomImage(1.0)">100%</button>
                                        <button class="control-btn" onclick="zoomImage(2.0)">200%</button>
                                        <button class="control-btn" onclick="toggleOverlays()">Overlays</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="planogram-panel">
                                       <div class="panel-header" style="padding: 8px 20px; min-height: 20px;">
                                           <h3 style="margin: 0; font-size: 14px; font-weight: 600;">üìä Generated Planogram</h3>
                            </div>
                                     <div class="panel-content" style="height: 100%;">
                                         <div id="planogramViewer" style="height: 100%; overflow: auto;">
                                    <div class="loading">Loading planogram...</div>
                                         </div>
                                     </div>
                                 </div>
                                </div>
                                
                             <!-- Dashboard and Controls Row - Half height, compact -->
                             <div class="dashboard-controls-row" style="display: grid; grid-template-columns: 2fr 3fr; gap: 20px; margin-bottom: 20px; height: 40px;">
                                 <!-- Compact Stats Dashboard -->
                                 <div id="compactStatsDashboard" class="compact-stats-dashboard" style="width: 100%; height: 100%;">
                                     <!-- Stats will be populated by JavaScript -->
                                 </div>
                                 
                                 <!-- Display Controls - Compact and Close to Planogram -->
                                 <div id="planogramControls" class="planogram-controls" style="width: 100%; height: 100%;">
                                     <!-- Controls will be populated by JavaScript -->
                                 </div>
                             </div>
                             
                             <!-- Tabs for Products and Feedback -->
                             <div class="simple-tabs" style="margin-bottom: 20px;">
                                 <button class="simple-tab active" onclick="switchSimpleTab('products')">üì¶ Products</button>
                                 <button class="simple-tab" onclick="switchSimpleTab('feedback')">üí¨ Feedback</button>
                             </div>
                             
                             <!-- Products Tab Content -->
                             <div id="products-tab" class="simple-tab-content active">
                                 <!-- Full Width Products Table -->
                                 <div id="extractedProductsTable" class="extracted-products-table" style="width: 100%; margin-bottom: 20px;">
                                     <!-- Table will be populated by JavaScript -->
                                 </div>
                             </div>
                             
                             <!-- Feedback Tab Content -->
                             <div id="feedback-tab" class="simple-tab-content" style="display: none;">
                                 <!-- Rating System -->
                                 <div class="rating-system">
                                    <h4>‚≠ê Extraction Quality</h4>
                                    <div class="star-rating" data-rating="extraction">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    
                                    <div class="feedback-area">
                                        <label>What worked well:</label>
                                        <textarea id="workedWell" placeholder="Describe what the AI did correctly..."></textarea>
                                    </div>
                                    
                                    <h4 style="margin-top: 20px;">‚≠ê Planogram Quality</h4>
                                    <div class="star-rating" data-rating="planogram">
                                        <span class="star" data-value="1">‚òÖ</span>
                                        <span class="star" data-value="2">‚òÖ</span>
                                        <span class="star" data-value="3">‚òÖ</span>
                                        <span class="star" data-value="4">‚òÖ</span>
                                        <span class="star" data-value="5">‚òÖ</span>
                                    </div>
                                    
                                    <div class="feedback-area">
                                        <label>Needs improvement:</label>
                                        <textarea id="needsImprovement" placeholder="Describe what needs to be fixed..."></textarea>
                                    </div>
                                    
                                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                                        <button class="btn btn-primary" onclick="submitFeedback()">üíæ Submit Feedback</button>
                                        <button class="btn btn-secondary" onclick="resetFeedback()">üîÑ Reset</button>
                                    </div>
                                    
                                    <div id="feedbackStatus" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
                                </div>
                            </div>
                            
                            <!-- Mode switching buttons -->
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-secondary" onclick="switchMode('advanced')">Advanced Mode</button>
                                <button class="btn btn-secondary" onclick="switchMode('queue')">Back to Queue</button>
                            </div>
                        </div>
                    </div>
                    
                    
                    
                    <!-- Advanced Mode - Technical Deep Dive with Tabs -->
                    <div id="advanced-mode" class="advanced-mode">
                        <!-- Advanced Mode Tabs -->
                        <div class="advanced-tabs">
                            <button class="advanced-tab active" onclick="switchAdvancedTab('overview')">üìä Overview</button>
                            <button class="advanced-tab" onclick="switchAdvancedTab('logs')">üìã Logs</button>
                            <button class="advanced-tab" onclick="switchAdvancedTab('debugger')">üîç Pipeline Debugger</button>
                             <button class="advanced-tab" onclick="switchAdvancedTab('iterations')">üîÑ Iterations</button>
                             <button class="advanced-tab" onclick="switchAdvancedTab('comparison')">‚öñÔ∏è System Comparison</button>
                            <button class="advanced-tab" onclick="switchAdvancedTab('orchestrator')">‚öôÔ∏è Orchestrator</button>
                        </div>
                        
                        <!-- Overview Tab - 4 Panel Grid -->
                        <div id="advanced-overview" class="advanced-tab-content active">
                            <div class="advanced-grid">
                                <!-- Original Image Panel -->
                                <div class="advanced-panel">
                                    <div class="panel-header">
                                        <h3>üì∑ Original Image Analysis</h3>
                                    </div>
                                    <div class="panel-content">
                                        <div class="image-viewer">
                                            <img id="advancedOriginalImage" src="" alt="Original image">
                                            <div class="image-controls">
                                                <button class="control-btn" onclick="zoomImage(0.5)">50%</button>
                                                <button class="control-btn" onclick="zoomImage(1.0)">100%</button>
                                                <button class="control-btn" onclick="zoomImage(2.0)">200%</button>
                                                <button class="control-btn" onclick="toggleOverlays()">Overlays</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Agent Deep Dive Panel -->
                                <div class="advanced-panel">
                                    <div class="panel-header">
                                        <h3>üîç Agent Deep Dive</h3>
                                    </div>
                                    <div class="technical-analysis">
                                        <div class="analysis-section">
                                            <h4>Model Performance</h4>
                                            <div class="analysis-data" id="modelPerformance">
                                                Loading performance data...
                                            </div>
                                        </div>
                                        
                                        <div class="analysis-section">
                                            <h4>Confidence Scores</h4>
                                            <div class="analysis-data" id="confidenceScores">
                                                Loading confidence data...
                                            </div>
                                        </div>
                                        
                                        <div class="analysis-section">
                                            <h4>Error Analysis</h4>
                                            <div class="analysis-data" id="errorAnalysis">
                                                Loading error analysis...
                                            </div>
                                        </div>
                        
                        <div class="analysis-section" style="background: #eff6ff; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                            <h4>üí° Demo Available</h4>
                            <div style="font-size: 14px; color: #1e40af;">
                                <p>To see the planogram demonstration:</p>
                                <ol style="margin: 10px 0; padding-left: 20px;">
                                    <li>Click the <strong>"üîÑ Iterations"</strong> tab above</li>
                                    <li>Select <strong>"üìä Demo: Interactive Planogram"</strong> from the dropdown</li>
                                    <li>View JSON data structure + static SVG representation</li>
                                    <li>See 18 products with stacking, gaps, and confidence colors</li>
                                </ol>
                                <p><em>The Interactive React component is available in Simple Mode when you select an image.</em></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Planogram Analysis Panel -->
                                <div class="advanced-panel">
                                    <div class="panel-header">
                                        <h3>üìä Planogram Analysis</h3>
                                    </div>
                                    <div class="panel-content">
                                        <div id="advancedPlanogramViewer" class="image-viewer">
                                            <div class="loading">Loading planogram...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Error Summary Panel -->
                                <div class="advanced-panel">
                                    <div class="panel-header">
                                        <h3>‚ö†Ô∏è Error Summary</h3>
                                    </div>
                                    <div class="error-summary-panel">
                                        <div id="errorSummary" class="error-summary">
                                            <!-- Error summary will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Logs Tab -->
                        <div id="advanced-logs" class="advanced-tab-content">
                            <div class="logs-container">
                                <!-- Log Controls -->
                                <div class="log-controls">
                                    <div class="log-filters">
                                        <select id="logLevelFilter" onchange="filterLogs()">
                                            <option value="">All Levels</option>
                                            <option value="ERROR">ERROR</option>
                                            <option value="WARNING">WARNING</option>
                                            <option value="INFO">INFO</option>
                                            <option value="DEBUG">DEBUG</option>
                                        </select>
                                        
                                        <select id="logComponentFilter" onchange="filterLogs()">
                                            <option value="">All Components</option>
                                            <option value="extraction_engine">Extraction Engine</option>
                                            <option value="agent">Agent</option>
                                            <option value="abstraction_manager">Abstraction Manager</option>
                                            <option value="queue_processor">Queue Processor</option>
                                            <option value="cost_tracker">Cost Tracker</option>
                                        </select>
                                        
                                        <input type="text" id="logSearchInput" placeholder="Search logs..." onkeyup="filterLogs()">
                                        
                                        <select id="logTimeRange" onchange="filterLogs()">
                                            <option value="1">Last 1 hour</option>
                                            <option value="6">Last 6 hours</option>
                                            <option value="24" selected>Last 24 hours</option>
                                            <option value="168">Last 7 days</option>
                                        </select>
                                    </div>
                                    
                                    <div class="log-actions">
                                        <button class="btn btn-secondary" onclick="toggleAutoScroll()">
                                            <span id="autoScrollText">‚è∏Ô∏è Pause Auto-scroll</span>
                                        </button>
                                        <button class="btn btn-secondary" onclick="exportLogs()">üì• Export</button>
                                        <button class="btn btn-secondary" onclick="clearLogView()">üóëÔ∏è Clear</button>
                                        <button class="btn btn-primary" onclick="refreshLogs()">üîÑ Refresh</button>
                                    </div>
                                </div>
                                
                                <!-- Log Viewer -->
                                <div class="log-viewer" id="logViewer">
                                    <div class="log-loading">Loading logs...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pipeline Debugger Tab -->
                        <div id="advanced-debugger" class="advanced-tab-content">
                            <div class="debugger-container">
                                <h3>üîç Real-Time Pipeline Debugger</h3>
                                
                                <!-- Debug Session Controls -->
                                <div class="debug-controls" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Upload ID:</label>
                                            <input type="text" id="debugUploadId" placeholder="Enter upload ID to monitor" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                                        </div>
                                        <div style="align-self: end;">
                                            <button id="startDebugBtn" onclick="startDebugSession()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer;">üîç Monitor Extraction</button>
                                        </div>
                                    </div>
                                    
                                    <div style="background: #f8fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #64748b; margin-bottom: 15px;">
                                        <p style="margin: 0; font-size: 14px; color: #475569;">
                                            <strong>Real-Time Monitoring:</strong> This interface shows the ACTUAL Master Orchestrator iteration cycle. Each iteration generates a NEW planogram until target accuracy is achieved.
                                        </p>
                                        <p style="margin: 8px 0 0 0; font-size: 13px; color: #64748b;">
                                            üîÑ <strong>Multiple Planograms:</strong> Iteration 1 ‚Üí Planogram A ‚Üí Compare ‚Üí 75% accuracy ‚Üí Iteration 2 ‚Üí Planogram B ‚Üí Compare ‚Üí 88% accuracy ‚Üí Continue until 95%+ achieved
                                        </p>
                                    </div>
                                    
                                    <div id="debugSessionInfo" style="display: none; background: #f0f9ff; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <strong>Monitoring Session:</strong> <span id="debugSessionId">-</span><br>
                                                <strong>Status:</strong> <span id="debugStatus">-</span><br>
                                                <strong>Current Stage:</strong> <span id="debugCurrentStage">-</span>
                                            </div>
                                            <button onclick="stopDebugSession()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Stop Monitoring</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Real-Time Pipeline Status -->
                                <div id="pipelineStatus" class="pipeline-status" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h4 style="margin: 0; color: #1f2937;">üìä System Workflow Status</h4>
                                                                            <div style="display: flex; gap: 10px; align-items: center;">
                                        <div style="background: #f0f9ff; padding: 6px 12px; border-radius: 6px; border: 1px solid #3b82f6;">
                                            <span style="font-size: 12px; font-weight: 600; color: #1e40af;">Monitoring System: </span>
                                            <span id="currentSystem" style="font-size: 12px; font-weight: 700; color: #1e40af;">Custom Consensus</span>
                                        </div>
                                        <div style="background: #fef3c7; padding: 6px 12px; border-radius: 6px; border: 1px solid #f59e0b;">
                                            <span style="font-size: 11px; color: #92400e;">‚ö†Ô∏è System selected before extraction starts</span>
                                        </div>
                                    </div>
                                    </div>
                                    
                                                        <!-- Master Orchestrator Iteration Cycle Progress -->
                    <div class="iteration-cycle-progress" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600;">Master Orchestrator Iteration Cycle:</span>
                            <span id="iterationProgressText">Ready to monitor extraction</span>
                        </div>
                        
                        <!-- Current Iteration Display -->
                        <div id="currentIterationDisplay" style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>Current Iteration:</strong> <span id="currentIterationNumber">-</span> / <span id="maxIterations">5</span>
                                    <br><strong>Target Accuracy:</strong> <span id="targetAccuracy">95%</span>
                                    <br><strong>Current Accuracy:</strong> <span id="currentAccuracy">-</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: #3b82f6;" id="iterationStatus">‚è≥</div>
                                    <div style="font-size: 12px; color: #64748b;" id="iterationStatusText">Waiting</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Real Master Orchestrator Steps -->
                        <div id="masterOrchestratorSteps" style="display: flex; flex-direction: column; gap: 8px;">
                            <!-- Steps will be populated based on actual Master Orchestrator flow -->
                        </div>
                    </div>
                                    
                                    <!-- Orchestrator Info -->
                                    <div class="orchestrator-info" style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                            <div>
                                                <div style="font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Orchestrator</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="orchestratorType">DeterministicOrchestrator</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Voting Mechanism</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="votingMechanism">weighted_consensus</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Active Models</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="activeModels">3</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase;">Total Cost</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="totalCost">¬£0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Real-Time Model Comparison -->
                                <div id="modelComparison" class="model-comparison" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
                                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">ü§ñ Live Consensus Voting</h4>
                                    
                                    <!-- Current Stage Breakdown -->
                                    <div id="currentStageBreakdown" style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                                        <h5 style="margin: 0 0 10px 0; color: #374151;">Current Stage: <span id="currentStageTitle">Structure Analysis</span></h5>
                                        <div id="stageModelResults" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                            <!-- Model results will be populated here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Consensus Voting Results -->
                                    <div id="consensusResults" style="background: #f0f9ff; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                        <h5 style="margin: 0 0 10px 0; color: #1e40af;">Consensus Decision</h5>
                                        <div id="consensusDecision" style="font-size: 14px; color: #1e40af;">
                                            Waiting for consensus voting...
                                        </div>
                                    </div>
                                    
                                    <!-- Cost Breakdown by Model -->
                                    <div id="costBreakdown" style="margin-top: 15px;">
                                        <h5 style="margin: 0 0 10px 0; color: #374151;">Cost Breakdown</h5>
                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                                            <div style="background: #fef3c7; padding: 10px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 12px; color: #92400e;">Claude-3.5-Sonnet</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #92400e;" id="claudeCost">¬£0.00</div>
                                            </div>
                                            <div style="background: #dbeafe; padding: 10px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 12px; color: #1e40af;">GPT-4o</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #1e40af;" id="gpt4oCost">¬£0.00</div>
                                            </div>
                                            <div style="background: #d1fae5; padding: 10px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 12px; color: #065f46;">Gemini-2.0-Flash</div>
                                                <div style="font-size: 16px; font-weight: 700; color: #065f46;" id="geminiCost">¬£0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Live Prompt Monitoring -->
                                <div id="livePromptMonitoring" class="live-prompt-monitoring" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
                                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">ü§ñ Live Prompt Monitoring</h4>
                                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                                        <div style="margin-bottom: 15px; font-size: 14px; color: #475569;">
                                            <strong>Real-time view of prompts being used by each AI model during extraction</strong>
                                        </div>
                                        <div id="promptContainer" style="display: flex; flex-direction: column; gap: 15px; max-height: 500px; overflow-y: auto;">
                                            <div style="color: #94a3b8; text-align: center; padding: 20px;">Waiting for extraction to start...</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Real-Time Logs -->
                                <div id="realTimeLogs" class="real-time-logs" style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
                                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìã Real-Time Extraction Logs</h4>
                                    <div style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; max-height: 400px; overflow-y: auto;" id="logContainer">
                                        <div style="color: #94a3b8;">Waiting for debug session to start...</div>
                                    </div>
                                </div>
                                
                                <!-- Active Sessions -->
                                <div class="active-sessions" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <h4 style="margin: 0 0 15px 0; color: #1f2937;">üîÑ Active Debug Sessions</h4>
                                    <div id="activeSessionsList">
                                        <div style="color: #6b7280; text-align: center; padding: 20px;">No active debug sessions</div>
                                    </div>
                                    <button onclick="loadActiveSessions()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 10px;">üîÑ Refresh Sessions</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Iterations Tab -->
                        <div id="advanced-iterations" class="advanced-tab-content">
                            <div class="iterations-container">
                                <h3>üîÑ Iteration Analysis</h3>
                                
                                <!-- Iteration Selector -->
                                <div class="iteration-selector">
                                    <label>Select Iteration:</label>
                                    <select id="iterationSelect" onchange="loadIterationDetails()">
                                        <option value="">Loading iterations...</option>
                                    </select>
                                    <span id="iterationStats" style="margin-left: 20px;"></span>
                                </div>
                                
                                <!-- Iteration Content Grid -->
                                <div class="iteration-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                                    <!-- Raw JSON Panel -->
                                    <div class="iteration-panel">
                                        <div class="panel-header">
                                            <h4>üìã Raw Extraction Data (JSON)</h4>
                                            <button onclick="copyJSON()" style="float: right;">üìã Copy</button>
                                        </div>
                                        <div class="json-viewer" id="iterationJSON" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; overflow: auto; max-height: 600px;">
                                            <div class="loading">Select an iteration to view data...</div>
                                        </div>
                                    </div>
                                    
                                    <!-- Planogram Panel -->
                                    <div class="iteration-panel">
                                        <div class="panel-header">
                                            <h4>üìä Planogram Visualization</h4>
                                            <span id="planogramAccuracy" style="float: right;"></span>
                                        </div>
                                        <div class="planogram-viewer" id="iterationPlanogram" style="background: #f8f9fa; padding: 15px; border-radius: 5px; overflow: auto; max-height: 600px;">
                                            <div class="loading">Select an iteration to view planogram...</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Shelf-by-Shelf Breakdown -->
                                <div class="shelf-breakdown" style="margin-top: 20px;">
                                    <h4>üì¶ Shelf-by-Shelf Product Breakdown</h4>
                                    <div id="shelfBreakdown" style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                        <div class="loading">Select an iteration to view shelf breakdown...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                                                 <!-- System Comparison Tab -->
                         <div id="advanced-comparison" class="advanced-tab-content">
                             <div class="comparison-container">
                                 <div class="agent-tabs">
                                     <button class="agent-tab active" onclick="switchAgent('agent1')">Agent 1: Custom Consensus</button>
                                     <button class="agent-tab" onclick="switchAgent('agent2')">Agent 2: LangGraph</button>
                                     <button class="agent-tab" onclick="switchAgent('agent3')">Agent 3: Hybrid</button>
                                 </div>
                                 
                                 <div id="agent1" class="agent-content">
                                     <div class="agent-metrics">
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent1Accuracy">--</div>
                                             <div class="metric-label">Accuracy</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent1Speed">--</div>
                                             <div class="metric-label">Processing Time</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent1Cost">--</div>
                                             <div class="metric-label">API Cost</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent1Products">--</div>
                                             <div class="metric-label">Products Found</div>
                                         </div>
                                     </div>
                                     
                                     <div class="extraction-results">
                                         <h4>Extraction Results</h4>
                                         <div id="agent1Results" class="results-grid">
                                             <!-- Results will be loaded here -->
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div id="agent2" class="agent-content" style="display: none;">
                                     <div class="agent-metrics">
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent2Accuracy">--</div>
                                             <div class="metric-label">Accuracy</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent2Speed">--</div>
                                             <div class="metric-label">Processing Time</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent2Cost">--</div>
                                             <div class="metric-label">API Cost</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent2Products">--</div>
                                             <div class="metric-label">Products Found</div>
                                         </div>
                                     </div>
                                     
                                     <div class="extraction-results">
                                         <h4>Extraction Results</h4>
                                         <div id="agent2Results" class="results-grid">
                                             <!-- Results will be loaded here -->
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div id="agent3" class="agent-content" style="display: none;">
                                     <div class="agent-metrics">
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent3Accuracy">--</div>
                                             <div class="metric-label">Accuracy</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent3Speed">--</div>
                                             <div class="metric-label">Processing Time</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent3Cost">--</div>
                                             <div class="metric-label">API Cost</div>
                                         </div>
                                         <div class="metric-card">
                                             <div class="metric-value" id="agent3Products">--</div>
                                             <div class="metric-label">Products Found</div>
                                         </div>
                                     </div>
                                     
                                     <div class="extraction-results">
                                         <h4>Extraction Results</h4>
                                         <div id="agent3Results" class="results-grid">
                                             <!-- Results will be loaded here -->
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                        
                        <!-- Orchestrator Tab -->
                        <div id="advanced-orchestrator" class="advanced-tab-content">
                            <div class="orchestrator-container">
                                <div class="orchestrator-flow" id="orchestratorFlow">
                                    <!-- Flow steps will be loaded here -->
                                </div>
                            </div>
                        </div>
                        

                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Prompt Intelligence Interface -->
            <div id="intelligence-interface" class="intelligence-interface">
                <div class="intelligence-container">
                    <div class="intelligence-header">
                        <h2>üß† Prompt Intelligence Dashboard</h2>
                        <p>Meta-learning analysis of prompt performance across all extractions</p>
                    </div>
                    
                    <!-- Intelligence Tabs -->
                    <div class="intelligence-tabs">
                        <button class="intelligence-tab active" onclick="switchIntelligenceTab('overview')">üìä Overview</button>
                        <button class="intelligence-tab" onclick="switchIntelligenceTab('performance')">üìà Performance</button>
                        <button class="intelligence-tab" onclick="switchIntelligenceTab('patterns')">üîç Patterns</button>
                        <button class="intelligence-tab" onclick="switchIntelligenceTab('recommendations')">üí° Recommendations</button>
                        <button class="intelligence-tab" onclick="switchIntelligenceTab('evolution')">üß¨ Evolution</button>
                    </div>
                    
                    <!-- Overview Tab -->
                    <div id="intelligence-overview" class="intelligence-tab-content active">
                        <div class="intelligence-grid">
                            <!-- Key Metrics Panel -->
                            <div class="intelligence-panel">
                                <div class="panel-header">
                                    <h3>üìä Key Metrics</h3>
                                </div>
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-value" id="totalExtractions">-</div>
                                        <div class="metric-label">Total Extractions</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="avgAccuracy">-</div>
                                        <div class="metric-label">Avg Accuracy</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="bestPrompt">-</div>
                                        <div class="metric-label">Best Prompt</div>
                                    </div>
                                    <div class="metric-card">
                                        <div class="metric-value" id="totalCostSaved">-</div>
                                        <div class="metric-label">Cost Saved</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- System Performance Panel -->
                            <div class="intelligence-panel">
                                <div class="panel-header">
                                    <h3>üéØ System Performance</h3>
                                </div>
                                <div class="system-performance" id="systemPerformance">
                                    Loading system performance data...
                                </div>
                            </div>
                            
                            <!-- Recent Insights Panel -->
                            <div class="intelligence-panel">
                                <div class="panel-header">
                                    <h3>üí° Recent Insights</h3>
                                </div>
                                <div class="insights-list" id="recentInsights">
                                    Loading recent insights...
                                </div>
                            </div>
                            
                            <!-- Quick Actions Panel -->
                            <div class="intelligence-panel">
                                <div class="panel-header">
                                    <h3>‚ö° Quick Actions</h3>
                                </div>
                                <div class="quick-actions">
                                    <button class="btn btn-primary" onclick="openPromptLibrary()">üìö Browse Prompt Library</button>
                                    <button class="btn btn-primary" onclick="generateRecommendations()">üîÆ Generate Recommendations</button>
                                    <button class="btn btn-secondary" onclick="exportIntelligence()">üì• Export Report</button>
                                    <button class="btn btn-warning" onclick="optimizePrompts()">üöÄ Optimize Prompts</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Tab -->
                    <div id="intelligence-performance" class="intelligence-tab-content">
                        <div class="performance-container">
                            <h3>üìà Performance Analysis</h3>
                            
                            <!-- Performance Charts -->
                            <div class="charts-grid">
                                <div class="chart-panel">
                                    <h4>Accuracy Over Time</h4>
                                    <div id="accuracyChart" class="chart-container">
                                        Chart will be rendered here
                                    </div>
                                </div>
                                
                                <div class="chart-panel">
                                    <h4>Cost vs Accuracy</h4>
                                    <div id="costAccuracyChart" class="chart-container">
                                        Chart will be rendered here
                                    </div>
                                </div>
                                
                                <div class="chart-panel">
                                    <h4>System Comparison</h4>
                                    <div id="systemComparisonChart" class="chart-container">
                                        Chart will be rendered here
                                    </div>
                                </div>
                                
                                <div class="chart-panel">
                                    <h4>Prompt Performance</h4>
                                    <div id="promptPerformanceChart" class="chart-container">
                                        Chart will be rendered here
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patterns Tab -->
                    <div id="intelligence-patterns" class="intelligence-tab-content">
                        <div class="patterns-container">
                            <h3>üîç Pattern Analysis</h3>
                            
                            <!-- Pattern Discovery -->
                            <div class="patterns-grid">
                                <div class="pattern-panel">
                                    <h4>üè™ Store Patterns</h4>
                                    <div id="storePatterns" class="pattern-content">
                                        Loading store patterns...
                                    </div>
                                </div>
                                
                                <div class="pattern-panel">
                                    <h4>üì¶ Category Patterns</h4>
                                    <div id="categoryPatterns" class="pattern-content">
                                        Loading category patterns...
                                    </div>
                                </div>
                                
                                <div class="pattern-panel">
                                    <h4>ü§ñ Model Patterns</h4>
                                    <div id="modelPatterns" class="pattern-content">
                                        Loading model patterns...
                                    </div>
                                </div>
                                
                                <div class="pattern-panel">
                                    <h4>‚è∞ Temporal Patterns</h4>
                                    <div id="temporalPatterns" class="pattern-content">
                                        Loading temporal patterns...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations Tab -->
                    <div id="intelligence-recommendations" class="intelligence-tab-content">
                        <div class="recommendations-container">
                            <h3>üí° AI Recommendations</h3>
                            
                            <!-- Recommendation Categories -->
                            <div class="recommendations-grid">
                                <div class="recommendation-panel">
                                    <h4>üéØ Prompt Optimization</h4>
                                    <div id="promptRecommendations" class="recommendation-content">
                                        Loading prompt recommendations...
                                    </div>
                                </div>
                                
                                <div class="recommendation-panel">
                                    <h4>‚öôÔ∏è System Configuration</h4>
                                    <div id="systemRecommendations" class="recommendation-content">
                                        Loading system recommendations...
                                    </div>
                                </div>
                                
                                <div class="recommendation-panel">
                                    <h4>üí∞ Cost Optimization</h4>
                                    <div id="costRecommendations" class="recommendation-content">
                                        Loading cost recommendations...
                                    </div>
                                </div>
                                
                                <div class="recommendation-panel">
                                    <h4>üöÄ Performance Improvements</h4>
                                    <div id="performanceRecommendations" class="recommendation-content">
                                        Loading performance recommendations...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Evolution Tab -->
                    <div id="intelligence-evolution" class="intelligence-tab-content">
                        <div class="evolution-container">
                            <h3>üß¨ Prompt Evolution</h3>
                            
                            <!-- Evolution Timeline -->
                            <div class="evolution-timeline" id="evolutionTimeline">
                                Loading evolution timeline...
                            </div>
                            
                            <!-- Evolution Analysis -->
                            <div class="evolution-analysis">
                                <div class="evolution-panel">
                                    <h4>üìà Performance Trends</h4>
                                    <div id="performanceTrends" class="evolution-content">
                                        Loading performance trends...
                                    </div>
                                </div>
                                
                                <div class="evolution-panel">
                                    <h4>üîÑ Adaptation History</h4>
                                    <div id="adaptationHistory" class="evolution-content">
                                        Loading adaptation history...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - Additional Prompt Management -->
            <div class="right-sidebar" id="rightSidebar">
                <button class="sidebar-toggle" onclick="toggleRightSidebar()">‚óÄ</button>
                <div class="sidebar-header">
                    <h3>‚öôÔ∏è Advanced Settings</h3>
                    <p style="font-size: 12px; color: #64748b; margin-top: 5px;">
                        Additional configuration options
                    </p>
                </div>
                
                <!-- Batch Operations Section -->
                <div class="prompt-section">
                    <h4>üîÑ Batch Operations</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-primary" onclick="applyConfigToSelected()" style="padding: 8px 12px; font-size: 12px;">
                            Apply to Selected
                        </button>
                        <button class="btn btn-secondary" onclick="resetSelectedItems()" style="padding: 8px 12px; font-size: 12px;">
                            Reset Selected
                        </button>
                    </div>
                </div>
                
                <!-- System Status Section -->
                <div class="prompt-section">
                    <h4>üìä System Status</h4>
                    <div style="font-size: 12px; color: #64748b;">
                        <div style="margin-bottom: 8px;">
                            <strong>Queue Items:</strong> <span id="totalQueueItems">-</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Selected:</strong> <span id="selectedQueueItems">0</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Active System:</strong> <span id="activeSystem">Custom Consensus</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Section -->
                <div class="prompt-section">
                    <h4>‚ö° Quick Actions</h4>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <button class="btn btn-warning" onclick="resetAllFailedItems()" style="padding: 6px 10px; font-size: 11px;">
                            üîÑ Reset All Failed
                        </button>
                        <button class="btn btn-success" onclick="loadQueue()" style="padding: 6px 10px; font-size: 11px;">
                            üîÑ Refresh Queue
                        </button>
                    </div>
                </div>
            </div>
        
        <!-- Process With Modal -->
        <div id="processWithModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;" onclick="closeProcessWithModal()">
            <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                <h3 style="margin: 0 0 20px 0; color: #1f2937; font-size: 20px; font-weight: 700;" id="processModalTitle">üöÄ Process with AI System</h3>
                
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">Select AI Extraction System:</label>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label class="system-option" style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectSystem('custom_consensus', this)">
                            <input type="radio" name="aiSystem" value="custom_consensus" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">Custom Consensus System</div>
                                <div style="font-size: 13px; color: #6b7280;">3 AI models vote in parallel (GPT-4o, Claude-3.5-Sonnet, Gemini-2.0-Flash)</div>
                                <div style="font-size: 12px; color: #3b82f6; margin-top: 4px;">‚ö° Best for accuracy ‚Ä¢ üéØ Weighted consensus ‚Ä¢ üí∞ Moderate cost</div>
        </div>
                        </label>
                        
                        <label class="system-option" style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectSystem('langgraph', this)">
                            <input type="radio" name="aiSystem" value="langgraph" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">LangGraph Workflow System</div>
                                <div style="font-size: 13px; color: #6b7280;">Sequential workflow with state management and smart retry logic</div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">üîÑ Self-correcting ‚Ä¢ üìä State tracking ‚Ä¢ üí° Efficient</div>
                            </div>
                        </label>
                        
                        <label class="system-option" style="display: flex; align-items: center; gap: 12px; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;" onclick="selectSystem('hybrid', this)">
                            <input type="radio" name="aiSystem" value="hybrid" style="width: 18px; height: 18px;">
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">Hybrid Adaptive System</div>
                                <div style="font-size: 13px; color: #6b7280;">Dynamically selects best approach based on image complexity</div>
                                <div style="font-size: 12px; color: #f59e0b; margin-top: 4px;">üß† Adaptive ‚Ä¢ üéØ Context-aware ‚Ä¢ üöÄ Optimized</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #3b82f6;">
                    <div style="font-size: 14px; color: #1e40af; font-weight: 600; margin-bottom: 5px;">üí° How it works:</div>
                    <div style="font-size: 13px; color: #475569; line-height: 1.5; margin-bottom: 10px;">
                        The Master Orchestrator will run multiple iterations until 95% accuracy is achieved. Each iteration generates a new planogram and compares it to the original image.
                    </div>
                    <div style="font-size: 12px; color: #64748b; border-top: 1px solid #e2e8f0; padding-top: 8px;">
                        <strong>Keyboard shortcuts:</strong> Press 1-3 to select system ‚Ä¢ Enter to start ‚Ä¢ Escape to cancel
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeProcessWithModal()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s ease;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">Cancel</button>
                    <button id="processWithBtn" onclick="processWithSelectedSystem()" style="padding: 10px 20px; background: #9ca3af; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-weight: 600; transition: all 0.2s ease; opacity: 0.6;" disabled onmouseover="if(!this.disabled) this.style.background='#2563eb'" onmouseout="if(!this.disabled) this.style.background='#3b82f6'">üöÄ Start Processing</button>
                </div>
            </div>
        </div>
        
        <!-- Initialize React Components -->
        <script>
            // CRITICAL: Define essential functions FIRST (before any other code)
            window.testJS = function() {
                alert('JavaScript is working!');
                console.log('‚úÖ JavaScript test successful');
            };
            
            window.switchMode = function(mode) {
                console.log('üîÑ SwitchMode called:', mode);
                alert('SwitchMode called with: ' + mode);
                
                try {
                    // Hide all modes
                    const modes = ['queue-interface', 'simple-mode', 'advanced-mode', 'intelligence-interface'];
                    modes.forEach(modeId => {
                        const element = document.getElementById(modeId);
                        if (element) element.classList.remove('active');
                    });
                    
                    // Show selected mode
                    const targetMode = document.getElementById(mode + '-interface') || document.getElementById(mode + '-mode');
                    if (targetMode) {
                        targetMode.classList.add('active');
                        console.log('‚úÖ Switched to mode:', mode);
                    } else {
                        console.error('‚ùå Mode not found:', mode);
                    }
                    
                    // Update button states
                    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                    const targetButton = document.querySelector(`[onclick*="'${mode}'"]`);
                    if (targetButton) targetButton.classList.add('active');
                    
                } catch (error) {
                    console.error('‚ùå Error in switchMode:', error);
                    alert('Error switching mode: ' + error.message);
                }
            };
            
            console.log('‚úÖ Essential functions defined');
            
            // React libraries loaded - ready for component loading when needed
            console.log('‚úÖ React libraries available:', typeof React !== 'undefined', typeof ReactDOM !== 'undefined');
            
            // Component loading is now handled on-demand when switching to Advanced mode
        </script>
        
        <script>
            // Global state
            let currentMode = 'queue';
            let performanceCharts = {}; // Store Chart.js instances
            let evolutionTreeData = null; // Store D3.js tree data
            let selectedItemId = null;
            let queueData = [];
            let imageData = [];
            let filteredImages = [];
            let currentPage = 1;
            let itemsPerPage = 20;
            let viewMode = 'grid';
            let sidebarCollapsed = false;
            let zoomLevel = 1.0;
            let overlaysVisible = false;
            let currentAgent = 'agent1';
            let currentAdvancedTab = 'overview';
            let autoScrollEnabled = true;
            let logRefreshInterval = null;
            
            // Global planogram component reference
            let currentPlanogramComponent = null;
            
            // Functions already defined at top of script
            
            // Initialize application
            document.addEventListener('DOMContentLoaded', async function() {
                console.log('üöÄ Initializing OnShelf Dashboard...');
                
                try {
                    // Initialize sidebar state - start in queue mode with sidebar visible
                    const sidebar = document.getElementById('leftSidebar');
                    const toggle = sidebar ? sidebar.querySelector('.sidebar-toggle') : null;
                     
                    if (sidebar) {
                        // Start in queue mode with sidebar visible for prompt management
                        sidebar.style.display = 'flex';
                        sidebarCollapsed = false;
                        if (toggle) toggle.innerHTML = '‚óÄ';
                        
                        // Show prompt management sidebar by default
                        const promptSidebar = document.getElementById('promptManagementSidebar');
                        const imageSidebar = document.getElementById('imageSelectionSidebar');
                        if (promptSidebar) promptSidebar.style.display = 'block';
                        if (imageSidebar) imageSidebar.style.display = 'none';
                    }
                
                    // Load data
                    try {
                        await loadQueue();
                        await loadImages();
                        await loadFilterData();
                    } catch (error) {
                        console.error('‚ùå Failed to load initial data:', error);
                    }
                    
                    // Initialize prompt management
                    try {
                        await initializePromptManagement();
                        window.promptManagementInitialized = true;
                    } catch (error) {
                        console.error('‚ùå Failed to initialize prompt management:', error);
                        window.promptManagementInitialized = false;
                    }
                    
                    // Initialize enhanced extraction settings
                    try {
                        await initializeEnhancedExtractionSettings();
                    } catch (error) {
                        console.error('‚ùå Failed to initialize enhanced extraction settings:', error);
                    }
                    
                    // Initialize queue item selection monitoring for smart recommendations
                    try {
                        initializeQueueSelectionMonitoring();
                    } catch (error) {
                        console.error('‚ùå Failed to initialize queue selection monitoring:', error);
                    }
                    
                    // Initialize React components only if needed
                    // Don't load InteractivePlanogram on initial load - load it when switching to advanced mode
                    
                    // Initialize additional features
                    initializeAdditionalFeatures();
                    
                    console.log('‚úÖ OnShelf Dashboard initialized successfully');
                     
                    // Auto-refresh queue every 30 seconds
                    setInterval(() => {
                        loadQueue();
                        loadImages();
                    }, 30000);
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize dashboard:', error);
                }
            });
            
            // Sidebar management
            function toggleSidebar() {
                const sidebar = document.getElementById('leftSidebar');
                const toggle = sidebar.querySelector('.sidebar-toggle');
                const mainContent = document.querySelector('.main-content');
                
                sidebarCollapsed = !sidebarCollapsed;
                
                if (sidebarCollapsed) {
                    // Collapse sidebar
                    sidebar.classList.add('collapsed');
                    toggle.innerHTML = '‚ñ∂';
                    toggle.style.left = '0px';
                    toggle.style.borderRadius = '0 4px 4px 0';
                    
                    // Expand main content to fill space
                    mainContent.style.marginLeft = '20px';
                    
                    // Find and resize all the actual content containers
                    const topPanels = document.querySelector('.top-panels');
                    const dashboardControlsRow = document.querySelector('.dashboard-controls-row');
                    const extractedProductsTable = document.getElementById('extractedProductsTable');
                    const ratingSystem = document.querySelector('.rating-system');
                    
                    if (topPanels) {
                        topPanels.style.width = 'calc(100vw - 40px)';
                    }
                    if (dashboardControlsRow) {
                        dashboardControlsRow.style.width = 'calc(100vw - 40px)';
                    }
                    if (extractedProductsTable) {
                        extractedProductsTable.style.width = 'calc(100vw - 40px)';
                    }
                    if (ratingSystem) {
                        ratingSystem.style.width = 'calc(100vw - 40px)';
                    }
                } else {
                    // Expand sidebar
                    sidebar.classList.remove('collapsed');
                    toggle.innerHTML = '‚óÄ';
                    toggle.style.left = '-30px';
                    toggle.style.borderRadius = '4px 0 0 4px';
                    
                    // Reset main content
                    mainContent.style.marginLeft = '';
                    
                    // Reset all content containers
                    const topPanels = document.querySelector('.top-panels');
                    const dashboardControlsRow = document.querySelector('.dashboard-controls-row');
                    const extractedProductsTable = document.getElementById('extractedProductsTable');
                    const ratingSystem = document.querySelector('.rating-system');
                    
                    if (topPanels) {
                        topPanels.style.width = '';
                    }
                    if (dashboardControlsRow) {
                        dashboardControlsRow.style.width = '';
                    }
                    if (extractedProductsTable) {
                        extractedProductsTable.style.width = '';
                    }
                    if (ratingSystem) {
                        ratingSystem.style.width = '';
                    }
                }
            }
            
            // Mode switching
            function switchMode(mode) {
                 // Clean up React components before switching modes
                 const planogramViewer = document.getElementById('planogramViewer');
                 const advancedPlanogram = document.getElementById('advancedPlanogramViewer');
                 
                 if (planogramViewer && typeof ReactDOM !== 'undefined') {
                     try {
                         ReactDOM.unmountComponentAtNode(planogramViewer);
                     } catch (e) {
                         // Ignore unmount errors
                     }
                 }
                 
                 if (advancedPlanogram && typeof ReactDOM !== 'undefined') {
                     try {
                         ReactDOM.unmountComponentAtNode(advancedPlanogram);
                     } catch (e) {
                         // Ignore unmount errors
                     }
                 }
                 
                // Hide all modes
                 document.getElementById('queue-interface').classList.remove('active');
                document.getElementById('simple-mode').classList.remove('active');
                document.getElementById('advanced-mode').classList.remove('active');
                document.getElementById('intelligence-interface').classList.remove('active');
                
                // Update mode buttons
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                 // Find the button that was clicked for this mode
                 const targetButton = document.querySelector(`[onclick="switchMode('${mode}')"]`);
                 if (targetButton) {
                     targetButton.classList.add('active');
                 }
                 
                 // Show/hide sidebar content based on mode
                 const promptSidebar = document.getElementById('promptManagementSidebar');
                 const imageSidebar = document.getElementById('imageSelectionSidebar');
                 const sidebar = document.querySelector('.left-sidebar');
                 
                 if (mode === 'queue') {
                     // Show prompt management sidebar for queue mode
                     promptSidebar.style.display = 'block';
                     imageSidebar.style.display = 'none';
                     sidebar.style.display = 'flex';
                     
                     // Initialize prompt management if not already done
                     if (!window.promptManagementInitialized) {
                         initializePromptManagement();
                         window.promptManagementInitialized = true;
                     }
                 } else if (mode === 'intelligence') {
                     // Hide sidebar for intelligence mode (full-width dashboard)
                     sidebar.style.display = 'none';
                 } else {
                     // Show image selection sidebar for simple/advanced modes
                     promptSidebar.style.display = 'none';
                     imageSidebar.style.display = 'block';
                     sidebar.style.display = 'flex';
                 }
                
                // Show selected mode
                if (mode === 'queue') {
                     document.getElementById('queue-interface').classList.add('active');
                    updateBreadcrumb('Extraction Queue');
                } else if (mode === 'simple') {
                    document.getElementById('simple-mode').classList.add('active');
                     
                     // Always default to demo for now since real extraction data isn't available
                     if (!selectedItemId || selectedItemId === 5 || selectedItemId === 1) {
                         selectedItemId = 'demo';
                         updateBreadcrumb('Demo - Interactive Planogram');
                     } else {
                         updateBreadcrumb(`Extraction #${selectedItemId} - Simple Analysis`);
                     }
                     
                     loadSimpleModeData();
                } else if (mode === 'advanced') {
                    document.getElementById('advanced-mode').classList.add('active');
                    updateBreadcrumb(`Extraction #${selectedItemId} - Advanced Analysis`);
                    
                    // Load InteractivePlanogram only when entering advanced mode
                    if (typeof window.InteractivePlanogram === 'undefined') {
                        console.log('üîÑ Loading InteractivePlanogram for Advanced mode...');
                        loadReactComponent();
                    }
                    
                    loadAdvancedModeData();
                } else if (mode === 'intelligence') {
                    document.getElementById('intelligence-interface').classList.add('active');
                    updateBreadcrumb('Prompt Intelligence Dashboard');
                    loadIntelligenceData();
                }
                
                currentMode = mode;
            }
            
            function updateBreadcrumb(text) {
                document.getElementById('breadcrumb').innerHTML = `<span>${text}</span>`;
            }
            
            // Show notification messages
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#17a2b8'};
                    color: white;
                    border-radius: 5px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    z-index: 10000;
                    max-width: 400px;
                    animation: slideIn 0.3s ease;
                `;
                notification.textContent = message;
                
                // Add to body
                document.body.appendChild(notification);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 5000);
            }
            
            // Load queue data
            async function loadQueue() {
                try {
                    console.log('üîÑ Loading queue data from API...');
                    const response = await fetch('/api/queue/items');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    queueData = data.items || [];
                    
                    console.log(`‚úÖ Successfully loaded ${queueData.length} real queue items from database`);
                    console.log('Queue items:', queueData.map(item => `#${item.id} (${item.status})`).join(', '));
                    
                    updateQueueStats();
                    renderQueue();
                    
                } catch (error) {
                    console.error('‚ùå Failed to load queue data:', error);
                    
                    // Show error state instead of mock data
                    queueData = [];
                    updateQueueStats();
                    renderQueueError(error.message);
                }
            }
            
            // Load images for sidebar
            async function loadImages() {
                try {
                    console.log('üîÑ Loading image data from API...');
                    const response = await fetch('/api/queue/items');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    imageData = data.items || [];
                    filteredImages = [...imageData];
                    
                    console.log(`‚úÖ Successfully loaded ${imageData.length} real images for sidebar`);
                    renderImages();
                    
                } catch (error) {
                    console.error('‚ùå Failed to load image data:', error);
                    
                    // Show error state instead of mock data
                    imageData = [];
                    filteredImages = [];
                    renderImagesError(error.message);
                }
            }
            
            // Load real filter data from database
            async function loadFilterData() {
                try {
                    console.log('üîÑ Loading filter data from database...');
                    
                    // Load real store data
                    const storeResponse = await fetch('/api/queue/stores');
                    if (storeResponse.ok) {
                        const stores = await storeResponse.json();
                        const storeSelect = document.getElementById('storeFilter');
                        
                        // Clear existing options except "All Stores"
                        while (storeSelect.children.length > 1) {
                            storeSelect.removeChild(storeSelect.lastChild);
                        }
                        
                        // Add real store options
                        stores.forEach(store => {
                            const option = document.createElement('option');
                            option.value = store.id;
                            option.textContent = store.name;
                            storeSelect.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Loaded ${stores.length} real stores`);
                    } else {
                        console.log('‚ÑπÔ∏è No store data available from API');
                    }
                    
                    // Load real category data
                    const categoryResponse = await fetch('/api/queue/categories');
                    if (categoryResponse.ok) {
                        const categories = await categoryResponse.json();
                        const categorySelect = document.getElementById('categoryFilter');
                        
                        // Clear existing options except "All Categories"
                        while (categorySelect.children.length > 1) {
                            categorySelect.removeChild(categorySelect.lastChild);
                        }
                        
                        // Add real category options
                        categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Loaded ${categories.length} real categories`);
                    } else {
                        console.log('‚ÑπÔ∏è No category data available from API');
                    }
                    
                    // Load real country data
                    const countryResponse = await fetch('/api/queue/countries');
                    if (countryResponse.ok) {
                        const countries = await countryResponse.json();
                        const countrySelect = document.getElementById('countryFilter');
                        
                        // Clear existing options except "All Countries"
                        while (countrySelect.children.length > 1) {
                            countrySelect.removeChild(countrySelect.lastChild);
                        }
                        
                        // Add real country options
                        countries.forEach(country => {
                            const option = document.createElement('option');
                            option.value = country.id;
                            option.textContent = country.name;
                            countrySelect.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Loaded ${countries.length} real countries`);
                    } else {
                        console.log('‚ÑπÔ∏è No country data available from API');
                    }
                    
                    // Load real city data
                    const cityResponse = await fetch('/api/queue/cities');
                    if (cityResponse.ok) {
                        const cities = await cityResponse.json();
                        const citySelect = document.getElementById('cityFilter');
                        
                        // Clear existing options except "All Cities"
                        while (citySelect.children.length > 1) {
                            citySelect.removeChild(citySelect.lastChild);
                        }
                        
                        // Add real city options
                        cities.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city.id;
                            option.textContent = city.name;
                            citySelect.appendChild(option);
                        });
                        
                        console.log(`‚úÖ Loaded ${cities.length} real cities`);
                    } else {
                        console.log('‚ÑπÔ∏è No city data available from API');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load filter data:', error);
                    console.log('‚ÑπÔ∏è Using empty filters (no mock data)');
                }
            }

            
            // Update queue statistics
            function updateQueueStats() {
                const stats = {
                    review: queueData.filter(item => item.human_review_required).length,
                    processing: queueData.filter(item => item.status === 'processing').length,
                    completed: queueData.filter(item => item.status === 'completed').length,
                    failed: queueData.filter(item => item.status === 'failed').length
                };
                
                document.getElementById('reviewCount').textContent = stats.review;
                document.getElementById('processingCount').textContent = stats.processing;
                document.getElementById('completedCount').textContent = stats.completed;
                document.getElementById('failedCount').textContent = stats.failed;
                
                // Update right sidebar status
                const totalQueueElement = document.getElementById('totalQueueItems');
                const selectedQueueElement = document.getElementById('selectedQueueItems');
                const activeSystemElement = document.getElementById('activeSystem');
                
                if (totalQueueElement) totalQueueElement.textContent = queueData.length;
                if (selectedQueueElement) selectedQueueElement.textContent = promptManagementState.selectedQueueItems.length;
                if (activeSystemElement) activeSystemElement.textContent = promptManagementState.selectedSystem.replace('_', ' ').replace(/\w/g, l => l.toUpperCase());
            }
            
            // Render queue error
            function renderQueueError(errorMessage) {
                const grid = document.getElementById('queueGrid');
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>‚ùå Failed to Load Queue</h3>
                        <p>Error: ${errorMessage}</p>
                        <button class="btn btn-primary" onclick="loadQueue()" style="margin-top: 15px;">üîÑ Retry</button>
                    </div>
                `;
            }
            
            // Render queue items as table with batch operations
            function renderQueue() {
                const grid = document.getElementById('queueGrid');
                
                if (queueData.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h3>üì≠ No Queue Items</h3>
                            <p>No extraction items found in the queue. Upload some images to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                // Add batch controls and enhanced table
                grid.innerHTML = `
                    <!-- Batch Controls -->
                    <div class="batch-controls" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                        <div class="batch-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div class="batch-selection" style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" ${promptManagementState.allSelected ? 'checked' : ''}>
                                <label for="selectAllCheckbox">Select All</label>
                                <span id="selectedCount">(${promptManagementState.selectedQueueItems.length} selected)</span>
                            </div>
                            <div class="batch-actions" style="display: flex; gap: 6px;">
                                <button class="primary" onclick="applyConfigToSelected()" id="applyConfigBtn" ${promptManagementState.selectedQueueItems.length === 0 ? 'disabled' : ''} style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; cursor: pointer; background: ${promptManagementState.selectedQueueItems.length === 0 ? '#9ca3af' : '#3b82f6'}; color: white; border-color: ${promptManagementState.selectedQueueItems.length === 0 ? '#9ca3af' : '#3b82f6'};">Apply Config</button>
                                <button onclick="resetSelectedItems()" id="resetBtn" ${promptManagementState.selectedQueueItems.length === 0 ? 'disabled' : ''} style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; cursor: pointer; background: ${promptManagementState.selectedQueueItems.length === 0 ? '#f3f4f6' : 'white'}; opacity: ${promptManagementState.selectedQueueItems.length === 0 ? '0.5' : '1'};">Reset</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Queue Table -->
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 20px 0; color: #2d3748; font-size: 20px; font-weight: 700;">üìã Extraction Queue (${queueData.length} items)</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead>
                                    <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 50px;">Select</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Status</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Date</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 120px;">Store</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Category</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 80px;">Country</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Config</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #4a5568; min-width: 80px;">Accuracy</th>
                                        <th style="padding: 12px 8px; text-align: center; font-weight: 600; color: #4a5568; min-width: 120px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${queueData.map(item => {
                                        const statusColor = getStatusColor(item.status);
                                        const accuracy = item.final_accuracy ? Math.round(item.final_accuracy * 100) : null;
                                        const accuracyColor = accuracy >= 90 ? '#10b981' : accuracy >= 70 ? '#f59e0b' : '#ef4444';
                                        const uploadId = item.upload_id || '-';
                                        const isSelected = promptManagementState.selectedQueueItems.includes(item.id);
                                        
                                        // Extract data from uploads and metadata
                                        const uploads = item.uploads || {};
                                        const metadata = uploads.metadata || {};
                                        
                                        const category = uploads.category || '-';
                                        const uploadDate = uploads.created_at || item.created_at;
                                        const storeName = metadata.store_name || metadata.retailer || '-';
                                        const storeLocation = metadata.city || '-';
                                        const country = metadata.country || '-';
                                        
                                        // Check for configuration overrides
                                        const hasSystemOverride = item.current_extraction_system && item.current_extraction_system !== 'auto';
                                        const hasPromptOverride = item.extraction_config && item.extraction_config.prompt_overrides;
                                        
                                        return `
                                            <tr style="border-bottom: 1px solid #e2e8f0; cursor: pointer; ${selectedItemId === item.id ? 'background-color: #f0f9ff;' : ''} ${isSelected ? 'background-color: #eff6ff;' : ''}" 
                                                data-item-id="${item.id}"
                                                onclick="selectQueueItem(${item.id})" 
                                                onmouseover="this.style.backgroundColor='#f8fafc'" 
                                                onmouseout="this.style.backgroundColor='${selectedItemId === item.id || isSelected ? '#f0f9ff' : 'transparent'}'">
                                                <td style="padding: 12px 8px;">
                                                    <input type="checkbox" class="queue-item-checkbox" 
                                                           value="${item.id}"
                                                           ${isSelected ? 'checked' : ''} 
                                                           onchange="toggleItemSelection(${item.id})"
                                                           onclick="event.stopPropagation()">
                                                </td>
                                                <td style="padding: 12px 8px;">
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${statusColor};"></div>
                                                        <span style="font-weight: 600; color: ${statusColor};">${getStatusText(item.status)}</span>
                                                        ${item.human_review_required ? '<span style="color: #f59e0b; margin-left: 4px;">‚ö†Ô∏è</span>' : ''}
                                                    </div>
                                                </td>
                                                <td style="padding: 12px 8px; color: #4a5568;">
                                                    ${new Date(uploadDate).toLocaleDateString()}
                                                    <div style="font-size: 12px; color: #64748b;">${new Date(uploadDate).toLocaleTimeString()}</div>
                                                </td>
                                                <td style="padding: 12px 8px; color: #2d3748; font-weight: 500;">
                                                    ${storeName}
                                                    ${storeLocation !== '-' ? `<div style="font-size: 12px; color: #64748b;">${storeLocation}</div>` : ''}
                                                </td>
                                                <td style="padding: 12px 8px; color: #4a5568;">
                                                    ${category}
                                                </td>
                                                <td style="padding: 12px 8px; color: #4a5568;">
                                                    ${country}
                                                </td>
                                                <td style="padding: 12px 8px;">
                                                    <div style="font-size: 11px;">
                                                        ${item.extraction_config ? `
                                                            <div class="config-badge" style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 4px; padding: 4px 6px; margin-bottom: 4px; position: relative;">
                                                                <div style="color: #1e40af; font-weight: 600; margin-bottom: 2px;">‚úÖ Configured</div>
                                                                <div style="color: #2563eb; font-size: 10px;">
                                                                    System: ${item.extraction_config.system || 'custom_consensus'}
                                                                </div>
                                                                <div class="config-tooltip">
                                                                    <div style="margin-bottom: 4px;"><strong>System:</strong> ${item.extraction_config.system || 'custom_consensus'}</div>
                                                                    ${item.extraction_config.models ? `
                                                                        <div style="margin-bottom: 4px;"><strong>Models:</strong></div>
                                                                        ${Object.entries(item.extraction_config.models).map(([k, v]) => `
                                                                            <div style="margin-left: 8px;">‚Ä¢ ${k}: ${v}</div>
                                                                        `).join('')}
                                                                    ` : ''}
                                                                    ${item.extraction_config.prompts ? `
                                                                        <div style="margin-top: 4px;"><strong>Prompts:</strong></div>
                                                                        ${Object.entries(item.extraction_config.prompts).map(([k, v]) => `
                                                                            <div style="margin-left: 8px;">‚Ä¢ ${k}: ${v === 'auto' ? 'Auto-selected' : v}</div>
                                                                        `).join('')}
                                                                    ` : ''}
                                                                </div>
                                                            </div>
                                                        ` : `
                                                            <div style="background: #f3f4f6; border: 1px dashed #9ca3af; border-radius: 4px; padding: 4px 6px;">
                                                                <div style="color: #6b7280; font-size: 10px;">
                                                                    <span style="opacity: 0.7;">‚ö™</span> Not configured
                                                                </div>
                                                                <div style="color: #9ca3af; font-size: 10px;">
                                                                    Will use defaults
                                                                </div>
                                                            </div>
                                                        `}
                                                    </div>
                                                </td>
                                                <td style="padding: 12px 8px; text-align: center;">
                                                    ${accuracy !== null ? `
                                                        <span style="font-weight: 600; color: ${accuracyColor};">${accuracy}%</span>
                                                    ` : '<span style="color: #94a3b8;">-</span>'}
                                                </td>
                                                <td style="padding: 12px 8px; text-align: center;">
                                                    <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                                        ${item.status === 'pending' ? `
                                                            <button class="btn btn-primary" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); showProcessWithModal(${item.id})">üöÄ Process</button>
                                                        ` : `
                                                            <button class="btn btn-success" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); viewResults(${item.id})">View</button>
                                                        `}
                                                        ${(item.status === 'failed' || item.status === 'processing') ? `
                                                            <button class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); resetItem(${item.id})">üîÑ Reset</button>
                                                        ` : ''}
                                                        ${item.status === 'completed' ? `
                                                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="event.stopPropagation(); showProcessWithModal(${item.id}, true)">üîÑ Reprocess</button>
                                                        ` : ''}
                                                        <button class="btn" style="padding: 4px 8px; font-size: 12px; background: #6b7280; color: white;" onclick="event.stopPropagation(); overrideQueueItem(${item.id})">‚öôÔ∏è Override</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // Helper function for status colors
            function getStatusColor(status) {
                switch(status) {
                    case 'completed': return '#10b981';
                    case 'processing': return '#3b82f6';
                    case 'pending': return '#f59e0b';
                    case 'failed': return '#ef4444';
                    default: return '#64748b';
                }
            }
            
            // Render images error
            function renderImagesError(errorMessage) {
                const container = document.getElementById('imageGrid');
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>‚ùå Failed to Load Images</h3>
                        <p>Error: ${errorMessage}</p>
                        <button class="btn btn-primary" onclick="loadImages()" style="margin-top: 15px;">üîÑ Retry</button>
                    </div>
                `;
            }
            
            // Render images in sidebar
            function renderImages() {
                const container = document.getElementById('imageGrid');
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageImages = filteredImages.slice(startIndex, endIndex);
                
                container.className = viewMode === 'grid' ? 'image-grid' : 'image-list';
                
                if (pageImages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>üì≠ No Images</h3>
                            <p>No images available. Upload some images to get started.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = pageImages.map(image => `
                    <div class="image-item ${viewMode}-view ${selectedItemId === image.id ? 'selected' : ''}" 
                         onclick="selectImage(${image.id})">
                        <div class="image-thumbnail">
                            <img src="/api/queue/image/${image.id}" alt="Queue item ${image.id}" 
                                 style="width: 100%; height: 100%; object-fit: cover;" 
                                 onerror="this.style.display='none'; this.parentElement.innerHTML='üì∑';">
                        </div>
                        <div class="image-info">
                            <div class="image-title">Extraction #${image.id}</div>
                            <div class="image-meta">
                                ${image.ready_media_id ? `Media: ${image.ready_media_id.substring(0, 8)}...` : 'No media ID'}<br>
                                ${new Date(image.created_at).toLocaleDateString()}
                                <div class="status-badge status-${image.status}">${image.status}</div>
                                ${(image.status === 'completed' || image.status === 'failed') ? `
                                    <button class="btn btn-sm btn-secondary" style="margin-top: 5px; padding: 2px 8px; font-size: 11px;" 
                                            onclick="event.stopPropagation(); showProcessWithModal(${image.id}, true)">
                                        üîÑ Reprocess
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                updatePagination();
            }
            
            // Image selection
            function selectImage(imageId) {
                selectedItemId = imageId;
                
                // Update visual selection in sidebar
                document.querySelectorAll('.image-item').forEach(item => {
                    item.classList.remove('selected');
                });
                event.target.closest('.image-item').classList.add('selected');
                
                // Auto-switch to simple mode and load the image
                switchMode('simple');
                
                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            }
            
            // Load data for different modes
            async function loadSimpleModeData() {
                try {
                     // Load original image (or show demo message)
                    const imageElement = document.getElementById('originalImage');
                    const loadingElement = document.getElementById('imageLoading');
                    
                     if (selectedItemId && selectedItemId !== 'demo') {
                    imageElement.onload = function() {
                        loadingElement.style.display = 'none';
                        imageElement.style.display = 'block';
                    };
                    
                    imageElement.onerror = function() {
                        loadingElement.innerHTML = 'Failed to load image';
                    };
                    
                    imageElement.src = `/api/queue/image/${selectedItemId}`;
                     } else {
                         // Show demo message for image
                         loadingElement.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;"><h3>üì∑ Demo Mode</h3><p>Select a real image from the sidebar to see the original photo, or view the interactive planogram demo on the right.</p></div>';
                         imageElement.style.display = 'none';
                     }
                    
                     // Load interactive planogram - ALWAYS show demo if no real item
                    const planogramViewer = document.getElementById('planogramViewer');
                     const imageId = selectedItemId || 'demo';
                     
                     console.log('Loading planogram for:', imageId);
                     
                     // Simple HTML/CSS Grid Approach - Convert React logic to pure HTML/CSS
                     async function renderSimpleGridPlanogram() {
                         console.log('üéØ Rendering Simple HTML/CSS Grid Planogram (converted from React)');
                         
                         try {
                             // Fetch planogram data
                             const response = await fetch(`/api/planogram/${imageId}/editable`);
                             if (!response.ok) {
                                 throw new Error(`Failed to load data: ${response.statusText}`);
                             }
                             
                             const data = await response.json();
                             console.log('üìä Planogram data loaded:', data);
                             
                             // Clear container
                             planogramViewer.innerHTML = '';
                             
                             // Create the planogram using your React component logic but in pure HTML/CSS
                             createSimpleGridPlanogram(planogramViewer, data.planogram);
                             
                             console.log('‚úÖ Simple HTML/CSS planogram rendered');
                             
                    } catch (error) {
                             console.error('‚ùå Error loading planogram:', error);
                             planogramViewer.innerHTML = `
                                 <div style="padding: 20px; text-align: center; color: #dc2626;">
                                     <h3>‚ùå Failed to Load Planogram</h3>
                                     <p>${error.message}</p>
                                 </div>
                             `;
                         }
                     }
                     
                     // Render the simple grid planogram
                     renderSimpleGridPlanogram();
                     
                     // Load planogram controls
                     await loadPlanogramControls(imageId);
                     
                     // Load compact stats dashboard
                     await loadCompactStatsDashboard(imageId);
                     
                     // Load extracted products table
                     await loadExtractedProductsTable(imageId);
                     
                } catch (error) {
                    console.error('Error loading simple mode data:', error);
                }
            }
             
             async function loadPlanogramControls(imageId) {
                 const controlsContainer = document.getElementById('planogramControls');
                 
                 // Create ultra-compact controls for half-height container
                 const controlsHTML = `
                     <div style="background: white; border-radius: 6px; padding: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); height: 100%; display: flex; align-items: center;">
                         <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                             <!-- Zoom Controls - Compact -->
                             <div style="display: flex; align-items: center; gap: 3px;">
                                 <span style="font-size: 8px; font-weight: 600; color: #4a5568;">üîç <span id="zoomPercentage">100%</span></span>
                                 <button onclick="updatePlanogramZoom(0.5, false, true)" style="padding: 2px 4px; background: #10b981; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">50%</button>
                                 <button onclick="updatePlanogramZoom(1, true)" style="padding: 2px 4px; background: #6b7280; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">100%</button>
                                 <button onclick="updatePlanogramZoom(1.5, false, true)" style="padding: 2px 4px; background: #f59e0b; color: white; border: none; border-radius: 2px; cursor: pointer; font-weight: 600; font-size: 7px;">150%</button>
                             </div>
                             
                             <!-- Display Toggles - Ultra Compact -->
                             <div style="display: flex; gap: 2px; align-items: center;">
                                 <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #4facfe; color: white; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                                     <input type="checkbox" id="toggleBrands" checked onchange="updatePlanogramDisplay('showBrands', this.checked)" style="display: none;">
                                     <span>‚úì</span>B
                                 </label>
                                 <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #fa709a; color: white; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                                     <input type="checkbox" id="toggleProducts" checked onchange="updatePlanogramDisplay('showProducts', this.checked)" style="display: none;">
                                     <span>‚úì</span>P
                                 </label>
                                 <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #a8edea; color: #2d3748; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                                     <input type="checkbox" id="togglePrices" checked onchange="updatePlanogramDisplay('showPrices', this.checked)" style="display: none;">
                                     <span>‚úì</span>¬£
                                 </label>
                                 <label style="display: flex; align-items: center; gap: 2px; padding: 2px 4px; background: #f7fafc; color: #4a5568; border-radius: 3px; cursor: pointer; font-weight: 600; font-size: 7px; line-height: 1;">
                                     <input type="checkbox" id="toggleConfidence" onchange="updatePlanogramDisplay('showConfidence', this.checked)" style="display: none;">
                                     <span>‚óã</span>%
                                 </label>
                             </div>
                         </div>
                     </div>
                 `;
                 
                 controlsContainer.innerHTML = controlsHTML;
             }
             
             async function loadCompactStatsDashboard(imageId) {
                 const dashboardContainer = document.getElementById('compactStatsDashboard');
                 
                 try {
                     const response = await fetch(`/api/planogram/${imageId}/editable`);
                     if (!response.ok) {
                         dashboardContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No stats data available</div>';
                         return;
                     }
                     
                     const data = await response.json();
                     let totalProducts = 0;
                     let totalFacings = 0;
                     let hasStacking = false;
                     let confidenceSum = 0;
                     let confidenceCount = 0;
                     
                     // Calculate stats from shelves
                     data.planogram.shelves.forEach(shelf => {
                         Object.values(shelf.sections).forEach(section => {
                             section.forEach(slot => {
                                 if (slot.type === 'product') {
                                     totalProducts++;
                                     totalFacings += slot.data.quantity?.total_facings || 1;
                                     if (slot.data.quantity?.stack > 1) {
                                         hasStacking = true;
                                     }
                                     if (slot.data.metadata?.extraction_confidence) {
                                         confidenceSum += slot.data.metadata.extraction_confidence;
                                         confidenceCount++;
                                     }
                                 }
                             });
                         });
                     });
                     
                     const avgConfidence = confidenceCount > 0 ? confidenceSum / confidenceCount : 0.9;
                     const shelfCount = data.planogram.shelves.length;
                     
                     // Generate ultra-compact stats dashboard HTML (half height)
                     const dashboardHTML = `
                         <div style="background: white; border-radius: 6px; padding: 4px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); height: 100%; display: flex; align-items: center;">
                             <div style="display: flex; gap: 4px; width: 100%; justify-content: space-between;">
                                 <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 3px 6px; border-radius: 3px; text-align: center; flex: 1;">
                                     <div style="font-size: 11px; font-weight: 700; line-height: 1;">${totalProducts}</div>
                                     <div style="font-size: 7px; opacity: 0.9; line-height: 1;">Products</div>
                                 </div>
                                 <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 3px 6px; border-radius: 3px; text-align: center; flex: 1;">
                                     <div style="font-size: 11px; font-weight: 700; line-height: 1;">${shelfCount}</div>
                                     <div style="font-size: 7px; opacity: 0.9; line-height: 1;">Shelves</div>
                                 </div>
                                 <div style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; padding: 3px 6px; border-radius: 3px; text-align: center; flex: 1;">
                                     <div style="font-size: 11px; font-weight: 700; line-height: 1;">${Math.round(avgConfidence * 100)}%</div>
                                     <div style="font-size: 7px; opacity: 0.8; line-height: 1;">Confidence</div>
                                 </div>
                                 <div style="background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%); color: white; padding: 3px 6px; border-radius: 3px; text-align: center; flex: 1;">
                                     <div style="font-size: 11px; font-weight: 700; line-height: 1;">${totalFacings}</div>
                                     <div style="font-size: 7px; opacity: 0.9; line-height: 1;">Facings</div>
                                 </div>
                                 ${hasStacking ? `
                                     <div style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; padding: 3px 6px; border-radius: 3px; text-align: center; flex: 1;">
                                         <div style="font-size: 9px; font-weight: 700; line-height: 1;">üìö</div>
                                         <div style="font-size: 6px; opacity: 0.8; line-height: 1;">Stack</div>
                                     </div>
                                 ` : ''}
                             </div>
                         </div>
                     `;
                     
                     dashboardContainer.innerHTML = dashboardHTML;
                     
                 } catch (error) {
                     console.error('Error loading stats dashboard:', error);
                     dashboardContainer.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 20px;">Failed to load stats dashboard</div>';
                 }
             }
             
             async function loadExtractedProductsTable(imageId) {
                 const tableContainer = document.getElementById('extractedProductsTable');
                 
                 try {
                     const response = await fetch(`/api/planogram/${imageId}/editable`);
                     if (!response.ok) {
                         tableContainer.innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">No extraction data available</div>';
                         return;
                     }
                     
                     const data = await response.json();
                     const products = [];
                     
                     // Extract all products from shelves
                     data.planogram.shelves.forEach(shelf => {
                         Object.values(shelf.sections).forEach(section => {
                             section.forEach(slot => {
                                 if (slot.type === 'product') {
                                     products.push({
                                         ...slot.data,
                                         shelf: shelf.shelf_number,
                                         position: slot.position
                                     });
                                 }
                             });
                         });
                     });
                     
                     // Sort by shelf and position
                     products.sort((a, b) => {
                         if (a.shelf !== b.shelf) return a.shelf - b.shelf;
                         return a.position - b.position;
                     });
                     
                     // Generate table HTML with ALL metadata
                     const tableHTML = `
                         <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                             <h4 style="margin: 0 0 16px 0; color: #2d3748; font-size: 18px; font-weight: 700;">üìã Extracted Products (${products.length} items)</h4>
                             <div style="overflow-x: auto;">
                                 <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                     <thead>
                                         <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 50px;">Shelf</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 40px;">Pos</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 80px;">Section</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 100px;">Brand</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 150px;">Product</th>
                                             <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Price</th>
                                             <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Facings</th>
                                             <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 60px;">Stack</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 60px;">Volume</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 60px;">Color</th>
                                             <th style="padding: 10px 6px; text-align: center; font-weight: 600; color: #4a5568; min-width: 80px;">Confidence</th>
                                             <th style="padding: 10px 6px; text-align: left; font-weight: 600; color: #4a5568; min-width: 60px;">ID</th>
                                         </tr>
                                     </thead>
                                     <tbody>
                                         ${products.map(product => {
                                             const confidence = Math.round((product.metadata?.extraction_confidence || 0.9) * 100);
                                             const confidenceColor = confidence >= 90 ? '#10b981' : confidence >= 70 ? '#f59e0b' : '#ef4444';
                                             const section = product.position?.section?.vertical || 'Unknown';
                                             const stackHeight = product.quantity?.stack || 1;
                                             const volume = product.metadata?.volume || product.volume || '-';
                                             const color = product.metadata?.color || product.color || '-';
                                             const productId = product.id || '-';
                                             
                                             return `
                                                 <tr style="border-bottom: 1px solid #e2e8f0; hover: background-color: #f8fafc;">
                                                     <td style="padding: 8px 6px; font-weight: 600; color: #2d3748;">${product.shelf}</td>
                                                     <td style="padding: 8px 6px; color: #4a5568;">${product.position}</td>
                                                     <td style="padding: 8px 6px; color: #4a5568; font-size: 12px;">${section}</td>
                                                     <td style="padding: 8px 6px; color: #4a5568; font-weight: 500;">${product.brand}</td>
                                                     <td style="padding: 8px 6px; color: #2d3748;">${product.name}</td>
                                                     <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: #2b6cb0;">${product.price ? '¬£' + product.price.toFixed(2) : '-'}</td>
                                                     <td style="padding: 8px 6px; text-align: center; color: #4a5568;">${product.quantity?.total_facings || 1}</td>
                                                     <td style="padding: 8px 6px; text-align: center; color: ${stackHeight > 1 ? '#f59e0b' : '#4a5568'}; font-weight: ${stackHeight > 1 ? '600' : 'normal'};">${stackHeight}${stackHeight > 1 ? ' üìö' : ''}</td>
                                                     <td style="padding: 8px 6px; color: #4a5568; font-size: 12px;">${volume}</td>
                                                     <td style="padding: 8px 6px; color: #4a5568; font-size: 12px;">${color}</td>
                                                     <td style="padding: 8px 6px; text-align: center; font-weight: 600; color: ${confidenceColor};">${confidence}%</td>
                                                     <td style="padding: 8px 6px; color: #64748b; font-size: 11px; font-family: monospace;">${productId}</td>
                                                 </tr>
                                             `;
                                         }).join('')}
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                     `;
                     
                     tableContainer.innerHTML = tableHTML;
                     
                 } catch (error) {
                     console.error('Error loading products table:', error);
                     tableContainer.innerHTML = '<div style="color: #ef4444; text-align: center; padding: 20px;">Failed to load products table</div>';
                }
            }
            
            async function loadComparisonModeData() {
                if (!selectedItemId) return;
                
                // Load comparison data for each agent
                try {
                    // This would normally fetch real comparison data
                    // For now, we'll use the existing mock data structure
                    console.log('Loading comparison data for item:', selectedItemId);
                    
                    // Load results for each agent
                    await loadAgentResults('agent1');
                    await loadAgentResults('agent2');
                    await loadAgentResults('agent3');
                    
                } catch (error) {
                    console.error('Error loading comparison data:', error);
                }
            }
            
            async function loadAdvancedModeData() {
                try {
                    // Load original image in advanced mode
                    const advancedImage = document.getElementById('advancedOriginalImage');
                    if (selectedItemId) {
                    advancedImage.src = `/api/queue/image/${selectedItemId}`;
                    } else {
                        // Show demo message when no item selected
                        advancedImage.style.display = 'none';
                        advancedImage.parentElement.innerHTML = '<div class="loading">Select an image from the sidebar or view the Demo in the Iterations tab</div>';
                    }
                    
                    // Load interactive planogram in advanced mode
                    const advancedPlanogram = document.getElementById('advancedPlanogramViewer');
                    try {
                        // Clear existing content
                        advancedPlanogram.innerHTML = '';
                        
                        // Always show demo if no item selected, otherwise show selected item
                        const imageId = selectedItemId || "demo";
                        
                        // Render interactive planogram component
                        if (window.InteractivePlanogram) {
                            ReactDOM.render(
                                React.createElement(window.InteractivePlanogram, {
                                    imageId: imageId,
                                    mode: 'advanced'
                                }),
                                advancedPlanogram
                            );
                        } else {
                            // Fallback to static SVG if React component not loaded
                            if (selectedItemId) {
                        const planogramResponse = await fetch(`/api/planogram/${selectedItemId}/render?format=svg&abstraction_level=sku_view`);
                        if (planogramResponse.ok) {
                            const svgContent = await planogramResponse.text();
                            advancedPlanogram.innerHTML = svgContent;
                        } else {
                            advancedPlanogram.innerHTML = '<div class="loading">Planogram not available</div>';
                                }
                            } else {
                                advancedPlanogram.innerHTML = '<div class="loading">React component not loaded. Please refresh the page to see demo.</div>';
                            }
                        }
                    } catch (error) {
                        advancedPlanogram.innerHTML = '<div class="loading">Failed to load planogram</div>';
                    }
                    
                    // Load technical analysis data
                    await loadTechnicalAnalysis();
                    await loadOrchestratorFlow();
                    
                } catch (error) {
                    console.error('Error loading advanced mode data:', error);
                }
            }
            
            async function loadAgentResults(agentId) {
                const resultsContainer = document.getElementById(`${agentId}Results`);
                
                if (!selectedItemId) {
                    resultsContainer.innerHTML = '<div class="loading">No item selected</div>';
                    return;
                }
                
                try {
                    // Try to load real comparison results
                    const response = await fetch(`/api/queue/comparison/${selectedItemId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Process real comparison data here
                        resultsContainer.innerHTML = '<div class="loading">Real comparison data loaded</div>';
                    } else {
                        resultsContainer.innerHTML = '<div class="loading">No comparison data available yet</div>';
                    }
                } catch (error) {
                    console.error('Failed to load agent results:', error);
                    resultsContainer.innerHTML = '<div class="loading">Failed to load comparison data</div>';
                }
            }
            
            async function loadTechnicalAnalysis() {
                if (!selectedItemId) {
                    document.getElementById('modelPerformance').innerHTML = 'No item selected';
                    document.getElementById('confidenceScores').innerHTML = 'No item selected';
                    document.getElementById('errorAnalysis').innerHTML = 'No item selected';
                    return;
                }
                
                try {
                    // Try to load real technical analysis data
                    const response = await fetch(`/api/queue/analysis/${selectedItemId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Process real analysis data here
                        document.getElementById('modelPerformance').innerHTML = 'Real performance data loaded';
                        document.getElementById('confidenceScores').innerHTML = 'Real confidence data loaded';
                        document.getElementById('errorAnalysis').innerHTML = 'Real error analysis loaded';
                    } else {
                        document.getElementById('modelPerformance').innerHTML = 'No analysis data available yet';
                        document.getElementById('confidenceScores').innerHTML = 'No confidence data available yet';
                        document.getElementById('errorAnalysis').innerHTML = 'No error analysis available yet';
                    }
                } catch (error) {
                    console.error('Failed to load technical analysis:', error);
                    document.getElementById('modelPerformance').innerHTML = 'Failed to load performance data';
                    document.getElementById('confidenceScores').innerHTML = 'Failed to load confidence data';
                    document.getElementById('errorAnalysis').innerHTML = 'Failed to load error analysis';
                }
            }
            
            async function loadOrchestratorFlow() {
                const flowContainer = document.getElementById('orchestratorFlow');
                
                if (!selectedItemId) {
                    flowContainer.innerHTML = '<div class="loading">No item selected</div>';
                    return;
                }
                
                try {
                    // Try to load real orchestrator flow data
                    const response = await fetch(`/api/queue/flow/${selectedItemId}`);
                    if (response.ok) {
                        const data = await response.json();
                        // Process real flow data here
                        flowContainer.innerHTML = '<div class="loading">Real orchestrator flow loaded</div>';
                    } else {
                        flowContainer.innerHTML = '<div class="loading">No flow data available yet</div>';
                    }
                } catch (error) {
                    console.error('Failed to load orchestrator flow:', error);
                    flowContainer.innerHTML = '<div class="loading">Failed to load flow data</div>';
                }
            }
            
            // Agent switching in comparison mode
            function switchAgent(agentId) {
                // Hide all agent content
                document.querySelectorAll('.agent-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                // Update tab states
                document.querySelectorAll('.agent-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected agent
                document.getElementById(agentId).style.display = 'block';
                event.target.classList.add('active');
                
                currentAgent = agentId;
            }
            
            // Helper functions
            function getStatusClass(status) {
                const classes = {
                    'pending': 'status-pending',
                    'processing': 'status-processing',
                    'completed': 'status-completed',
                    'failed': 'status-failed'
                };
                return classes[status] || 'status-pending';
            }
            
            function getStatusText(status) {
                const texts = {
                    'pending': 'Pending',
                    'processing': 'Processing',
                    'completed': 'Completed',
                    'failed': 'Failed'
                };
                return texts[status] || 'Unknown';
            }
            
            // Queue item selection
            function selectQueueItem(itemId) {
                selectedItemId = itemId;
                
                // Update visual selection
                document.querySelectorAll('.queue-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector(`[data-item-id="${itemId}"]`).classList.add('selected');
                
                // Update breadcrumb
                updateBreadcrumb(`Extraction #${itemId} Selected`);
                 
                 // Note: Don't auto-switch to simple mode since real data isn't available
                 console.log(`üìã Selected queue item #${itemId} (real extraction data not available yet)`);
            }
            
            // System selection update
            function updateSystemSelection(itemId) {
                const checkboxes = document.querySelectorAll(`input[onchange="updateSystemSelection(${itemId})"]`);
                const selectedSystems = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
                
                // Update the item data
                const item = queueData.find(item => item.id === itemId);
                if (item) {
                    item.selected_systems = selectedSystems;
                }
                
                console.log(`Updated systems for item ${itemId}:`, selectedSystems);
            }
            
            // Processing actions
            async function startProcessing(itemId) {
                const item = queueData.find(item => item.id === itemId);
                if (!item || item.selected_systems.length === 0) {
                    alert('Please select at least one extraction system');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/queue/process/${itemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ systems: item.selected_systems })
                    });
                    
                    if (response.ok) {
                        // Update item status
                        item.status = 'processing';
                        renderQueue();
                        updateQueueStats();
                    } else {
                        throw new Error('Failed to start processing');
                    }
                } catch (error) {
                    console.error('Error starting processing:', error);
                    alert('Failed to start processing. Please try again.');
                }
            }
            
            async function viewResults(itemId) {
                 // For now, always show demo since real extraction data isn't available
                 selectedItemId = 'demo';
                switchMode('simple');
                 console.log(`üìä Viewing results for item #${itemId} (showing demo data instead)`);
            }
            
            async function reprocess(itemId) {
                if (confirm('Are you sure you want to reprocess this extraction?')) {
                    try {
                        const response = await fetch(`/api/queue/reprocess/${itemId}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            loadQueue(); // Reload queue
                        } else {
                            throw new Error('Failed to start reprocessing');
                        }
                    } catch (error) {
                        console.error('Error reprocessing:', error);
                        alert('Failed to start reprocessing. Please try again.');
                    }
                }
            }
            
            // Open debug interface for specific queue item
            function openDebugInterface(uploadId) {
                console.log(`üîç Opening debug interface for upload ID: ${uploadId}`);
                
                // Switch to advanced mode and debugger tab
                switchMode('advanced');
                setTimeout(() => {
                    switchAdvancedTab('debugger');
                    
                    // Pre-populate the debug form with the upload ID
                    setTimeout(() => {
                        const uploadIdInput = document.getElementById('debugUploadId');
                        if (uploadIdInput) {
                            uploadIdInput.value = uploadId;
                            console.log(`‚úÖ Pre-populated debug form with upload ID: ${uploadId}`);
                        }
                        
                        // Optionally auto-start the debug session
                        if (confirm(`Start debug session for upload ${uploadId}?`)) {
                            startDebugSession();
                        }
                    }, 100);
                }, 100);
            }
            
            // Reset individual item
            async function resetItem(itemId) {
                if (confirm('Are you sure you want to reset this item? This will clear its status and allow it to be processed again.')) {
                    try {
                        const response = await fetch(`/api/queue/reset/${itemId}`, {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            console.log(`‚úÖ Reset item #${itemId}`);
                            loadQueue(); // Reload queue to show updated status
                            updateQueueStats();
                        } else {
                            throw new Error('Failed to reset item');
                        }
                    } catch (error) {
                        console.error('Error resetting item:', error);
                        alert('Failed to reset item. Please try again.');
                    }
                }
            }
            
            // Reset all failed/stuck items
            async function resetAllFailedItems() {
                const failedItems = queueData.filter(item => item.status === 'failed' || item.status === 'processing');
                
                if (failedItems.length === 0) {
                    alert('No failed or stuck items to reset.');
                    return;
                }
                
                if (confirm(`Are you sure you want to reset ${failedItems.length} failed/stuck items? This will clear their status and allow them to be processed again.`)) {
                    try {
                        const response = await fetch('/api/queue/reset-all-failed', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            console.log(`‚úÖ Reset ${failedItems.length} failed/stuck items`);
                            loadQueue(); // Reload queue to show updated status
                            updateQueueStats();
                        } else {
                            throw new Error('Failed to reset items');
                        }
                    } catch (error) {
                        console.error('Error resetting items:', error);
                        alert('Failed to reset items. Please try again.');
                    }
                }
            }
            
            // Process With Modal Functions
            let currentProcessItemId = null;
            let isReprocessing = false;
            
            function showProcessWithModal(itemId, reprocess = false) {
                currentProcessItemId = itemId;
                isReprocessing = reprocess;
                
                const modal = document.getElementById('processWithModal');
                const title = document.getElementById('processModalTitle');
                
                title.textContent = reprocess ? 'üîÑ Reprocess with AI System' : 'üöÄ Process with AI System';
                
                // Reset form
                document.querySelectorAll('input[name="aiSystem"]').forEach(radio => {
                    radio.checked = false;
                });
                document.querySelectorAll('.system-option').forEach(option => {
                    option.style.borderColor = '#e5e7eb';
                    option.style.background = 'white';
                    option.classList.remove('selected');
                });
                const processBtn = document.getElementById('processWithBtn');
                processBtn.disabled = true;
                processBtn.style.opacity = '0.6';
                processBtn.style.cursor = 'not-allowed';
                processBtn.style.background = '#9ca3af';
                
                // Show modal
                modal.style.display = 'flex';
                
                console.log(`${reprocess ? 'Reprocess' : 'Process'} modal opened for item ${itemId}`);
            }
            
            function closeProcessWithModal() {
                const modal = document.getElementById('processWithModal');
                modal.style.display = 'none';
                currentProcessItemId = null;
                isReprocessing = false;
            }
            
            function selectSystem(systemValue, labelElement) {
                // Update radio button
                const radio = labelElement.querySelector('input[type="radio"]');
                radio.checked = true;
                
                // Update visual selection
                document.querySelectorAll('.system-option').forEach(label => {
                    label.style.borderColor = '#e5e7eb';
                    label.style.background = 'white';
                    label.classList.remove('selected');
                });
                
                labelElement.style.borderColor = '#3b82f6';
                labelElement.style.background = '#f0f9ff';
                labelElement.classList.add('selected');
                
                // Enable process button
                const processBtn = document.getElementById('processWithBtn');
                processBtn.disabled = false;
                processBtn.style.opacity = '1';
                processBtn.style.cursor = 'pointer';
                processBtn.style.background = '#3b82f6';
                
                console.log(`Selected system: ${systemValue}`);
            }
            
            // Add keyboard support for modal
            document.addEventListener('keydown', function(e) {
                const modal = document.getElementById('processWithModal');
                if (modal.style.display === 'flex') {
                    if (e.key === 'Escape') {
                        closeProcessWithModal();
                    } else if (e.key === 'Enter') {
                        const processBtn = document.getElementById('processWithBtn');
                        if (!processBtn.disabled) {
                            processWithSelectedSystem();
                        }
                    } else if (e.key >= '1' && e.key <= '3') {
                        // Quick select with number keys
                        const systems = ['custom_consensus', 'langgraph', 'hybrid'];
                        const systemIndex = parseInt(e.key) - 1;
                        if (systemIndex < systems.length) {
                            const systemValue = systems[systemIndex];
                            const label = document.querySelector(`label[onclick*="${systemValue}"]`);
                            if (label) {
                                selectSystem(systemValue, label);
                            }
                        }
                    }
                }
            });
            
            async function processWithSelectedSystem() {
                const selectedSystem = document.querySelector('input[name="aiSystem"]:checked');
                
                if (!selectedSystem || !currentProcessItemId) {
                    alert('Please select a system and try again.');
                    return;
                }
                
                const systemValue = selectedSystem.value;
                const actionText = isReprocessing ? 'Reprocessing' : 'Processing';
                
                try {
                    // Close modal first
                    closeProcessWithModal();
                    
                    // Show processing feedback
                    const item = queueData.find(item => item.id === currentProcessItemId);
                    if (item) {
                        item.status = 'processing';
                        renderQueue();
                        updateQueueStats();
                    }
                    
                    console.log(`${actionText} item ${currentProcessItemId} with ${systemValue}`);
                    
                    // Make API call to start processing
                    const response = await fetch(`/api/queue/${isReprocessing ? 'reprocess' : 'process'}/${currentProcessItemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            system: systemValue,
                            target_accuracy: 0.95,
                            max_iterations: 5
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log(`‚úÖ ${actionText} started successfully:`, result);
                        
                        // Show success message
                        alert(`${actionText} started with ${getSystemDisplayName(systemValue)}! You can monitor progress in the Advanced > Pipeline Debugger tab.`);
                        
                        // Reload queue to show updated status
                        setTimeout(() => {
                            loadQueue();
                        }, 1000);
                        
                    } else {
                        throw new Error(`Failed to start ${actionText.toLowerCase()}`);
                    }
                    
                } catch (error) {
                    console.error(`Error ${actionText.toLowerCase()}:`, error);
                    alert(`Failed to start ${actionText.toLowerCase()}. Please try again.`);
                    
                    // Reset item status on error
                    if (item) {
                        item.status = isReprocessing ? 'completed' : 'pending';
                        renderQueue();
                        updateQueueStats();
                    }
                }
            }
            
            function getSystemDisplayName(systemValue) {
                const names = {
                    'custom_consensus': 'Custom Consensus System',
                    'langgraph': 'LangGraph Workflow System', 
                    'hybrid': 'Hybrid Adaptive System'
                };
                return names[systemValue] || systemValue;
            }
            
            // Remove item function
            async function removeItem(itemId) {
                const item = queueData.find(item => item.id === itemId);
                const itemName = item ? `Extraction #${item.id}` : `Item #${itemId}`;
                
                if (confirm(`Are you sure you want to remove ${itemName} from the queue? This action cannot be undone.`)) {
                    try {
                        const response = await fetch(`/api/queue/remove/${itemId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            console.log(`‚úÖ Removed item #${itemId} from queue`);
                            
                            // Remove from local data
                            const index = queueData.findIndex(item => item.id === itemId);
                            if (index !== -1) {
                                queueData.splice(index, 1);
                            }
                            
                            // Update UI
                            renderQueue();
                            updateQueueStats();
                            
                            // Show success message
                            alert(`${itemName} has been removed from the queue.`);
                            
                        } else {
                            throw new Error('Failed to remove item');
                        }
                    } catch (error) {
                        console.error('Error removing item:', error);
                        alert('Failed to remove item. Please try again.');
                    }
                }
            }
            
            // Image filtering
            function filterImages() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const storeFilter = document.getElementById('storeFilter').value;
                const countryFilter = document.getElementById('countryFilter').value;
                const cityFilter = document.getElementById('cityFilter').value;
                const categoryFilter = document.getElementById('categoryFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;
                
                filteredImages = imageData.filter(image => {
                    // Extract metadata fields
                    const uploads = image.uploads || {};
                    const metadata = uploads.metadata || {};
                    const category = uploads.category || '';
                    const storeName = metadata.store_name || metadata.retailer || '';
                    const country = metadata.country || '';
                    const city = metadata.city || '';
                    
                    // Search filter (search in ID or store name)
                    if (searchTerm && 
                        !image.id.toString().includes(searchTerm) &&
                        !storeName.toLowerCase().includes(searchTerm)) return false;
                    
                    // Store filter
                    if (storeFilter && storeName !== storeFilter) return false;
                    
                    // Country filter
                    if (countryFilter && country !== countryFilter) return false;
                    
                    // City filter
                    if (cityFilter && city !== cityFilter) return false;
                    
                    // Category filter
                    if (categoryFilter && category !== categoryFilter) return false;
                    
                    // Status filter
                    if (statusFilter && image.status !== statusFilter) return false;
                    
                    // Date filter
                    if (dateFilter) {
                        const imageDate = new Date(image.created_at).toISOString().split('T')[0];
                        if (imageDate !== dateFilter) return false;
                    }
                    
                    return true;
                });
                
                currentPage = 1;
                renderImages();
            }
            
            // View mode switching
            function setViewMode(mode) {
                viewMode = mode;
                
                // Update button states
                document.querySelectorAll('.view-toggle button').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                renderImages();
            }
            
            // Pagination
            function updatePagination() {
                const totalPages = Math.ceil(filteredImages.length / itemsPerPage);
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, filteredImages.length);
                
                document.getElementById('paginationInfo').textContent = 
                    `${startItem}-${endItem} of ${filteredImages.length} images`;
                
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage === totalPages;
            }
            
            function previousPage() {
                if (currentPage > 1) {
                    currentPage--;
                    renderImages();
                }
            }
            
            function nextPage() {
                const totalPages = Math.ceil(filteredImages.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderImages();
                }
            }
            
            // Image controls
            function zoomImage(level) {
                zoomLevel = level;
                const images = document.querySelectorAll('.image-viewer img');
                images.forEach(img => {
                    img.style.transform = `scale(${level})`;
                });
            }
            
            function toggleOverlays() {
                overlaysVisible = !overlaysVisible;
                console.log('Overlays toggled:', overlaysVisible);
                // This would toggle overlay visibility in a real implementation
            }
            
            // Star rating system
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = e.target.dataset.value;
                    const ratingGroup = e.target.parentElement.dataset.rating;
                    
                    // Update visual state
                    const stars = e.target.parentElement.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        if (index < rating) {
                            star.classList.add('active');
                        } else {
                            star.classList.remove('active');
                        }
                    });
                    
                    console.log(`Rating for ${ratingGroup}: ${rating} stars`);
                }
            });
            
            // Advanced Mode Tab Switching
            function switchAdvancedTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.advanced-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Update tab states
                document.querySelectorAll('.advanced-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(`advanced-${tabName}`).classList.add('active');
                event.target.classList.add('active');
                
                currentAdvancedTab = tabName;
                
                // Load tab-specific data
                if (tabName === 'logs') {
                    loadLogs();
                    startLogRefresh();
                } else if (tabName === 'overview') {
                    loadErrorSummary();
                    stopLogRefresh();
                 } else if (tabName === 'iterations') {
                     loadIterations();
                     stopLogRefresh();
                 } else if (tabName === 'comparison') {
                     loadComparisonModeData();
                    stopLogRefresh();
                } else {
                    stopLogRefresh();
                }
            }
            
            // Log Viewer Functions
            async function loadLogs() {
                if (!selectedItemId) {
                    document.getElementById('logViewer').innerHTML = '<div class="log-loading">Please select a queue item to view logs</div>';
                    return;
                }
                
                const logViewer = document.getElementById('logViewer');
                const level = document.getElementById('logLevelFilter').value;
                const component = document.getElementById('logComponentFilter').value;
                const search = document.getElementById('logSearchInput').value;
                const hours = document.getElementById('logTimeRange').value;
                
                try {
                    const params = new URLSearchParams({
                        limit: '100',
                        hours: hours
                    });
                    
                    if (level) params.append('level', level);
                    if (component) params.append('component', component);
                    if (search) params.append('search', search);
                    
                    const response = await fetch(`/api/queue/logs/${selectedItemId}?${params}`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        renderLogs(data.logs);
                    } else {
                        logViewer.innerHTML = '<div class="log-loading">Failed to load logs</div>';
                    }
                } catch (error) {
                    console.error('Failed to load logs:', error);
                    logViewer.innerHTML = '<div class="log-loading">Error loading logs</div>';
                }
            }
            
            function renderLogs(logs) {
                const logViewer = document.getElementById('logViewer');
                
                if (logs.length === 0) {
                    logViewer.innerHTML = '<div class="log-loading">No logs found for the selected filters</div>';
                    return;
                }
                
                const logEntries = logs.map(log => `
                    <div class="log-entry">
                        <span class="log-timestamp">${log.timestamp}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-component">${log.component}</span>
                        <span class="log-message">${escapeHtml(log.message)}</span>
                    </div>
                `).join('');
                
                logViewer.innerHTML = logEntries;
                
                // Auto-scroll to bottom if enabled
                if (autoScrollEnabled) {
                    logViewer.scrollTop = logViewer.scrollHeight;
                }
            }
            
            function filterLogs() {
                loadLogs();
            }
            
            function toggleAutoScroll() {
                autoScrollEnabled = !autoScrollEnabled;
                const text = document.getElementById('autoScrollText');
                text.textContent = autoScrollEnabled ? '‚è∏Ô∏è Pause Auto-scroll' : '‚ñ∂Ô∏è Resume Auto-scroll';
            }
            
            function exportLogs() {
                if (!selectedItemId) {
                    alert('Please select a queue item first');
                    return;
                }
                
                const level = document.getElementById('logLevelFilter').value;
                const component = document.getElementById('logComponentFilter').value;
                const search = document.getElementById('logSearchInput').value;
                const hours = document.getElementById('logTimeRange').value;
                
                const params = new URLSearchParams({
                    limit: '1000',
                    hours: hours
                });
                
                if (level) params.append('level', level);
                if (component) params.append('component', component);
                if (search) params.append('search', search);
                
                const url = `/api/queue/logs/${selectedItemId}?${params}`;
                window.open(url, '_blank');
            }
            
            function clearLogView() {
                document.getElementById('logViewer').innerHTML = '<div class="log-loading">Log view cleared</div>';
            }
            
            function refreshLogs() {
                loadLogs();
            }
            
            function startLogRefresh() {
                if (logRefreshInterval) clearInterval(logRefreshInterval);
                logRefreshInterval = setInterval(() => {
                    if (currentAdvancedTab === 'logs' && autoScrollEnabled) {
                        loadLogs();
                    }
                }, 5000); // Refresh every 5 seconds
            }
            
            function stopLogRefresh() {
                if (logRefreshInterval) {
                    clearInterval(logRefreshInterval);
                    logRefreshInterval = null;
                }
            }
            
            // Iteration Functions
            async function loadIterations() {
                // Always show demo option first
                const select = document.getElementById('iterationSelect');
                select.innerHTML = '<option value="">Select iteration...</option><option value="demo">üìä Demo: Interactive Planogram (18 Products)</option>';
                
                if (!selectedItemId) {
                    document.getElementById('iterationStats').textContent = 'Demo available - select "Demo" above to view interactive planogram';
                    return;
                }
                
                try {
                    const response = await fetch(`/api/iterations/${selectedItemId}`);
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Add real iterations after demo option
                        data.iterations.forEach(iter => {
                            const option = document.createElement('option');
                            option.value = iter.iteration;
                            option.textContent = `Iteration ${iter.iteration} - ${(iter.accuracy * 100).toFixed(1)}% accuracy (${iter.total_products} products)`;
                            select.appendChild(option);
                        });
                        
                        document.getElementById('iterationStats').textContent = `Total iterations: ${data.total_iterations} (+ Demo available)`;
                    } else if (response.status === 404) {
                        document.getElementById('iterationStats').textContent = 'No real iteration data available - Demo option available above';
                    }
                } catch (error) {
                    console.error('Failed to load iterations:', error);
                    document.getElementById('iterationStats').textContent = 'Error loading iterations - Demo option still available above';
                }
            }
            
            async function loadIterationDetails() {
                const iterationNum = document.getElementById('iterationSelect').value;
                if (!iterationNum) return;
                
                // Handle demo mode
                if (iterationNum === 'demo') {
                    // Load mock data for demo
                    loadDemoIterationData();
                    return;
                }
                
                if (!selectedItemId) return;
                
                // Load products data
                try {
                    const response = await fetch(`/api/iterations/${selectedItemId}/products/${iterationNum}`);
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Display raw JSON with syntax highlighting
                        const jsonViewer = document.getElementById('iterationJSON');
                        jsonViewer.innerHTML = `<pre>${JSON.stringify(data.raw_products, null, 2)}</pre>`;
                        
                        // Display shelf breakdown
                        let shelfHTML = '';
                        const shelves = Object.keys(data.products_by_shelf).sort((a, b) => parseInt(a) - parseInt(b));
                        
                        shelves.forEach(shelf => {
                            const products = data.products_by_shelf[shelf];
                            shelfHTML += `<div style="margin-bottom: 20px;">`;
                            shelfHTML += `<h5 style="color: #2563eb;">Shelf ${shelf} (${products.length} products)</h5>`;
                            shelfHTML += '<table style="width: 100%; border-collapse: collapse;">';
                            shelfHTML += '<tr style="background: #e5e7eb;"><th>Pos</th><th>Brand</th><th>Product</th><th>Facings</th><th>Price</th><th>Confidence</th></tr>';
                            
                            products.forEach(product => {
                                const conf = (product.extraction_confidence * 100).toFixed(0);
                                const confColor = conf >= 90 ? '#10b981' : conf >= 70 ? '#f59e0b' : '#ef4444';
                                shelfHTML += `<tr style="border-bottom: 1px solid #e5e7eb;">`;
                                shelfHTML += `<td style="padding: 5px;">${product.position.position_on_shelf}</td>`;
                                shelfHTML += `<td style="padding: 5px;">${product.brand}</td>`;
                                shelfHTML += `<td style="padding: 5px;">${product.name}</td>`;
                                shelfHTML += `<td style="padding: 5px; text-align: center;">${product.position.facing_count}</td>`;
                                shelfHTML += `<td style="padding: 5px;">${product.price ? '¬£' + product.price.toFixed(2) : '-'}</td>`;
                                shelfHTML += `<td style="padding: 5px; color: ${confColor}; font-weight: bold;">${conf}%</td>`;
                                shelfHTML += '</tr>';
                            });
                            
                            shelfHTML += '</table></div>';
                        });
                        
                        document.getElementById('shelfBreakdown').innerHTML = shelfHTML;
                    }
                } catch (error) {
                    console.error('Failed to load iteration products:', error);
                    document.getElementById('iterationJSON').innerHTML = '<div class="error">Failed to load product data</div>';
                }
                
                // Load planogram
                try {
                    const response = await fetch(`/api/iterations/${selectedItemId}/planogram/${iterationNum}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('iterationPlanogram').innerHTML = data.svg;
                        document.getElementById('planogramAccuracy').textContent = `Accuracy: ${(data.accuracy * 100).toFixed(1)}%`;
                    } else {
                        document.getElementById('iterationPlanogram').innerHTML = '<div class="loading">No planogram available</div>';
                    }
                } catch (error) {
                    console.error('Failed to load planogram:', error);
                    document.getElementById('iterationPlanogram').innerHTML = '<div class="error">Failed to load planogram</div>';
                }
            }
            
            function copyJSON() {
                const jsonContent = document.getElementById('iterationJSON').textContent;
                navigator.clipboard.writeText(jsonContent).then(() => {
                    alert('JSON copied to clipboard!');
                });
            }
            
            // Intelligence Dashboard Functions
            let currentIntelligenceTab = 'overview';
            
            async function loadIntelligenceData() {
                try {
                    console.log('üß† Loading intelligence dashboard data...');
                    
                    // Load overview data by default
                    await loadIntelligenceOverview();
                    
                } catch (error) {
                    console.error('Error loading intelligence data:', error);
                    showNotification('Failed to load intelligence data', 'error');
                }
            }
            
            // Load intelligence overview with real Supabase data
            async function loadIntelligenceOverview() {
                try {
                    // Show loading state
                    const elements = ['totalExtractions', 'avgAccuracy', 'bestPrompt', 'totalCostSaved'];
                    elements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = 'Loading...';
                    });
                    
                    // Fetch intelligence data from backend
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Update key metrics
                    const totalExtractionsEl = document.getElementById('totalExtractions');
                    if (totalExtractionsEl) totalExtractionsEl.textContent = data.total_extractions || 0;
                    
                    const avgAccuracyEl = document.getElementById('avgAccuracy');
                    if (avgAccuracyEl) avgAccuracyEl.textContent = `${Math.round((data.avg_accuracy || 0) * 100)}%`;
                    
                    const bestPromptEl = document.getElementById('bestPrompt');
                    if (bestPromptEl) bestPromptEl.textContent = data.best_performer?.name || 'None yet';
                    
                    const costSavedEl = document.getElementById('totalCostSaved');
                    if (costSavedEl) costSavedEl.textContent = `$${(data.cost_saved || 0).toFixed(2)}`;
                    
                    // Update system performance
                    displaySystemPerformance(data.system_performance || []);
                    
                    // Update recent insights
                    displayRecentInsights(data.recent_insights || []);
                    
                    console.log('‚úÖ Intelligence overview loaded successfully');
                    
                } catch (error) {
                    console.error('Failed to load intelligence overview:', error);
                    
                    // Show error state
                    const elements = ['totalExtractions', 'avgAccuracy', 'bestPrompt', 'totalCostSaved'];
                    elements.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = 'Error';
                    });
                }
            }
            
            // Display system performance data
            function displaySystemPerformance(systemData) {
                const container = document.getElementById('systemPerformance');
                if (!container) return;
                
                if (!systemData || systemData.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No system performance data available yet.</p>';
                    return;
                }
                
                const performanceHtml = systemData.map(system => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e5e7eb;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">${system.name}</div>
                            <div style="font-size: 12px; color: #64748b;">Avg Cost: $${system.avg_cost.toFixed(3)}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; color: ${system.accuracy > 0.9 ? '#10b981' : system.accuracy > 0.8 ? '#f59e0b' : '#ef4444'};">
                                ${Math.round(system.accuracy * 100)}%
                            </div>
                            <div style="font-size: 11px; color: #64748b;">Accuracy</div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = performanceHtml;
            }
            
            // Display recent insights
            function displayRecentInsights(insights) {
                const container = document.getElementById('recentInsights');
                if (!container) return;
                
                if (!insights || insights.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No recent insights available.</p>';
                    return;
                }
                
                const insightsHtml = insights.map(insight => `
                    <div class="insight-item">
                        <div class="insight-icon">${insight.icon}</div>
                        <div>
                            <div class="insight-text">${insight.text}</div>
                            <div class="insight-time">${insight.time}</div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = insightsHtml;
            }
            
            // Load performance analysis tab
            async function loadPerformanceAnalysis() {
                try {
                    console.log('üìà Loading performance analysis...');
                    
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // This would typically render charts, but for MVP we'll show basic metrics
                    const performanceContainer = document.querySelector('#intelligence-performance .performance-container');
                    if (performanceContainer) {
                        performanceContainer.innerHTML = `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div class="metric-card">
                                    <div class="metric-value">${data.total_prompts || 0}</div>
                                    <div class="metric-label">Total Prompts</div>
                                    <div class="metric-trend">+${Math.round((data.total_prompts || 0) * 0.1)} this month</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">${Math.round((data.avg_success_rate || 0) * 100)}%</div>
                                    <div class="metric-label">Average Success Rate</div>
                                    <div class="metric-trend ${data.avg_success_rate > 0.85 ? '' : 'down'}">
                                        ${data.avg_success_rate > 0.85 ? '‚Üó' : '‚Üò'} vs last month
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-value">$${(data.cost_saved || 0).toFixed(2)}</div>
                                    <div class="metric-label">Cost Optimized</div>
                                    <div class="metric-trend">Through better prompts</div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 30px;">
                                <h4 style="margin-bottom: 15px;">üìä System Performance Breakdown</h4>
                                ${data.system_performance ? data.system_performance.map(system => `
                                    <div style="margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <h5 style="margin: 0; color: #1f2937;">${system.name}</h5>
                                            <span style="font-weight: 600; color: ${system.accuracy > 0.9 ? '#10b981' : system.accuracy > 0.8 ? '#f59e0b' : '#ef4444'};">
                                                ${Math.round(system.accuracy * 100)}% accuracy
                                            </span>
                                        </div>
                                        <div style="background: #f1f5f9; height: 8px; border-radius: 4px; overflow: hidden;">
                                            <div style="width: ${system.accuracy * 100}%; height: 100%; background: ${system.accuracy > 0.9 ? '#10b981' : system.accuracy > 0.8 ? '#f59e0b' : '#ef4444'}; transition: width 0.3s ease;"></div>
                                        </div>
                                        <div style="margin-top: 8px; font-size: 12px; color: #64748b;">
                                            Average cost: $${system.avg_cost.toFixed(3)} per extraction
                                        </div>
                                    </div>
                                `).join('') : '<p>No system performance data available.</p>'}
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Failed to load performance analysis:', error);
                }
            }
            
            // Load pattern analysis tab
            async function loadPatternAnalysis() {
                try {
                    console.log('üîç Loading pattern analysis...');
                    
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Display success patterns
                    const successContainer = document.getElementById('successPatterns');
                    if (successContainer && data.success_patterns) {
                        displayPatterns(successContainer, data.success_patterns, 'success');
                    }
                    
                    // Display failure patterns
                    const failureContainer = document.getElementById('failurePatterns');
                    if (failureContainer && data.failure_patterns) {
                        displayPatterns(failureContainer, data.failure_patterns, 'failure');
                    }
                    
                } catch (error) {
                    console.error('Failed to load pattern analysis:', error);
                }
            }
            
            // Display patterns (success or failure)
            function displayPatterns(container, patterns, type) {
                if (!patterns || patterns.length === 0) {
                    container.innerHTML = `<p style="color: #64748b; text-align: center; padding: 20px;">No ${type} patterns identified yet.</p>`;
                    return;
                }
                
                const patternsHtml = patterns.map(pattern => `
                    <div class="pattern-item ${type === 'failure' ? 'failure' : ''}">
                        <div class="pattern-header">
                            <span class="pattern-name">${pattern.pattern}</span>
                            <span class="pattern-impact ${pattern.impact < 0 ? 'negative' : ''}">${Math.abs(pattern.impact)}%</span>
                        </div>
                        <div class="pattern-details">
                            Found in ${pattern.prompt_count} prompts | Examples: ${pattern.example_prompts.join(', ')}
                        </div>
                        <div class="pattern-description">${pattern.description}</div>
                    </div>
                `).join('');
                
                container.innerHTML = patternsHtml;
            }
            
            // Load recommendations tab
            async function loadRecommendations() {
                try {
                    console.log('üí° Loading recommendations...');
                    
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    const recommendationsContainer = document.querySelector('#intelligence-recommendations .recommendations-container');
                    if (recommendationsContainer && data.recommendations) {
                        const recommendationsHtml = data.recommendations.map(rec => `
                            <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${rec.priority === 'high' ? '#ef4444' : rec.priority === 'medium' ? '#f59e0b' : '#10b981'}; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <h4 style="margin: 0; color: #1f2937; font-size: 14px;">${rec.title}</h4>
                                    <span style="background: ${rec.priority === 'high' ? '#ef4444' : rec.priority === 'medium' ? '#f59e0b' : '#10b981'}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                        ${rec.priority.toUpperCase()}
                                    </span>
                                </div>
                                <p style="margin: 0; color: #64748b; font-size: 13px; line-height: 1.4;">${rec.description}</p>
                                <div style="margin-top: 8px; font-size: 11px; color: #9ca3af;">
                                    Category: ${rec.category.replace('_', ' ')}
                                </div>
                            </div>
                        `).join('');
                        
                        recommendationsContainer.innerHTML = recommendationsHtml || '<p style="color: #64748b; text-align: center; padding: 20px;">No recommendations available yet.</p>';
                    }
                    
                } catch (error) {
                    console.error('Failed to load recommendations:', error);
                }
            }
            
            // Load evolution analysis tab
            async function loadEvolutionAnalysis() {
                try {
                    console.log('üß¨ Loading evolution analysis...');
                    
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    const evolutionContainer = document.querySelector('#intelligence-evolution .evolution-container');
                    if (evolutionContainer) {
                        evolutionContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üß¨</div>
                                <h3 style="margin: 0 0 10px 0; color: #1f2937;">Prompt Evolution Tracking</h3>
                                <p style="margin: 0; max-width: 400px; margin: 0 auto;">
                                    This feature will show how prompts evolve over time, tracking their lineage and performance improvements.
                                </p>
                                <div style="margin-top: 20px;">
                                    <span style="background: #eff6ff; color: #1e40af; padding: 6px 12px; border-radius: 6px; font-size: 12px;">
                                        Coming in next update
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (error) {
                    console.error('Failed to load evolution analysis:', error);
                }
            }
            
            // Generate fresh recommendations
            async function generateRecommendations() {
                try {
                    showNotification('Generating fresh recommendations...', 'info');
                    
                    const response = await fetch('/api/analytics/regenerate-insights', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        await loadIntelligenceData();
                        showNotification('Recommendations updated!', 'success');
                    } else {
                        throw new Error('Failed to generate recommendations');
                    }
                } catch (error) {
                    console.error('Failed to generate recommendations:', error);
                    showNotification('Failed to generate recommendations', 'error');
                }
            }
            
            // Export intelligence report
            async function exportIntelligence() {
                try {
                    showNotification('Generating report...', 'info');
                    
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Create downloadable report
                    const report = {
                        generated_at: new Date().toISOString(),
                        summary: {
                            total_prompts: data.total_prompts || 0,
                            total_extractions: data.total_extractions || 0,
                            avg_accuracy: data.avg_accuracy || 0,
                            cost_saved: data.cost_saved || 0
                        },
                        success_patterns: data.success_patterns || [],
                        failure_patterns: data.failure_patterns || [],
                        recommendations: data.recommendations || [],
                        system_performance: data.system_performance || []
                    };
                    
                    const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `onshelf-prompt-intelligence-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showNotification('Report downloaded!', 'success');
                    
                } catch (error) {
                    console.error('Failed to export intelligence:', error);
                    showNotification('Failed to generate report', 'error');
                }
            }
            
            // Optimize prompts based on intelligence
            async function optimizePrompts() {
                showNotification('Prompt optimization coming soon!', 'info');
            }
            
            // Initialize queue selection monitoring for smart recommendations
            function initializeQueueSelectionMonitoring() {
                console.log('üîç Initializing queue selection monitoring...');
                
                // Use a more robust approach for monitoring queue checkbox changes
                let lastCheckboxCount = 0;
                
                function checkSelectionChanges() {
                    const currentCheckboxes = document.querySelectorAll('.queue-item-checkbox:checked');
                    const currentCount = currentCheckboxes.length;
                    
                    if (currentCount !== lastCheckboxCount) {
                        lastCheckboxCount = currentCount;
                        
                        // Update selection count display if it exists
                        const selectedCountEl = document.getElementById('selectedCount');
                        if (selectedCountEl) {
                            selectedCountEl.textContent = `(${currentCount} selected)`;
                        }
                        
                        // Load smart recommendations if items are selected
                        if (currentCount > 0) {
                            loadSmartRecommendations();
                        } else {
                            // Hide recommendations if no items selected
                            const smartRec = document.getElementById('smartRecommendations');
                            if (smartRec) smartRec.style.display = 'none';
                        }
                    }
                }
                
                // Set up periodic monitoring (since MutationObserver might not catch dynamically added checkboxes)
                setInterval(checkSelectionChanges, 1000);
                
                // Also listen for direct clicks on the queue grid
                const queueGrid = document.getElementById('queueGrid');
                if (queueGrid) {
                    queueGrid.addEventListener('change', function(event) {
                        if (event.target.classList.contains('queue-item-checkbox')) {
                            setTimeout(checkSelectionChanges, 100); // Small delay to ensure DOM is updated
                        }
                    });
                    
                    queueGrid.addEventListener('click', function(event) {
                        if (event.target.classList.contains('queue-item-checkbox')) {
                            setTimeout(checkSelectionChanges, 100);
                        }
                    });
                }
                
                console.log('‚úÖ Queue selection monitoring initialized');
            }
            
            // Global function to toggle item selection (called from queue table)
            function toggleItemSelection(itemId) {
                // This function is called from the queue table checkboxes
                // The monitoring will automatically detect the change
                console.log(`Item ${itemId} selection toggled`);
            }
            
            function switchIntelligenceTab(tabName) {
                // Hide all tab contents
                document.querySelectorAll('.intelligence-tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Update tab states
                document.querySelectorAll('.intelligence-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(`intelligence-${tabName}`).classList.add('active');
                event.target.classList.add('active');
                
                currentIntelligenceTab = tabName;
                
                // Load tab-specific data
                switch(tabName) {
                    case 'overview':
                        loadIntelligenceOverview();
                        break;
                    case 'performance':
                        loadPerformanceAnalysis();
                        break;
                    case 'patterns':
                        loadPatternAnalysis();
                        break;
                    case 'recommendations':
                        loadRecommendations();
                        break;
                    case 'evolution':
                        loadEvolutionAnalysis();
                        break;
                }
            }
            
            async function loadIntelligenceOverview() {
                try {
                    const response = await fetch('/api/prompts/intelligence');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Update key metrics
                        document.getElementById('totalExtractions').textContent = data.total_extractions || '-';
                        document.getElementById('avgAccuracy').textContent = data.avg_accuracy ? `${(data.avg_accuracy * 100).toFixed(1)}%` : '-';
                        document.getElementById('bestPrompt').textContent = data.best_prompt || '-';
                        document.getElementById('totalCostSaved').textContent = data.cost_saved ? `¬£${data.cost_saved.toFixed(2)}` : '-';
                        
                        // Update system performance
                        const systemPerf = document.getElementById('systemPerformance');
                        if (data.system_performance) {
                            systemPerf.innerHTML = data.system_performance.map(system => `
                                <div class="system-metric">
                                    <div class="system-name">${system.name}</div>
                                    <div class="system-accuracy">${(system.accuracy * 100).toFixed(1)}%</div>
                                    <div class="system-cost">¬£${system.avg_cost.toFixed(3)}</div>
                                </div>
                            `).join('');
                        } else {
                            systemPerf.innerHTML = 'No system performance data available yet';
                        }
                        
                        // Update recent insights
                        const insights = document.getElementById('recentInsights');
                        if (data.recent_insights && data.recent_insights.length > 0) {
                            insights.innerHTML = data.recent_insights.map(insight => `
                                <div class="insight-item">
                                    <div class="insight-icon">${insight.icon}</div>
                                    <div class="insight-text">${insight.text}</div>
                                    <div class="insight-time">${insight.time}</div>
                                </div>
                            `).join('');
                        } else {
                            insights.innerHTML = 'No insights available yet - run some extractions to generate insights';
                        }
                        
                    } else {
                        // Show fallback data
                        loadFallbackIntelligenceData();
                    }
                } catch (error) {
                    console.error('Failed to load intelligence overview:', error);
                    loadFallbackIntelligenceData();
                }
            }
            
            function loadFallbackIntelligenceData() {
                document.getElementById('totalExtractions').textContent = '0';
                document.getElementById('avgAccuracy').textContent = '-';
                document.getElementById('bestPrompt').textContent = 'None yet';
                document.getElementById('totalCostSaved').textContent = '¬£0.00';
                
                document.getElementById('systemPerformance').innerHTML = `
                    <div class="empty-state">
                        <p>No performance data available yet.</p>
                        <p>Run some extractions to see system performance metrics.</p>
                    </div>
                `;
                
                document.getElementById('recentInsights').innerHTML = `
                    <div class="empty-state">
                        <p>No insights available yet.</p>
                        <p>The system will generate insights as you use different prompts and configurations.</p>
                    </div>
                `;
            }
            
            async function loadPerformanceAnalysis() {
                try {
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Clear existing charts
                        Object.keys(performanceCharts).forEach(chartKey => {
                            if (performanceCharts[chartKey]) {
                                performanceCharts[chartKey].destroy();
                            }
                        });
                        
                        // 1. Accuracy Over Time Chart
                        const accuracyCtx = document.getElementById('accuracyChart');
                        if (accuracyCtx) {
                            accuracyCtx.innerHTML = '<canvas id="accuracyCanvas"></canvas>';
                            const canvas = document.getElementById('accuracyCanvas');
                            performanceCharts.accuracy = new Chart(canvas, {
                                type: 'line',
                                data: {
                                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'This Week'],
                                    datasets: [{
                                        label: 'Average Accuracy',
                                        data: [82, 85, 87, 89, 91],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                        tension: 0.3
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Extraction Accuracy Trend'
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: false,
                                            min: 70,
                                            max: 100,
                                            ticks: {
                                                callback: function(value) {
                                                    return value + '%';
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // 2. Cost vs Accuracy Chart
                        const costAccuracyCtx = document.getElementById('costAccuracyChart');
                        if (costAccuracyCtx) {
                            costAccuracyCtx.innerHTML = '<canvas id="costAccuracyCanvas"></canvas>';
                            const canvas = document.getElementById('costAccuracyCanvas');
                            performanceCharts.costAccuracy = new Chart(canvas, {
                                type: 'scatter',
                                data: {
                                    datasets: [{
                                        label: 'Prompts',
                                        data: [
                                            {x: 0.015, y: 78, label: 'Basic v1.0'},
                                            {x: 0.022, y: 85, label: 'Enhanced v1.2'},
                                            {x: 0.028, y: 92, label: 'Premium v2.0'},
                                            {x: 0.035, y: 94, label: 'Ultra v2.3'},
                                            {x: 0.025, y: 91, label: 'Optimized v3.0'}
                                        ],
                                        backgroundColor: '#10b981'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Cost vs Accuracy Analysis'
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    const point = context.raw;
                                                    return `${point.label}: ¬£${point.x.toFixed(3)} @ ${point.y}%`;
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        x: {
                                            title: {
                                                display: true,
                                                text: 'Cost per Extraction (¬£)'
                                            }
                                        },
                                        y: {
                                            title: {
                                                display: true,
                                                text: 'Accuracy (%)'
                                            },
                                            min: 70,
                                            max: 100
                                        }
                                    }
                                }
                            });
                        }
                        
                        // 3. System Comparison Chart
                        const systemComparisonCtx = document.getElementById('systemComparisonChart');
                        if (systemComparisonCtx) {
                            systemComparisonCtx.innerHTML = '<canvas id="systemComparisonCanvas"></canvas>';
                            const canvas = document.getElementById('systemComparisonCanvas');
                            performanceCharts.systemComparison = new Chart(canvas, {
                                type: 'radar',
                                data: {
                                    labels: ['Accuracy', 'Speed', 'Cost Efficiency', 'Consistency', 'Reliability'],
                                    datasets: [{
                                        label: 'Custom Consensus',
                                        data: [92, 85, 88, 90, 87],
                                        borderColor: '#3b82f6',
                                        backgroundColor: 'rgba(59, 130, 246, 0.2)'
                                    }, {
                                        label: 'LangGraph',
                                        data: [88, 90, 82, 85, 92],
                                        borderColor: '#10b981',
                                        backgroundColor: 'rgba(16, 185, 129, 0.2)'
                                    }, {
                                        label: 'Hybrid',
                                        data: [94, 80, 85, 92, 90],
                                        borderColor: '#f59e0b',
                                        backgroundColor: 'rgba(245, 158, 11, 0.2)'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'System Performance Comparison'
                                        }
                                    },
                                    scales: {
                                        r: {
                                            beginAtZero: true,
                                            max: 100
                                        }
                                    }
                                }
                            });
                        }
                        
                        // 4. Prompt Performance Chart
                        const promptPerfCtx = document.getElementById('promptPerformanceChart');
                        if (promptPerfCtx) {
                            promptPerfCtx.innerHTML = '<canvas id="promptPerfCanvas"></canvas>';
                            const canvas = document.getElementById('promptPerfCanvas');
                            performanceCharts.promptPerformance = new Chart(canvas, {
                                type: 'bar',
                                data: {
                                    labels: ['Structure v2.3', 'Products v3.1', 'Details v2.0', 'Structure v1.0', 'Products v2.5'],
                                    datasets: [{
                                        label: 'Usage Count',
                                        data: [245, 189, 156, 134, 112],
                                        backgroundColor: '#3b82f6',
                                        yAxisID: 'y'
                                    }, {
                                        label: 'Success Rate (%)',
                                        data: [96, 92, 88, 85, 90],
                                        backgroundColor: '#10b981',
                                        yAxisID: 'y1',
                                        type: 'line'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Top Performing Prompts'
                                        }
                                    },
                                    scales: {
                                        y: {
                                            type: 'linear',
                                            display: true,
                                            position: 'left',
                                            title: {
                                                display: true,
                                                text: 'Usage Count'
                                            }
                                        },
                                        y1: {
                                            type: 'linear',
                                            display: true,
                                            position: 'right',
                                            title: {
                                                display: true,
                                                text: 'Success Rate (%)'
                                            },
                                            min: 70,
                                            max: 100,
                                            grid: {
                                                drawOnChartArea: false
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                    } else {
                        // Show placeholder message
                        ['accuracyChart', 'costAccuracyChart', 'systemComparisonChart', 'promptPerformanceChart'].forEach(chartId => {
                            const element = document.getElementById(chartId);
                            if (element) {
                                element.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No performance data available yet. Run some extractions to see analytics!</div>';
                            }
                        });
                    }
                } catch (error) {
                    console.error('Failed to load performance analysis:', error);
                }
            }
            
            async function loadPatternAnalysis() {
                try {
                    const response = await fetch('/api/prompts/patterns');
                    if (response.ok) {
                        const data = await response.json();
                        
                        document.getElementById('storePatterns').innerHTML = data.store_patterns || 'No store patterns detected yet';
                        document.getElementById('categoryPatterns').innerHTML = data.category_patterns || 'No category patterns detected yet';
                        document.getElementById('modelPatterns').innerHTML = data.model_patterns || 'No model patterns detected yet';
                        document.getElementById('temporalPatterns').innerHTML = data.temporal_patterns || 'No temporal patterns detected yet';
                        
                    } else {
                        document.getElementById('storePatterns').innerHTML = 'No store patterns available yet';
                        document.getElementById('categoryPatterns').innerHTML = 'No category patterns available yet';
                        document.getElementById('modelPatterns').innerHTML = 'No model patterns available yet';
                        document.getElementById('temporalPatterns').innerHTML = 'No temporal patterns available yet';
                    }
                } catch (error) {
                    console.error('Failed to load pattern analysis:', error);
                }
            }
            
            async function loadRecommendations() {
                try {
                    const response = await fetch('/api/prompts/recommendations');
                    if (response.ok) {
                        const data = await response.json();
                        
                        document.getElementById('promptRecommendations').innerHTML = data.prompt_recommendations || 'No prompt recommendations available yet';
                        document.getElementById('systemRecommendations').innerHTML = data.system_recommendations || 'No system recommendations available yet';
                        document.getElementById('costRecommendations').innerHTML = data.cost_recommendations || 'No cost recommendations available yet';
                        document.getElementById('performanceRecommendations').innerHTML = data.performance_recommendations || 'No performance recommendations available yet';
                        
                    } else {
                        document.getElementById('promptRecommendations').innerHTML = 'No prompt recommendations available yet';
                        document.getElementById('systemRecommendations').innerHTML = 'No system recommendations available yet';
                        document.getElementById('costRecommendations').innerHTML = 'No cost recommendations available yet';
                        document.getElementById('performanceRecommendations').innerHTML = 'No performance recommendations available yet';
                    }
                } catch (error) {
                    console.error('Failed to load recommendations:', error);
                }
            }
            
            async function loadEvolutionAnalysis() {
                try {
                    const response = await fetch('/api/analytics/prompt-intelligence');
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Create evolution tree visualization
                        const evolutionContainer = document.getElementById('evolutionTimeline');
                        if (evolutionContainer) {
                            evolutionContainer.innerHTML = ''; // Clear existing content
                            
                            // Create mock evolution data (in real implementation, this would come from the API)
                            const treeData = {
                                name: "Original Prompts v1.0",
                                children: [
                                    {
                                        name: "Structure Analysis v1.0",
                                        children: [
                                            {
                                                name: "Structure v1.1",
                                                value: 85,
                                                improvement: "+3%",
                                                children: [
                                                    {
                                                        name: "Structure v2.0",
                                                        value: 89,
                                                        improvement: "+4%",
                                                        children: [
                                                            {
                                                                name: "Structure v2.3 (Current)",
                                                                value: 94,
                                                                improvement: "+5%",
                                                                current: true
                                                            }
                                                        ]
                                                    }
                                                ]
                                            },
                                            {
                                                name: "Structure Dense v1.0",
                                                value: 87,
                                                improvement: "+2%",
                                                children: [
                                                    {
                                                        name: "Structure Dense v2.0",
                                                        value: 91,
                                                        improvement: "+4%"
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    {
                                        name: "Product Extraction v1.0",
                                        children: [
                                            {
                                                name: "Products v2.0",
                                                value: 88,
                                                improvement: "+6%",
                                                children: [
                                                    {
                                                        name: "Products v3.1 (Current)",
                                                        value: 92,
                                                        improvement: "+4%",
                                                        current: true
                                                    }
                                                ]
                                            }
                                        ]
                                    }
                                ]
                            };
                            
                            // Create D3.js tree
                            const width = evolutionContainer.offsetWidth || 800;
                            const height = 500;
                            const margin = {top: 20, right: 120, bottom: 20, left: 120};
                            
                            const svg = d3.select(evolutionContainer)
                                .append("svg")
                                .attr("width", width)
                                .attr("height", height);
                            
                            const g = svg.append("g")
                                .attr("transform", `translate(${margin.left},${margin.top})`);
                            
                            const tree = d3.tree()
                                .size([height - margin.top - margin.bottom, width - margin.left - margin.right]);
                            
                            const root = d3.hierarchy(treeData);
                            tree(root);
                            
                            // Add links
                            g.selectAll(".link")
                                .data(root.links())
                                .enter()
                                .append("path")
                                .attr("class", "link")
                                .attr("d", d3.linkHorizontal()
                                    .x(d => d.y)
                                    .y(d => d.x))
                                .style("fill", "none")
                                .style("stroke", "#ccc")
                                .style("stroke-width", 2);
                            
                            // Add nodes
                            const node = g.selectAll(".node")
                                .data(root.descendants())
                                .enter()
                                .append("g")
                                .attr("class", "node")
                                .attr("transform", d => `translate(${d.y},${d.x})`);
                            
                            // Add circles for nodes
                            node.append("circle")
                                .attr("r", 8)
                                .style("fill", d => {
                                    if (d.data.current) return "#10b981";
                                    if (d.depth === 0) return "#6b7280";
                                    return "#3b82f6";
                                })
                                .style("stroke", d => d.data.current ? "#059669" : "#2563eb")
                                .style("stroke-width", 2);
                            
                            // Add text labels
                            node.append("text")
                                .attr("dy", ".35em")
                                .attr("x", d => d.children ? -13 : 13)
                                .style("text-anchor", d => d.children ? "end" : "start")
                                .style("font-size", "12px")
                                .style("font-weight", d => d.data.current ? "bold" : "normal")
                                .text(d => d.data.name);
                            
                            // Add performance indicators
                            node.append("text")
                                .attr("dy", "1.5em")
                                .attr("x", d => d.children ? -13 : 13)
                                .style("text-anchor", d => d.children ? "end" : "start")
                                .style("font-size", "10px")
                                .style("fill", "#10b981")
                                .text(d => d.data.improvement || "");
                            
                            // Add legend
                            const legend = svg.append("g")
                                .attr("transform", `translate(${width - 150}, 20)`);
                            
                            const legendData = [
                                {color: "#6b7280", label: "Original"},
                                {color: "#3b82f6", label: "Evolution"},
                                {color: "#10b981", label: "Current Best"}
                            ];
                            
                            legendData.forEach((item, i) => {
                                const legendRow = legend.append("g")
                                    .attr("transform", `translate(0, ${i * 20})`);
                                
                                legendRow.append("circle")
                                    .attr("r", 6)
                                    .style("fill", item.color);
                                
                                legendRow.append("text")
                                    .attr("x", 15)
                                    .attr("y", 5)
                                    .style("font-size", "12px")
                                    .text(item.label);
                            });
                        }
                        
                        // Add performance trends (mock data)
                        const trendsContainer = document.getElementById('performanceTrends');
                        if (trendsContainer) {
                            trendsContainer.innerHTML = `
                                <div class="trend-summary">
                                    <h4>üìà Performance Trends</h4>
                                    <ul>
                                        <li>Average accuracy improved by <strong>12%</strong> over 6 iterations</li>
                                        <li>Cost per extraction reduced by <strong>18%</strong></li>
                                        <li>Processing speed increased by <strong>25%</strong></li>
                                        <li>Error rate decreased from <strong>15%</strong> to <strong>6%</strong></li>
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Add adaptation history (mock data)
                        const adaptationContainer = document.getElementById('adaptationHistory');
                        if (adaptationContainer) {
                            adaptationContainer.innerHTML = `
                                <div class="adaptation-timeline">
                                    <h4>üîÑ Recent Adaptations</h4>
                                    <div class="adaptation-item">
                                        <span class="date">2025-01-26</span>
                                        <span class="change">Structure v2.3: Added confidence scoring</span>
                                        <span class="impact">+5% accuracy</span>
                                    </div>
                                    <div class="adaptation-item">
                                        <span class="date">2025-01-24</span>
                                        <span class="change">Products v3.1: Improved brand recognition</span>
                                        <span class="impact">+4% accuracy</span>
                                    </div>
                                    <div class="adaptation-item">
                                        <span class="date">2025-01-22</span>
                                        <span class="change">Details v2.0: Enhanced price extraction</span>
                                        <span class="impact">+3% accuracy</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                    } else {
                        document.getElementById('evolutionTimeline').innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No evolution data available yet. Create prompt versions to see the evolution tree!</div>';
                        document.getElementById('performanceTrends').innerHTML = '';
                        document.getElementById('adaptationHistory').innerHTML = '';
                    }
                } catch (error) {
                    console.error('Failed to load evolution analysis:', error);
                }
            }
            
            async function generateRecommendations() {
                try {
                    const response = await fetch('/api/prompts/generate-recommendations', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        alert('New recommendations generated! Check the Recommendations tab.');
                        if (currentIntelligenceTab === 'recommendations') {
                            loadRecommendations();
                        }
                    } else {
                        alert('Failed to generate recommendations. Please try again.');
                    }
                } catch (error) {
                    console.error('Failed to generate recommendations:', error);
                    alert('Error generating recommendations. Please try again.');
                }
            }
            
            async function exportIntelligence() {
                try {
                    const response = await fetch('/api/prompts/export-intelligence');
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `intelligence-report-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        alert('Failed to export intelligence report. Please try again.');
                    }
                } catch (error) {
                    console.error('Failed to export intelligence:', error);
                    alert('Error exporting intelligence report. Please try again.');
                }
            }
            
            async function optimizePrompts() {
                if (confirm('This will analyze all prompt performance data and suggest optimizations. Continue?')) {
                    try {
                        const response = await fetch('/api/prompts/optimize', {
                            method: 'POST'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            alert(`Prompt optimization complete! ${data.optimizations_applied} optimizations applied.`);
                            loadIntelligenceData(); // Refresh data
                        } else {
                            alert('Failed to optimize prompts. Please try again.');
                        }
                    } catch (error) {
                        console.error('Failed to optimize prompts:', error);
                        alert('Error optimizing prompts. Please try again.');
                    }
                }
            }
            
            async function loadDemoIterationData() {
                // Display demo data with static SVG representation
                try {
                    document.getElementById('iterationJSON').innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3>üìä Demo: Planogram Data Structure (18 Products)</h3>
                            <p>This shows the JSON data structure that feeds the interactive React planogram.</p>
                            <p><strong>Features:</strong> 18 products across 3 shelves, stacking data, gap detection, section organization, confidence scores</p>
                        </div>
                        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow: auto; max-height: 400px; font-family: monospace; font-size: 12px;">{
  "shelves": {
    "1": {
      "shelf_number": 1,
      "sections": {
        "Left": [
          {
            "type": "product",
            "position": 1,
            "data": {
              "brand": "Coca-Cola",
              "name": "Coke Zero 330ml",
              "price": 1.29,
              "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
              "visual": {"confidence_color": "#22c55e"},
              "metadata": {"extraction_confidence": 0.98}
            }
          },
          {
            "type": "product", 
            "position": 2,
            "data": {
              "brand": "Coca-Cola",
              "name": "Sprite 330ml", 
              "price": 1.29,
              "quantity": {"stack": 1, "columns": 2, "total_facings": 2},
              "visual": {"confidence_color": "#3b82f6"},
              "metadata": {"extraction_confidence": 0.92}
            }
          }
        ],
        "Center": [
          {
            "type": "product",
            "position": 4,
            "data": {
              "brand": "PepsiCo",
              "name": "Pepsi Max 330ml",
              "price": 1.19,
              "quantity": {"stack": 1, "columns": 3, "total_facings": 3},
              "visual": {"confidence_color": "#22c55e"},
              "metadata": {"extraction_confidence": 0.95}
            }
          },
          {
            "type": "empty",
            "position": 6,
            "reason": "gap_detected"
          }
        ],
        "Right": [
          {
            "type": "product",
            "position": 7,
            "data": {
              "brand": "Red Bull",
              "name": "Energy Drink 250ml",
              "price": 1.89,
              "quantity": {"stack": 2, "columns": 2, "total_facings": 4},
              "visual": {"confidence_color": "#22c55e"},
              "metadata": {"extraction_confidence": 0.96}
            }
          }
        ]
      }
    }
  }
}</pre>
                    `;
                    
                    // Show message directing to Simple Mode for actual planogram
                    const planogramContainer = document.getElementById('iterationPlanogram');
                    planogramContainer.innerHTML = `
                        <div style="background: #eff6ff; padding: 30px; border-radius: 8px; border: 1px solid #3b82f6; text-align: center;">
                            <h3 style="margin: 0 0 15px 0; color: #1e40af;">üéØ View Interactive Planogram</h3>
                            <p style="margin: 0 0 20px 0; color: #1e40af; font-size: 16px;">
                                To see the actual planogram visualization with all 18 products, stacking, gaps, and interactive controls:
                            </p>
                            <button onclick="switchMode('simple')" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 10px;">
                                üöÄ Go to Simple Mode
                            </button>
                            <p style="margin: 20px 0 0 0; color: #64748b; font-size: 14px;">
                                The iterations tab shows data structure. The actual planogram visualization is in Simple Mode.
                            </p>
                        </div>
                    `;
                    
                    document.getElementById('planogramAccuracy').textContent = 'Interactive Planogram Available in Simple Mode';
                    
                    // Add shelf breakdown table
                    document.getElementById('shelfBreakdown').innerHTML = `
                        <h4>üì¶ Shelf-by-Shelf Product Breakdown</h4>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #2563eb;">Shelf 1 (Bottom) - 7 products</h5>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <tr style="background: #e5e7eb; font-weight: bold;">
                                    <th style="padding: 10px; text-align: left;">Pos</th>
                                    <th style="padding: 10px; text-align: left;">Brand</th>
                                    <th style="padding: 10px; text-align: left;">Product</th>
                                    <th style="padding: 10px; text-align: center;">Facings</th>
                                    <th style="padding: 10px; text-align: left;">Price</th>
                                    <th style="padding: 10px; text-align: center;">Confidence</th>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">1</td>
                                    <td style="padding: 8px;">Coca-Cola</td>
                                    <td style="padding: 8px;">Coke Zero Sugar 330ml</td>
                                    <td style="padding: 8px; text-align: center;">3</td>
                                    <td style="padding: 8px;">¬£1.29</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">98%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">2</td>
                                    <td style="padding: 8px;">Coca-Cola</td>
                                    <td style="padding: 8px;">Sprite Zero 330ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£1.29</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">92%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">3</td>
                                    <td style="padding: 8px;">Coca-Cola</td>
                                    <td style="padding: 8px;">Fanta Orange 330ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£1.29</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">89%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">4</td>
                                    <td style="padding: 8px;">PepsiCo</td>
                                    <td style="padding: 8px;">Pepsi Max Cherry 330ml</td>
                                    <td style="padding: 8px; text-align: center;">3</td>
                                    <td style="padding: 8px;">¬£1.19</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">95%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">5</td>
                                    <td style="padding: 8px;">PepsiCo</td>
                                    <td style="padding: 8px;">7UP Free 330ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£1.19</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">86%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">7</td>
                                    <td style="padding: 8px;">Red Bull</td>
                                    <td style="padding: 8px;">Energy Drink 250ml</td>
                                    <td style="padding: 8px; text-align: center;">4 <span style="color: #f59e0b; font-size: 10px;">(STACKED 2√ó2)</span></td>
                                    <td style="padding: 8px;">¬£1.89</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">96%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">8</td>
                                    <td style="padding: 8px;">Monster</td>
                                    <td style="padding: 8px;">Energy Original 500ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£2.15</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">91%</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #2563eb;">Shelf 2 (Middle) - 6 products</h5>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <tr style="background: #e5e7eb; font-weight: bold;">
                                    <th style="padding: 10px; text-align: left;">Pos</th>
                                    <th style="padding: 10px; text-align: left;">Brand</th>
                                    <th style="padding: 10px; text-align: left;">Product</th>
                                    <th style="padding: 10px; text-align: center;">Facings</th>
                                    <th style="padding: 10px; text-align: left;">Price</th>
                                    <th style="padding: 10px; text-align: center;">Confidence</th>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">1</td>
                                    <td style="padding: 8px;">Evian</td>
                                    <td style="padding: 8px;">Natural Water 500ml</td>
                                    <td style="padding: 8px; text-align: center;">6 <span style="color: #f59e0b; font-size: 10px;">(STACKED 3√ó2)</span></td>
                                    <td style="padding: 8px;">¬£0.89</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">97%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">2</td>
                                    <td style="padding: 8px;">Coca-Cola</td>
                                    <td style="padding: 8px;">Smartwater 600ml</td>
                                    <td style="padding: 8px; text-align: center;">4 <span style="color: #f59e0b; font-size: 10px;">(STACKED 2√ó2)</span></td>
                                    <td style="padding: 8px;">¬£1.49</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">88%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">3</td>
                                    <td style="padding: 8px;">Innocent</td>
                                    <td style="padding: 8px;">Orange Juice 330ml</td>
                                    <td style="padding: 8px; text-align: center;">3</td>
                                    <td style="padding: 8px;">¬£2.29</td>
                                    <td style="padding: 8px; color: #64748b; text-align: center;">-</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">4</td>
                                    <td style="padding: 8px;">Innocent</td>
                                    <td style="padding: 8px;">Apple Juice 330ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£2.29</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">90%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">5</td>
                                    <td style="padding: 8px;">Innocent</td>
                                    <td style="padding: 8px;">Berry Smoothie 250ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£2.79</td>
                                    <td style="padding: 8px; color: #f59e0b; font-weight: bold; text-align: center;">76%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">6</td>
                                    <td style="padding: 8px;">Lipton</td>
                                    <td style="padding: 8px;">Ice Tea Lemon 500ml</td>
                                    <td style="padding: 8px; text-align: center;">6 <span style="color: #f59e0b; font-size: 10px;">(STACKED 2√ó3)</span></td>
                                    <td style="padding: 8px;">¬£1.59</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">93%</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #2563eb;">Shelf 3 (Top) - 5 products</h5>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <tr style="background: #e5e7eb; font-weight: bold;">
                                    <th style="padding: 10px; text-align: left;">Pos</th>
                                    <th style="padding: 10px; text-align: left;">Brand</th>
                                    <th style="padding: 10px; text-align: left;">Product</th>
                                    <th style="padding: 10px; text-align: center;">Facings</th>
                                    <th style="padding: 10px; text-align: left;">Price</th>
                                    <th style="padding: 10px; text-align: center;">Confidence</th>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">1</td>
                                    <td style="padding: 8px;">Starbucks</td>
                                    <td style="padding: 8px;">Frappuccino Vanilla 250ml</td>
                                    <td style="padding: 8px; text-align: center;">3</td>
                                    <td style="padding: 8px;">¬£2.49</td>
                                    <td style="padding: 8px; color: #10b981; font-weight: bold; text-align: center;">96%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">2</td>
                                    <td style="padding: 8px;">Starbucks</td>
                                    <td style="padding: 8px;">Frappuccino Mocha 250ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£2.49</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">89%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">3</td>
                                    <td style="padding: 8px;">Powerade</td>
                                    <td style="padding: 8px;">ION4 Blue 500ml</td>
                                    <td style="padding: 8px; text-align: center;">4 <span style="color: #f59e0b; font-size: 10px;">(STACKED 2√ó2)</span></td>
                                    <td style="padding: 8px;">¬£1.79</td>
                                    <td style="padding: 8px; color: #3b82f6; font-weight: bold; text-align: center;">85%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">4</td>
                                    <td style="padding: 8px;">Gatorade</td>
                                    <td style="padding: 8px;">Orange Sports Drink 500ml</td>
                                    <td style="padding: 8px; text-align: center;">4 <span style="color: #f59e0b; font-size: 10px;">(STACKED 2√ó2)</span></td>
                                    <td style="padding: 8px;">¬£1.79</td>
                                    <td style="padding: 8px; color: #f59e0b; font-weight: bold; text-align: center;">78%</td>
                                </tr>
                                <tr style="border-bottom: 1px solid #e5e7eb;">
                                    <td style="padding: 8px;">5</td>
                                    <td style="padding: 8px;">Rockstar</td>
                                    <td style="padding: 8px;">Energy Drink 500ml</td>
                                    <td style="padding: 8px; text-align: center;">2</td>
                                    <td style="padding: 8px;">¬£1.99</td>
                                    <td style="padding: 8px; color: #64748b; text-align: center;">-</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                            <h5 style="color: #1e40af; margin: 0 0 10px 0;">üìä Summary Statistics</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 14px;">
                                <div><strong>Total Products:</strong> 18</div>
                                <div><strong>Total Facings:</strong> 51</div>
                                <div><strong>Stacked Products:</strong> 6</div>
                                <div><strong>Avg Confidence:</strong> 90.1%</div>
                                <div><strong>Price Range:</strong> ¬£0.89 - ¬£2.79</div>
                                <div><strong>Gaps Detected:</strong> 3</div>
                            </div>
                        </div>
                    `;
                        
                } catch (error) {
                    console.error('Error loading demo data:', error);
                    document.getElementById('iterationJSON').innerHTML = '<div class="error">Error loading demo data</div>';
                }
            }
            
            async function loadDemoIteration(iterationNum) {
                try {
                    // Load products data
                    const productsResponse = await fetch(`/api/iterations/12345/products/${iterationNum}`);
                    if (productsResponse.ok) {
                        const productsData = await productsResponse.json();
                        
                        // Update JSON viewer with selected iteration
                        document.getElementById('iterationJSON').innerHTML = `
                            <div style="margin-bottom: 20px;">
                                <h3>üìä Demo Iteration ${iterationNum} - Products Data</h3>
                                <button onclick="loadDemoIterationData()" style="margin-bottom: 10px; padding: 5px 10px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">‚Üê Back to Overview</button>
                            </div>
                            <pre style="background: #f8fafc; padding: 20px; border-radius: 8px; overflow: auto; max-height: 400px;">${JSON.stringify(productsData.raw_products, null, 2)}</pre>
                        `;
                    }
                    
                    // Load planogram
                    const planogramResponse = await fetch(`/api/iterations/12345/planogram/${iterationNum}`);
                    if (planogramResponse.ok) {
                        const planogramData = await planogramResponse.json();
                        document.getElementById('iterationPlanogram').innerHTML = planogramData.svg;
                        document.getElementById('planogramAccuracy').textContent = `Demo Iteration ${iterationNum} - Accuracy: ${(planogramData.accuracy * 100).toFixed(1)}%`;
                    } else {
                        document.getElementById('iterationPlanogram').innerHTML = '<div class="loading">No planogram available for this iteration</div>';
                    }
                } catch (error) {
                    console.error('Error loading demo iteration:', error);
                    document.getElementById('iterationJSON').innerHTML = '<div class="error">Error loading iteration data</div>';
                }
            }
            
            // Error Summary Functions
            async function loadErrorSummary() {
                const errorSummary = document.getElementById('errorSummary');
                
                try {
                    const response = await fetch('/api/queue/logs/errors?limit=5');
                    
                    if (response.ok) {
                        const data = await response.json();
                        renderErrorSummary(data.errors);
                    } else {
                        errorSummary.innerHTML = '<div class="log-loading">Failed to load error summary</div>';
                    }
                } catch (error) {
                    console.error('Failed to load error summary:', error);
                    errorSummary.innerHTML = '<div class="log-loading">Error loading error summary</div>';
                }
            }
            
            // Real-Time Debugging Functions
            let debugWebSocket = null;
            let currentDebugSessionId = null;
            
            // System workflow definitions
            const systemWorkflows = {
                "Custom Consensus": {
                    "stages": [
                        {"name": "structure_consensus", "display": "Structure Analysis", "models": ["GPT-4o", "Claude-3.5-Sonnet", "Gemini-2.0-Flash"], "type": "parallel"},
                        {"name": "position_consensus", "display": "Position Consensus", "models": ["GPT-4o", "Claude-3.5-Sonnet", "Gemini-2.0-Flash"], "type": "shelf_by_shelf"},
                        {"name": "quantity_consensus", "display": "Quantity Analysis", "models": ["GPT-4o", "Claude-3.5-Sonnet", "Gemini-2.0-Flash"], "type": "parallel"},
                        {"name": "detail_consensus", "display": "Detail Extraction", "models": ["GPT-4o", "Claude-3.5-Sonnet", "Gemini-2.0-Flash"], "type": "parallel"},
                        {"name": "planogram_generation", "display": "Generate Planogram", "models": ["PlanogramOrchestrator"], "type": "iteration_step"},
                        {"name": "ai_comparison", "display": "AI Compare vs Original", "models": ["ImageComparisonAgent"], "type": "iteration_step"},
                        {"name": "accuracy_calculation", "display": "Calculate Accuracy", "models": ["FeedbackManager"], "type": "iteration_step"},
                        {"name": "iteration_decision", "display": "Continue or Stop?", "models": ["MasterOrchestrator"], "type": "decision_point"}
                    ],
                    "orchestrator": "DeterministicOrchestrator",
                    "voting_mechanism": "weighted_consensus"
                },
                "LangGraph": {
                    "stages": [
                        {"name": "structure_consensus_node", "display": "Structure Node", "models": ["GPT-4o", "Claude-3.5-Sonnet"], "type": "workflow_node"},
                        {"name": "position_consensus_node", "display": "Position Node", "models": ["GPT-4o", "Claude-3.5-Sonnet"], "type": "workflow_node"},
                        {"name": "quantity_consensus_node", "display": "Quantity Node", "models": ["GPT-4o", "Claude-3.5-Sonnet"], "type": "workflow_node"},
                        {"name": "detail_consensus_node", "display": "Detail Node", "models": ["GPT-4o", "Claude-3.5-Sonnet"], "type": "workflow_node"},
                        {"name": "generate_planogram_node", "display": "Planogram Node", "models": ["Workflow"], "type": "workflow_node"},
                        {"name": "validate_end_to_end_node", "display": "Validation Node", "models": ["Workflow"], "type": "workflow_node"},
                        {"name": "smart_retry_node", "display": "Smart Retry", "models": ["Workflow"], "type": "conditional"}
                    ],
                    "orchestrator": "LangGraph StateGraph",
                    "voting_mechanism": "workflow_state_management"
                },
                "Hybrid": {
                    "stages": [
                        {"name": "adaptive_structure", "display": "Adaptive Structure", "models": ["Dynamic Selection"], "type": "adaptive"},
                        {"name": "multi_model_positions", "display": "Multi-Model Positions", "models": ["Best Available"], "type": "adaptive"},
                        {"name": "consensus_validation", "display": "Consensus Validation", "models": ["Ensemble"], "type": "ensemble"},
                        {"name": "quality_optimization", "display": "Quality Optimization", "models": ["Feedback Loop"], "type": "iterative"}
                    ],
                    "orchestrator": "AdaptiveOrchestrator",
                    "voting_mechanism": "dynamic_consensus"
                }
            };

            function displaySystemWorkflow(systemName) {
                const workflow = systemWorkflows[systemName];
                
                // Update system display
                document.getElementById('currentSystem').textContent = systemName;
                document.getElementById('orchestratorType').textContent = workflow.orchestrator;
                document.getElementById('votingMechanism').textContent = workflow.voting_mechanism;
                
                // Count active models
                const allModels = new Set();
                workflow.stages.forEach(stage => {
                    stage.models.forEach(model => allModels.add(model));
                });
                document.getElementById('activeModels').textContent = allModels.size;
                
                // Show REAL Master Orchestrator iteration cycle steps
                displayMasterOrchestratorSteps(systemName);
                
                console.log(`üìä Displaying workflow for ${systemName} with real Master Orchestrator steps`);
            }
            
            function displayMasterOrchestratorSteps(systemName) {
                const stepsContainer = document.getElementById('masterOrchestratorSteps');
                stepsContainer.innerHTML = '';
                
                // REAL Master Orchestrator iteration cycle steps (from src/orchestrator/master_orchestrator.py)
                const masterSteps = [
                    {
                        id: 'extract_data',
                        name: `Step 1: Extract with ${systemName}`,
                        description: 'ExtractionOrchestrator.extract_with_cumulative_learning() - Uses previous attempts and focus areas',
                        status: 'pending',
                        component: 'ExtractionOrchestrator'
                    },
                    {
                        id: 'generate_planogram',
                        name: 'Step 2: Generate Planogram',
                        description: 'PlanogramOrchestrator.generate_for_agent_iteration() - Creates visual planogram from extraction JSON',
                        status: 'pending',
                        component: 'PlanogramOrchestrator'
                    },
                    {
                        id: 'ai_compare',
                        name: 'Step 3: AI Comparison Analysis',
                        description: 'ImageComparisonAgent.compare_image_vs_planogram() - Compares original image vs generated planogram',
                        status: 'pending',
                        component: 'ImageComparisonAgent'
                    },
                    {
                        id: 'calculate_accuracy',
                        name: 'Step 4: Calculate Accuracy',
                        description: 'FeedbackManager.analyze_accuracy_with_failure_areas() - Analyzes comparison and identifies failure areas',
                        status: 'pending',
                        component: 'CumulativeFeedbackManager'
                    },
                    {
                        id: 'iteration_decision',
                        name: 'Step 5: Iteration Decision',
                        description: 'MasterOrchestrator checks: if accuracy >= target_accuracy, STOP; else prepare next iteration with focus areas',
                        status: 'pending',
                        component: 'MasterOrchestrator'
                    }
                ];
                
                masterSteps.forEach((step, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'master-step';
                    stepDiv.setAttribute('data-step', step.id);
                    stepDiv.style.cssText = `
                        display: flex; 
                        align-items: center; 
                        padding: 8px 12px; 
                        background: #f8fafc; 
                        border-radius: 6px; 
                        border-left: 4px solid #e5e7eb;
                        transition: all 0.3s ease;
                    `;
                    
                    stepDiv.innerHTML = `
                        <div style="width: 24px; height: 24px; border-radius: 50%; background: #e5e7eb; color: #6b7280; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; margin-right: 12px;">
                            ${index + 1}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #374151; font-size: 14px;">${step.name}</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">${step.description}</div>
                            <div style="font-size: 11px; color: #3b82f6; margin-top: 4px; font-weight: 500;">üîß ${step.component}</div>
                        </div>
                        <div style="font-size: 12px; color: #6b7280; font-weight: 600;">‚è∏ Pending</div>
                    `;
                    
                    stepsContainer.appendChild(stepDiv);
                });
            }

            // Initialize workflow display (called from main DOMContentLoaded)
            function initializeWorkflowDisplay() {
                displaySystemWorkflow('Custom Consensus');
            }
            
            async function startDebugSession() {
                const uploadId = document.getElementById('debugUploadId').value.trim();
                
                if (!uploadId) {
                    alert('Please enter an upload ID to monitor');
                    return;
                }
                
                try {
                    // Start monitoring session - system will be detected automatically
                    const response = await fetch('/api/debug/start-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            upload_id: uploadId,
                            system_name: 'Custom Consensus'  // Default system for monitoring
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to start debug session: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    currentDebugSessionId = data.session_id;
                    
                    // Update UI
                    document.getElementById('debugSessionId').textContent = currentDebugSessionId;
                    document.getElementById('debugStatus').textContent = 'Starting...';
                    document.getElementById('debugCurrentStage').textContent = 'Detecting system...';
                    document.getElementById('debugSessionInfo').style.display = 'block';
                    document.getElementById('startDebugBtn').disabled = true;
                    document.getElementById('startDebugBtn').textContent = 'üîÑ Monitoring...';
                    
                    // Update system display based on actual system being used
                    if (data.system) {
                        displaySystemWorkflow(data.system);
                        addLogMessage(`Monitoring ${data.system} extraction system`, 'info');
                    }
                    
                    // Show pipeline status panels
                    document.getElementById('pipelineStatus').style.display = 'block';
                    document.getElementById('modelComparison').style.display = 'block';
                    document.getElementById('livePromptMonitoring').style.display = 'block';
                    document.getElementById('realTimeLogs').style.display = 'block';
                    
                    // Connect WebSocket for real-time updates
                    connectDebugWebSocket(currentDebugSessionId);
                    
                    console.log(`‚úÖ Started monitoring session: ${currentDebugSessionId} for system: ${data.system || 'Unknown'}`);
                    
                } catch (error) {
                    console.error('Failed to start monitoring session:', error);
                    alert(`Failed to start monitoring session: ${error.message}`);
                }
            }
            
            function connectDebugWebSocket(sessionId) {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/api/debug/ws/${sessionId}`;
                
                debugWebSocket = new WebSocket(wsUrl);
                
                debugWebSocket.onopen = function() {
                    console.log('‚úÖ Monitoring WebSocket connected');
                    addLogMessage('Connected to monitoring session', 'info');
                };
                
                debugWebSocket.onmessage = function(event) {
                    const update = JSON.parse(event.data);
                    handleDebugUpdate(update);
                };
                
                debugWebSocket.onclose = function() {
                    console.log('üîå Monitoring WebSocket disconnected');
                    addLogMessage('Disconnected from monitoring session', 'warning');
                };
                
                debugWebSocket.onerror = function(error) {
                    console.error('‚ùå Monitoring WebSocket error:', error);
                    addLogMessage('WebSocket connection error', 'error');
                };
            }
            
            function handleDebugUpdate(update) {
                console.log('üì° Debug update received:', update);
                
                switch (update.type) {
                    case 'initial_status':
                        document.getElementById('debugStatus').textContent = update.status;
                        document.getElementById('debugCurrentStage').textContent = update.current_stage;
                        break;
                        
                    case 'stage_update':
                        updatePipelineStage(update.stage, update.status);
                        document.getElementById('debugCurrentStage').textContent = update.stage;
                        document.getElementById('pipelineProgressText').textContent = update.message || `${update.stage} - ${update.status}`;
                        addLogMessage(`Stage ${update.stage}: ${update.status}`, 'info');
                        break;
                        
                    case 'prompt_used':
                        // Show live prompts being used by each model
                        displayLivePrompt(update.model, update.step, update.prompt_template, update.prompt_content, update.agent_id);
                        addLogMessage(`ü§ñ ${update.model} using prompt: ${update.prompt_template} for ${update.step}`, 'info');
                        break;
                        
                    case 'iteration_start':
                        updateIterationStart(update);
                        addLogMessage(`üîÑ Starting Iteration ${update.iteration} - Target: ${update.target_accuracy}%`, 'info');
                        break;
                        
                    case 'extract_data_start':
                        updateMasterStep('extract_data', 'processing', `Extracting with ${update.system}`);
                        addLogMessage(`üîç Step 1: Extracting data using ${update.system}`, 'info');
                        break;
                        
                    case 'extract_data_complete':
                        updateMasterStep('extract_data', 'completed', `Found ${update.products} products`);
                        addLogMessage(`‚úÖ Step 1 Complete: ${update.products} products extracted`, 'success');
                        break;
                        
                    case 'planogram_generation_start':
                        updateMasterStep('generate_planogram', 'processing', 'Creating visual planogram');
                        addLogMessage(`üìä Step 2: Generating planogram from extraction JSON`, 'info');
                        break;
                        
                    case 'planogram_generated':
                        updateMasterStep('generate_planogram', 'completed', `Planogram created`);
                        addLogMessage(`‚úÖ Step 2 Complete: Planogram generated for ${update.products} products`, 'success');
                        break;
                        
                    case 'ai_comparison_start':
                        updateMasterStep('ai_compare', 'processing', 'Comparing vs original image');
                        addLogMessage(`üîç Step 3: AI comparing planogram vs original image`, 'info');
                        break;
                        
                    case 'ai_comparison_complete':
                        updateMasterStep('ai_compare', 'completed', 'Comparison analysis done');
                        addLogMessage(`‚úÖ Step 3 Complete: AI comparison analysis finished`, 'success');
                        break;
                        
                    case 'accuracy_calculation_start':
                        updateMasterStep('calculate_accuracy', 'processing', 'Analyzing accuracy');
                        addLogMessage(`üìä Step 4: Calculating accuracy from comparison`, 'info');
                        break;
                        
                    case 'accuracy_calculated':
                        updateMasterStep('calculate_accuracy', 'completed', `${update.accuracy}% accuracy`);
                        updateMasterStep('iteration_decision', 'processing', 'Deciding next action');
                        
                        const accuracyColor = update.accuracy >= 95 ? 'success' : update.accuracy >= 80 ? 'warning' : 'error';
                        addLogMessage(`üéØ Step 4 Complete: ${update.accuracy}% accuracy (Target: ${update.target}%)`, accuracyColor);
                        
                        // Update current accuracy display
                        document.getElementById('currentAccuracy').textContent = `${update.accuracy}%`;
                        
                        if (update.accuracy >= update.target) {
                            updateMasterStep('iteration_decision', 'completed', '‚úÖ Target achieved - STOP');
                            updateIterationComplete(update.iteration, update.accuracy, true);
                            addLogMessage(`‚úÖ Step 5 Complete: Target accuracy achieved! Stopping iterations.`, 'success');
                        } else {
                            updateMasterStep('iteration_decision', 'completed', '‚è≠Ô∏è Continue to next iteration');
                            addLogMessage(`‚è≠Ô∏è Step 5 Complete: Accuracy below target, continuing to next iteration...`, 'info');
                            // Reset steps for next iteration
                            setTimeout(() => resetMasterStepsForNextIteration(), 1000);
                        }
                        break;
                        
                    case 'iteration_complete':
                        updateIterationInfo(update);
                        addLogMessage(`Iteration ${update.iteration} complete - Accuracy: ${(update.accuracy * 100).toFixed(1)}%, Products: ${update.products_found}, Cost: ¬£${update.cost.toFixed(2)}`, 'success');
                        break;
                        
                    case 'extraction_complete':
                        document.getElementById('debugStatus').textContent = 'Completed';
                        document.getElementById('startDebugBtn').disabled = false;
                        document.getElementById('startDebugBtn').textContent = 'üîç Monitor Extraction';
                        addLogMessage(`Extraction complete! Final accuracy: ${(update.final_accuracy * 100).toFixed(1)}%, Total cost: ¬£${update.total_cost.toFixed(2)}`, 'success');
                        break;
                        
                    case 'extraction_failed':
                        document.getElementById('debugStatus').textContent = 'Failed';
                        document.getElementById('startDebugBtn').disabled = false;
                        document.getElementById('startDebugBtn').textContent = 'üîç Monitor Extraction';
                        addLogMessage(`Extraction failed: ${update.error}`, 'error');
                        break;
                }
            }
            
            function updatePipelineStage(stage, status) {
                const stageElement = document.querySelector(`[data-stage="${stage}"]`);
                if (stageElement) {
                    stageElement.classList.remove('pending', 'processing', 'completed', 'failed');
                    
                    if (status === 'processing') {
                        stageElement.style.background = '#f59e0b';
                        stageElement.style.color = 'white';
                        stageElement.innerHTML = `${stage.charAt(0).toUpperCase() + stage.slice(1)} ‚è≥`;
                    } else if (status === 'completed') {
                        stageElement.style.background = '#10b981';
                        stageElement.style.color = 'white';
                        stageElement.innerHTML = `${stage.charAt(0).toUpperCase() + stage.slice(1)} ‚úÖ`;
                    } else if (status === 'failed') {
                        stageElement.style.background = '#ef4444';
                        stageElement.style.color = 'white';
                        stageElement.innerHTML = `${stage.charAt(0).toUpperCase() + stage.slice(1)} ‚ùå`;
                    }
                }
            }
            
            function updateIterationInfo(update) {
                document.getElementById('currentIteration').textContent = update.iteration;
                document.getElementById('productsFound').textContent = update.products_found;
                document.getElementById('currentAccuracy').textContent = `${(update.accuracy * 100).toFixed(1)}%`;
                document.getElementById('totalCost').textContent = `¬£${update.total_cost.toFixed(2)}`;
            }
            
            function addLogMessage(message, level = 'info') {
                const logContainer = document.getElementById('logContainer');
                const timestamp = new Date().toLocaleTimeString();
                
                let color = '#e2e8f0';
                let icon = '‚ÑπÔ∏è';
                
                switch (level) {
                    case 'success':
                        color = '#10b981';
                        icon = '‚úÖ';
                        break;
                    case 'warning':
                        color = '#f59e0b';
                        icon = '‚ö†Ô∏è';
                        break;
                    case 'error':
                        color = '#ef4444';
                        icon = '‚ùå';
                        break;
                }
                
                const logEntry = document.createElement('div');
                logEntry.style.color = color;
                logEntry.style.marginBottom = '5px';
                logEntry.innerHTML = `<span style="color: #94a3b8;">[${timestamp}]</span> ${icon} ${message}`;
                
                logContainer.appendChild(logEntry);
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            function stopDebugSession() {
                if (currentDebugSessionId) {
                    // Close WebSocket
                    if (debugWebSocket) {
                        debugWebSocket.close();
                        debugWebSocket = null;
                    }
                    
                    // Clean up session
                    fetch(`/api/debug/session/${currentDebugSessionId}`, {
                        method: 'DELETE'
                    }).catch(console.error);
                    
                    // Reset UI
                    document.getElementById('debugSessionInfo').style.display = 'none';
                    document.getElementById('pipelineStatus').style.display = 'none';
                    document.getElementById('modelComparison').style.display = 'none';
                    document.getElementById('livePromptMonitoring').style.display = 'none';
                    document.getElementById('realTimeLogs').style.display = 'none';
                    document.getElementById('startDebugBtn').disabled = false;
                    document.getElementById('startDebugBtn').textContent = 'üîç Monitor Extraction';
                    
                    currentDebugSessionId = null;
                    console.log('üõë Monitoring session stopped');
                }
            }
            
            async function loadActiveSessions() {
                try {
                    const response = await fetch('/api/debug/active-sessions');
                    if (response.ok) {
                        const data = await response.json();
                        renderActiveSessions(data.active_sessions);
                    }
                } catch (error) {
                    console.error('Failed to load active sessions:', error);
                }
            }
            
            function renderActiveSessions(sessions) {
                const container = document.getElementById('activeSessionsList');
                
                if (sessions.length === 0) {
                    container.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 20px;">No active debug sessions</div>';
                    return;
                }
                
                const sessionItems = sessions.map(session => `
                    <div style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 4px solid #3b82f6;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>Session:</strong> ${session.session_id.substring(0, 8)}...<br>
                                <strong>Upload ID:</strong> ${session.upload_id}<br>
                                <strong>Status:</strong> ${session.status}<br>
                                <strong>Stage:</strong> ${session.current_stage}<br>
                                <strong>Iterations:</strong> ${session.iterations}
                            </div>
                            <div>
                                <button onclick="connectToSession('${session.session_id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-bottom: 5px;">Connect</button><br>
                                <button onclick="stopSession('${session.session_id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Stop</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = sessionItems;
            }
            
            function connectToSession(sessionId) {
                if (currentDebugSessionId) {
                    stopDebugSession();
                }
                
                currentDebugSessionId = sessionId;
                document.getElementById('debugSessionId').textContent = sessionId;
                document.getElementById('debugSessionInfo').style.display = 'block';
                document.getElementById('pipelineStatus').style.display = 'block';
                document.getElementById('modelComparison').style.display = 'block';
                document.getElementById('livePromptMonitoring').style.display = 'block';
                document.getElementById('realTimeLogs').style.display = 'block';
                
                connectDebugWebSocket(sessionId);
                
                // Load current session status
                fetch(`/api/debug/session/${sessionId}/status`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('debugStatus').textContent = data.status;
                        document.getElementById('debugCurrentStage').textContent = data.current_stage;
                    })
                    .catch(console.error);
            }
            
            function stopSession(sessionId) {
                fetch(`/api/debug/session/${sessionId}`, {
                    method: 'DELETE'
                }).then(() => {
                    loadActiveSessions();
                    if (currentDebugSessionId === sessionId) {
                        stopDebugSession();
                    }
                }).catch(console.error);
            }
            
            // Real-time Master Orchestrator step updates
            function updateIterationStart(update) {
                document.getElementById('currentIterationNumber').textContent = update.iteration;
                document.getElementById('targetAccuracy').textContent = `${update.target_accuracy}%`;
                document.getElementById('iterationStatus').textContent = 'üîÑ';
                document.getElementById('iterationStatusText').textContent = 'Running';
                document.getElementById('iterationProgressText').textContent = `Iteration ${update.iteration} - Extracting Data`;
                
                // Reset all steps to pending for new iteration
                resetMasterStepsForNextIteration();
            }
            
            function updateMasterStep(stepId, status, statusText) {
                const stepElement = document.querySelector(`[data-step="${stepId}"]`);
                if (!stepElement) return;
                
                const circle = stepElement.querySelector('div:first-child');
                const statusElement = stepElement.querySelector('div:last-child');
                
                if (status === 'processing') {
                    stepElement.style.borderLeftColor = '#f59e0b';
                    stepElement.style.background = '#fffbeb';
                    circle.style.background = '#f59e0b';
                    circle.style.color = 'white';
                    statusElement.innerHTML = '‚è≥ Processing';
                    statusElement.style.color = '#f59e0b';
                } else if (status === 'completed') {
                    stepElement.style.borderLeftColor = '#10b981';
                    stepElement.style.background = '#f0fdf4';
                    circle.style.background = '#10b981';
                    circle.style.color = 'white';
                    statusElement.innerHTML = '‚úÖ Complete';
                    statusElement.style.color = '#10b981';
                } else if (status === 'failed') {
                    stepElement.style.borderLeftColor = '#ef4444';
                    stepElement.style.background = '#fef2f2';
                    circle.style.background = '#ef4444';
                    circle.style.color = 'white';
                    statusElement.innerHTML = '‚ùå Failed';
                    statusElement.style.color = '#ef4444';
                }
                
                // Update status text if provided
                if (statusText) {
                    const descriptionElement = stepElement.querySelector('div:nth-child(2) div:last-child');
                    if (descriptionElement) {
                        descriptionElement.textContent = statusText;
                    }
                }
            }
            
            function updateIterationComplete(iteration, accuracy, targetAchieved) {
                document.getElementById('currentAccuracy').textContent = `${accuracy}%`;
                
                if (targetAchieved) {
                    document.getElementById('iterationStatus').textContent = '‚úÖ';
                    document.getElementById('iterationStatusText').textContent = 'Complete';
                    document.getElementById('iterationProgressText').textContent = `Iteration ${iteration} - Target Achieved!`;
                } else {
                    document.getElementById('iterationStatus').textContent = '‚è≠Ô∏è';
                    document.getElementById('iterationStatusText').textContent = 'Continuing';
                    document.getElementById('iterationProgressText').textContent = `Iteration ${iteration} - Preparing Next`;
                }
            }
            
            function resetMasterStepsForNextIteration() {
                const steps = ['extract_data', 'generate_planogram', 'ai_compare', 'calculate_accuracy', 'iteration_decision'];
                
                steps.forEach(stepId => {
                    const stepElement = document.querySelector(`[data-step="${stepId}"]`);
                    if (!stepElement) return;
                    
                    const circle = stepElement.querySelector('div:first-child');
                    const statusElement = stepElement.querySelector('div:last-child');
                    
                    // Reset to pending state
                    stepElement.style.borderLeftColor = '#e5e7eb';
                    stepElement.style.background = '#f8fafc';
                    circle.style.background = '#e5e7eb';
                    circle.style.color = '#6b7280';
                    statusElement.innerHTML = '‚è∏ Pending';
                    statusElement.style.color = '#6b7280';
                });
            }
            
            // Live prompt monitoring functions
            function displayLivePrompt(model, step, promptTemplate, promptContent, agentId) {
                const promptContainer = document.getElementById('promptContainer');
                
                // Clear the waiting message if it's the first prompt
                if (promptContainer.innerHTML.includes('Waiting for extraction')) {
                    promptContainer.innerHTML = '';
                }
                
                // Create unique ID for this prompt
                const promptId = `prompt-${model}-${step}-${agentId || 'main'}`;
                
                // Remove existing prompt from same model/step if it exists
                const existingPrompt = document.getElementById(promptId);
                if (existingPrompt) {
                    existingPrompt.remove();
                }
                
                // Get model color
                const modelColors = {
                    'GPT-4o': '#10b981',
                    'Claude-3.5-Sonnet': '#3b82f6', 
                    'Gemini-2.0-Flash': '#f59e0b',
                    'GPT-4o-Latest': '#10b981',
                    'Claude-3-Sonnet': '#3b82f6'
                };
                
                const modelColor = modelColors[model] || '#6b7280';
                
                // Create prompt display element
                const promptElement = document.createElement('div');
                promptElement.id = promptId;
                promptElement.style.cssText = `
                    border: 2px solid ${modelColor};
                    border-radius: 8px;
                    background: white;
                    overflow: hidden;
                    margin-bottom: 10px;
                `;
                
                // Truncate prompt content for display
                const truncatedContent = promptContent.length > 300 
                    ? promptContent.substring(0, 300) + '...' 
                    : promptContent;
                
                promptElement.innerHTML = `
                    <div style="background: ${modelColor}; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>ü§ñ ${model}</strong> ‚Ä¢ Step: ${step} ‚Ä¢ Template: ${promptTemplate}
                            ${agentId ? ` ‚Ä¢ Agent: ${agentId}` : ''}
                        </div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                    <div style="padding: 15px;">
                        <div style="background: #f8fafc; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; line-height: 1.4; color: #374151; max-height: 200px; overflow-y: auto;">
                            ${escapeHtml(truncatedContent)}
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <button onclick="expandPrompt('${promptId}')" style="background: #e5e7eb; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üìÑ View Full Prompt
                            </button>
                            <button onclick="copyPrompt('${promptId}')" style="background: #e5e7eb; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                üìã Copy
                            </button>
                        </div>
                    </div>
                `;
                
                // Store full content for later access
                promptElement.dataset.fullContent = promptContent;
                
                // Add to container (newest at top)
                promptContainer.insertBefore(promptElement, promptContainer.firstChild);
                
                // Limit to last 10 prompts to avoid memory issues
                const allPrompts = promptContainer.children;
                if (allPrompts.length > 10) {
                    for (let i = 10; i < allPrompts.length; i++) {
                        allPrompts[i].remove();
                    }
                }
            }
            
            function expandPrompt(promptId) {
                const promptElement = document.getElementById(promptId);
                if (!promptElement) return;
                
                const fullContent = promptElement.dataset.fullContent;
                
                // Create modal to show full prompt
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; color: #1f2937;">Full Prompt Content</h3>
                            <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚úï Close</button>
                        </div>
                        <div style="padding: 20px; overflow-y: auto; flex: 1;">
                            <pre style="background: #f8fafc; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; line-height: 1.4; color: #374151; white-space: pre-wrap; margin: 0;">${escapeHtml(fullContent)}</pre>
                        </div>
                        <div style="padding: 20px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px;">
                            <button onclick="copyToClipboard('${escapeHtml(fullContent).replace(/'/g, "\'")}'); this.textContent='‚úÖ Copied!'; setTimeout(() => this.textContent='üìã Copy Full Prompt', 2000)" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">üìã Copy Full Prompt</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            function copyPrompt(promptId) {
                const promptElement = document.getElementById(promptId);
                if (!promptElement) return;
                
                const fullContent = promptElement.dataset.fullContent;
                copyToClipboard(fullContent);
                
                // Show feedback
                const button = promptElement.querySelector('button[onclick*="copyPrompt"]');
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ Copied!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                }
            }
            
            function copyToClipboard(text) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            function renderErrorSummary(errors) {
                const errorSummary = document.getElementById('errorSummary');
                
                if (errors.length === 0) {
                    errorSummary.innerHTML = '<div class="log-loading">‚úÖ No recent errors found</div>';
                    return;
                }
                
                const errorItems = errors.map(error => `
                    <div class="error-item ${error.level.toLowerCase()}" onclick="jumpToLogContext('${error.timestamp}', '${error.component}')">
                        <div class="error-timestamp">${error.timestamp}</div>
                        <div class="error-component">${error.component}</div>
                        <div class="error-message">${escapeHtml(error.message)}</div>
                    </div>
                `).join('');
                
                errorSummary.innerHTML = errorItems;
            }
            
            function jumpToLogContext(timestamp, component) {
                // Switch to logs tab
                switchAdvancedTab('logs');
                
                // Set filters to show context around this error
                document.getElementById('logComponentFilter').value = component;
                document.getElementById('logSearchInput').value = '';
                
                // Load logs with the specific context
                setTimeout(() => {
                    loadLogs();
                }, 100);
            }
            
            // Fallback planogram display (pure HTML/CSS)
            function showFallbackPlanogram(container) {
                console.log('Showing fallback HTML planogram...');
                container.innerHTML = `
                    <div class="interactive-planogram">
                        <!-- Planogram Header -->
                        <div class="planogram-header">
                            <div class="planogram-stats">
                                <span class="stat">üì¶ 18 Products</span>
                                <span class="stat">üìö 3 Shelves</span>
                                <span class="stat">üéØ 90% Confidence</span>
                                <span class="stat stacking-indicator">üìö Stacking Detected</span>
                            </div>
                        </div>

                        <!-- Shelf Container -->
                        <div class="shelves-container">
                            <!-- Shelf 3 (Top) -->
                            <div class="shelf-component">
                                <div class="shelf-header">
                                    <h3>Shelf 3</h3>
                                    <div class="shelf-stats">
                                        <span class="products-count">5 products</span>
                                        <span class="gaps-count">1 gaps</span>
                                    </div>
                                </div>
                                <div class="shelf-content">
                                    <div class="shelf-section section-left">
                                        <div class="section-label">Left</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-1">
                                                <div class="product-slot full-height" style="background-color: #22c55e;">
                                                    <div class="product-content">
                                                        <div class="product-name">Starbucks Frappuccino Vanilla 250ml</div>
                                                        <div class="product-price">¬£2.49</div>
                                                        <div class="product-facings">3 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-2">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Starbucks Frappuccino Mocha 250ml</div>
                                                        <div class="product-price">¬£2.49</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-center">
                                        <div class="section-label">Center</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-3">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row stack-top" style="background-color: #3b82f6;">
                                                        <div class="product-content">
                                                            <div class="product-name">Powerade ION4 Blue</div>
                                                            <div class="stacking-indicator">Stack 1/2</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row stack-bottom" style="background-color: #3b82f6;">
                                                        <div class="product-content">
                                                            <div class="product-name">Powerade ION4 Blue</div>
                                                            <div class="stacking-indicator">Stack 2/2</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-4">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row stack-top" style="background-color: #f59e0b;">
                                                        <div class="product-content">
                                                            <div class="product-name">Gatorade Orange</div>
                                                            <div class="stacking-indicator">Stack 1/2</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row stack-bottom" style="background-color: #f59e0b;">
                                                        <div class="product-content">
                                                            <div class="product-name">Gatorade Orange</div>
                                                            <div class="stacking-indicator">Stack 2/2</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-right">
                                        <div class="section-label">Right</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-5">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Rockstar Energy 500ml</div>
                                                        <div class="product-price">¬£1.99</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-6">
                                                <div class="empty-slot">
                                                    <div class="empty-content">
                                                        <span class="empty-icon">üì≠</span>
                                                        <span class="empty-text">Empty</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shelf 2 (Middle) -->
                            <div class="shelf-component">
                                <div class="shelf-header">
                                    <h3>Shelf 2</h3>
                                    <div class="shelf-stats">
                                        <span class="products-count">6 products</span>
                                        <span class="gaps-count">1 gaps</span>
                                    </div>
                                </div>
                                <div class="shelf-content">
                                    <div class="shelf-section section-left">
                                        <div class="section-label">Left</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-1">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Evian Water</div>
                                                            <div class="stacking-indicator">Stack 1/3</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Evian Water</div>
                                                            <div class="stacking-indicator">Stack 2/3</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Evian Water</div>
                                                            <div class="stacking-indicator">Stack 3/3</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-2">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row stack-top" style="background-color: #3b82f6;">
                                                        <div class="product-content">
                                                            <div class="product-name">Smartwater</div>
                                                            <div class="stacking-indicator">Stack 1/2</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row stack-bottom" style="background-color: #3b82f6;">
                                                        <div class="product-content">
                                                            <div class="product-name">Smartwater</div>
                                                            <div class="stacking-indicator">Stack 2/2</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-center">
                                        <div class="section-label">Center</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-3">
                                                <div class="product-slot full-height" style="background-color: #22c55e;">
                                                    <div class="product-content">
                                                        <div class="product-name">Innocent Orange Juice 330ml</div>
                                                        <div class="product-price">¬£2.29</div>
                                                        <div class="product-facings">3 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-4">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Innocent Apple Juice 330ml</div>
                                                        <div class="product-price">¬£2.29</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-5">
                                                <div class="product-slot full-height" style="background-color: #f59e0b;">
                                                    <div class="product-content">
                                                        <div class="product-name">Innocent Berry Smoothie</div>
                                                        <div class="product-price">¬£2.79</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-right">
                                        <div class="section-label">Right</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-6">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row stack-top" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Lipton Ice Tea</div>
                                                            <div class="stacking-indicator">Stack 1/2</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row stack-bottom" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Lipton Ice Tea</div>
                                                            <div class="stacking-indicator">Stack 2/2</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-7">
                                                <div class="empty-slot">
                                                    <div class="empty-content">
                                                        <span class="empty-icon">üì≠</span>
                                                        <span class="empty-text">Empty</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shelf 1 (Bottom) -->
                            <div class="shelf-component">
                                <div class="shelf-header">
                                    <h3>Shelf 1</h3>
                                    <div class="shelf-stats">
                                        <span class="products-count">7 products</span>
                                        <span class="gaps-count">1 gaps</span>
                                    </div>
                                </div>
                                <div class="shelf-content">
                                    <div class="shelf-section section-left">
                                        <div class="section-label">Left</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-1">
                                                <div class="product-slot full-height" style="background-color: #22c55e;">
                                                    <div class="product-content">
                                                        <div class="product-name">Coca-Cola Coke Zero 330ml</div>
                                                        <div class="product-price">¬£1.29</div>
                                                        <div class="product-facings">3 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-2">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Coca-Cola Sprite 330ml</div>
                                                        <div class="product-price">¬£1.29</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-3">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Coca-Cola Fanta Orange</div>
                                                        <div class="product-price">¬£1.29</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-center">
                                        <div class="section-label">Center</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-4">
                                                <div class="product-slot full-height" style="background-color: #22c55e;">
                                                    <div class="product-content">
                                                        <div class="product-name">PepsiCo Pepsi Max 330ml</div>
                                                        <div class="product-price">¬£1.19</div>
                                                        <div class="product-facings">3 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-5">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">PepsiCo 7UP Free</div>
                                                        <div class="product-price">¬£1.19</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-6">
                                                <div class="empty-slot">
                                                    <div class="empty-content">
                                                        <span class="empty-icon">üì≠</span>
                                                        <span class="empty-text">Empty</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="shelf-section section-right">
                                        <div class="section-label">Right</div>
                                        <div class="section-slots">
                                            <div class="slot-container position-7">
                                                <div class="product-slot stacked">
                                                    <div class="stack-row stack-top" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Red Bull Energy</div>
                                                            <div class="stacking-indicator">Stack 1/2</div>
                                                        </div>
                                                    </div>
                                                    <div class="stack-row stack-bottom" style="background-color: #22c55e;">
                                                        <div class="product-content">
                                                            <div class="product-name">Red Bull Energy</div>
                                                            <div class="stacking-indicator">Stack 2/2</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="slot-container position-8">
                                                <div class="product-slot full-height" style="background-color: #3b82f6;">
                                                    <div class="product-content">
                                                        <div class="product-name">Monster Energy 500ml</div>
                                                        <div class="product-price">¬£2.15</div>
                                                        <div class="product-facings">2 facings</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Overlay Controls -->
                        <div class="planogram-overlay-controls">
                            <h4>Display Options</h4>
                            <div class="overlay-toggles">
                                <label><input type="checkbox" checked> Product Names</label>
                                <label><input type="checkbox" checked> Prices</label>
                                <label><input type="checkbox" checked> Facing Counts</label>
                                <label><input type="checkbox"> Confidence Scores</label>
                                <label><input type="checkbox" checked> Stacking Indicators</label>
                            </div>
                            <p style="margin-top: 10px; font-size: 12px; color: #64748b;">
                                <strong>Note:</strong> This is a fallback HTML version. The React component provides full interactivity.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // Global planogram control functions - working with HTML grid
            let currentZoomLevel = 1.0;
            let displaySettings = {
                showBrands: true,
                showProducts: true, 
                showPrices: true,
                showConfidence: false
            };

            function updatePlanogramZoom(factor, reset = false) {
                const planogramViewer = document.getElementById('planogramViewer');
                if (!planogramViewer) return;

                if (reset) {
                    currentZoomLevel = 1.0;
                } else {
                    currentZoomLevel *= factor;
                    currentZoomLevel = Math.max(0.5, Math.min(3.0, currentZoomLevel)); // Limit zoom range
                }

                planogramViewer.style.transform = `scale(${currentZoomLevel})`;
                planogramViewer.style.transformOrigin = 'top left';
                
                const zoomElement = document.getElementById('zoomPercentage');
                if (zoomElement) {
                    zoomElement.textContent = Math.round(currentZoomLevel * 100) + '%';
                }
                
                console.log(`üîç Zoom updated: ${Math.round(currentZoomLevel * 100)}%`);
            }
            
            function updatePlanogramDisplay(setting, enabled) {
                displaySettings[setting] = enabled;
                
                // Update button visual state
                const button = document.querySelector(`#toggle${setting.charAt(0).toUpperCase() + setting.slice(1).replace('show', '')}`);
                if (button) {
                    const label = button.parentElement;
                    const span = label.querySelector('span');
                    if (enabled) {
                        span.textContent = '‚úì';
                        label.style.background = getToggleColor(setting);
                        label.style.color = setting === 'showPrices' ? '#2d3748' : 'white';
                    } else {
                        span.textContent = '‚óã';
                        label.style.background = '#f7fafc';
                        label.style.color = '#4a5568';
                    }
                }

                // Apply display changes to all product cells
                const productCells = document.querySelectorAll('[data-product-cell]');
                productCells.forEach(cell => {
                    const brandDiv = cell.querySelector('[data-brand]');
                    const nameDiv = cell.querySelector('[data-name]');
                    const priceDiv = cell.querySelector('[data-price]');
                    const confidenceDiv = cell.querySelector('[data-confidence]');

                    if (brandDiv) brandDiv.style.display = displaySettings.showBrands ? 'block' : 'none';
                    if (nameDiv) nameDiv.style.display = displaySettings.showProducts ? 'block' : 'none';
                    if (priceDiv) priceDiv.style.display = displaySettings.showPrices ? 'block' : 'none';
                    if (confidenceDiv) confidenceDiv.style.display = displaySettings.showConfidence ? 'block' : 'none';
                });
                
                console.log(`‚úÖ Updated planogram display: ${setting} = ${enabled}`);
            }
            
            function getToggleColor(setting) {
                const colors = {
                    'showBrands': '#4facfe',
                    'showProducts': '#fa709a', 
                    'showPrices': '#a8edea',
                    'showConfidence': '#ffecd2'
                };
                return colors[setting] || '#f7fafc';
            }
            
            // Zoom functionality for planogram
            let currentZoom = 1.0;
            
            function updatePlanogramZoom(factor, reset = false, absolute = false) {
                if (reset) {
                    currentZoom = 1.0;
                } else if (absolute) {
                    // Set absolute zoom level
                    currentZoom = factor;
                } else {
                    // Multiply current zoom by factor
                    currentZoom *= factor;
                }
                // Limit zoom range
                currentZoom = Math.max(0.3, Math.min(3.0, currentZoom));
                
                // Apply zoom to all planogram grids AND adjust containers properly
                const planogramGrids = document.querySelectorAll('.planogram-grid');
                const planogramViewer = document.getElementById('planogramViewer');
                const shelfContainers = document.querySelectorAll('.planogram-grid').forEach(grid => {
                    const shelfContainer = grid.closest('div[style*="background: white"]');
                    if (shelfContainer) {
                        // Scale the entire shelf container, not just the grid
                        shelfContainer.style.transform = `scale(${currentZoom})`;
                        shelfContainer.style.transformOrigin = 'top left';
                        
                        // Adjust container dimensions to prevent clipping
                        if (currentZoom > 1.0) {
                            // When zooming in, increase the container size proportionally
                            shelfContainer.style.marginBottom = `${(currentZoom - 1) * 100}px`;
                            shelfContainer.style.marginRight = `${(currentZoom - 1) * 200}px`;
                        } else {
                            // Reset margins when zooming out or at normal zoom
                            shelfContainer.style.marginBottom = '0px';
                            shelfContainer.style.marginRight = '0px';
                        }
                    }
                });
                
                // Adjust the main container to accommodate the scaled content
                if (planogramViewer) {
                    // Always enable scrolling for zoom
                    planogramViewer.style.overflow = 'auto';
                    planogramViewer.style.height = '100%';
                    
                    // Adjust the container's internal spacing based on zoom
                    const planogramDiv = planogramViewer.querySelector('div[style*="background: #f8fafc"]');
                    if (planogramDiv) {
                        if (currentZoom > 1.0) {
                            // Add extra padding when zoomed in to prevent clipping
                            planogramDiv.style.paddingBottom = `${currentZoom * 50}px`;
                            planogramDiv.style.paddingRight = `${currentZoom * 50}px`;
                        } else {
                            // Reset padding for normal/zoom out
                            planogramDiv.style.paddingBottom = '16px';
                            planogramDiv.style.paddingRight = '16px';
                        }
                    }
                }
                
                // Update zoom percentage display
                const zoomDisplay = document.getElementById('zoomPercentage');
                if (zoomDisplay) {
                    zoomDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
                }
                
                console.log(`üîç Planogram zoom updated: ${Math.round(currentZoom * 100)}% - Containers scaled and adjusted for proper visibility`);
            }
            
            // Dynamic Grid Planogram - GLOBAL width consistency + proper stacking
            function createSimpleGridPlanogram(container, planogramData) {
                console.log('üéØ Creating GLOBAL CONSISTENT GRID planogram with proper stacking');
                
                const { shelves } = planogramData;
                
                // Calculate GLOBAL dimensions across ALL shelves - CUMULATIVE APPROACH
                let globalMaxPosition = 8; // Minimum shelf width
                let globalMaxStackHeight = 1;
                
                console.log('üîç Calculating global dimensions using CUMULATIVE positioning...');
                
                // First pass: calculate actual grid slots needed for each shelf
                shelves.forEach(shelf => {
                    console.log(`üìè Analyzing shelf ${shelf.shelf_number} for global dimensions`);
                    
                    let shelfGridPosition = 1; // Track cumulative position for this shelf
                    
                    ['Left', 'Center', 'Right'].forEach(sectionName => {
                        if (shelf.sections[sectionName]) {
                            shelf.sections[sectionName].forEach(slot => {
                                if (slot.type === 'product' && slot.data) {
                                    const product = slot.data;
                                    const facings = product.quantity?.columns || 1;
                                    const stackHeight = product.quantity?.stack || 1;
                                    
                                    console.log(`  üìç ${product.brand} ${product.name}: ${facings} facings starting at grid ${shelfGridPosition}`);
                                    
                                    shelfGridPosition += facings; // Move to next position
                                    globalMaxStackHeight = Math.max(globalMaxStackHeight, stackHeight);
                                    
                                } else if (slot.type === 'empty') {
                                    console.log(`  ‚≠ï Empty slot at grid ${shelfGridPosition}`);
                                    shelfGridPosition += 1; // Empty takes 1 slot
                                }
                            });
                        }
                    });
                    
                    const shelfTotalSlots = shelfGridPosition - 1;
                    console.log(`  üìä Shelf ${shelf.shelf_number} needs ${shelfTotalSlots} total grid slots`);
                    globalMaxPosition = Math.max(globalMaxPosition, shelfTotalSlots);
                });

                console.log(`üìè Global dimensions: ${globalMaxPosition} positions √ó ${globalMaxStackHeight} stack height`);
                
                // DEBUG: Test the logic with Coke Zero example
                console.log('üß™ TESTING LOGIC: Coke Zero at position 1 with 3 facings should fill grid slots 1, 2, 3');
                console.log('üß™ Grid calculation: position 1 ‚Üí grid columns 0, 1, 2 (0-based)');
                console.log('üß™ Display: Should show 3 separate Coke Zero cells');

                // Create main container
                const planogramDiv = document.createElement('div');
                planogramDiv.style.cssText = `
                    background: #f8fafc;
                    height: 100%;
                    padding: 16px;
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                    overflow: auto;
                    display: flex;
                    flex-direction: column;
                `;
                
                // Create shelves container
                const shelvesContainer = document.createElement('div');
                shelvesContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 16px;
                    min-height: 100%;
                    overflow: visible;
                    padding: 8px;
                    min-width: max-content;
                `;

                // Sort shelves from top to bottom (highest shelf number first)
                const sortedShelves = shelves.sort((a, b) => b.shelf_number - a.shelf_number);

                // ALL shelves use the SAME global dimensions
                sortedShelves.forEach(shelf => {
                    const shelfDiv = createGlobalConsistentShelfGrid(shelf, globalMaxPosition, globalMaxStackHeight);
                    shelvesContainer.appendChild(shelfDiv);
                });
                
                planogramDiv.appendChild(shelvesContainer);
                container.appendChild(planogramDiv);
            }
            

            
            function getConfidenceColor(confidence) {
                // EXACT MATCH with backend color mapping in src/api/planogram_editor.py
                // This must match the get_confidence_color function in the backend
                if (confidence >= 0.95) return '#22c55e'; // Green - very high (95%+)
                if (confidence >= 0.85) return '#3b82f6'; // Blue - high (85-94%)
                if (confidence >= 0.70) return '#f59e0b'; // Orange - medium (70-84%)
                return '#ef4444'; // Red - low (below 70%)
            }
            
            function getTotalProducts(shelves) {
                let total = 0;
                shelves.forEach(shelf => {
                    total += shelf.product_count || 0;
                });
                return total;
            }
            
            function getMaxStackHeight(shelf) {
                let maxStack = 1;
                Object.values(shelf.sections).forEach(section => {
                    section.forEach(slot => {
                        if (slot.type === 'product') {
                            const stack = slot.data.quantity?.stack || 1;
                            maxStack = Math.max(maxStack, stack);
                        }
                    });
                });
                return maxStack;
            }
            
            // Create GLOBAL CONSISTENT shelf grid - all shelves same width
            function createGlobalConsistentShelfGrid(shelf, globalMaxPosition, globalMaxStackHeight) {
                console.log(`üèóÔ∏è Creating GLOBAL CONSISTENT grid for Shelf ${shelf.shelf_number}: ${globalMaxPosition} positions √ó ${globalMaxStackHeight} stack (SAME for all shelves)`);
                
                const shelfDiv = document.createElement('div');
                shelfDiv.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    border: 1px solid #e2e8f0;
                    padding: 12px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                    display: flex;
                    align-items: stretch;
                `;

                // Shelf number on the left side
                const shelfNumber = document.createElement('div');
                shelfNumber.style.cssText = `
                    background: transparent;
                    color: #64748b;
                    font-weight: 600;
                    font-size: 16px;
                    padding: 8px 4px;
                    margin-right: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 25px;
                    flex-shrink: 0;
                `;
                shelfNumber.textContent = shelf.shelf_number;
                shelfDiv.appendChild(shelfNumber);

                // Grid container (no header)
                const gridWrapper = document.createElement('div');
                gridWrapper.style.cssText = `
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    overflow: hidden;
                    min-width: 0;
                `;

                // Create 2D grid array using GLOBAL dimensions
                const grid = createGlobal2DGrid(shelf, globalMaxPosition, globalMaxStackHeight);
                
                // Calculate ACTUAL stack height for THIS shelf (not global)
                let actualShelfStackHeight = 1;
                ['Left', 'Center', 'Right'].forEach(sectionName => {
                    if (shelf.sections[sectionName]) {
                        shelf.sections[sectionName].forEach(slot => {
                            if (slot.type === 'product' && slot.data) {
                                const stackHeight = slot.data.quantity?.stack || 1;
                                actualShelfStackHeight = Math.max(actualShelfStackHeight, stackHeight);
                            }
                        });
                    }
                });

                console.log(`üìê Shelf ${shelf.shelf_number}: Using actual stack height ${actualShelfStackHeight} (not global ${globalMaxStackHeight})`);

                // Create the visual grid container with FIXED compact dimensions - no horizontal scroll
                const gridContainer = document.createElement('div');
                gridContainer.className = 'planogram-grid';
                gridContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(${globalMaxPosition}, 45px);
                    grid-template-rows: repeat(${actualShelfStackHeight}, 32px);
                    gap: 1px;
                    background: #f7fafc;
                    border-radius: 4px;
                    padding: 6px;
                    width: 100%;
                    max-width: 100%;
                    box-sizing: border-box;
                    overflow: hidden;
                    transform-origin: top left;
                    transition: transform 0.3s ease;
                    justify-content: start;
                `;

                // DEBUG: Check what's actually in the grid before rendering
                console.log(`üîç GRID CONTENTS for shelf ${shelf.shelf_number}:`);
                for (let stackLevel = 0; stackLevel < actualShelfStackHeight; stackLevel++) {
                    let rowContents = [];
                    for (let position = 0; position < globalMaxPosition; position++) {
                        const cellData = grid[stackLevel][position];
                        if (cellData.type === 'product') {
                            rowContents.push(`${cellData.product.brand}(F${cellData.facingIndex})`);
                        } else {
                            rowContents.push('EMPTY');
                        }
                    }
                    console.log(`  Row ${stackLevel}: [${rowContents.join(', ')}]`);
                }

                // Fill grid with cells using ACTUAL shelf stack height
                for (let stackLevel = actualShelfStackHeight - 1; stackLevel >= 0; stackLevel--) {
                    for (let position = 0; position < globalMaxPosition; position++) {
                        const cellData = grid[stackLevel][position];
                        const cell = createGlobalGridCell(cellData, position + 1, stackLevel + 1);
                        gridContainer.appendChild(cell);
                    }
                }

                gridWrapper.appendChild(gridContainer);
                shelfDiv.appendChild(gridWrapper);
                return shelfDiv;
            }
            
            // Create GLOBAL 2D grid array using ACTUAL JSON data
            function createGlobal2DGrid(shelf, globalMaxPosition, globalMaxStackHeight) {
                console.log(`üìä Creating GLOBAL 2D grid from JSON: ${globalMaxPosition} √ó ${globalMaxStackHeight}`);
                
                // Initialize empty grid with GLOBAL dimensions
                const grid = [];
                for (let stackLevel = 0; stackLevel < globalMaxStackHeight; stackLevel++) {
                    grid[stackLevel] = [];
                    for (let position = 0; position < globalMaxPosition; position++) {
                        grid[stackLevel][position] = { 
                            type: 'empty', 
                            position: position + 1, 
                            stackLevel: stackLevel + 1 
                        };
                    }
                }
                
                // Place products from ACTUAL JSON data - CALCULATE REAL GRID POSITIONS
                console.log(`üèóÔ∏è Shelf ${shelf.shelf_number}: Starting product placement`);
                console.log(`üìä Raw shelf data:`, shelf);
                
                let currentGridPosition = 1; // Track actual grid position
                
                ['Left', 'Center', 'Right'].forEach(sectionName => {
                    if (shelf.sections[sectionName]) {
                        console.log(`üìÇ Section ${sectionName}: ${shelf.sections[sectionName].length} slots`);
                        console.log(`üìã Section ${sectionName} raw data:`, shelf.sections[sectionName]);
                        
                        shelf.sections[sectionName].forEach((slot, index) => {
                            console.log(`üîç Processing slot ${index + 1}:`, slot);
                            
                            if (slot.type === 'product' && slot.data) {
                                const facings = slot.data.quantity?.columns || 1;
                                console.log(`üìç PRODUCT: ${slot.data.brand} ${slot.data.name}`);
                                console.log(`üìê JSON position: ${slot.position} (sequence in section)`);
                                console.log(`üìê REAL grid position: ${currentGridPosition} (calculated)`);
                                console.log(`üìê Facings: ${facings} ‚Üí will occupy grid slots ${currentGridPosition} to ${currentGridPosition + facings - 1}`);
                                
                                placeProductInGlobalGrid(grid, slot.data, currentGridPosition);
                                currentGridPosition += facings; // Move to next available position
                                
                            } else if (slot.type === 'empty') {
                                console.log(`‚≠ï EMPTY: JSON position ${slot.position} ‚Üí grid position ${currentGridPosition}`);
                                currentGridPosition += 1; // Empty slot takes 1 position
                            } else {
                                console.log(`‚ùì UNKNOWN SLOT TYPE: ${slot.type}`, slot);
                            }
                        });
                    } else {
                        console.log(`üìÇ Section ${sectionName}: No data`);
                    }
                });
                console.log(`‚úÖ Shelf ${shelf.shelf_number}: Product placement complete. Total grid positions used: ${currentGridPosition - 1}`);
                
                return grid;
            }
            
            // Place product in GLOBAL grid - DECOUPLE JSON position from grid positions
            function placeProductInGlobalGrid(grid, product, jsonPosition) {
                // Extract EXACT values from JSON data
                const facings = product.quantity?.columns || 1;
                const stackHeight = product.quantity?.stack || 1;
                
                console.log(`üì¶ PRODUCT: ${product.brand} ${product.name}`);
                console.log(`üìç JSON position: ${jsonPosition} (starting position of this product)`);
                console.log(`üìê Facings: ${facings} (will occupy ${facings} grid slots)`);
                console.log(`üìö Stack: ${stackHeight} (height in each slot)`);
                console.log(`üéØ GRID SLOTS TO FILL: ${jsonPosition} to ${jsonPosition + facings - 1}`);
                
                // FILL GRID SLOTS: Each facing gets its own grid column
                for (let stackLevel = 0; stackLevel < stackHeight; stackLevel++) {
                    for (let facing = 0; facing < facings; facing++) {
                        // GRID POSITION CALCULATION:
                        // - jsonPosition is 1-based (e.g., position 4)
                        // - grid is 0-based (e.g., grid[0][3])
                        // - facing 0 goes to jsonPosition, facing 1 goes to jsonPosition+1, etc.
                        const gridRow = stackLevel;
                        const gridCol = (jsonPosition - 1) + facing; // Convert to 0-based and add facing offset
                        
                        console.log(`  üî≤ SLOT ${gridCol + 1}: grid[${gridRow}][${gridCol}] = ${product.brand} facing ${facing + 1}/${facings}, stack ${stackLevel + 1}/${stackHeight}`);
                        
                        if (gridRow < grid.length && gridCol < grid[0].length) {
                            grid[gridRow][gridCol] = {
                                type: 'product',
                                product: product,
                                jsonPosition: jsonPosition, // Original JSON position
                                gridPosition: gridCol + 1, // Actual grid slot (1-based)
                                stackLevel: stackLevel + 1,
                                facingIndex: facing + 1,
                                totalFacings: facings,
                                totalStack: stackHeight,
                                cellId: `${product.id || product.brand}-JSON${jsonPosition}-GRID${gridCol + 1}-F${facing + 1}S${stackLevel + 1}`
                            };
                            console.log(`    ‚úÖ FILLED grid slot ${gridCol + 1} with ${product.brand} facing ${facing + 1}`);
                        } else {
                            console.error(`‚ùå GRID OVERFLOW: grid[${gridRow}][${gridCol}] for ${product.brand} facing ${facing + 1}`);
                        }
                    }
                }
                console.log(`‚úÖ ${product.brand}: JSON position ${jsonPosition} ‚Üí FILLED grid slots ${jsonPosition} to ${jsonPosition + facings - 1}`);
            }
            
            // Create grid cell using EXACT JSON data - truly empty slots are invisible
            function createGlobalGridCell(cellData, position, stackLevel) {
                const cell = document.createElement('div');
                
                if (cellData.type === 'empty') {
                    // TRULY EMPTY cell - completely transparent/invisible with fixed dimensions
                    cell.style.cssText = `
                        background: transparent;
                        border: none;
                        height: 32px;
                        width: 45px;
                        min-width: 45px;
                        max-width: 45px;
                        box-sizing: border-box;
                    `;
                    return cell;
                }

                // Product cell using EXACT JSON data
                const { product, jsonPosition, gridPosition, facingIndex, stackLevel: productStackLevel, totalFacings, totalStack, cellId } = cellData;
                
                // Use EXACT confidence from JSON - prioritize visual.confidence_color if available
                const confidence = product.metadata?.extraction_confidence || product.extraction_confidence || 0.9;
                const confidenceColor = product.visual?.confidence_color || getConfidenceColor(confidence);
                
                console.log(`üé® Cell: ${cellId}, JSON pos: ${jsonPosition}, Grid pos: ${gridPosition}, Facing: ${facingIndex}/${totalFacings}, Stack: ${productStackLevel}/${totalStack}, Confidence: ${confidence}`);
                console.log(`üé® Color source: ${product.visual?.confidence_color ? 'JSON visual.confidence_color' : 'calculated from confidence'} = ${confidenceColor}`);
                console.log(`üé® Product visual data:`, product.visual);
                
                // Style product cell - FIXED compact size to prevent expansion
                cell.style.cssText = `
                    background: linear-gradient(135deg, ${confidenceColor} 0%, ${adjustColor(confidenceColor, -20)} 100%);
                    color: white;
                    border-radius: 2px;
                    height: 32px;
                    width: 45px;
                    min-width: 45px;
                    max-width: 45px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    font-size: 6px;
                    font-weight: 500;
                    border: 1px solid ${confidenceColor};
                    position: relative;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                    box-sizing: border-box;
                    overflow: hidden;
                `;

                // Add hover effect
                cell.addEventListener('mouseenter', () => {
                    cell.style.transform = 'scale(1.05)';
                    cell.style.zIndex = '10';
                    cell.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                });
                cell.addEventListener('mouseleave', () => {
                    cell.style.transform = 'scale(1)';
                    cell.style.zIndex = '1';
                    cell.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                });

                // Add data attribute for display controls
                cell.setAttribute('data-product-cell', 'true');

                // ALL CELLS show the same product info - no "main cell" concept for facings
                const brandDiv = document.createElement('div');
                brandDiv.setAttribute('data-brand', 'true');
                brandDiv.style.cssText = `
                    font-weight: 700;
                    font-size: 6px;
                    text-align: center;
                    margin-bottom: 0px;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    white-space: nowrap;
                    width: 100%;
                    line-height: 1;
                `;
                brandDiv.textContent = product.brand || 'Unknown';

                const nameDiv = document.createElement('div');
                nameDiv.setAttribute('data-name', 'true');
                nameDiv.style.cssText = `
                    font-size: 5px;
                    text-align: center;
                    opacity: 0.9;
                    text-overflow: ellipsis;
                    overflow: hidden;
                    white-space: nowrap;
                    width: 100%;
                    line-height: 1;
                    margin-bottom: 0px;
                `;
                nameDiv.textContent = product.name || 'Product';

                if (product.price) {
                    const priceDiv = document.createElement('div');
                    priceDiv.setAttribute('data-price', 'true');
                    priceDiv.style.cssText = `
                        font-size: 5px;
                        font-weight: 700;
                        text-align: center;
                        background: rgba(255,255,255,0.2);
                        padding: 0px 2px;
                        border-radius: 1px;
                        line-height: 1;
                        margin-top: 1px;
                    `;
                    priceDiv.textContent = `¬£${product.price.toFixed(2)}`;
                    cell.appendChild(priceDiv);
                }

                const confidenceDiv = document.createElement('div');
                confidenceDiv.setAttribute('data-confidence', 'true');
                confidenceDiv.style.cssText = `
                    font-size: 4px;
                    font-weight: 700;
                    text-align: center;
                    background: rgba(0,0,0,0.7);
                    color: white;
                    padding: 0px 1px;
                    border-radius: 1px;
                    margin-top: 1px;
                    display: none;
                    line-height: 1;
                `;
                confidenceDiv.textContent = `${Math.round(confidence * 100)}%`;
                cell.appendChild(confidenceDiv);

                cell.appendChild(brandDiv);
                cell.appendChild(nameDiv);

                // Add facing indicator for debugging (optional)
                if (totalFacings > 1) {
                    const indicator = document.createElement('div');
                    indicator.style.cssText = `
                        position: absolute;
                        top: 1px;
                        right: 1px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        font-size: 4px;
                        padding: 0px 1px;
                        border-radius: 1px;
                        font-weight: 700;
                        line-height: 1;
                    `;
                    indicator.textContent = `F${facingIndex}`;
                    cell.appendChild(indicator);
                }

                // Add click handler with EXACT JSON data
                cell.addEventListener('click', () => {
                    console.log(`üñ±Ô∏è Clicked cell: ${cellId}`);
                    console.log(`üìç Product: ${product.brand} ${product.name}`);
                    console.log(`üìê JSON position: ${jsonPosition}, Grid position: ${gridPosition}`);
                    console.log(`üìä Facing: ${facingIndex}/${totalFacings}, Stack: ${productStackLevel}/${totalStack}`);
                    console.log('Full product data:', product);
                });

                return cell;
            }
            
            // Utility function to adjust color brightness
            function adjustColor(color, amount) {
                const usePound = color[0] === '#';
                const col = usePound ? color.slice(1) : color;
                const num = parseInt(col, 16);
                let r = (num >> 16) + amount;
                let g = (num >> 8 & 0x00FF) + amount;
                let b = (num & 0x0000FF) + amount;
                r = r > 255 ? 255 : r < 0 ? 0 : r;
                g = g > 255 ? 255 : g < 0 ? 0 : g;
                b = b > 255 ? 255 : b < 0 ? 0 : b;
                return (usePound ? '#' : '') + (r << 16 | g << 8 | b).toString(16).padStart(6, '0');
            }


            
            // Utility function
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Load React component only when needed (for Advanced mode)
            function loadReactComponent() {
                console.log('üì¶ Loading InteractivePlanogram component for Advanced mode...');
                
                // Check if React is available
                if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
                    console.log('‚è≥ React not ready, waiting...');
                    setTimeout(loadReactComponent, 100);
                    return;
                }
                
                // Check if already loaded
                if (typeof window.InteractivePlanogram !== 'undefined') {
                    console.log('‚úÖ InteractivePlanogram already loaded');
                    initializePlanogramComponent();
                    return;
                }
                
                // Load the component script
                const script = document.createElement('script');
                script.src = `/static/components/InteractivePlanogram.js?v=${Date.now()}`;
                script.onload = function() {
                    console.log('‚úÖ React component script loaded');
                    if (typeof window.InteractivePlanogram !== 'undefined') {
                        console.log('üöÄ Initializing React Planogram Component...');
                        initializePlanogramComponent();
                    } else {
                        console.error('‚ùå InteractivePlanogram still not available after loading script');
                    }
                };
                script.onerror = function() {
                    console.error('‚ùå Failed to load React component script');
                };
                document.head.appendChild(script);
            }
            
            // Initialize React Planogram Component
            function initializePlanogramComponent() {
                console.log('üöÄ Initializing React Planogram Component...');
                
                // Check if everything is loaded
                if (typeof React === 'undefined') {
                    console.error('‚ùå React not loaded');
                    return false;
                }
                
                if (typeof ReactDOM === 'undefined') {
                    console.error('‚ùå ReactDOM not loaded');
                    return false;
                }
                
                if (typeof window.InteractivePlanogram === 'undefined') {
                    console.error('‚ùå InteractivePlanogram component not loaded');
                    return false;
                }
                
                // Find the planogram container
                const planogramContainer = document.getElementById('planogramViewer');
                if (!planogramContainer) {
                    console.log('‚ö†Ô∏è Planogram container not found (will try later)');
                    return false;
                }
                
                try {
                    // Clear existing content
                    planogramContainer.innerHTML = '';
                    
                    // Create and render React component
                    const planogramElement = React.createElement(window.InteractivePlanogram, {
                        imageId: 'demo'
                    });
                    
                    ReactDOM.render(planogramElement, planogramContainer);
                    console.log('‚úÖ React Planogram Component rendered successfully');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error rendering React component:', error);
                    planogramContainer.innerHTML = `
                        <div style="padding: 20px; text-align: center; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;">
                            <h3>‚ö†Ô∏è Component Error</h3>
                            <p>Failed to render planogram: ${error.message}</p>
                        </div>
                    `;
                    return false;
                }
            }
            
            // Force load planogram function (called from main DOMContentLoaded)
            window.forceLoadPlanogram = function() {
                console.log('üîß Force loading planogram...');
                if (typeof window.InteractivePlanogram !== 'undefined') {
                    initializePlanogramComponent();
                } else {
                    loadReactComponent();
                }
            };
            
            // Prompt Management State
            let promptManagementState = {
                selectedSystem: 'custom_consensus',
                selectedPromptType: 'structure',
                selectedPromptModel: 'universal',
                selectedPromptVersion: '',
                selectedPrompt: null,
                editedPromptContent: '',
                selectedQueueItems: [],
                allSelected: false
            };
            
            // Utility function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Batch Operations Functions
            function toggleSelectAll() {
                promptManagementState.allSelected = !promptManagementState.allSelected;
                
                if (promptManagementState.allSelected) {
                    // Select all visible items
                    promptManagementState.selectedQueueItems = queueData.map(item => item.id);
                } else {
                    promptManagementState.selectedQueueItems = [];
                }
                
                // Re-render queue to update UI
                renderQueue();
                updateQueueStats();
            }
            
            function toggleItemSelection(itemId) {
                const index = promptManagementState.selectedQueueItems.indexOf(itemId);
                if (index > -1) {
                    promptManagementState.selectedQueueItems.splice(index, 1);
                } else {
                    promptManagementState.selectedQueueItems.push(itemId);
                }
                
                // Update select all state
                promptManagementState.allSelected = promptManagementState.selectedQueueItems.length === queueData.length;
                
                // Re-render queue to update UI
                renderQueue();
                updateQueueStats();
            }
            
            async function applyConfigToSelected() {
                if (promptManagementState.selectedQueueItems.length === 0) {
                    alert('No items selected');
                    return;
                }
                
                try {
                    const response = await fetch('/api/queue/batch-configure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: promptManagementState.selectedQueueItems,
                            system: promptManagementState.selectedSystem,
                            prompt_overrides: promptManagementState.selectedPromptVersion ? {
                                [promptManagementState.selectedPromptType]: promptManagementState.selectedPromptVersion
                            } : {}
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`Configuration applied to ${result.updated_items?.length || promptManagementState.selectedQueueItems.length} items`);
                        // Clear selection and reload queue
                        promptManagementState.selectedQueueItems = [];
                        promptManagementState.allSelected = false;
                        loadQueue();
                    } else {
                        alert('Failed to apply configuration: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Failed to apply configuration:', error);
                    alert('Failed to apply configuration: ' + error.message);
                }
            }
            
            async function resetSelectedItems() {
                if (promptManagementState.selectedQueueItems.length === 0) {
                    alert('No items selected');
                    return;
                }
                
                if (!confirm(`Reset configuration for ${promptManagementState.selectedQueueItems.length} selected items?`)) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/queue/batch-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: promptManagementState.selectedQueueItems
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`Configuration reset for ${result.reset_items?.length || promptManagementState.selectedQueueItems.length} items`);
                        // Clear selection and reload queue
                        promptManagementState.selectedQueueItems = [];
                        promptManagementState.allSelected = false;
                        loadQueue();
                    } else {
                        alert('Failed to reset configuration: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Failed to reset configuration:', error);
                    alert('Failed to reset configuration: ' + error.message);
                }
            }
            
            // Initialize Prompt Management
            async function initializePromptManagement() {
                console.log('üéõÔ∏è Initializing Prompt Management...');
                
                try {
                    // Load available prompts for dropdowns
                    console.log('üì° Fetching available prompts...');
                    const availablePromptsResponse = await fetch('/api/prompts/available');
                    if (!availablePromptsResponse.ok) {
                        throw new Error(`Failed to load available prompts: ${availablePromptsResponse.status}`);
                    }
                    const availablePrompts = await availablePromptsResponse.json();
                    console.log('‚úÖ Available prompts loaded:', availablePrompts.length, 'prompts');
                    console.log('üìã First prompt sample:', availablePrompts[0]);
                    
                    // Populate system selection first
                    populateSystemSelection();
                    
                    // Populate prompt dropdowns with the fetched data
                    populatePromptDropdowns(availablePrompts);
                    
                    // Load initial prompt preview if we have prompts
                    if (availablePrompts && availablePrompts.length > 0) {
                        // Set initial selections to first available prompt
                        const firstPrompt = availablePrompts[0];
                        promptManagementState.selectedPromptType = firstPrompt.type;
                        promptManagementState.selectedPromptModel = firstPrompt.model;
                        promptManagementState.selectedPromptVersion = firstPrompt.id;
                        
                        console.log('üéØ Loading initial prompt preview:', firstPrompt.id);
                        await loadPromptPreview(firstPrompt.id);
                        
                        // Update dropdowns to show selections
                        const typeSelect = document.getElementById('promptTypeSelect');
                        const modelSelect = document.getElementById('promptModelSelect');
                        const versionSelect = document.getElementById('promptVersionSelect');
                        
                        if (typeSelect) typeSelect.value = firstPrompt.type;
                        if (modelSelect) modelSelect.value = firstPrompt.model;
                        if (versionSelect) versionSelect.value = firstPrompt.id;
                        
                    } else {
                        console.warn('‚ö†Ô∏è No available prompts found');
                        // Show placeholder content
                        const contentElement = document.getElementById('promptPreviewContent');
                        if (contentElement) {
                            contentElement.innerHTML = '<div style="color: #f59e0b; padding: 10px;">‚ö†Ô∏è No prompts available. Check API connection.</div>';
                        }
                    }
                    
                    console.log('‚úÖ Prompt management initialization complete');
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize prompt management:', error);
                    // Show error in UI
                    const contentElement = document.getElementById('promptPreviewContent');
                    if (contentElement) {
                        contentElement.innerHTML = `<div style="color: #ef4444; padding: 10px;">‚ùå Error loading prompts: ${error.message}<br><small>Check browser console for details</small></div>`;
                    }
                }
            }
            
            // Populate System Selection
            function populateSystemSelection() {
                const systemContainer = document.getElementById('systemSelection');
                if (!systemContainer) return;
                
                const systems = [
                    { id: 'custom_consensus', name: 'Custom Consensus', description: 'Multi-model consensus with weighted voting' },
                    { id: 'langgraph', name: 'LangGraph', description: 'Graph-based workflow orchestration' },
                    { id: 'hybrid', name: 'Hybrid', description: 'Combined approach with memory' }
                ];
                
                systemContainer.innerHTML = systems.map(system => `
                    <div class="radio-option ${system.id === promptManagementState.selectedSystem ? 'selected' : ''}" 
                         onclick="selectSystem('${system.id}')">
                        <input type="radio" name="system" value="${system.id}" 
                               ${system.id === promptManagementState.selectedSystem ? 'checked' : ''}>
                        <label>${system.name}</label>
                    </div>
                `).join('');
            }
            
            // Select System
            function selectSystem(systemId) {
                promptManagementState.selectedSystem = systemId;
                populateSystemSelection();
                console.log('Selected system:', systemId);
                
                // Update the display to show current selection
                document.querySelectorAll('.radio-option').forEach(option => {
                    option.classList.remove('selected');
                    const radio = option.querySelector('input[type="radio"]');
                    if (radio) radio.checked = false;
                });
                
                const selectedOption = document.querySelector(`input[value="${systemId}"]`);
                if (selectedOption) {
                    selectedOption.checked = true;
                    selectedOption.closest('.radio-option').classList.add('selected');
                }
            }
            
            // Populate Prompt Dropdowns
            function populatePromptDropdowns(availablePrompts) {
                console.log('üìã populatePromptDropdowns called with:', availablePrompts);
                
                const typeSelect = document.getElementById('promptTypeSelect');
                const modelSelect = document.getElementById('promptModelSelect');
                const versionSelect = document.getElementById('promptVersionSelect');
                
                if (!typeSelect || !modelSelect || !versionSelect) {
                    console.error('‚ùå Prompt dropdown elements not found!');
                    console.log('typeSelect:', typeSelect);
                    console.log('modelSelect:', modelSelect);
                    console.log('versionSelect:', versionSelect);
                    return;
                }
                
                // Ensure we have an array
                let promptsArray = Array.isArray(availablePrompts) ? availablePrompts : Object.values(availablePrompts || {});
                
                if (!promptsArray || promptsArray.length === 0) {
                    console.warn('‚ö†Ô∏è No prompts available for dropdowns');
                    typeSelect.innerHTML = '<option value="">No prompts available</option>';
                    modelSelect.innerHTML = '<option value="">No prompts available</option>';
                    versionSelect.innerHTML = '<option value="">No prompts available</option>';
                    return;
                }
                
                console.log(`üìä Processing ${promptsArray.length} prompts for dropdowns`);
                
                // Extract unique types
                const types = [...new Set(promptsArray.map(p => p.type).filter(Boolean))];
                console.log('üìù Available types:', types);
                
                // Extract unique models
                const models = [...new Set(promptsArray.map(p => p.model).filter(Boolean))];
                console.log('ü§ñ Available models:', models);
                
                // Populate type dropdown
                typeSelect.innerHTML = '<option value="">Select Type</option>' + types.map(type => {
                    const displayName = type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ');
                    const isSelected = type === promptManagementState.selectedPromptType;
                    return `<option value="${type}" ${isSelected ? 'selected' : ''}>${displayName}</option>`;
                }).join('');
                
                // Populate model dropdown
                modelSelect.innerHTML = '<option value="">Select Model</option>' + models.map(model => {
                    const displayName = model.charAt(0).toUpperCase() + model.slice(1);
                    const isSelected = model === promptManagementState.selectedPromptModel;
                    return `<option value="${model}" ${isSelected ? 'selected' : ''}>${displayName}</option>`;
                }).join('');
                
                // Populate version dropdown
                updateVersionDropdown(promptsArray);
                
                console.log('‚úÖ Prompt dropdowns populated successfully');
            }
            
            // Update Version Dropdown
            function updateVersionDropdown(availablePrompts) {
                const versionSelect = document.getElementById('promptVersionSelect');
                if (!versionSelect) {
                    console.warn('‚ö†Ô∏è Version select element not found');
                    return;
                }
                
                console.log('üîÑ Updating version dropdown with filters:', {
                    selectedType: promptManagementState.selectedPromptType,
                    selectedModel: promptManagementState.selectedPromptModel
                });
                
                const filteredPrompts = availablePrompts.filter(p => {
                    const typeMatch = !promptManagementState.selectedPromptType || p.type === promptManagementState.selectedPromptType;
                    const modelMatch = !promptManagementState.selectedPromptModel || p.model === promptManagementState.selectedPromptModel;
                    return typeMatch && modelMatch;
                });
                
                console.log('üìã Filtered prompts:', filteredPrompts);
                
                if (filteredPrompts.length === 0) {
                    versionSelect.innerHTML = '<option value="">No matching prompts</option>';
                    return;
                }
                
                versionSelect.innerHTML = '<option value="">Select Version</option>' + filteredPrompts.map((prompt, index) => {
                    const successRate = prompt.performance_stats?.success_rate || prompt.performance?.success_rate || 'N/A';
                    const isSelected = prompt.id === promptManagementState.selectedPromptVersion || (index === 0 && !promptManagementState.selectedPromptVersion);
                    return `<option value="${prompt.id}" ${isSelected ? 'selected' : ''}>${prompt.version} (${successRate}% success)</option>`;
                }).join('');
                
                if (filteredPrompts.length > 0 && !promptManagementState.selectedPromptVersion) {
                    promptManagementState.selectedPromptVersion = filteredPrompts[0].id;
                    loadPromptPreview(filteredPrompts[0].id);
                }
            }
            
            // Handle Prompt Selection Changes
            async function onPromptSelectionChange() {
                const typeSelect = document.getElementById('promptTypeSelect');
                const modelSelect = document.getElementById('promptModelSelect');
                const versionSelect = document.getElementById('promptVersionSelect');
                
                if (typeSelect) promptManagementState.selectedPromptType = typeSelect.value;
                if (modelSelect) promptManagementState.selectedPromptModel = modelSelect.value;
                
                console.log('üîÑ Prompt selection changed:', {
                    type: promptManagementState.selectedPromptType,
                    model: promptManagementState.selectedPromptModel
                });
                
                // Reload available prompts with filters
                try {
                    const response = await fetch(`/api/prompts/available?type=${promptManagementState.selectedPromptType}&model=${promptManagementState.selectedPromptModel}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load filtered prompts: ${response.status}`);
                    }
                    const availablePrompts = await response.json();
                    console.log('‚úÖ Filtered prompts loaded:', availablePrompts);
                    updateVersionDropdown(availablePrompts);
                } catch (error) {
                    console.error('‚ùå Failed to update prompt selection:', error);
                    // Show error in version dropdown
                    const versionSelect = document.getElementById('promptVersionSelect');
                    if (versionSelect) {
                        versionSelect.innerHTML = '<option value="">Error loading prompts</option>';
                    }
                }
            }
            
            // Load Prompt Preview
            async function loadPromptPreview(promptId) {
                try {
                    console.log('üîç Loading prompt preview for ID:', promptId);
                    
                    const response = await fetch(`/api/prompts/${promptId}`);
                    if (!response.ok) {
                        console.error(`‚ùå Failed to fetch prompt ${promptId}: ${response.status} ${response.statusText}`);
                        throw new Error(`Failed to load prompt: ${response.status} ${response.statusText}`);
                    }
                    
                    const prompt = await response.json();
                    console.log('‚úÖ Prompt loaded successfully:', prompt);
                    
                    promptManagementState.selectedPrompt = prompt;
                    
                    // Update preview content
                    const contentElement = document.getElementById('promptPreviewContent');
                    if (contentElement) {
                        // Try different possible content fields
                        const content = prompt.content || prompt.full_content || prompt.template || prompt.prompt_text || 'No content available';
                        console.log('üìù Prompt content length:', content.length);
                        
                        if (content === 'No content available') {
                            contentElement.innerHTML = `
                                <div style="color: #f59e0b; padding: 10px; background: #fef3c7; border-radius: 4px;">
                                    ‚ö†Ô∏è No content found for this prompt<br>
                                    <small>Available fields: ${Object.keys(prompt).join(', ')}</small>
                                </div>
                            `;
                        } else {
                            // Show first 500 characters
                            const truncatedContent = content.length > 500 ? content.substring(0, 500) + '...' : content;
                            contentElement.innerHTML = `
                                <div style="background: #f8fafc; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 11px; line-height: 1.4; white-space: pre-wrap;">
                                    ${escapeHtml(truncatedContent)}
                                </div>
                                <div style="margin-top: 8px; font-size: 10px; color: #64748b;">
                                    ${content.length > 500 ? `Showing first 500 of ${content.length} characters` : `${content.length} characters total`}
                                </div>
                            `;
                        }
                    }
                    
                    // Update performance metrics
                    const performanceStats = prompt.performance_stats || prompt.performance || {};
                    updatePerformanceMetrics(performanceStats);
                    
                    // Update editor content
                    const editorElement = document.getElementById('promptEditorContent');
                    if (editorElement) {
                        const content = prompt.content || prompt.full_content || prompt.template || prompt.prompt_text || '';
                        editorElement.value = content;
                        promptManagementState.editedPromptContent = content;
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to load prompt preview:', error);
                    
                    // Show detailed error in preview
                    const contentElement = document.getElementById('promptPreviewContent');
                    if (contentElement) {
                        contentElement.innerHTML = `
                            <div style="color: #ef4444; padding: 10px; background: #fef2f2; border-radius: 4px;">
                                ‚ùå Error loading prompt: ${error.message}<br>
                                <small>Prompt ID: ${promptId}</small><br>
                                <small>Check browser console for details</small>
                            </div>
                        `;
                    }
                }
            }
            
            // Update Performance Metrics
            function updatePerformanceMetrics(stats) {
                const metricsContainer = document.getElementById('performanceMetrics');
                if (!metricsContainer) {
                    console.warn('‚ö†Ô∏è Performance metrics container not found');
                    return;
                }
                
                console.log('üìä Updating performance metrics:', stats);
                
                // Handle missing or undefined stats
                const successRate = stats.success_rate || stats.accuracy || 'N/A';
                const usageCount = stats.usage_count || stats.uses || 0;
                const avgCost = stats.avg_cost || stats.cost || 0;
                const errorRate = stats.error_rate || (1 - (stats.success_rate || 0));
                
                metricsContainer.innerHTML = `
                    <div class="metric">
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-value">${typeof successRate === 'number' ? successRate.toFixed(1) + '%' : successRate}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Usage Count</div>
                        <div class="metric-value">${usageCount}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Avg Cost</div>
                        <div class="metric-value">¬£${typeof avgCost === 'number' ? avgCost.toFixed(3) : avgCost}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Error Rate</div>
                        <div class="metric-value">${typeof errorRate === 'number' ? (errorRate * 100).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                `;
            }
            
            // Save New Prompt Version
            async function saveNewPromptVersion() {
                try {
                    const response = await fetch('/api/prompts/create-version', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            base_prompt_id: promptManagementState.selectedPrompt.id,
                            content: promptManagementState.editedPromptContent,
                            notes: 'Created via sidebar interface'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('New prompt version created successfully!');
                        // Refresh available prompts
                        const availablePrompts = await fetch('/api/prompts/available').then(r => r.json());
                        populatePromptDropdowns(availablePrompts);
                    }
                } catch (error) {
                    console.error('Failed to save prompt version:', error);
                    alert('Failed to save prompt version');
                }
            }
            
            // Activate Prompt
            async function activatePrompt() {
                try {
                    const response = await fetch(`/api/prompts/${promptManagementState.selectedPromptVersion}/activate`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Prompt activated successfully!');
                    }
                } catch (error) {
                    console.error('Failed to activate prompt:', error);
                    alert('Failed to activate prompt');
                }
            }
            
            // Enhanced Extraction Settings Functions
            
            // Show Smart Recommendations
            function showSmartRecommendations(context = {}) {
                const recommendationsDiv = document.getElementById('smartRecommendations');
                if (!recommendationsDiv) return;
                
                // Update context display
                document.getElementById('recStore').textContent = context.store || 'Tesco Metro';
                document.getElementById('recCategory').textContent = context.category || 'Beverages';
                document.getElementById('recHistory').textContent = context.history || 'No history available';
                
                // Generate auto-selection choices
                const autoChoices = generateAutoSelectionChoices(context);
                const choicesContainer = document.getElementById('autoSelectChoices');
                choicesContainer.innerHTML = autoChoices.map(choice => `
                    <div class="auto-choice">
                        <strong>${choice.type}:</strong> ${choice.selection}
                        <div class="reason">${choice.reason}</div>
                    </div>
                `).join('');
                
                recommendationsDiv.style.display = 'block';
            }
            
            // Generate Auto-Selection Choices
            function generateAutoSelectionChoices(context) {
                return [
                    {
                        type: 'System',
                        selection: 'Custom Consensus',
                        reason: 'Best performance for beverage category (92% avg accuracy)'
                    },
                    {
                        type: 'Structure Model',
                        selection: 'Claude-3.5-Sonnet',
                        reason: 'Highest shelf detection accuracy for this store type'
                    },
                    {
                        type: 'Products Model',
                        selection: 'GPT-4o',
                        reason: 'Superior product identification in crowded shelves'
                    },
                    {
                        type: 'Details Model',
                        selection: 'Claude-3.5-Sonnet',
                        reason: 'Best price extraction for UK retail format'
                    }
                ];
            }
            
            // Use Auto-Selection
            function useAutoSelection() {
                // Apply the auto-selected configuration
                selectSystem('custom_consensus');
                
                // Set model assignments
                document.getElementById('model-structure').value = 'claude';
                document.getElementById('model-products').value = 'gpt4o';
                document.getElementById('model-details').value = 'claude';
                
                // Update prompt options for each model
                updatePromptOptions('structure');
                updatePromptOptions('products');
                updatePromptOptions('details');
                
                // Hide recommendations and show configuration
                document.getElementById('smartRecommendations').style.display = 'none';
                document.getElementById('modelConfig').style.display = 'block';
                document.getElementById('promptSelection').style.display = 'block';
                
                console.log('‚úÖ Auto-selection applied');
            }
            
            // Show Custom Selection
            function showCustomSelection() {
                document.getElementById('smartRecommendations').style.display = 'none';
                document.getElementById('modelConfig').style.display = 'block';
                document.getElementById('promptSelection').style.display = 'block';
            }
            
            // Update Prompt Options
            async function updatePromptOptions(extractionType) {
                const modelSelect = document.getElementById(`model-${extractionType}`);
                const promptSelect = document.getElementById(`prompt-${extractionType}`);
                
                if (!modelSelect || !promptSelect) return;
                
                const selectedModel = modelSelect.value;
                
                try {
                    // Fetch prompts for this type and model
                    const response = await fetch(`/api/prompts/available?type=${extractionType}&model=${selectedModel}`);
                    const prompts = await response.json();
                    
                    // Populate prompt dropdown with performance data
                    promptSelect.innerHTML = '<option value="auto">ü§ñ Auto-select best</option>' + 
                        prompts.map(prompt => {
                            const successRate = prompt.performance_stats?.success_rate || 85;
                            const usageCount = prompt.performance_stats?.usage_count || 0;
                            return `<option value="${prompt.id}">${prompt.name} (${successRate}% ‚Ä¢ ${usageCount} uses)</option>`;
                        }).join('');
                        
                } catch (error) {
                    console.error(`Failed to load prompts for ${extractionType}:`, error);
                    promptSelect.innerHTML = '<option value="auto">ü§ñ Auto-select best</option>';
                }
            }
            
            // Show Prompt Preview
            async function showPromptPreview(extractionType) {
                const promptSelect = document.getElementById(`prompt-${extractionType}`);
                const previewDiv = document.getElementById(`preview-${extractionType}`);
                
                if (!promptSelect || !previewDiv) return;
                
                const selectedPromptId = promptSelect.value;
                
                if (selectedPromptId === 'auto') {
                    previewDiv.style.display = 'none';
                    return;
                }
                
                try {
                    // Fetch prompt details
                    const response = await fetch(`/api/prompts/${selectedPromptId}`);
                    const prompt = await response.json();
                    
                    // Update preview content
                    const promptName = previewDiv.querySelector('.prompt-name');
                    const performanceBadge = previewDiv.querySelector('.performance-badge');
                    const previewStats = previewDiv.querySelector('.preview-stats');
                    const promptSnippet = previewDiv.querySelector('.prompt-snippet');
                    
                    if (promptName) promptName.textContent = prompt.metadata?.prompt_type || 'Unknown Prompt';
                    if (performanceBadge) {
                        const successRate = prompt.performance_stats?.success_rate || 85;
                        performanceBadge.textContent = `${successRate}% success`;
                    }
                    if (previewStats) {
                        const stats = prompt.performance_stats || {};
                        previewStats.innerHTML = `
                            <span>üìä ${stats.usage_count || 0} uses</span>
                            <span>‚è±Ô∏è Last: ${getTimeAgo(prompt.metadata?.updated_at)}</span>
                            <span>üí∞ Avg cost: ¬£${(stats.avg_cost || 0.025).toFixed(3)}</span>
                        `;
                    }
                    if (promptSnippet) {
                        const content = prompt.content || prompt.full_content || '';
                        promptSnippet.textContent = content.substring(0, 150) + (content.length > 150 ? '...' : '');
                    }
                    
                    previewDiv.style.display = 'block';
                    
                } catch (error) {
                    console.error(`Failed to load prompt preview for ${extractionType}:`, error);
                    previewDiv.style.display = 'none';
                }
            }
            
            // Create New Prompt
            function createNewPrompt(extractionType) {
                // Open the enhanced prompt engineering modal
                openPromptEngineeringModal(extractionType);
            }
            
            // View Full Prompt
            async function viewFullPrompt(extractionType) {
                const promptSelect = document.getElementById(`prompt-${extractionType}`);
                if (!promptSelect) return;
                
                const selectedPromptId = promptSelect.value;
                if (selectedPromptId === 'auto') return;
                
                try {
                    const response = await fetch(`/api/prompts/${selectedPromptId}`);
                    const prompt = await response.json();
                    
                    // Open the enhanced prompt engineering modal in view mode
                    openPromptEngineeringModal(extractionType, prompt, 'view');
                    
                } catch (error) {
                    console.error('Failed to load full prompt:', error);
                    alert('Failed to load prompt details');
                }
            }
            
            // Customize Prompt
            async function customizePrompt(extractionType) {
                const promptSelect = document.getElementById(`prompt-${extractionType}`);
                if (!promptSelect) return;
                
                const selectedPromptId = promptSelect.value;
                if (selectedPromptId === 'auto') return;
                
                try {
                    const response = await fetch(`/api/prompts/${selectedPromptId}`);
                    const prompt = await response.json();
                    
                    // Open the enhanced prompt engineering modal in edit mode
                    openPromptEngineeringModal(extractionType, prompt, 'edit');
                    
                } catch (error) {
                    console.error('Failed to load prompt for customization:', error);
                    alert('Failed to load prompt for customization');
                }
            }
            
            // View Performance
            async function viewPerformance(extractionType) {
                const promptSelect = document.getElementById(`prompt-${extractionType}`);
                if (!promptSelect) return;
                
                const selectedPromptId = promptSelect.value;
                if (selectedPromptId === 'auto') return;
                
                // Open performance analytics modal
                openPerformanceModal(selectedPromptId);
            }
            
            // Apply Enhanced Configuration to Selected Items
            async function applyEnhancedConfigToSelected() {
                if (promptManagementState.selectedQueueItems.length === 0) {
                    alert('No items selected. Please select items from the queue first.');
                    return;
                }
                
                // Gather current configuration
                const config = {
                    system: promptManagementState.selectedSystem,
                    models: {
                        structure: document.getElementById('model-structure')?.value,
                        products: document.getElementById('model-products')?.value,
                        details: document.getElementById('model-details')?.value
                    },
                    prompts: {
                        structure: document.getElementById('prompt-structure')?.value,
                        products: document.getElementById('prompt-products')?.value,
                        details: document.getElementById('prompt-details')?.value
                    }
                };
                
                try {
                    const response = await fetch('/api/queue/batch-configure-enhanced', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: promptManagementState.selectedQueueItems,
                            configuration: config,
                            reasoning: 'Manual configuration via enhanced UI'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`Enhanced configuration applied to ${result.updated_items.length} items`);
                        loadQueue(); // Reload the queue
                        
                        // Clear selection
                        promptManagementState.selectedQueueItems = [];
                        promptManagementState.allSelected = false;
                    } else {
                        throw new Error(result.message || 'Failed to apply configuration');
                    }
                } catch (error) {
                    console.error('Failed to apply enhanced configuration:', error);
                    alert('Failed to apply configuration: ' + error.message);
                }
            }
            
            // Save as Default Configuration
            async function saveAsDefault() {
                const config = {
                    system: promptManagementState.selectedSystem,
                    models: {
                        structure: document.getElementById('model-structure')?.value,
                        products: document.getElementById('model-products')?.value,
                        details: document.getElementById('model-details')?.value
                    },
                    prompts: {
                        structure: document.getElementById('prompt-structure')?.value,
                        products: document.getElementById('prompt-products')?.value,
                        details: document.getElementById('prompt-details')?.value
                    }
                };
                
                try {
                    const response = await fetch('/api/prompts/save-default-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            configuration: config,
                            name: 'Enhanced UI Default',
                            description: 'Default configuration set via enhanced extraction UI'
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Configuration saved as default successfully!');
                    } else {
                        throw new Error(result.message || 'Failed to save default configuration');
                    }
                } catch (error) {
                    console.error('Failed to save default configuration:', error);
                    alert('Failed to save as default: ' + error.message);
                }
            }
            
            // Utility function to get time ago
            function getTimeAgo(dateString) {
                if (!dateString) return 'Unknown';
                
                const now = new Date();
                const date = new Date(dateString);
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffHours < 1) return 'Just now';
                if (diffHours < 24) return `${diffHours} hours ago`;
                if (diffDays < 7) return `${diffDays} days ago`;
                return date.toLocaleDateString();
            }
            
            // Enhanced Prompt Engineering UI Functions
            
            // Open Prompt Engineering Modal
            function openPromptEngineeringModal(extractionType, prompt = null, mode = 'create') {
                const modal = document.createElement('div');
                modal.id = 'promptEngineeringModal';
                modal.className = 'modal-overlay';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    backdrop-filter: blur(4px);
                `;
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    max-width: 1200px;
                    width: 100%;
                    max-height: 90vh;
                    overflow: hidden;
                    display: flex;
                    flex-direction: column;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                `;
                
                const title = mode === 'create' ? `Create New ${extractionType} Prompt` : 
                             mode === 'edit' ? `Customize ${extractionType} Prompt` : 
                             `View ${extractionType} Prompt`;
                
                modalContent.innerHTML = `
                    <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                        <h2 style="margin: 0; color: #1f2937; font-size: 20px;">‚ú® ${title}</h2>
                        <button onclick="closePromptEngineeringModal()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 14px;">‚úï Close</button>
                    </div>
                    
                    <div style="flex: 1; overflow-y: auto;">
                        <!-- Tab Navigation -->
                        <div style="display: flex; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                            <button class="prompt-tab active" onclick="switchPromptTab('combined')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600;">Combined View</button>
                            <button class="prompt-tab" onclick="switchPromptTab('prompt')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">Prompt Only</button>
                            <button class="prompt-tab" onclick="switchPromptTab('schema')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">Schema</button>
                            <button class="prompt-tab" onclick="switchPromptTab('reasoning')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">AI Reasoning</button>
                        </div>
                        
                        <!-- Combined View Tab -->
                        <div id="promptTab-combined" class="prompt-tab-content" style="padding: 24px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; height: 500px;">
                                <!-- Left: Prompt Content -->
                                <div style="display: flex; flex-direction: column;">
                                    <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üìù Prompt Content</h3>
                                    <textarea id="promptContentEditor" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Monaco', monospace; font-size: 12px; resize: none;" ${mode === 'view' ? 'readonly' : ''}>${prompt?.content || prompt?.full_content || getDefaultPromptTemplate(extractionType)}</textarea>
                                </div>
                                
                                <!-- Right: Pydantic Schema -->
                                <div style="display: flex; flex-direction: column;">
                                    <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üèóÔ∏è Pydantic Schema</h3>
                                    <textarea id="schemaContentEditor" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Monaco', monospace; font-size: 12px; resize: none;" ${mode === 'view' ? 'readonly' : ''}>${getDefaultSchemaTemplate(extractionType)}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Prompt Only Tab -->
                        <div id="promptTab-prompt" class="prompt-tab-content" style="display: none; padding: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üìù Prompt Content</h3>
                            <textarea id="promptOnlyEditor" style="width: 100%; height: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Monaco', monospace; font-size: 12px; resize: vertical;" ${mode === 'view' ? 'readonly' : ''}>${prompt?.content || prompt?.full_content || getDefaultPromptTemplate(extractionType)}</textarea>
                        </div>
                        
                        <!-- Schema Tab -->
                        <div id="promptTab-schema" class="prompt-tab-content" style="display: none; padding: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">üèóÔ∏è Pydantic Schema</h3>
                            <textarea id="schemaOnlyEditor" style="width: 100%; height: 400px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Monaco', monospace; font-size: 12px; resize: vertical;" ${mode === 'view' ? 'readonly' : ''}>${getDefaultSchemaTemplate(extractionType)}</textarea>
                        </div>
                        
                        <!-- AI Reasoning Tab -->
                        <div id="promptTab-reasoning" class="prompt-tab-content" style="display: none; padding: 24px;">
                            <h3 style="margin: 0 0 12px 0; color: #1f2937; font-size: 16px;">ü§ñ AI-Assisted Optimization</h3>
                            <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0; color: #1e40af; font-size: 14px;">AI can help optimize your prompt based on performance patterns and best practices.</p>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Optimization Goal:</label>
                                <select id="optimizationGoal" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="accuracy">Improve Accuracy</option>
                                    <option value="speed">Reduce Processing Time</option>
                                    <option value="cost">Lower Token Cost</option>
                                    <option value="consistency">Improve Consistency</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151;">Context (Optional):</label>
                                <textarea id="optimizationContext" placeholder="Describe specific issues or requirements..." style="width: 100%; height: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <button onclick="generateAIOptimization('${extractionType}')" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin-bottom: 16px;">ü§ñ Generate AI Optimization</button>
                            
                            <div id="aiOptimizationResult" style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 16px; min-height: 200px; font-family: 'Monaco', monospace; font-size: 12px; white-space: pre-wrap; color: #374151;">
                                AI optimization suggestions will appear here...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f8fafc; display: flex; gap: 12px; justify-content: flex-end;">
                        ${mode !== 'view' ? `
                            <button onclick="testPromptConfiguration('${extractionType}')" style="background: #f59e0b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">üß™ Test Configuration</button>
                            <button onclick="savePromptConfiguration('${extractionType}', '${mode}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">üíæ Save ${mode === 'create' ? 'New' : 'Version'}</button>
                        ` : ''}
                        <button onclick="closePromptEngineeringModal()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Load field definitions for tooltips
                loadFieldDefinitions();
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePromptEngineeringModal();
                    }
                });
                
                // Store current extraction type for later use
                modal.dataset.extractionType = extractionType;
                modal.dataset.mode = mode;
                if (prompt) {
                    modal.dataset.promptId = prompt.id;
                }
            }
            
            // Close Prompt Engineering Modal
            function closePromptEngineeringModal() {
                const modal = document.getElementById('promptEngineeringModal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Switch Prompt Tab
            function switchPromptTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.prompt-tab').forEach(tab => {
                    tab.style.borderBottomColor = 'transparent';
                    tab.style.color = '#6b7280';
                    tab.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`[onclick="switchPromptTab('${tabName}')"]`);
                if (activeTab) {
                    activeTab.style.borderBottomColor = '#3b82f6';
                    activeTab.style.color = '#3b82f6';
                    activeTab.classList.add('active');
                }
                
                // Update tab content
                document.querySelectorAll('.prompt-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                const activeContent = document.getElementById(`promptTab-${tabName}`);
                if (activeContent) {
                    activeContent.style.display = 'block';
                }
                
                // Sync content between editors
                syncPromptEditors();
            }
            
            // Sync content between different editors
            function syncPromptEditors() {
                const combinedPrompt = document.getElementById('promptContentEditor');
                const promptOnly = document.getElementById('promptOnlyEditor');
                const combinedSchema = document.getElementById('schemaContentEditor');
                const schemaOnly = document.getElementById('schemaOnlyEditor');
                
                if (combinedPrompt && promptOnly) {
                    // Sync prompt content
                    if (document.activeElement === combinedPrompt) {
                        promptOnly.value = combinedPrompt.value;
                    } else if (document.activeElement === promptOnly) {
                        combinedPrompt.value = promptOnly.value;
                    }
                }
                
                if (combinedSchema && schemaOnly) {
                    // Sync schema content
                    if (document.activeElement === combinedSchema) {
                        schemaOnly.value = combinedSchema.value;
                    } else if (document.activeElement === schemaOnly) {
                        combinedSchema.value = schemaOnly.value;
                    }
                }
            }
            
            // Get default prompt template
            function getDefaultPromptTemplate(extractionType) {
                const templates = {
                    structure: `You are an expert at analyzing retail shelf images to identify the physical structure and layout.

Your task is to:
1. Identify the number of shelves in the image
2. Determine the width and sections of each shelf
3. Detect any structural elements like dividers, price rails, or shelf edges
4. Note the overall planogram structure

Focus on the physical layout, not the products themselves.

Please analyze the image systematically from top to bottom, left to right.`,
                    
                    products: `You are an expert at identifying and cataloging products on retail shelves.

Your task is to:
1. Identify each distinct product on the shelves
2. Determine the exact position of each product
3. Count the number of facings for each product
4. Note any stacking or depth arrangements
5. Identify brand names and product names where visible

Be precise about positioning and avoid double-counting products.

Analyze each shelf section systematically.`,
                    
                    details: `You are an expert at extracting detailed product information from retail shelf images.

Your task is to:
1. Extract prices for each identified product
2. Read any visible text on products or price tags
3. Identify promotional indicators or special offers
4. Note product sizes, volumes, or pack information
5. Assess the confidence level of each extraction

Focus on accuracy over speed. If text is unclear, indicate lower confidence.

Process each product methodically.`
                };
                
                return templates[extractionType] || 'Please provide instructions for the AI model...';
            }
            
            // Get default schema template
            function getDefaultSchemaTemplate(extractionType) {
                const schemas = {
                    structure: `from pydantic import BaseModel, Field
from typing import List, Optional

class ShelfSection(BaseModel):
    horizontal: str = Field(description="Shelf number (1, 2, 3, etc.)")
    vertical: str = Field(description="Section within shelf (Left, Center, Right)")
    width_cm: Optional[float] = Field(description="Estimated width in centimeters")

class ShelfStructure(BaseModel):
    total_shelves: int = Field(description="Total number of shelves detected")
    shelf_height_cm: Optional[float] = Field(description="Estimated height of each shelf")
    total_width_cm: Optional[float] = Field(description="Total width of the planogram")
    sections: List[ShelfSection] = Field(description="List of all shelf sections")
    confidence: float = Field(description="Confidence in structure detection (0-1)")`,
                    
                    products: `from pydantic import BaseModel, Field
from typing import List, Optional

class ProductPosition(BaseModel):
    shelf_level: int = Field(description="Which shelf (1=top, 2=middle, etc.)")
    position_on_shelf: int = Field(description="Position from left to right")
    section: str = Field(description="Shelf section (Left, Center, Right)")
    facings_count: int = Field(description="Number of product facings")
    stack_depth: Optional[int] = Field(description="Products stacked behind (if visible)")

class Product(BaseModel):
    brand: str = Field(description="Brand name")
    name: str = Field(description="Product name")
    position: ProductPosition = Field(description="Exact position on shelf")
    confidence: float = Field(description="Confidence in identification (0-1)")

class ProductExtraction(BaseModel):
    products: List[Product] = Field(description="All identified products")
    total_products: int = Field(description="Total count of distinct products")`,
                    
                    details: `from pydantic import BaseModel, Field
from typing import List, Optional

class ProductDetails(BaseModel):
    product_id: str = Field(description="Reference to identified product")
    price: Optional[float] = Field(description="Price in local currency")
    price_text: Optional[str] = Field(description="Raw price text if unclear")
    volume: Optional[str] = Field(description="Product volume/size (e.g., '330ml')")
    any_text: Optional[str] = Field(description="Any other visible text")
    is_on_promo: bool = Field(description="Whether product appears to be on promotion")
    confidence: float = Field(description="Confidence in details extraction (0-1)")

class DetailExtraction(BaseModel):
    product_details: List[ProductDetails] = Field(description="Details for each product")
    extraction_notes: Optional[str] = Field(description="Any extraction challenges or notes")`
                };
                
                return schemas[extractionType] || '# Define your Pydantic schema here...';
            }
            
            // Generate AI Optimization
            async function generateAIOptimization(extractionType) {
                const goal = document.getElementById('optimizationGoal').value;
                const context = document.getElementById('optimizationContext').value;
                const resultDiv = document.getElementById('aiOptimizationResult');
                
                resultDiv.textContent = 'ü§ñ Generating AI optimization suggestions...';
                
                try {
                    const response = await fetch('/api/prompts/ai-optimize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            extraction_type: extractionType,
                            current_prompt: document.getElementById('promptContentEditor').value,
                            current_schema: document.getElementById('schemaContentEditor').value,
                            optimization_goal: goal,
                            context: context
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        resultDiv.textContent = result.optimization_suggestions;
                    } else {
                        throw new Error(result.message || 'Failed to generate optimization');
                    }
                } catch (error) {
                    console.error('Failed to generate AI optimization:', error);
                    resultDiv.textContent = `‚ùå Error generating optimization: ${error.message}

This feature requires backend AI integration. For now, here are some general optimization tips:

For ${goal}:
${getOptimizationTips(goal, extractionType)}`;
                }
            }
            
            // Get optimization tips
            function getOptimizationTips(goal, extractionType) {
                const tips = {
                    accuracy: {
                        structure: `‚Ä¢ Be more specific about shelf identification criteria
‚Ä¢ Add examples of edge cases (partial shelves, angled views)
‚Ä¢ Include instructions for handling occlusions
‚Ä¢ Specify how to handle non-standard shelf configurations`,
                        products: `‚Ä¢ Add specific brand recognition patterns
‚Ä¢ Include instructions for handling similar-looking products
‚Ä¢ Specify how to count facings accurately
‚Ä¢ Add guidance for handling stacked or rotated products`,
                        details: `‚Ä¢ Include specific price format examples
‚Ä¢ Add instructions for handling unclear text
‚Ä¢ Specify confidence thresholds for different text clarity levels
‚Ä¢ Include guidance for promotional text recognition`
                    },
                    speed: {
                        structure: `‚Ä¢ Simplify the analysis workflow
‚Ä¢ Focus on key structural elements first
‚Ä¢ Reduce redundant verification steps
‚Ä¢ Use more direct language and fewer examples`,
                        products: `‚Ä¢ Prioritize obvious products first
‚Ä¢ Use systematic scanning patterns
‚Ä¢ Reduce detailed description requirements
‚Ä¢ Focus on essential identification features`,
                        details: `‚Ä¢ Target specific text areas (price tags, labels)
‚Ä¢ Skip non-essential text extraction
‚Ä¢ Use confidence-based early stopping
‚Ä¢ Prioritize high-value information`
                    },
                    cost: {
                        structure: `‚Ä¢ Use more concise language
‚Ä¢ Reduce example text and explanations
‚Ä¢ Focus on essential instructions only
‚Ä¢ Eliminate redundant phrasing`,
                        products: `‚Ä¢ Streamline product identification criteria
‚Ä¢ Use shorter, more direct instructions
‚Ä¢ Reduce verbose explanations
‚Ä¢ Focus on key distinguishing features`,
                        details: `‚Ä¢ Target specific extraction goals
‚Ä¢ Use bullet points instead of paragraphs
‚Ä¢ Eliminate unnecessary context
‚Ä¢ Focus on high-priority information only`
                    },
                    consistency: {
                        structure: `‚Ä¢ Add explicit step-by-step procedures
‚Ä¢ Include standardized terminology
‚Ä¢ Specify exact output formats
‚Ä¢ Add validation checkpoints`,
                        products: `‚Ä¢ Define clear product categorization rules
‚Ä¢ Standardize position description format
‚Ä¢ Include consistent naming conventions
‚Ä¢ Add cross-validation steps`,
                        details: `‚Ä¢ Standardize price format requirements
‚Ä¢ Define consistent confidence scoring
‚Ä¢ Include format validation rules
‚Ä¢ Add consistency check procedures`
                    }
                };
                
                return tips[goal]?.[extractionType] || '‚Ä¢ Consider the specific requirements for your use case\n‚Ä¢ Test different approaches systematically\n‚Ä¢ Monitor performance metrics closely';
            }
            
            // Test Prompt Configuration
            async function testPromptConfiguration(extractionType) {
                const promptContent = document.getElementById('promptContentEditor').value;
                const schemaContent = document.getElementById('schemaContentEditor').value;
                
                try {
                    const response = await fetch('/api/prompts/test', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            extraction_type: extractionType,
                            prompt_content: promptContent,
                            schema_content: schemaContent,
                            test_image: 'demo' // Use a demo image for testing
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`‚úÖ Test completed successfully!

Accuracy: ${result.accuracy}%
Processing time: ${result.processing_time}ms
Token usage: ${result.token_usage}`);
                    } else {
                        throw new Error(result.message || 'Test failed');
                    }
                } catch (error) {
                    console.error('Failed to test prompt configuration:', error);
                    alert(`‚ùå Test failed: ${error.message}

Note: This feature requires backend integration for live testing.`);
                }
            }
            
            // Save Prompt Configuration
            async function savePromptConfiguration(extractionType, mode) {
                const promptContent = document.getElementById('promptContentEditor').value;
                const schemaContent = document.getElementById('schemaContentEditor').value;
                const modal = document.getElementById('promptEngineeringModal');
                
                if (!promptContent.trim()) {
                    alert('Please enter prompt content before saving.');
                    return;
                }
                
                try {
                    const requestData = {
                        prompt_type: extractionType,
                        model_type: 'universal', // Default to universal, can be customized
                        prompt_content: promptContent,
                        schema_content: schemaContent,
                        prompt_version: mode === 'create' ? '1.0' : `${Date.now()}`, // Simple versioning
                        created_via: 'enhanced_ui'
                    };
                    
                    if (mode === 'edit' && modal.dataset.promptId) {
                        requestData.base_prompt_id = modal.dataset.promptId;
                    }
                    
                    const endpoint = mode === 'create' ? '/api/prompts/save' : '/api/prompts/create-version';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`‚úÖ Prompt ${mode === 'create' ? 'created' : 'version saved'} successfully!`);
                        closePromptEngineeringModal();
                        
                        // Refresh the prompt options in the main UI
                        updatePromptOptions(extractionType);
                    } else {
                        throw new Error(result.message || 'Failed to save prompt');
                    }
                } catch (error) {
                    console.error('Failed to save prompt configuration:', error);
                    alert(`‚ùå Failed to save prompt: ${error.message}`);
                }
            }
            
            // Open Performance Modal
            function openPerformanceModal(promptId) {
                const modal = document.createElement('div');
                modal.id = 'performanceModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                    backdrop-filter: blur(4px);
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; background: #f8fafc;">
                            <h2 style="margin: 0; color: #1f2937; font-size: 18px;">üìä Prompt Performance Analytics</h2>
                            <button onclick="closePerformanceModal()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚úï Close</button>
                        </div>
                        
                        <div style="flex: 1; overflow-y: auto; padding: 20px;">
                            <div id="performanceContent">
                                <div style="text-align: center; padding: 40px; color: #6b7280;">
                                    üìä Loading performance data...
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePerformanceModal();
                    }
                });
                
                // Load performance data
                loadPerformanceData(promptId);
            }
            
            // Close Performance Modal
            function closePerformanceModal() {
                const modal = document.getElementById('performanceModal');
                if (modal) {
                    modal.remove();
                }
            }
            
            // Load Performance Data
            async function loadPerformanceData(promptId) {
                const contentDiv = document.getElementById('performanceContent');
                
                try {
                    const response = await fetch(`/api/prompts/${promptId}/performance`);
                    const data = await response.json();
                    
                    if (data.success) {
                        renderPerformanceData(data.performance, contentDiv);
                    } else {
                        throw new Error(data.message || 'Failed to load performance data');
                    }
                } catch (error) {
                    console.error('Failed to load performance data:', error);
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ef4444;">
                            ‚ùå Failed to load performance data<br>
                            <small>${error.message}</small><br><br>
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; text-align: left; color: #374151;">
                                <h4 style="margin: 0 0 10px 0;">Demo Performance Data:</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">87.5%</div>
                                        <div style="font-size: 12px; color: #6b7280;">Success Rate</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">245</div>
                                        <div style="font-size: 12px; color: #6b7280;">Total Uses</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">¬£0.023</div>
                                        <div style="font-size: 12px; color: #6b7280;">Avg Cost</div>
                                    </div>
                                    <div style="background: white; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: bold; color: #6b7280;">1.2s</div>
                                        <div style="font-size: 12px; color: #6b7280;">Avg Time</div>
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    This is demo data. Real performance analytics require backend integration.
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Render Performance Data
            function renderPerformanceData(performance, container) {
                const stats = performance.stats || {};
                const trends = performance.trends || [];
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border-left: 4px solid #10b981;">
                            <div style="font-size: 28px; font-weight: bold; color: #10b981;">${(stats.success_rate || 87.5).toFixed(1)}%</div>
                            <div style="font-size: 14px; color: #065f46; margin-top: 5px;">Success Rate</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Last 30 days</div>
                        </div>
                        
                        <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${stats.usage_count || 245}</div>
                            <div style="font-size: 14px; color: #1e40af; margin-top: 5px;">Total Uses</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">All time</div>
                        </div>
                        
                        <div style="background: #fefbf2; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                            <div style="font-size: 28px; font-weight: bold; color: #f59e0b;">¬£${(stats.avg_cost || 0.023).toFixed(3)}</div>
                            <div style="font-size: 14px; color: #92400e; margin-top: 5px;">Avg Cost</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Per extraction</div>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border-left: 4px solid #6b7280;">
                            <div style="font-size: 28px; font-weight: bold; color: #6b7280;">${(stats.avg_time || 1.2).toFixed(1)}s</div>
                            <div style="font-size: 14px; color: #374151; margin-top: 5px;">Avg Time</div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Processing time</div>
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                        <h3 style="margin: 0 0 15px 0; color: #1f2937; font-size: 16px;">üìà Performance Trends</h3>
                        <div style="color: #6b7280; font-size: 14px;">
                            Performance trend visualization would appear here with real data integration.
                        </div>
                    </div>
                `;
            }
            
            // Enhanced queue functionality is now integrated into renderQueue()
            
            // Get Item Display Name
            function getItemDisplayName(item) {
                if (item.uploads && item.uploads.collections && item.uploads.collections.stores) {
                    const store = item.uploads.collections.stores;
                    return `${store.retailer_name} - ${item.uploads.category || 'Unknown Category'}`;
                }
                return `Item #${item.id}`;
            }
            
            // Toggle Select All
            function toggleSelectAll() {
                promptManagementState.allSelected = !promptManagementState.allSelected;
                
                if (promptManagementState.allSelected) {
                    // Select all visible items
                    const allItemIds = Array.from(document.querySelectorAll('.queue-item')).map(el => 
                        parseInt(el.getAttribute('data-item-id'))
                    );
                    promptManagementState.selectedQueueItems = allItemIds;
                } else {
                    promptManagementState.selectedQueueItems = [];
                }
                
                // Re-render to update UI
                renderQueue();
            }
            
            // Toggle Item Selection
            function toggleItemSelection(itemId) {
                const index = promptManagementState.selectedQueueItems.indexOf(itemId);
                if (index > -1) {
                    promptManagementState.selectedQueueItems.splice(index, 1);
                } else {
                    promptManagementState.selectedQueueItems.push(itemId);
                }
                
                // Update select all state
                const totalItems = document.querySelectorAll('.queue-item').length;
                promptManagementState.allSelected = promptManagementState.selectedQueueItems.length === totalItems;
                
                // Re-render to update UI
                renderQueue();
            }
            
            // Apply Config to Selected Items
            async function applyConfigToSelected() {
                if (promptManagementState.selectedQueueItems.length === 0) {
                    alert('No items selected');
                    return;
                }
                
                try {
                    const response = await fetch('/api/queue/batch-configure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: promptManagementState.selectedQueueItems,
                            system: promptManagementState.selectedSystem,
                            prompt_overrides: {
                                [promptManagementState.selectedPromptType]: promptManagementState.selectedPromptVersion
                            }
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`Configuration applied to ${result.updated_items.length} items`);
                        loadQueue(); // Reload the detailed queue
                    }
                } catch (error) {
                    console.error('Failed to apply configuration:', error);
                    alert('Failed to apply configuration');
                }
            }
            
            // Reset Selected Items
            async function resetSelectedItems() {
                if (promptManagementState.selectedQueueItems.length === 0) {
                    alert('No items selected');
                    return;
                }
                
                try {
                    const response = await fetch('/api/queue/batch-reset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: promptManagementState.selectedQueueItems
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert(`Configuration reset for ${result.reset_items.length} items`);
                        promptManagementState.selectedQueueItems = [];
                        loadQueue(); // Reload the detailed queue
                    }
                } catch (error) {
                    console.error('Failed to reset configuration:', error);
                    alert('Failed to reset configuration');
                }
            }
            
            // Process Queue Item
            async function processQueueItem(itemId) {
                try {
                    const response = await fetch(`/api/queue/process/${itemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            systems: [promptManagementState.selectedSystem]
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Processing started successfully!');
                        loadQueue(); // Reload the detailed queue
                    }
                } catch (error) {
                    console.error('Failed to start processing:', error);
                    alert('Failed to start processing');
                }
            }
            
            // Override Queue Item
            function overrideQueueItem(itemId) {
                // Find the item data
                const item = queueData.find(i => i.id === itemId);
                if (!item) {
                    alert('Item not found');
                    return;
                }
                
                // Create a simple override modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; max-width: 500px; width: 100%; padding: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #1f2937;">‚öôÔ∏è Override Configuration for Item #${itemId}</h3>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Extraction System:</label>
                            <select id="overrideSystem" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="custom_consensus" ${item.current_extraction_system === 'custom_consensus' ? 'selected' : ''}>Custom Consensus</option>
                                <option value="langgraph" ${item.current_extraction_system === 'langgraph' ? 'selected' : ''}>LangGraph</option>
                                <option value="hybrid" ${item.current_extraction_system === 'hybrid' ? 'selected' : ''}>Hybrid</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Status:</label>
                            <select id="overrideStatus" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                                <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="processing" ${item.status === 'processing' ? 'selected' : ''}>Processing</option>
                                <option value="completed" ${item.status === 'completed' ? 'selected' : ''}>Completed</option>
                                <option value="failed" ${item.status === 'failed' ? 'selected' : ''}>Failed</option>
                            </select>
                        </div>
                        
                        <div style="background: #f8fafc; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #374151;">Current Configuration:</h4>
                            <div style="font-size: 14px; color: #6b7280;">
                                <div><strong>Store:</strong> ${item.uploads?.metadata?.store_name || 'Unknown'}</div>
                                <div><strong>Category:</strong> ${item.uploads?.category || 'Unknown'}</div>
                                <div><strong>System:</strong> ${item.current_extraction_system}</div>
                                <div><strong>Status:</strong> ${item.status}</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">Cancel</button>
                            <button onclick="applyOverride(${itemId})" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">Apply Override</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }
            
            async function applyOverride(itemId) {
                const system = document.getElementById('overrideSystem').value;
                const status = document.getElementById('overrideStatus').value;
                
                try {
                    const response = await fetch(`/api/queue/batch-configure`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: [itemId],
                            system: system
                        })
                    });
                    
                    if (response.ok) {
                        // Also update status if needed
                        if (status !== queueData.find(i => i.id === itemId)?.status) {
                            await fetch(`/api/queue/items/${itemId}/status`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: status })
                            });
                        }
                        
                        alert('Override applied successfully!');
                        
                        // Close modal and reload queue
                        document.querySelector('div[style*="position: fixed"]').remove();
                        loadQueue();
                    } else {
                        alert('Failed to apply override');
                    }
                } catch (error) {
                    console.error('Error applying override:', error);
                    alert('Error applying override: ' + error.message);
                }
            }
            
            // Toggle Right Sidebar
            function toggleRightSidebar() {
                const sidebar = document.getElementById('rightSidebar');
                if (sidebar) {
                    const toggle = sidebar.querySelector('.sidebar-toggle');
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        // Expand sidebar
                        sidebar.classList.remove('collapsed');
                        if (toggle) {
                            toggle.innerHTML = '‚óÄ';
                            toggle.style.right = '-30px';
                            toggle.style.borderRadius = '4px 0 0 4px';
                        }
                    } else {
                        // Collapse sidebar
                        sidebar.classList.add('collapsed');
                        if (toggle) {
                            toggle.innerHTML = '‚ñ∂';
                            toggle.style.right = '0px';
                            toggle.style.borderRadius = '0 4px 4px 0';
                        }
                    }
                }
            }
            
            // Additional initialization functions (called from main DOMContentLoaded)
            function initializeAdditionalFeatures() {
                console.log('üîß Initializing additional features...');
                
                // Initialize workflow display
                initializeWorkflowDisplay();
                
                console.log('‚úÖ Additional features initialized');
            }
            
            // Initialize Enhanced Extraction Settings
            async function initializeEnhancedExtractionSettings() {
                console.log('üîß Initializing Enhanced Extraction Settings...');
                
                try {
                    // Show smart recommendations by default
                    showSmartRecommendations({
                        store: 'Tesco Metro',
                        category: 'Beverages',
                        history: 'No history available'
                    });
                    
                    // Initialize model dropdowns with default values
                    const modelSelectors = ['model-structure', 'model-products', 'model-details'];
                    modelSelectors.forEach(selectorId => {
                        const selector = document.getElementById(selectorId);
                        if (selector) {
                            selector.addEventListener('change', function() {
                                const extractionType = selectorId.replace('model-', '');
                                updatePromptOptions(extractionType);
                            });
                        }
                    });
                    
                    // Initialize prompt dropdowns
                    const promptSelectors = ['prompt-structure', 'prompt-products', 'prompt-details'];
                    promptSelectors.forEach(selectorId => {
                        const selector = document.getElementById(selectorId);
                        if (selector) {
                            selector.addEventListener('change', function() {
                                const extractionType = selectorId.replace('prompt-', '');
                                showPromptPreview(extractionType);
                            });
                        }
                    });
                    
                    // Load initial prompt options for each extraction type
                    await updatePromptOptions('structure');
                    await updatePromptOptions('products');
                    await updatePromptOptions('details');
                    
                    console.log('‚úÖ Enhanced Extraction Settings initialized successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize Enhanced Extraction Settings:', error);
                }
            }
            
            // Enhanced Extraction Configuration State
            let extractionConfig = {
                system: 'custom_consensus',
                models: {
                    structure: 'claude',
                    products: 'gpt4o',
                    details: 'gemini'
                },
                prompts: {
                    structure: 'auto',
                    products: 'auto',
                    details: 'auto'
                },
                autoSelectReasoning: {}
            };
            
            // Performance data cache
            let promptPerformanceCache = {};
            
            // Load smart recommendations based on context
            async function loadSmartRecommendations() {
                const selectedItems = getSelectedQueueItems();
                if (selectedItems.length === 0) {
                    document.getElementById('smartRecommendations').style.display = 'none';
                    return;
                }
                
                // Get context from first selected item
                const context = {
                    store: selectedItems[0].uploads?.collections?.stores?.retailer_name || 'Unknown Store',
                    category: selectedItems[0].uploads?.category || 'Unknown Category',
                    retailer: extractRetailerFromStore(selectedItems[0].uploads?.collections?.stores?.retailer_name || '')
                };
                
                try {
                    // Get AI recommendations
                    const response = await fetch('/api/extraction/recommend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(context)
                    });
                    
                    if (response.ok) {
                        const recommendations = await response.json();
                        
                        // Update UI
                        document.getElementById('recStore').textContent = context.store;
                        document.getElementById('recCategory').textContent = context.category;
                        document.getElementById('recHistory').textContent = recommendations.history_summary || 'No history available';
                        
                        // Show what auto-select would choose
                        const choicesHtml = `
                            <div class="auto-choice">System: ${recommendations.system || 'custom_consensus'} <span class="reason">(${recommendations.system_reason || 'Default choice'})</span></div>
                            <div class="auto-choice">Structure: ${recommendations.models?.structure || 'claude'} + "${recommendations.prompts?.structure?.name || 'Default prompt'}"</div>
                            <div class="auto-choice">Products: ${recommendations.models?.products || 'gpt4o'} + "${recommendations.prompts?.products?.name || 'Default prompt'}"</div>
                            <div class="auto-choice">Details: ${recommendations.models?.details || 'gemini'} + "${recommendations.prompts?.details?.name || 'Default prompt'}"</div>
                        `;
                        document.getElementById('autoSelectChoices').innerHTML = choicesHtml;
                        
                        // Store reasoning for later use
                        extractionConfig.autoSelectReasoning = recommendations;
                        
                        // Show recommendations section
                        document.getElementById('smartRecommendations').style.display = 'block';
                    } else {
                        console.log('No recommendations available from API');
                        document.getElementById('smartRecommendations').style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('Failed to load recommendations:', error);
                    document.getElementById('smartRecommendations').style.display = 'none';
                }
            }
            
            // Enhanced prompt loading with performance data
            async function updatePromptOptions(type) {
                const modelSelect = document.getElementById(`model-${type}`);
                const model = modelSelect ? modelSelect.value : 'claude';
                
                try {
                    const response = await fetch(`/api/analytics/prompts-with-stats?prompt_type=${type}&model_type=${model}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const prompts = await response.json();
                    
                    const select = document.getElementById(`prompt-${type}`);
                    if (!select) return;
                    
                    select.innerHTML = '<option value="auto">ü§ñ Auto-select best</option>';
                    
                    prompts.forEach(prompt => {
                        const option = document.createElement('option');
                        option.value = prompt.id;
                        
                        // Include performance data in the option text
                        const successRate = prompt.performance_stats?.success_rate ? `${Math.round(prompt.performance_stats.success_rate)}%` : 'New';
                        const uses = prompt.performance_stats?.usage_count || 0;
                        option.textContent = `${prompt.name} v${prompt.version} | ${successRate} | ${uses} uses`;
                        
                        // Store full data for preview
                        promptPerformanceCache[prompt.id] = prompt;
                        
                        select.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Failed to load prompts:', error);
                    // Fallback to basic options
                    const select = document.getElementById(`prompt-${type}`);
                    if (select) {
                        select.innerHTML = `
                            <option value="auto">ü§ñ Auto-select best</option>
                            <option value="default_${type}">Default ${type} prompt | 85% | 150 uses</option>
                        `;
                    }
                }
            }
            
            // Show prompt preview with performance
            function showPromptPreview(type) {
                const select = document.getElementById(`prompt-${type}`);
                const promptId = select.value;
                
                const preview = document.getElementById(`preview-${type}`);
                if (!preview) return;
                
                if (promptId === 'auto') {
                    preview.style.display = 'none';
                    return;
                }
                
                const promptData = promptPerformanceCache[promptId];
                if (!promptData) {
                    preview.style.display = 'none';
                    return;
                }
                
                preview.style.display = 'block';
                
                // Update preview content
                const nameElement = preview.querySelector('.prompt-name');
                const badgeElement = preview.querySelector('.performance-badge');
                const statsElement = preview.querySelector('.preview-stats');
                const snippetElement = preview.querySelector('.prompt-snippet');
                
                if (nameElement) nameElement.textContent = `${promptData.name} v${promptData.version}`;
                if (badgeElement) {
                    const successRate = promptData.performance_stats?.success_rate;
                    badgeElement.textContent = successRate ? `${Math.round(successRate)}% success` : 'New - No data';
                }
                
                // Update stats
                if (statsElement) {
                    const stats = promptData.performance_stats || {};
                    statsElement.innerHTML = `
                        <span>üìä ${stats.usage_count || 0} uses</span>
                        <span>‚è±Ô∏è Last: ${stats.last_used || 'Never'}</span>
                        <span>üí∞ Avg cost: $${stats.avg_cost || 0}</span>
                    `;
                }
                
                // Show prompt snippet
                if (snippetElement && promptData.content) {
                    const snippet = promptData.content.substring(0, 150) + '...';
                    snippetElement.textContent = snippet;
                }
            }
            
            // Get selected queue items
            function getSelectedQueueItems() {
                const checkboxes = document.querySelectorAll('.queue-item-checkbox:checked');
                const selectedItems = [];
                
                checkboxes.forEach(checkbox => {
                    const itemId = parseInt(checkbox.value);
                    const item = queueData.find(q => q.id === itemId);
                    if (item) {
                        selectedItems.push(item);
                    }
                });
                
                return selectedItems;
            }
            
            // Extract retailer from store name
            function extractRetailerFromStore(storeName) {
                if (!storeName) return 'Unknown';
                
                // Common retailer patterns
                const patterns = {
                    'tesco': /tesco/i,
                    'sainsbury': /sainsbury/i,
                    'asda': /asda/i,
                    'morrisons': /morrisons/i,
                    'aldi': /aldi/i,
                    'lidl': /lidl/i,
                    'coop': /co.?op/i
                };
                
                for (const [retailer, pattern] of Object.entries(patterns)) {
                    if (pattern.test(storeName)) {
                        return retailer.charAt(0).toUpperCase() + retailer.slice(1);
                    }
                }
                
                return storeName.split(' ')[0] || 'Unknown';
            }
            
            // Use auto-selection
            async function useAutoSelection() {
                if (!extractionConfig.autoSelectReasoning) {
                    showNotification('No auto-selection data available', 'warning');
                    return;
                }
                
                const reasoning = extractionConfig.autoSelectReasoning;
                
                // Apply system selection
                const systemRadio = document.querySelector(`input[name="system"][value="${reasoning.system}"]`);
                if (systemRadio) {
                    systemRadio.checked = true;
                    selectSystem(reasoning.system);
                }
                
                // Apply model and prompt selections
                ['structure', 'products', 'details'].forEach(type => {
                    const modelSelect = document.getElementById(`model-${type}`);
                    const promptSelect = document.getElementById(`prompt-${type}`);
                    
                    if (modelSelect && reasoning.models?.[type]) {
                        modelSelect.value = reasoning.models[type];
                    }
                    
                    if (promptSelect && reasoning.prompts?.[type]?.prompt_id) {
                        promptSelect.value = reasoning.prompts[type].prompt_id;
                    }
                });
                
                showNotification('Auto-selection applied!', 'success');
            }
            
            // Show custom selection options
            function showCustomSelection() {
                document.getElementById('modelConfig').style.display = 'block';
                document.getElementById('promptSelection').style.display = 'block';
                
                // Initialize prompt options for all types
                ['structure', 'products', 'details'].forEach(type => {
                    updatePromptOptions(type);
                });
            }
            
            // Create new prompt - opens prompt engineering modal
            function createNewPrompt(type) {
                openPromptEngineeringModal(type);
            }
            
            // Customize existing prompt
            function customizePrompt(type) {
                const promptId = document.getElementById(`prompt-${type}`).value;
                const promptData = promptPerformanceCache[promptId];
                
                openPromptEngineeringModal(type, promptData);
            }
            
            // View full prompt details
            function viewFullPrompt(type) {
                const promptId = document.getElementById(`prompt-${type}`).value;
                const promptData = promptPerformanceCache[promptId];
                
                showPromptDetailsModal(promptData);
            }
            
            // View performance data
            function viewPerformance(type) {
                const promptId = document.getElementById(`prompt-${type}`).value;
                const promptData = promptPerformanceCache[promptId];
                
                showPerformanceModal(promptData);
            }
            
            // Apply enhanced configuration to selected items
            async function applyEnhancedConfigToSelected() {
                const selectedItems = getSelectedQueueItems();
                
                if (selectedItems.length === 0) {
                    showNotification('Please select queue items first', 'warning');
                    return;
                }
                
                // Build configuration object
                const config = {
                    system: document.querySelector('input[name="system"]:checked')?.value || 'custom_consensus',
                    models: {},
                    prompts: {},
                    reasoning: {}
                };
                
                // Collect model and prompt selections
                ['structure', 'products', 'details'].forEach(type => {
                    const modelSelect = document.getElementById(`model-${type}`);
                    const promptSelect = document.getElementById(`prompt-${type}`);
                    
                    config.models[type] = modelSelect ? modelSelect.value : 'claude';
                    config.prompts[type] = promptSelect ? promptSelect.value : 'auto';
                    
                    // Include reasoning if using auto-select
                    if (config.prompts[type] === 'auto' && extractionConfig.autoSelectReasoning) {
                        config.reasoning[type] = extractionConfig.autoSelectReasoning.prompts?.[type]?.reason || 'Auto-selected';
                    }
                });
                
                try {
                    const response = await fetch('/api/queue/batch-configure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_ids: selectedItems.map(item => item.id),
                            extraction_config: config
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        showNotification(`Configuration applied to ${result.updated_count} items`, 'success');
                        
                        // Update local queue data to show configuration
                        selectedItems.forEach(item => {
                            const queueItem = queueData.find(q => q.id === item.id);
                            if (queueItem) {
                                queueItem.extraction_config = config;
                                queueItem.status = 'configured';
                                queueItem.current_extraction_system = config.system;
                            }
                        });
                        
                        // Refresh the queue display
                        await loadQueue();
                        
                        // Hide configuration panels
                        document.getElementById('smartRecommendations').style.display = 'none';
                        document.getElementById('modelConfig').style.display = 'none';
                        document.getElementById('promptSelection').style.display = 'none';
                        
                        // Clear checkboxes
                        document.querySelectorAll('.queue-item-checkbox:checked').forEach(cb => {
                            cb.checked = false;
                        });
                    } else {
                        throw new Error(result.detail || result.message || 'Server responded with error');
                    }
                } catch (error) {
                    console.error('Failed to apply configuration:', error);
                    showNotification('Failed to apply configuration: ' + error.message, 'error');
                }
            }
            
            // Save as default configuration
            async function saveAsDefault() {
                const config = {
                    system: document.querySelector('input[name="system"]:checked').value,
                    models: {},
                    prompts: {}
                };
                
                ['structure', 'products', 'details'].forEach(type => {
                    const modelSelect = document.getElementById(`model-${type}`);
                    const promptSelect = document.getElementById(`prompt-${type}`);
                    
                    config.models[type] = modelSelect ? modelSelect.value : 'claude';
                    config.prompts[type] = promptSelect ? promptSelect.value : 'auto';
                });
                
                try {
                    const response = await fetch('/api/extraction/save-default-config', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        showNotification('Default configuration saved!', 'success');
                    } else {
                        throw new Error('Failed to save default configuration');
                    }
                } catch (error) {
                    console.error('Failed to save default:', error);
                    showNotification('Failed to save default configuration', 'error');
                }
            }
            
            // Enhanced Prompt Engineering Modal Functions
            let currentPromptGeneration = null;
            let editingPromptData = null;
            
            // Open enhanced prompt engineering modal with versioning
            function openPromptEngineeringModal(type = null, existingPrompt = null) {
                const modal = document.getElementById('promptEngineeringModal');
                if (modal) {
                    modal.remove(); // Remove existing modal
                }
                
                editingPromptData = existingPrompt;
                
                // Create enhanced modal with versioning
                const modalHtml = `
                    <div id="promptEngineeringModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div class="modal-content" style="background: white; border-radius: 12px; max-width: 1400px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h2 style="margin: 0; color: #1f2937; font-size: 20px;">‚ú® AI-Assisted Prompt Engineering</h2>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <button onclick="openPromptLibrary()" style="background: #6366f1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                            üìö Browse Library
                                        </button>
                                        <button onclick="closePromptEngineeringModal()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚úï Close</button>
                                    </div>
                                </div>
                                
                                ${existingPrompt ? `
                                    <div id="versionInfo" class="version-management" style="margin-top: 15px;">
                                        <div class="current-version">
                                            Editing: <span id="currentPromptName">${existingPrompt.name || existingPrompt.template_id}</span>
                                            <span class="version-badge">v${existingPrompt.version || existingPrompt.prompt_version}</span>
                                        </div>
                                        <div class="version-options">
                                            <label>
                                                <input type="radio" name="versionStrategy" value="new" checked>
                                                Create New Version (v${incrementVersion(existingPrompt.version || existingPrompt.prompt_version)})
                                            </label>
                                            <label>
                                                <input type="radio" name="versionStrategy" value="branch">
                                                Create Branch (${existingPrompt.name || existingPrompt.template_id} - Custom)
                                            </label>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div style="flex: 1; overflow: hidden; display: flex;">
                                <!-- Left Panel: User Inputs -->
                                <div style="width: 400px; padding: 20px; border-right: 1px solid #e5e7eb; overflow-y: auto;">
                                    <h3 style="margin: 0 0 15px 0; color: #1f2937;">1. Prompt Configuration</h3>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Prompt Type:</label>
                                        <select id="promptTypeSelect" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                                            <option value="structure" ${type === 'structure' ? 'selected' : ''}>Structure Analysis</option>
                                            <option value="products" ${type === 'products' ? 'selected' : ''}>Product Extraction</option>
                                            <option value="details" ${type === 'details' ? 'selected' : ''}>Detail Enhancement</option>
                                        </select>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">
                                            Fields to Extract:
                                            <button onclick="manageFieldDefinitions()" style="float: right; padding: 4px 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; cursor: pointer;">üìù Manage Definitions</button>
                                        </label>
                                        <div id="fieldCheckboxContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 180px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 10px; border-radius: 4px;">
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="product_name" checked> Product Name</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="brand" checked> Brand</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="price" checked> Price</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="position" checked> Position</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="facings" checked> Facings</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="stack" checked> Stack</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="color"> Color</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="promo_text"> Promo Text</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="package_size"> Package Size</label>
                                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;"><input type="checkbox" name="field" value="confidence"> Confidence</label>
                                        </div>
                                        <div id="fieldDefinitionsPreview" style="margin-top: 10px; padding: 10px; background: #f8fafc; border-radius: 4px; border: 1px solid #e5e7eb; display: none;">
                                            <h5 style="margin: 0 0 8px 0; font-size: 13px; color: #4b5563;">üìñ Field Definitions:</h5>
                                            <div id="definitionsList" style="font-size: 12px; color: #6b7280;"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Base Prompt Context:</label>
                                        <textarea id="basePromptContext" rows="4" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;" placeholder="Enter the base prompt template...">${existingPrompt?.prompt_content || existingPrompt?.content || 'Extract products from this retail shelf image.\nFocus on accuracy and systematic extraction from left to right.\nPay special attention to small products and edge cases.'}</textarea>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Special Instructions:</label>
                                        <textarea id="specialInstructions" rows="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;" placeholder="E.g., This prompt is optimized for Tesco shelves with high product density..."></textarea>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <details style="background: #f8fafc; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                            <summary style="cursor: pointer; font-weight: 600; color: #1f2937;">üß† Advanced: View/Edit Meta-Prompt</summary>
                                            <div style="margin-top: 10px;">
                                                <p style="font-size: 12px; color: #64748b; margin-bottom: 8px;">This is the prompt sent to Claude to generate your optimized prompt. You can customize it:</p>
                                                <textarea id="metaPromptEditor" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; min-height: 200px; font-family: monospace; font-size: 12px;" placeholder="Leave empty to use default meta-prompt"></textarea>
                                                <button onclick="resetMetaPrompt()" style="margin-top: 8px; padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; cursor: pointer;">Reset to Default</button>
                                            </div>
                                        </details>
                                    </div>
                                    
                                    <button onclick="generateOptimizedPrompt()" class="btn-primary" style="width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                                        ü§ñ Generate Optimized Prompt
                                    </button>
                                </div>
                                
                                <!-- Right Panel: AI Results -->
                                <div style="flex: 1; display: flex; flex-direction: column;">
                                    <div id="aiThinking" style="display: none; flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                                        <div style="width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
                                        <p style="color: #64748b; font-size: 16px;">AI is optimizing your prompt...</p>
                                    </div>
                                    
                                    <div id="aiResults" style="display: none; flex: 1; flex-direction: column;">
                                        <!-- Tabs for different views -->
                                        <div style="display: flex; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                                            <button class="result-tab-btn active" onclick="showResultTab('combined')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600;">Combined View</button>
                                            <button class="result-tab-btn" onclick="showResultTab('prompt')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">Prompt Only</button>
                                            <button class="result-tab-btn" onclick="showResultTab('schema')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">Pydantic Schema</button>
                                            <button class="result-tab-btn" onclick="showResultTab('reasoning')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">AI Reasoning</button>
                                            <button class="result-tab-btn" onclick="showResultTab('meta')" style="padding: 12px 20px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280;">Meta-Prompt</button>
                                        </div>
                                        
                                        <!-- Combined View Tab -->
                                        <div id="combinedTab" class="result-tab active" style="flex: 1; padding: 20px; overflow-y: auto;">
                                            <h4 style="margin: 0 0 15px 0; color: #1f2937;">üìã Complete Instructor Configuration:</h4>
                                            <pre id="finalConfigPreview" style="background: #f1f5f9; padding: 15px; border-radius: 6px; font-size: 11px; line-height: 1.4; overflow-x: auto; white-space: pre-wrap; border: 1px solid #e5e7eb;"></pre>
                                            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #3b82f6;">
                                                <p style="margin: 0; font-size: 13px; color: #1e40af;">üìã This is exactly what will be stored and used by the Instructor library.</p>
                                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #1e40af;">üîß The prompt template guides the AI model, while the Pydantic schema ensures structured output.</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Prompt Only Tab -->
                                        <div id="promptTab" class="result-tab" style="display: none; flex: 1; padding: 20px; flex-direction: column;">
                                            <h4 style="margin: 0 0 10px 0; color: #1f2937;">‚úèÔ∏è Optimized Prompt (Editable):</h4>
                                            <textarea id="editablePrompt" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-family: 'Monaco', monospace; font-size: 12px; resize: none;"></textarea>
                                            <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 12px; color: #64748b;">
                                                <span>Estimated tokens: <span id="tokenCount">0</span></span>
                                                <span>Complexity: <span id="complexityScore">Medium</span></span>
                                            </div>
                                        </div>
                                        
                                        <!-- Pydantic Schema Tab -->
                                        <div id="schemaTab" class="result-tab" style="display: none; flex: 1; padding: 20px; flex-direction: column;">
                                            <h4 style="margin: 0 0 10px 0; color: #1f2937;">üèóÔ∏è Generated Pydantic Model:</h4>
                                            <pre id="pydanticModelCode" style="flex: 1; background: #f1f5f9; padding: 15px; border-radius: 6px; font-size: 11px; overflow: auto; border: 1px solid #e5e7eb;"></pre>
                                            <div style="margin-top: 10px;">
                                                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px;">
                                                    <input type="checkbox" id="includeValidation" checked> Include field validation
                                                </label>
                                                <label style="display: flex; align-items: center; gap: 8px; font-size: 12px; margin-top: 5px;">
                                                    <input type="checkbox" id="includeExamples" checked> Include field examples
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <!-- AI Reasoning Tab -->
                                        <div id="reasoningTab" class="result-tab" style="display: none; flex: 1; padding: 20px; overflow-y: auto;">
                                            <h4 style="margin: 0 0 15px 0; color: #1f2937;">üß† AI Optimization Reasoning:</h4>
                                            <ul id="reasoningList" style="margin: 0 0 20px 0; padding-left: 20px; line-height: 1.6;"></ul>
                                            <div>
                                                <h5 style="margin: 0 0 10px 0; color: #1f2937;">üöÄ Key Improvements:</h5>
                                                <ul id="improvementsList" style="margin: 0; padding-left: 20px; line-height: 1.6;"></ul>
                                            </div>
                                        </div>
                                        
                                        <!-- Meta-Prompt Tab -->
                                        <div id="metaTab" class="result-tab" style="display: none; flex: 1; padding: 20px; overflow-y: auto;">
                                            <h4 style="margin: 0 0 15px 0; color: #1f2937;">üîç Meta-Prompt Used:</h4>
                                            <p style="font-size: 12px; color: #64748b; margin-bottom: 10px;">This is the exact prompt that was sent to Claude to generate your optimized prompt:</p>
                                            <pre id="metaPromptUsed" style="background: #f1f5f9; padding: 15px; border-radius: 6px; font-size: 12px; overflow: auto; border: 1px solid #e5e7eb; white-space: pre-wrap;"></pre>
                                        </div>
                                        
                                        <!-- Actions -->
                                        <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f8fafc;">
                                            <div style="display: flex; gap: 10px;">
                                                <button onclick="saveOptimizedPrompt()" class="btn-primary" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                                    üíæ Save to Database
                                                </button>
                                                <button onclick="regeneratePrompt()" class="btn-secondary" style="padding: 10px 15px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">
                                                    üîÑ Regenerate
                                                </button>
                                                <button onclick="testPrompt()" class="btn-secondary" style="padding: 10px 15px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">
                                                    üß™ Test
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Pre-fill fields if editing existing prompt
                if (existingPrompt && existingPrompt.metadata) {
                    try {
                        const metadata = typeof existingPrompt.metadata === 'string' 
                            ? JSON.parse(existingPrompt.metadata) 
                            : existingPrompt.metadata;
                        
                        if (metadata.fields) {
                            document.querySelectorAll('input[name="field"]').forEach(cb => {
                                cb.checked = metadata.fields.includes(cb.value);
                            });
                        }
                    } catch (e) {
                        console.warn('Could not parse prompt metadata:', e);
                    }
                }
            }
            
            // Close prompt engineering modal
            function closePromptEngineeringModal() {
                const modal = document.getElementById('promptEngineeringModal');
                if (modal) {
                    modal.remove();
                }
                editingPromptData = null;
                currentPromptGeneration = null;
            }
            
            // Generate optimized prompt using AI
            async function generateOptimizedPrompt() {
                const selectedFields = Array.from(document.querySelectorAll('input[name="field"]:checked'))
                    .map(cb => cb.value);
                const baseContext = document.getElementById('basePromptContext').value;
                const specialInstructions = document.getElementById('specialInstructions').value;
                const promptType = document.getElementById('promptTypeSelect').value;
                const metaPrompt = document.getElementById('metaPromptEditor').value;
                
                // Show loading
                document.getElementById('aiThinking').style.display = 'flex';
                document.getElementById('aiResults').style.display = 'none';
                
                try {
                    const response = await fetch('/api/analytics/generate-optimized-prompt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt_type: promptType,
                            base_prompt: baseContext,
                            fields_to_extract: selectedFields,
                            special_instructions: specialInstructions,
                            parent_prompt_id: editingPromptData?.prompt_id || null,
                            meta_prompt: metaPrompt || null
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    currentPromptGeneration = result;
                    
                    // Display results
                    displayEnhancedResults(result);
                    
                } catch (error) {
                    console.error('Failed to generate prompt:', error);
                    showNotification('Failed to generate optimized prompt', 'error');
                    document.getElementById('aiThinking').style.display = 'none';
                }
            }
            
            // Display enhanced prompt results
            function displayEnhancedResults(result) {
                document.getElementById('aiThinking').style.display = 'none';
                document.getElementById('aiResults').style.display = 'flex';
                
                // Combined view - show complete Instructor configuration
                let instructorConfig = '# INSTRUCTOR CONFIGURATION\n';
                instructorConfig += '# This exact configuration will be used for extraction\n\n';
                instructorConfig += '## Prompt Template:\n';
                instructorConfig += '\"\"\"\n';
                instructorConfig += (result.optimized_prompt || 'No prompt generated') + '\n';
                instructorConfig += '\"\"\"\n\n';
                instructorConfig += '## Pydantic Model:\n';
                instructorConfig += (result.pydantic_model_code || 'No model generated') + '\n\n';
                instructorConfig += '## Usage:\n';
                instructorConfig += 'from models import ' + (result.model_class_name || 'ExtractionResult') + '\n\n';
                instructorConfig += 'response = client.chat.completions.create(\n';
                instructorConfig += '    model="' + (result.recommended_model || 'gpt-4o') + '",\n';
                instructorConfig += '    messages=[{"role": "user", "content": prompt}],\n';
                instructorConfig += '    response_model=' + (result.model_class_name || 'ExtractionResult') + '\n';
                instructorConfig += ')\n\n';
                instructorConfig += '## Metadata:\n';
                instructorConfig += '- Fields: ' + (result.instructor_config?.fields?.join(', ') || 'N/A') + '\n';
                instructorConfig += '- Optimized for: ' + (result.optimization_focus || 'General use') + '\n';
                instructorConfig += '- Expected token usage: ~' + (result.estimated_tokens || 'Unknown');
                
                document.getElementById('finalConfigPreview').textContent = instructorConfig;
                
                // Editable prompt
                document.getElementById('editablePrompt').value = result.optimized_prompt || '';
                document.getElementById('tokenCount').textContent = Math.round(result.estimated_tokens || 0);
                
                // Pydantic model
                document.getElementById('pydanticModelCode').textContent = result.pydantic_model_code || '';
                
                // AI reasoning
                const reasoningList = document.getElementById('reasoningList');
                reasoningList.innerHTML = (result.reasoning || ['AI optimization applied'])
                    .map(r => `<li>${r}</li>`)
                    .join('');
                
                // Key improvements
                const improvementsList = document.getElementById('improvementsList');
                improvementsList.innerHTML = (result.key_improvements || ['Enhanced clarity and structure'])
                    .map(imp => `<li>${imp}</li>`)
                    .join('');
                
                // Display meta-prompt if available
                if (result.meta_prompt_used) {
                    document.getElementById('metaPromptUsed').textContent = result.meta_prompt_used;
                }
            }
            
            // Switch between result tabs
            function showResultTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.result-tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.style.borderBottomColor = 'transparent';
                    btn.style.color = '#6b7280';
                });
                
                event.target.classList.add('active');
                event.target.style.borderBottomColor = '#3b82f6';
                event.target.style.color = '#3b82f6';
                
                // Show/hide tab content
                document.querySelectorAll('.result-tab').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                const targetTab = document.getElementById(tabName + 'Tab');
                if (targetTab) {
                    targetTab.style.display = 'flex';
                }
            }
            
            // Save optimized prompt to database
            async function saveOptimizedPrompt() {
                if (!currentPromptGeneration) {
                    showNotification('No prompt to save', 'warning');
                    return;
                }
                
                const editedPrompt = document.getElementById('editablePrompt').value;
                const promptType = document.getElementById('promptTypeSelect').value;
                
                let versionStrategy = 'new';
                if (editingPromptData) {
                    const checkedStrategy = document.querySelector('input[name="versionStrategy"]:checked');
                    versionStrategy = checkedStrategy ? checkedStrategy.value : 'new';
                }
                
                try {
                    const saveData = {
                        ...currentPromptGeneration,
                        optimized_prompt: editedPrompt,
                        prompt_type: promptType,
                        model_type: 'universal',
                        version_strategy: versionStrategy,
                        parent_prompt_id: editingPromptData?.prompt_id || null
                    };
                    
                    const response = await fetch('/api/analytics/save-generated-prompt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(saveData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification(`Prompt saved successfully! ID: ${result.prompt_id}`, 'success');
                        closePromptEngineeringModal();
                        
                        // Refresh prompt selectors if they're visible
                        if (document.getElementById('promptSelection').style.display !== 'none') {
                            ['structure', 'products', 'details'].forEach(type => {
                                updatePromptOptions(type);
                            });
                        }
                    } else {
                        throw new Error('Server error');
                    }
                } catch (error) {
                    console.error('Failed to save prompt:', error);
                    showNotification('Failed to save prompt', 'error');
                }
            }
            
            // Regenerate prompt
            function regeneratePrompt() {
                generateOptimizedPrompt();
            }
            
            // Test prompt on sample
            function testPrompt() {
                showNotification('Test functionality coming soon!', 'info');
            }
            
            // Increment version number
            function incrementVersion(currentVersion) {
                try {
                    const version = parseFloat(currentVersion || '1.0');
                    return (version + 0.1).toFixed(1);
                } catch {
                    return '1.1';
                }
            }
            
            // Modal helper functions for detailed prompt views
            function showPromptDetailsModal(promptData) {
                if (!promptData) return;
                
                const modalHtml = `
                    <div class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                            <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; background: #f8fafc;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; color: #1f2937;">üìã ${promptData.name || promptData.template_id} v${promptData.version || promptData.prompt_version}</h3>
                                    <button onclick="this.closest('.modal-overlay').remove()" style="background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">‚úï</button>
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 13px; color: #64748b;">
                                    <span>üìä Success Rate: ${(promptData.performance_score * 100).toFixed(0)}%</span>
                                    <span>üî¢ Uses: ${promptData.usage_count || 0}</span>
                                    <span>üí∞ Avg Cost: ${promptData.avg_token_cost || '$0.000'}</span>
                                </div>
                            </div>
                            <div style="flex: 1; padding: 20px; overflow-y: auto;">
                                <h4 style="margin: 0 0 10px 0; color: #1f2937;">Full Prompt Content:</h4>
                                <pre style="background: #f1f5f9; padding: 15px; border-radius: 6px; font-size: 12px; line-height: 1.4; white-space: pre-wrap; border: 1px solid #e5e7eb;">${promptData.prompt_content || promptData.content || 'No content available'}</pre>
                            </div>
                            <div style="padding: 20px; border-top: 1px solid #e5e7eb; background: #f8fafc;">
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="customizePrompt('${promptData.prompt_type}')" class="btn-primary" style="flex: 1; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Customize</button>
                                    <button onclick="viewPerformance('${promptData.prompt_type}')" class="btn-secondary" style="padding: 10px 15px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; border-radius: 6px; cursor: pointer;">üìà Performance</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            function showPerformanceModal(promptData) {
                if (!promptData) return;
                
                showNotification('Performance analytics coming soon!', 'info');
            }
            
            // Reset meta-prompt to default
            function resetMetaPrompt() {
                const defaultMetaPrompt = `Create an optimized extraction prompt for retail shelf images.

Type: {prompt_type}
Fields to extract: {fields}
Base context: {base_prompt}
Special instructions: {special_instructions}

Generate:
1. An optimized prompt that will achieve >90% accuracy
2. A Pydantic model for structured output with the requested fields
3. Key improvements and reasoning

The prompt should be clear, specific, and include examples where helpful.
Format the response as JSON with keys:
- optimized_prompt: The full prompt text
- pydantic_model_code: Complete Pydantic model code
- model_class_name: Name of the Pydantic class
- reasoning: List of optimization decisions made
- key_improvements: List of key improvements
- optimization_focus: What this prompt is optimized for
- recommended_model: Which AI model to use (claude/gpt4o/gemini)`;
                
                document.getElementById('metaPromptEditor').value = defaultMetaPrompt;
                showNotification('Meta-prompt reset to default', 'success');
            }
            
            // ========== Field Definitions Functions ==========
            
            // Load field definitions when modal opens
            async function loadFieldDefinitions() {
                try {
                    const response = await fetch('/field-definitions');
                    const data = await response.json();
                    
                    if (data.definitions) {
                        window.fieldDefinitions = data.definitions.reduce((acc, def) => {
                            acc[def.field_name] = def;
                            return acc;
                        }, {});
                        
                        // Update field checkboxes with tooltips
                        updateFieldCheckboxes();
                    }
                } catch (error) {
                    console.error('Failed to load field definitions:', error);
                }
            }
            
            // Update field checkboxes with definition tooltips
            function updateFieldCheckboxes() {
                const container = document.getElementById('fieldCheckboxContainer');
                if (!container || !window.fieldDefinitions) return;
                
                // Get all checkbox labels
                const labels = container.querySelectorAll('label');
                labels.forEach(label => {
                    const checkbox = label.querySelector('input[type="checkbox"]');
                    if (!checkbox) return;
                    
                    const fieldName = checkbox.value;
                    const definition = window.fieldDefinitions[fieldName];
                    
                    if (definition) {
                        // Add info icon with tooltip
                        const infoIcon = document.createElement('span');
                        infoIcon.innerHTML = ' ‚ÑπÔ∏è';
                        infoIcon.style.cursor = 'help';
                        infoIcon.title = `${definition.definition}${definition.examples ? '
Examples: ' + definition.examples : ''}`;
                        label.appendChild(infoIcon);
                    }
                });
                
                // Show field definitions preview when checkboxes change
                container.addEventListener('change', updateFieldDefinitionsPreview);
            }
            
            // Update field definitions preview
            function updateFieldDefinitionsPreview() {
                const checkedFields = Array.from(document.querySelectorAll('input[name="field"]:checked'))
                    .map(cb => cb.value);
                
                const preview = document.getElementById('fieldDefinitionsPreview');
                const list = document.getElementById('definitionsList');
                
                if (!preview || !list || !window.fieldDefinitions) return;
                
                const definitions = checkedFields
                    .map(field => window.fieldDefinitions[field])
                    .filter(def => def);
                
                if (definitions.length > 0) {
                    preview.style.display = 'block';
                    list.innerHTML = definitions.map(def => `
                        <div style="margin-bottom: 8px;">
                            <strong>${def.display_name}:</strong> ${def.definition}
                            ${def.examples ? `<br><em style="color: #9ca3af;">Examples: ${def.examples}</em>` : ''}
                        </div>
                    `).join('');
                } else {
                    preview.style.display = 'none';
                }
            }
            
            // Manage field definitions modal
            function manageFieldDefinitions() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10001;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h2 style="margin: 0 0 20px 0;">üìù Manage Field Definitions</h2>
                        
                        <div id="fieldDefinitionsList" style="margin-bottom: 20px;">
                            <p style="color: #6b7280;">Loading field definitions...</p>
                        </div>
                        
                        <button onclick="addFieldDefinition()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            ‚ûï Add New Field
                        </button>
                        
                        <button onclick="this.closest('.fixed').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                loadFieldDefinitionsList();
            }
            
            // Load field definitions list for management
            async function loadFieldDefinitionsList() {
                const container = document.getElementById('fieldDefinitionsList');
                if (!container) return;
                
                try {
                    const response = await fetch('/field-definitions');
                    const data = await response.json();
                    
                    if (data.definitions && data.definitions.length > 0) {
                        container.innerHTML = data.definitions.map(def => `
                            <div style="border: 1px solid #e5e7eb; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                <h4 style="margin: 0 0 8px 0;">${def.display_name} (${def.field_name})</h4>
                                <p style="margin: 0 0 8px 0; color: #4b5563;">${def.definition}</p>
                                ${def.examples ? `<p style="margin: 0; font-size: 12px; color: #9ca3af;"><em>Examples: ${def.examples}</em></p>` : ''}
                                <div style="margin-top: 10px;">
                                    <button onclick="editFieldDefinition('${def.field_name}')" style="padding: 4px 8px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; cursor: pointer; margin-right: 5px;">
                                        Edit
                                    </button>
                                    <button onclick="deleteFieldDefinition('${def.field_name}')" style="padding: 4px 8px; background: #fee2e2; border: 1px solid #fecaca; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="color: #6b7280;">No field definitions found. Add some to help the AI understand your extraction requirements!</p>';
                    }
                } catch (error) {
                    container.innerHTML = '<p style="color: #ef4444;">Failed to load field definitions. Please try again.</p>';
                    console.error('Failed to load field definitions:', error);
                }
            }
            
            // Add new field definition
            function addFieldDefinition() {
                const form = `
                    <div style="border: 1px solid #e5e7eb; padding: 20px; border-radius: 6px; margin-bottom: 20px; background: #f9fafb;">
                        <h3 style="margin: 0 0 15px 0;">Add New Field Definition</h3>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Field Name (e.g., "facings"):</label>
                            <input type="text" id="newFieldName" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Display Name:</label>
                            <input type="text" id="newDisplayName" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Definition:</label>
                            <textarea id="newDefinition" rows="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 4px;">Examples (optional):</label>
                            <textarea id="newExamples" rows="2" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="e.g., '3 facings means 3 identical products side by side'"></textarea>
                        </div>
                        <button onclick="saveNewFieldDefinition()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                            Save
                        </button>
                        <button onclick="loadFieldDefinitionsList()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                `;
                
                const container = document.getElementById('fieldDefinitionsList');
                if (container) {
                    container.innerHTML = form + container.innerHTML;
                }
            }
            
            // Save new field definition
            async function saveNewFieldDefinition() {
                const fieldName = document.getElementById('newFieldName').value.trim();
                const displayName = document.getElementById('newDisplayName').value.trim();
                const definition = document.getElementById('newDefinition').value.trim();
                const examples = document.getElementById('newExamples').value.trim();
                
                if (!fieldName || !displayName || !definition) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/field-definitions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            field_name: fieldName,
                            display_name: displayName,
                            definition: definition,
                            examples: examples || null
                        })
                    });
                    
                    if (response.ok) {
                        showNotification('Field definition added successfully', 'success');
                        loadFieldDefinitionsList();
                        loadFieldDefinitions(); // Reload for the main form
                    } else {
                        const error = await response.json();
                        showNotification(error.detail || 'Failed to add field definition', 'error');
                    }
                } catch (error) {
                    showNotification('Failed to add field definition', 'error');
                    console.error('Failed to add field definition:', error);
                }
            }
            
            // Edit field definition
            async function editFieldDefinition(fieldName) {
                try {
                    const response = await fetch(`/field-definitions/${fieldName}`);
                    const def = await response.json();
                    
                    const form = `
                        <div style="border: 1px solid #e5e7eb; padding: 20px; border-radius: 6px; margin-bottom: 20px; background: #f9fafb;">
                            <h3 style="margin: 0 0 15px 0;">Edit Field Definition</h3>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Field Name:</label>
                                <input type="text" value="${def.field_name}" disabled style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; background: #f3f4f6;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Display Name:</label>
                                <input type="text" id="editDisplayName" value="${def.display_name}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <div style="margin-bottom: 10px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Definition:</label>
                                <textarea id="editDefinition" rows="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">${def.definition}</textarea>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 4px;">Examples (optional):</label>
                                <textarea id="editExamples" rows="2" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">${def.examples || ''}</textarea>
                            </div>
                            <button onclick="saveEditedFieldDefinition('${def.field_name}')" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                Save Changes
                            </button>
                            <button onclick="loadFieldDefinitionsList()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    `;
                    
                    const container = document.getElementById('fieldDefinitionsList');
                    if (container) {
                        container.innerHTML = form;
                    }
                } catch (error) {
                    showNotification('Failed to load field definition', 'error');
                    console.error('Failed to load field definition:', error);
                }
            }
            
            // Save edited field definition
            async function saveEditedFieldDefinition(fieldName) {
                const displayName = document.getElementById('editDisplayName').value.trim();
                const definition = document.getElementById('editDefinition').value.trim();
                const examples = document.getElementById('editExamples').value.trim();
                
                if (!displayName || !definition) {
                    showNotification('Please fill in all required fields', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`/field-definitions/${fieldName}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            field_name: fieldName,
                            display_name: displayName,
                            definition: definition,
                            examples: examples || null
                        })
                    });
                    
                    if (response.ok) {
                        showNotification('Field definition updated successfully', 'success');
                        loadFieldDefinitionsList();
                        loadFieldDefinitions(); // Reload for the main form
                    } else {
                        const error = await response.json();
                        showNotification(error.detail || 'Failed to update field definition', 'error');
                    }
                } catch (error) {
                    showNotification('Failed to update field definition', 'error');
                    console.error('Failed to update field definition:', error);
                }
            }
            
            // Delete field definition
            async function deleteFieldDefinition(fieldName) {
                if (!confirm(`Are you sure you want to delete the field definition for "${fieldName}"?`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/field-definitions/${fieldName}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showNotification('Field definition deleted successfully', 'success');
                        loadFieldDefinitionsList();
                        loadFieldDefinitions(); // Reload for the main form
                    } else {
                        const error = await response.json();
                        showNotification(error.detail || 'Failed to delete field definition', 'error');
                    }
                } catch (error) {
                    showNotification('Failed to delete field definition', 'error');
                    console.error('Failed to delete field definition:', error);
                }
            }
            
            // ========== Prompt Library Functions ==========
            
            // Open prompt library modal
            function openPromptLibrary() {
                const modal = document.createElement('div');
                modal.id = 'promptLibraryModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10002;
                    backdrop-filter: blur(4px);
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 12px; padding: 0; max-width: 1200px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <!-- Header -->
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; background: linear-gradient(to right, #f8fafc, #f3f4f6);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h2 style="margin: 0; color: #1f2937; font-size: 24px;">üìö Prompt Library</h2>
                                <button onclick="document.getElementById('promptLibraryModal').remove()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                            <p style="margin: 10px 0 0 0; color: #6b7280;">Browse existing prompts and their performance metrics for inspiration</p>
                        </div>
                        
                        <!-- Stats Bar -->
                        <div id="libraryStats" style="padding: 15px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 30px; align-items: center; font-size: 14px;">
                                <span>Loading statistics...</span>
                            </div>
                        </div>
                        
                        <!-- Filter Bar -->
                        <div style="padding: 15px 20px; background: white; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                                <select id="libraryFilterType" onchange="filterPromptLibrary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">All Types</option>
                                    <option value="structure">Structure</option>
                                    <option value="products">Products</option>
                                    <option value="details">Details</option>
                                </select>
                                
                                <select id="libraryFilterModel" onchange="filterPromptLibrary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">All Models</option>
                                    <option value="claude">Claude</option>
                                    <option value="gpt4o">GPT-4o</option>
                                    <option value="gemini">Gemini</option>
                                </select>
                                
                                <select id="libraryFilterAccuracy" onchange="filterPromptLibrary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="">Any Accuracy</option>
                                    <option value="0.9">90%+ Accuracy</option>
                                    <option value="0.8">80%+ Accuracy</option>
                                    <option value="0.7">70%+ Accuracy</option>
                                </select>
                                
                                <select id="librarySortBy" onchange="filterPromptLibrary()" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                                    <option value="performance_score">Best Performance</option>
                                    <option value="usage_count">Most Used</option>
                                    <option value="cost">Lowest Cost</option>
                                    <option value="recent">Recently Used</option>
                                </select>
                                
                                <input type="text" id="librarySearch" placeholder="Search prompts..." onkeyup="filterPromptLibrary()" 
                                    style="flex: 1; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px;">
                            </div>
                        </div>
                        
                        <!-- Prompt Grid -->
                        <div id="promptLibraryContent" style="flex: 1; overflow-y: auto; padding: 20px;">
                            <div id="promptGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                                <!-- Prompts will be loaded here -->
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                loadPromptLibrary();
                loadLibraryStats();
            }
            
            // Load prompt library
            async function loadPromptLibrary() {
                const grid = document.getElementById('promptGrid');
                if (!grid) return;
                
                // Show loading state
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280;">Loading prompts...</p>';
                
                try {
                    const params = new URLSearchParams({
                        prompt_type: document.getElementById('libraryFilterType')?.value || '',
                        model_type: document.getElementById('libraryFilterModel')?.value || '',
                        min_accuracy: document.getElementById('libraryFilterAccuracy')?.value || '',
                        sort_by: document.getElementById('librarySortBy')?.value || 'performance_score'
                    });
                    
                    // Remove empty params
                    for (const [key, value] of [...params]) {
                        if (!value) params.delete(key);
                    }
                    
                    const response = await fetch(`/api/prompts/library?${params}`);
                    const data = await response.json();
                    
                    if (data.prompts && data.prompts.length > 0) {
                        grid.innerHTML = data.prompts.map(prompt => createPromptCard(prompt)).join('');
                    } else {
                        grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280;">No prompts found matching your criteria.</p>';
                    }
                } catch (error) {
                    console.error('Failed to load prompt library:', error);
                    grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #ef4444;">Failed to load prompts. Please try again.</p>';
                }
            }
            
            // Create prompt card
            function createPromptCard(prompt) {
                const perfColor = prompt.performance_score >= 0.9 ? '#10b981' : 
                                prompt.performance_score >= 0.8 ? '#f59e0b' : '#ef4444';
                
                return `
                    <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; background: white; hover: box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: all 0.2s;">
                        <!-- Header -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 4px 0; font-size: 16px; color: #1f2937;">${prompt.name}</h3>
                                <p style="margin: 0; font-size: 12px; color: #6b7280;">${prompt.description || 'No description'}</p>
                            </div>
                            <span style="background: ${perfColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ${(prompt.performance_score * 100).toFixed(0)}%
                            </span>
                        </div>
                        
                        <!-- Metadata -->
                        <div style="display: flex; gap: 12px; margin-bottom: 12px; font-size: 11px; color: #6b7280;">
                            <span>üì± ${prompt.model_type.toUpperCase()}</span>
                            <span>üì¶ ${prompt.prompt_type}</span>
                            <span>üî• ${prompt.usage_count} uses</span>
                            <span>üí∞ $${prompt.avg_cost.toFixed(3)}</span>
                        </div>
                        
                        <!-- Preview -->
                        <div style="background: #f9fafb; padding: 10px; border-radius: 4px; margin-bottom: 12px;">
                            <p style="margin: 0; font-size: 11px; color: #4b5563; font-family: monospace; line-height: 1.4;">
                                ${prompt.preview}
                            </p>
                        </div>
                        
                        <!-- Tags -->
                        ${prompt.tags && prompt.tags.length > 0 ? `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;">
                                ${prompt.tags.map(tag => `
                                    <span style="background: #e5e7eb; color: #4b5563; padding: 2px 8px; border-radius: 12px; font-size: 10px;">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 8px; justify-content: space-between; align-items: center;">
                            <span style="font-size: 11px; color: #9ca3af;">
                                Last used: ${prompt.last_used}
                            </span>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="viewPromptDetails('${prompt.id}')" style="padding: 6px 12px; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    View Details
                                </button>
                                <button onclick="usePromptAsTemplate('${prompt.id}')" style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    Use as Template
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Load library statistics
            async function loadLibraryStats() {
                const statsDiv = document.getElementById('libraryStats');
                if (!statsDiv) return;
                
                try {
                    const response = await fetch('/api/prompts/library/stats');
                    const stats = await response.json();
                    
                    statsDiv.innerHTML = `
                        <div style="display: flex; gap: 30px; align-items: center; font-size: 14px;">
                            <span><strong>${stats.total_prompts}</strong> Total Prompts</span>
                            <span><strong>${(stats.avg_performance * 100).toFixed(0)}%</strong> Avg Performance</span>
                            <span><strong>${stats.most_used_type || 'N/A'}</strong> Most Used Type</span>
                            <span><strong>${stats.most_successful_model || 'N/A'}</strong> Best Model</span>
                            <span><strong>$${stats.avg_cost_per_extraction.toFixed(3)}</strong> Avg Cost</span>
                        </div>
                    `;
                } catch (error) {
                    console.error('Failed to load library stats:', error);
                }
            }
            
            // Filter prompt library
            function filterPromptLibrary() {
                // Debounce search
                clearTimeout(window.libraryFilterTimeout);
                window.libraryFilterTimeout = setTimeout(() => {
                    loadPromptLibrary();
                }, 300);
            }
            
            // View prompt details
            async function viewPromptDetails(promptId) {
                try {
                    const response = await fetch(`/api/prompts/${promptId}`);
                    const prompt = await response.json();
                    
                    // Create detail modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10003;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h2 style="margin: 0 0 20px 0;">${prompt.name || 'Prompt Details'}</h2>
                            
                            <div style="background: #f9fafb; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0;">Full Prompt Content:</h4>
                                <pre style="margin: 0; white-space: pre-wrap; font-family: monospace; font-size: 12px; line-height: 1.5;">${prompt.content}</pre>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <h4 style="margin: 0 0 10px 0;">Performance Metrics:</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Success Rate: ${(prompt.performance_stats.success_rate || 0).toFixed(1)}%</li>
                                        <li>Usage Count: ${prompt.performance_stats.usage_count || 0}</li>
                                        <li>Avg Cost: $${(prompt.performance_stats.avg_cost || 0).toFixed(3)}</li>
                                        <li>Error Rate: ${(prompt.performance_stats.error_rate || 0).toFixed(1)}%</li>
                                    </ul>
                                </div>
                                
                                <div>
                                    <h4 style="margin: 0 0 10px 0;">Metadata:</h4>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 14px;">
                                        <li>Type: ${prompt.prompt_type}</li>
                                        <li>Model: ${prompt.model_type}</li>
                                        <li>Created: ${new Date(prompt.metadata.created_at).toLocaleDateString()}</li>
                                        <li>Version: ${prompt.version || 1}</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Close
                                </button>
                                <button onclick="usePromptAsTemplate('${promptId}'); this.closest('div[style*=\'position: fixed\']').remove()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Use as Template
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Close on background click
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                } catch (error) {
                    console.error('Failed to load prompt details:', error);
                    showNotification('Failed to load prompt details', 'error');
                }
            }
            
            // Use prompt as template
            async function usePromptAsTemplate(promptId) {
                try {
                    const response = await fetch(`/api/prompts/${promptId}`);
                    const prompt = await response.json();
                    
                    // Close library modal
                    const libraryModal = document.getElementById('promptLibraryModal');
                    if (libraryModal) {
                        libraryModal.remove();
                    }
                    
                    // Open prompt engineering modal with this prompt as template
                    openPromptEngineeringModal(prompt.prompt_type, prompt);
                    
                    // Pre-fill the fields
                    setTimeout(() => {
                        const basePromptTextarea = document.getElementById('basePromptContext');
                        if (basePromptTextarea) {
                            basePromptTextarea.value = prompt.content;
                        }
                        
                        // Set the parent prompt info
                        editingPromptData = prompt;
                        
                        showNotification('Loaded prompt as template. Modify and generate your own version!', 'success');
                    }, 100);
                } catch (error) {
                    console.error('Failed to use prompt as template:', error);
                    showNotification('Failed to load prompt template', 'error');
                }
            }
            
            // ========== Feedback System Functions ==========
            
            // Switch between Simple view tabs
            function switchSimpleTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.simple-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // Update tab content
                document.querySelectorAll('.simple-tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                
                if (tabName === 'products') {
                    document.getElementById('products-tab').style.display = 'block';
                } else if (tabName === 'feedback') {
                    document.getElementById('feedback-tab').style.display = 'block';
                }
            }
            
            // Handle star rating clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const rating = e.target.getAttribute('data-value');
                    const ratingContainer = e.target.parentElement;
                    const ratingType = ratingContainer.getAttribute('data-rating');
                    
                    // Update visual state
                    ratingContainer.querySelectorAll('.star').forEach((star, index) => {
                        if (index < rating) {
                            star.classList.add('active');
                        } else {
                            star.classList.remove('active');
                        }
                    });
                    
                    // Store rating
                    if (ratingType === 'extraction') {
                        currentFeedback.extractionRating = parseInt(rating);
                    } else if (ratingType === 'planogram') {
                        currentFeedback.planogramRating = parseInt(rating);
                    }
                }
            });
            
            // Current feedback data
            let currentFeedback = {
                extractionRating: 0,
                planogramRating: 0,
                workedWell: '',
                needsImprovement: ''
            };
            
            // Submit feedback
            async function submitFeedback() {
                // Get current values
                currentFeedback.workedWell = document.getElementById('workedWell').value;
                currentFeedback.needsImprovement = document.getElementById('needsImprovement').value;
                
                // Validate
                if (currentFeedback.extractionRating === 0 || currentFeedback.planogramRating === 0) {
                    showNotification('Please rate both extraction and planogram quality', 'warning');
                    return;
                }
                
                if (!currentFeedback.workedWell && !currentFeedback.needsImprovement) {
                    showNotification('Please provide at least one comment', 'warning');
                    return;
                }
                
                // Get current queue item ID
                const currentItem = queueData.find(item => item.id === selectedItemId);
                if (!currentItem) {
                    showNotification('No item selected', 'error');
                    return;
                }
                
                try {
                    const response = await fetch('/api/feedback/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            queue_item_id: currentItem.id,
                            upload_id: currentItem.upload_id,
                            extraction_rating: currentFeedback.extractionRating,
                            planogram_rating: currentFeedback.planogramRating,
                            worked_well: currentFeedback.workedWell,
                            needs_improvement: currentFeedback.needsImprovement,
                            metadata: {
                                accuracy: currentItem.final_accuracy,
                                system: currentItem.current_extraction_system,
                                timestamp: new Date().toISOString()
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showNotification('Feedback submitted successfully! Thank you!', 'success');
                        
                        // Show success status
                        const statusDiv = document.getElementById('feedbackStatus');
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = '#10b981';
                        statusDiv.style.color = 'white';
                        statusDiv.innerHTML = '‚úÖ Feedback saved! This will help improve future extractions.';
                        
                        // Reset form after 2 seconds
                        setTimeout(() => {
                            resetFeedback();
                            statusDiv.style.display = 'none';
                        }, 2000);
                    } else {
                        throw new Error('Failed to submit feedback');
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    showNotification('Failed to submit feedback: ' + error.message, 'error');
                    
                    // Show error status
                    const statusDiv = document.getElementById('feedbackStatus');
                    statusDiv.style.display = 'block';
                    statusDiv.style.background = '#ef4444';
                    statusDiv.style.color = 'white';
                    statusDiv.innerHTML = '‚ùå Error submitting feedback. Please try again.';
                }
            }
            
            // Reset feedback form
            function resetFeedback() {
                // Reset ratings
                document.querySelectorAll('.star-rating .star').forEach(star => {
                    star.classList.remove('active');
                });
                
                // Clear text areas
                document.getElementById('workedWell').value = '';
                document.getElementById('needsImprovement').value = '';
                
                // Reset data
                currentFeedback = {
                    extractionRating: 0,
                    planogramRating: 0,
                    workedWell: '',
                    needsImprovement: ''
                };
                
                showNotification('Feedback form reset', 'info');
            }
        </script>
        
        </div>
    
    <style>
        /* Right Sidebar - Prompt Management */
        .right-sidebar {
            width: 350px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 100;
            position: relative;
            flex-shrink: 0;
            max-height: 100vh;
            overflow-y: auto;
        }
        
        .right-sidebar.collapsed {
            transform: translateX(330px);
            width: 20px;
        }
        
        /* Prompt Management Styles */
        .prompt-section {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .prompt-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .system-selection {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .radio-option:hover {
            background: #f8fafc;
            border-color: #3b82f6;
        }
        
        .radio-option.selected {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }
        
        .radio-option input[type="radio"] {
            margin: 0;
        }
        
        .radio-option label {
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            margin: 0;
        }
        
        .prompt-dropdowns {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dropdown-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .dropdown-group label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .dropdown-group select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        
        .prompt-preview {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .prompt-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            font-size: 11px;
            font-family: 'Monaco', 'Menlo', monospace;
            line-height: 1.4;
            color: #374151;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .metric {
            background: #f1f5f9;
            padding: 6px 8px;
            border-radius: 4px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 10px;
            color: #64748b;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 12px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .prompt-editor {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .prompt-editor textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
            background: white;
        }
        
        .editor-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        
        .editor-actions button {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .editor-actions button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .editor-actions button:hover {
            background: #f8fafc;
        }
        
        .editor-actions button.primary:hover {
            background: #2563eb;
        }
        
        /* Batch Operations */
        .batch-controls {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .batch-selection {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .batch-actions {
            display: flex;
            gap: 6px;
        }
        
        .batch-actions button {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            background: white;
        }
        
        .batch-actions button:hover {
            background: #f8fafc;
        }
        
        .batch-actions button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .batch-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Enhanced Queue Items */
        .queue-item {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .queue-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
        }
        
        .queue-item.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .queue-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .queue-item-checkbox {
            margin: 0;
        }
        
        .queue-item-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
        }
        
        .queue-item-config {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        .config-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #64748b;
        }
        
        .config-indicator.override {
            color: #dc2626;
            font-weight: 500;
        }
        
        .queue-item-actions {
            display: flex;
            gap: 6px;
        }
        
        .queue-item-actions button {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            background: white;
        }
        
        .queue-item-actions button:hover {
            background: #f8fafc;
        }
        
        .queue-item-actions button.primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
    </body>
    </html>
    